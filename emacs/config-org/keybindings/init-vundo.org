* init-vundo.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "init-vundo.el") :lexical t
:END:

** Headers

#+BEGIN_SRC emacs-lisp
  ;;; init-vundo.el -- Config for Vundo -*- lexical-binding: t; -*-

  ;; Filename: init-vundo.el
  ;; Description: Config for Vundo
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024, mcge, all rights reserved.
  ;; Create   Date: 2025-01-04 15:00:00
  ;; Version: 0.1
  ;; Modified   By:  mcge <mcgeq@outlook.com>
  ;; Last Modified:  <2025-01-10 Fri 10:17>
  ;; Keywords:
  ;; Compatibility: GNU Emacs 31.0.50

  ;;; Commentary:
  ;;
  ;; Config for Vundo
  ;;

  ;;; Installation:
  ;;
  ;; Put init-vundo.el to your load-path.
  ;; The load-path is usually ~/elisp/.
  ;; It's set in your ~/.emacs like this:
  ;; (add-to-list 'load-path (expand-file-name "~/elisp"))
  ;;
  ;; And the following to your ~/.emacs startup file.
  ;;
  ;; (require 'init-vundo)
  ;;
  ;; No need more.

  ;;; Customize:
  ;;
  ;;
  ;;
  ;; All of the above can customize by:
  ;;      M-x customize-group RET init-aider RET
  ;;

  ;;; Change log:
  ;;

#+END_SRC


** Require
#+BEGIN_SRC emacs-lisp
;;; Require:
(require 'vundo)
(require 'hydra)

#+END_SRC

** Configuration
#+BEGIN_SRC emacs-lisp
  ;;; Configuration:
  
  ;; Use Unicode symbols for better visualization
  (setq vundo-glyph-alist vundo-unicode-symbols)
  
  ;; Don't roll back changes when quitting (commit by default)
  (setq vundo-roll-back-on-quit nil)
  
  ;; Compact display mode for smaller trees
  (setq vundo-compact-display t)
  
  ;; Auto-bury diff window when vundo quits
  (setq vundo-diff-quit 'bury)
  
  ;; Prevent vundo from making buffer read-only
  ;; Override the problematic behavior at its source
  (defun vundo--force-writable-after-command (&rest _)
    "Force buffer to be writable after any vundo command."
    (run-with-timer 0.01 nil
                    (lambda ()
                      (when (and (not (eq major-mode 'vundo-mode))
                                 buffer-read-only)
                        (read-only-mode -1)))))
  
  ;; Add advice to all vundo navigation and exit commands
  (advice-add 'vundo-backward :after #'vundo--force-writable-after-command)
  (advice-add 'vundo-forward :after #'vundo--force-writable-after-command)
  (advice-add 'vundo-next :after #'vundo--force-writable-after-command)
  (advice-add 'vundo-previous :after #'vundo--force-writable-after-command)
  (advice-add 'vundo-stem-root :after #'vundo--force-writable-after-command)
  (advice-add 'vundo-stem-end :after #'vundo--force-writable-after-command)
  (advice-add 'vundo-goto-last-saved :after #'vundo--force-writable-after-command)
  (advice-add 'vundo-quit :after #'vundo--force-writable-after-command)
  (advice-add 'vundo-confirm :after #'vundo--force-writable-after-command)
  
  ;; Popup mode configuration (auto-show vundo on undo/redo)
  ;; Uncomment to enable popup mode
  ;; (vundo-popup-mode 1)
  ;; (setq vundo-popup-delay 3) ; Auto-hide after 3 seconds
  
  ;; Set font for vundo buffer to support Unicode symbols
  ;; You may need to install Symbola or Unifont font
  ;; (set-face-attribute 'vundo-default nil :family "Symbola")

#+END_SRC

** Keybindings
#+BEGIN_SRC emacs-lisp
  ;;; Keybindings:
  
  ;; Global keybinding to open vundo
  (global-set-key (kbd "C-x u") 'vundo)
  (global-set-key (kbd "C-/") 'vundo)  ; Alternative binding
  
  ;; Enhanced hydra with all vundo features
  (defhydra hydra-vundo (:color pink :hint nil)
    "
╭────────^Movement^─────────┬─────^Branch^──────┬──────^Saved^──────┬─────^Diff^────┬───^Actions^───╮
│ _f_ forward  _b_ backward │ _n_ next branch   │ _l_ last saved    │ _m_ mark      │ _RET_ confirm │
│ _a_ to branch _w_ forward │ _p_ prev branch   │ _r_ next saved    │ _u_ unmark    │ _q_ quit      │
│ _e_ to tip               │                   │                   │ _d_ diff      │ _Q_ abort     │
╰──────────────────────────┴───────────────────┴───────────────────┴───────────────┴───────────────╯
    "
    ;; Basic movement
    ("f" vundo-forward "forward")
    ("b" vundo-backward "backward")
    
    ;; Branch navigation
    ("n" vundo-next "next branch")
    ("p" vundo-previous "prev branch")
    ("a" vundo-stem-root "to branch point")
    ("w" vundo-stem-end "forward to tip")
    ("e" vundo-stem-end "to end")
    
    ;; Saved state navigation
    ("l" vundo-goto-last-saved "last saved")
    ("r" vundo-goto-next-saved "next saved")
    
    ;; Diff operations
    ("m" vundo-diff-mark "mark for diff")
    ("u" vundo-diff-unmark "unmark")
    ("d" vundo-diff "show diff")
    
    ;; Actions
    ("RET" vundo-confirm "confirm" :color blue)
    ("q" vundo-quit "quit" :color blue)
    ("Q" (progn (setq vundo-roll-back-on-quit t) (vundo-quit)) "abort" :color blue)
    ("C-g" vundo-quit "quit" :color blue)
    
    ;; Debug (hidden)
    ("i" vundo--inspect)
    ("D" vundo--debug))
  
  ;; Bind hydra to vundo-mode
  (define-key vundo-mode-map "." 'hydra-vundo/body)
  (define-key vundo-mode-map "?" 'hydra-vundo/body)
  
  ;; Auto-show hydra when vundo opens
  (add-hook 'vundo-mode-hook #'hydra-vundo/body)
#+END_SRC

** Ends
#+BEGIN_SRC emacs-lisp
(provide 'init-vundo)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-vundo.el ends here
#+END_SRC
