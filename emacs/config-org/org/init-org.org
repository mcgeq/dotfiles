* init-org.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "init-org.el") :lexical t
:END:

** Headers

#+BEGIN_SRC emacs-lisp
  ;;; init-org.el -- Config for Emacs Font -*- lexical-binding: t; -*-

  ;; Filename: init-org.el
  ;; Description: Config for Emacs Font
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024, mcge, all rights reserved.
  ;; Create   Date: 2025-01-04 15:00:00
  ;; Version: 0.1
  ;; Modified   By:  mcgeq <mcgeq@outlook.com>
  ;; Last Modified:  <2025-02-16 Sun 11:48>
  ;; Keywords:
  ;; Compatibility: 31.0.50

  ;;; Commentary:
  ;;
  ;; Config for Font
  ;;

  ;;; Installation:
  ;;
  ;; Put init-org.el to your load-path.
  ;; The load-path is usually ~/elisp/.
  ;; It's set in your ~/.emacs like this:
  ;; (add-to-list 'load-path (expand-file-name "~/elisp"))
  ;;
  ;; And the following to your ~/.emacs startup file.
  ;;
  ;; (require 'init-org)
  ;;
  ;; No need more.

  ;;; Customize:
  ;;
  ;;
  ;;
  ;; All of the above can customize by:
  ;;      M-x customize-group RET init-aider RET
  ;;

  ;;; Change log:
  ;;

#+END_SRC

** Require

#+BEGIN_SRC emacs-lisp
  ;;; Require:
  (require 'visual-fill-column)
  (require 'mixed-pitch)
  (require 'org-superstar)
  (require 'org-appear)
  (require 'cal-china-x)
  (require 'ox)

#+END_SRC

** Code
*** Org
#+BEGIN_SRC emacs-lisp
  ;;; Code:

  (setq org-ellipsis " â­"
        org-tags-column 0
        org-log-into-drawer t
        org-pretty-entities t
        org-startup-indented t
        org-hide-leading-stars nil
        org-hide-emphasis-markers t
        org-image-actual-width '(800)
        org-startup-with-inline-images t
        org-indent-mode-turns-on-hiding-stars nil)

  ;; done close time
  (setq org-log-done 'time)

  ;; TOOD çš„å…³é”®è¯è®¾ç½®ï¼Œå¯ä»¥è®¾ç½®ä¸åŒçš„ç»„
  (setq org-todo-keywords '((sequence
                             "TODO(t)"
                             "HOLD(h!)"
                             "WIP(i!)"
                             "WAIT(w!)"
                             "|"
                             "DONE(d!)"
                             "CANCELLED(c@/!)")
                            (sequence
                             "REPORT(r)"
                             "BUG(b)"
                             "KNOWNCAUSE(k)"
                             "|"
                             "FIXED(f!)")))
  ;; TODO å…³é”®è¯çš„æ ·å¼è®¾ç½®
  (setq org-todo-keyword-faces '(("TODO"       :foreground "#7c7c75" :weight bold)
                                 ("HOLD"       :foreground "#feb24c" :weight bold)
                                 ("WIP"        :foreground "#0098dd" :weight bold)
                                 ("WAIT"       :foreground "#9f7efe" :weight bold)
                                 ("DONE"       :foreground "#50a14f" :weight bold)
                                 ("CANCELLED"  :foreground "#ff6480" :weight bold)
                                 ("REPORT"     :foreground "magenta" :weight bold)
                                 ("BUG"        :foreground "red"     :weight bold)
                                 ("KNOWNCAUSE" :foreground "yellow"  :weight bold)
                                 ("FIXED"      :foreground "green"   :weight bold)))

  ;; å½“æ ‡é¢˜è¡ŒçŠ¶æ€å˜åŒ–æ—¶æ ‡ç­¾åŒæ­¥å‘ç”Ÿçš„å˜åŒ–
  ;; Moving a task to CANCELLED adds a CANCELLED tag
  ;; Moving a task to WAIT adds a WAIT tag
  ;; Moving a task to HOLD adds WAIT and HOLD tags
  ;; Moving a task to a done state removes WAIT and HOLD tags
  ;; Moving a task to TODO removes WAIT, CANCELLED, and HOLD tags
  ;; Moving a task to DONE removes WAIT, CANCELLED, and HOLD tags
  (setq org-todo-state-tags-triggers
        (quote (("CANCELLED" ("CANCELLED" . t))
                ("WAIT" ("WAIT" . t))
                ("HOLD" ("WAIT") ("HOLD" . t))
                (done ("WAIT") ("HOLD"))
                ("TODO" ("WAIT") ("CANCELLED") ("HOLD"))
                ("DONE" ("WAIT") ("CANCELLED") ("HOLD")))))

  ;; é‡å¤æ‰§è¡Œæ—¶åŠ ä¸Šæ—¶é—´æˆ³
  (setq org-log-repeat 'time)
  ;; Deadline ä¿®æ”¹æ—¶åŠ ä¸Šä¸€æ¡è®°å½•
  (setq org-log-redeadline 'note)
  ;; Schedule ä¿®æ”¹æ—¶åŠ ä¸Šä¸€æ¡è®°å½•
  (setq org-log-reschedule 'note)
  ;; ä»¥æŠ½å±‰çš„æ–¹å¼è®°å½•
  (setq org-log-into-drawer t)
  ;; ç´§æ¥ç€æ ‡é¢˜è¡Œæˆ–è€…è®¡åˆ’/æˆªæ­¢æ—¶é—´æˆ³ååŠ ä¸Šè®°å½•æŠ½å±‰
  (setq org-log-state-notes-insert-after-drawers nil)

  (custom-set-faces
   '(org-level-1 ((t (:height 1.15))))
   '(org-level-2 ((t (:height 1.13))))
   '(org-level-3 ((t (:height 1.11))))
   '(org-level-4 ((t (:height 1.09))))
   '(org-level-5 ((t (:height 1.07))))
   '(org-level-6 ((t (:height 1.05))))
   '(org-level-7 ((t (:height 1.03))))
   '(org-level-8 ((t (:height 1.01))))
   '(org-tag ((t (:inherit 'fixed-pitch))))
   '(org-date ((t (:inherit 'fixed-pitch))))
   '(org-todo ((t (:inherit 'fixed-pitch))))
   '(org-done ((t (:inherit 'fixed-pitch))))
   '(org-drawer ((t (:inherit 'fixed-pitch))))
   '(org-ellipsis ((t (:inherit 'fixed-pitch))))
   '(org-property-value ((t (:inherit 'fixed-pitch))))
   '(org-special-keyword ((t (:inherit 'fixed-pitch))))
   '(org-headline-done ((t (:inherit 'variable-pitch)))))

  ;; visual-fill-column
  (setq visual-fill-column-width 88)

  ;; mixed-pitch (with font availability check)
  (when (display-graphic-p)
    (let ((mono-font (if (find-font (font-spec :name "FiraCode Nerd Font Mono"))
                         "FiraCode Nerd Font Mono"
                       (if (find-font (font-spec :name "Consolas"))
                           "Consolas"
                         "monospace")))
          (serif-font (if (find-font (font-spec :name "Noto Serif"))
                          "Noto Serif"
                        (if (find-font (font-spec :name "Georgia"))
                            "Georgia"
                          "serif"))))
      (custom-set-faces
       `(default ((t (:font ,mono-font))))
       `(fixed-pitch ((t (:font ,mono-font :height 1.0))))
       `(variable-pitch ((t (:font ,serif-font :height 1.0)))))))

  ;; org-superstar
  (setq org-superstar-leading-bullet ?\s
        org-superstar-special-todo-items t
        org-superstar-item-bullet-alist '((43 . "â¬§") (45 . "â¬¨"))
        org-superstar-headline-bullets-list '("â˜°" "â˜±" "â˜²" "â˜³" "â˜´" "â˜µ" "â˜¶" "â˜·"))

  (custom-set-faces
   '(org-superstar-item ((t (:inherit 'fixed-pitch))))
   '(org-superstar-header-bullet ((t (:height 232 :inherit 'fixed-pitch)))))

  (add-hook 'org-mode-hook
            (lambda ()
              (setq-local line-spacing 2)
              (visual-line-mode)
              (visual-fill-column-mode)
              (mixed-pitch-mode)
              (org-superstar-mode)
              (org-appear-mode)))

  (defun mg/org-font-lock-drawer (limit)
    (when (or (re-search-forward "SCHEDULED:\\(\\(.\\|\n\\)+:\s*\n\\)" limit t)
              (re-search-forward ".+?:\s+\\(.+\\)$" limit t))
      (let ((beg (match-beginning 1))
            (end (match-end 1)))
        (put-text-property beg end 'face 'fixed-pitch)
        (put-text-property (match-beginning 0) (match-end 0) 'font-lock-multiline 't)
        (goto-char end))))

  (font-lock-add-keywords 'org-mode
                          '(mg/org-font-lock-drawer))

  (font-lock-add-keywords 'org-mode
                          '(("\\cc\\( \\)[/+*_=~][^a-zA-Z0-9/+*_=~\n]+?[/+*_=~]\\( \\)?\\cc?"
                             (1 (prog1 () (compose-region (match-beginning 1) (match-end 1) ""))))))


#+END_SRC

*** Calendar
#+begin_src emacs-lisp
  ;; calendar
  ;; é…ç½® calendar
  (with-eval-after-load 'calendar
    ;; è®¾ç½®æ ‡è®°ä»Šå¤©
    (add-hook 'calendar-today-visible-hook 'calendar-mark-today)

    ;; è®¾ç½®æ˜¯å¦æ˜¾ç¤ºä¸­å›½èŠ‚æ—¥
    (setq calendar-chinese-all-holidays-flag nil)
    ;; è®¾ç½®æ˜¯å¦æ˜¾ç¤ºèŠ‚æ—¥
    (setq calendar-mark-holidays-flag t)
    ;; è®¾ç½®æ˜¯å¦æ˜¾ç¤ºæ—¥è®°æ¡ç›®ï¼ˆä½¿ç”¨ Org æ—¥è®°ï¼‰
    (setq calendar-mark-diary-entries-flag nil)
    ;; è®¾ç½®æ—¶åŒºçš„æ˜¾ç¤ºæ–¹å¼ï¼Œæ•°å­—æ–¹å¼ï¼ˆå¦‚ +0800ï¼‰
    (setq calendar-time-zone-style 'numeric)
    ;; è®¾ç½®æ—¥æœŸæ˜¾ç¤ºæ–¹å¼ï¼šå¹´/æœˆ/æ—¥
    (setq calendar-date-style 'iso)
    ;; è®¾ç½®ä¸­æ–‡å¤©å¹²åœ°æ”¯
    (setq calendar-chinese-celestial-stem
          ["ç”²" "ä¹™" "ä¸™" "ä¸" "æˆŠ" "å·±" "åºš" "è¾›" "å£¬" "ç™¸"])
    (setq calendar-chinese-terrestrial-branch
          ["å­" "ä¸‘" "å¯…" "å¯" "è¾°" "å·³" "åˆ" "æœª" "ç”³" "é…‰" "æˆŒ" "äº¥"])
    ;; è®¾ç½®ä¸­æ–‡æœˆä»½åç§°
    (setq calendar-month-name-array
          ["ä¸€æœˆ" "äºŒæœˆ" "ä¸‰æœˆ" "å››æœˆ" "äº”æœˆ" "å…­æœˆ" "ä¸ƒæœˆ" "å…«æœˆ" "ä¹æœˆ" "åæœˆ" "åä¸€æœˆ" "åäºŒæœˆ"])
    ;; è®¾ç½®æ˜ŸæœŸæ ‡é¢˜æ˜¾ç¤º
    (setq calendar-day-name-array
          ["æ—¥" "ä¸€" "äºŒ" "ä¸‰" "å››" "äº”" "å…­"])
    ;; è®¾ç½®å‘¨ä¸€ä¸ºä¸€å‘¨çš„ç¬¬ä¸€å¤©
    (setq calendar-week-start-day 1))
#+end_src

*** ParseTime
#+begin_src emacs-lisp
  ;; parse time
  ;; æ—¶é—´è§£æå¢åŠ ä¸­æ–‡æ‹¼éŸ³
  (with-eval-after-load 'parse-time
    (setq parse-time-months
          (append '(("yiy" . 1) ("ery" . 2) ("sany" . 3)
                    ("siy" . 4) ("wuy" . 5) ("liuy" . 6)
                    ("qiy" . 7) ("bay" . 8) ("jiuy" . 9)
                    ("shiy" . 10) ("shiyiy" . 11) ("shiery" . 12)
                    ("yiyue" . 1) ("eryue" . 2) ("sanyue" . 3)
                    ("siyue" . 4) ("wuyue" . 5) ("liuyue" . 6)
                    ("qiyue" . 7) ("bayue" . 8) ("jiuyue" . 9)
                    ("shiyue" . 10) ("shiyiyue" . 11) ("shieryue" . 12))
                  parse-time-months))

    (setq parse-time-weekdays
          (append '(("zri" . 0) ("zqi" . 0)
                    ("zyi" . 1) ("zer" . 2) ("zsan" . 3)
                    ("zsi" . 4) ("zwu" . 5) ("zliu" . 6)
                    ("zr" . 0) ("zq" . 0)
                    ("zy" . 1) ("ze" . 2) ("zs" . 3)
                    ("zsi" . 4) ("zw" . 5) ("zl" . 6))
                  parse-time-weekdays)))
#+end_src

*** Holiday
#+begin_src emacs-lisp
  ;; cal-china-x
  ;; ä¸­å›½èŠ‚æ—¥è®¾ç½®
  (with-eval-after-load 'cal-china-x
    ;; è®¾ç½®é‡è¦èŠ‚æ—¥
    (setq calendar-mark-holidays-flag t)
    (setq cal-china-x-important-holidays cal-china-x-chinese-holidays)

    ;; è®¾ç½®æ‰€æœ‰èŠ‚æ—¥
    (setq cal-china-x-general-holidays
          '(;; å…¬å†èŠ‚æ—¥
            (holiday-fixed 1 1 "å…ƒæ—¦")
            (holiday-fixed 2 14 "æƒ…äººèŠ‚")
            (holiday-fixed 3 8 "å¦‡å¥³èŠ‚")
            (holiday-fixed 3 14 "ç™½è‰²æƒ…äººèŠ‚")
            (holiday-fixed 4 1 "æ„šäººèŠ‚")
            (holiday-fixed 5 1 "åŠ³åŠ¨èŠ‚")
            (holiday-fixed 5 4 "é’å¹´èŠ‚")
            (holiday-float 5 0 2 "æ¯äº²èŠ‚")
            (holiday-fixed 6 1 "å„¿ç«¥èŠ‚")
            (holiday-float 6 0 3 "çˆ¶äº²èŠ‚")
            (holiday-fixed 9 10 "æ•™å¸ˆèŠ‚")
            (holiday-fixed 10 1 "å›½åº†èŠ‚")
            (holiday-fixed 10 2 "å›½åº†èŠ‚")
            (holiday-fixed 10 3 "å›½åº†èŠ‚")
            (holiday-fixed 10 24 "ç¨‹åºå‘˜èŠ‚")
            (holiday-fixed 11 11 "åŒ 11 è´­ç‰©èŠ‚")
            (holiday-fixed 12 25 "åœ£è¯èŠ‚")
            ;; å†œå†èŠ‚æ—¥
            (holiday-lunar 12 30 "æ˜¥èŠ‚" 0)
            (holiday-lunar 1 1 "æ˜¥èŠ‚" 0)
            (holiday-lunar 1 2 "æ˜¥èŠ‚" 0)
            (holiday-lunar 1 15 "å…ƒå®µèŠ‚" 0)
            (holiday-solar-term "æ¸…æ˜" "æ¸…æ˜èŠ‚")
            (holiday-solar-term "å°å¯’" "å°å¯’")
            (holiday-solar-term "å¤§å¯’" "å¤§å¯’")
            (holiday-solar-term "ç«‹æ˜¥" "ç«‹æ˜¥")
            (holiday-solar-term "é›¨æ°´" "é›¨æ°´")
            (holiday-solar-term "æƒŠè›°" "æƒŠè›°")
            (holiday-solar-term "æ˜¥åˆ†" "æ˜¥åˆ†")
            (holiday-solar-term "è°·é›¨" "è°·é›¨")
            (holiday-solar-term "ç«‹å¤" "ç«‹å¤")
            (holiday-solar-term "å°æ»¡" "å°æ»¡")
            (holiday-solar-term "èŠ’ç§" "èŠ’ç§")
            (holiday-solar-term "å¤è‡³" "å¤è‡³")
            (holiday-solar-term "å°æš‘" "å°æš‘")
            (holiday-solar-term "å¤§æš‘" "å¤§æš‘")
            (holiday-solar-term "ç«‹ç§‹" "ç«‹ç§‹")
            (holiday-solar-term "å¤„æš‘" "å¤„æš‘")
            (holiday-solar-term "ç™½éœ²" "ç™½éœ²")
            (holiday-solar-term "ç§‹åˆ†" "ç§‹åˆ†")
            (holiday-solar-term "å¯’éœ²" "å¯’éœ²")
            (holiday-solar-term "éœœé™" "éœœé™")
            (holiday-solar-term "ç«‹å†¬" "ç«‹å†¬")
            (holiday-solar-term "å°é›ª" "å°é›ª")
            (holiday-solar-term "å¤§é›ª" "å¤§é›ª")
            (holiday-solar-term "å†¬è‡³" "å†¬è‡³")
            (holiday-lunar 5 5 "ç«¯åˆèŠ‚" 0)
            (holiday-lunar 8 15 "ä¸­ç§‹èŠ‚" 0)
            (holiday-lunar 7 7 "ä¸ƒå¤•æƒ…äººèŠ‚" 0)
            (holiday-lunar 12 8 "è…Šå…«èŠ‚" 0)
            (holiday-lunar 9 9 "é‡é˜³èŠ‚" 0)))

    ;; è®¾ç½®æ—¥å†çš„èŠ‚æ—¥ï¼Œé€šç”¨èŠ‚æ—¥å·²ç»åŒ…å«äº†æ‰€æœ‰èŠ‚æ—¥
    (setq calendar-holidays (append cal-china-x-general-holidays
                                    cal-china-x-important-holidays
                                    )))

  ;; è‡ªåŠ¨åˆå§‹åŒ– cal-china-x
  (add-hook 'after-init-hook 'cal-china-x-setup)
#+end_src

*** ox-gfm
#+begin_src emacs-lisp

  ;; viewer
  (eval-after-load "org"
    '(require 'ox-gfm nil t))
  (add-to-list 'org-export-backends 'md)
  (add-to-list 'org-export-backends 'gfm)
#+end_src


*** è¡Œé—´è·
#+begin_src emacs-lisp
  ;; å½“ org æ¨¡å—åŠ è½½å®Œæ¯•åè®¾ç½®è¡Œé—´è·
  (with-eval-after-load 'org
    (setq line-spacing 0.25)
    (setq org-list-demote-modify-bullet
          '(("+" . "-") ("-" . "+") ("*" . "+") ("1." . "a."))))
  (font-lock-add-keywords
   'org-mode
   '(("^ +\\([-*]\\) "
      (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "â–»"))))))
#+end_src


*** ç¾åŒ–org
#+begin_src emacs-lisp
  ;; ================================
  ;; åœ¨ org mode é‡Œç¾åŒ–å­—ç¬¦ä¸²
  ;; ================================
  (defun mcg/org-prettify-symbols ()
    (setq prettify-symbols-alist
          (mapcan (lambda (x) (list x (cons (upcase (car x)) (cdr x))))
                  '(
                    ("#+begin_src"      . "â†ª")         ; 21AA 9998
                    ("#+end_src"        . "â†©")         ; 21A9 â–¡ 9633
                    ("#+begin_example"  . 129083)       ; ğŸ »
                    ("#+end_example"    . 129081)       ; ğŸ ¹
                    ("#+results:"       . 9776)         ; â˜°
                    ("#+attr_latex:"    . "ğŸ„›")
                    ("#+attr_html:"     . "ğŸ„—")
                    ("#+attr_org:"      . "ğŸ„")
                    ("#+name:"          . "ğŸ„")         ; 127261
                    ("#+caption:"       . "ğŸ„’")         ; 127250
                    ("#+date:"          . "ğŸ“…")         ; 128197
                    ("#+author:"        . "ğŸ’")         ; 128100
                    ("#+setupfile:"     . 128221)       ; ğŸ“
                    ("#+email:"         . 128231)       ; ğŸ“§
                    ("#+startup:"       . 10034)        ; âœ²
                    ("#+options:"       . 9965)         ; â›­
                    ("#+title:"         . 10162)        ; â²
                    ("#+subtitle:"      . 11146)        ; â®Š
                    ("#+downloaded:"    . 8650)         ; â‡Š
                    ("#+language:"      . 128441)       ; ğŸ–¹
                    ("#+begin_quote"    . 187)          ; Â»
                    ("#+end_quote"      . 171)          ; Â«
                    ("#+begin_results"  . 8943)         ; â‹¯
                    ("#+end_results"    . 8943)         ; â‹¯
                    (":PROPERTIES:"     . "â¥¼")
                    (":HEADER-ARGS:"    . "Ğ­")
                    (":END:"            . "â¥½")
                    )))
    (setq prettify-symbols-unprettify-at-point t)
    (prettify-symbols-mode 1))

  (add-hook 'org-mode-hook 'mcg/org-prettify-symbols)
#+end_src


*** ä¸­è‹±æ–‡å‰åç©ºæ ¼
#+begin_src emacs-lisp
  ;; https://emacs-china.org/t/org-mode/22313?u=vagrantjoker
  ;; è§£å†³ä¸­æ–‡æ ‡è®°å‰åç©ºæ ¼çš„é—®é¢˜
  (font-lock-add-keywords 'org-mode
                          '(("\\cc\\( \\)[/+*_=~][^a-zA-Z0-9]*?[/+*_=~]\\( \\)?\\cc?"
                            (1 (prog1 () (compose-region (match-beginning 1) (match-end 1) ""))))
                            ("\\cc?\\( \\)?[/+*_=~][^a-zA-Z0-9]*?[/+*_=~]\\( \\)\\cc"
                             (2 (prog1 () (compose-region (match-beginning 2) (match-end 2) "")))))
                          'append)

  (with-eval-after-load 'org
    (defun eli-strip-ws-maybe (text _backend _info)
      (let* ((text (replace-regexp-in-string
                    "\\(\\cc\\) *\n *\\(\\cc\\)"
                    "\\1\\2" text));; remove whitespace from line break
             ;; remove whitespace from `org-emphasis-alist'
             (text (replace-regexp-in-string "\\(\\cc\\) \\(.*?\\) \\(\\cc\\)"
                                             "\\1\\2\\3" text))
             ;; restore whitespace between English words and Chinese words
             (text (replace-regexp-in-string "\\(\\cc\\)\\(\\(?:<[^>]+>\\)?[a-z0-9A-Z-]+\\(?:<[^>]+>\\)?\\)\\(\\cc\\)"
                                             "\\1 \\2 \\3" text)))
        text))
    (add-to-list 'org-export-filter-paragraph-functions #'eli-strip-ws-maybe))
#+end_src


** Ends

#+BEGIN_SRC emacs-lisp
(provide 'init-org)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-org.el ends here
#+END_SRC
