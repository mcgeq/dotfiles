#+TITLE: Markdown Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-markdown.el :lexical t

* Markdown Module

本模块负责 MCG Emacs 的 Markdown 编辑支持，包括：
- markdown-mode / markdown-ts-mode 配置
- grip-mode 用于 GitHub 风格的 Markdown 预览
- 语法高亮和编辑增强

** File Header

#+begin_src emacs-lisp
;;; init-markdown.el --- Markdown Configuration for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-markdown.el
;; Description: Markdown editing support module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-10
;; Version: 3.0
;; Keywords: markdown, writing
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Markdown module for MCG Emacs, responsible for:
;; - markdown-mode / markdown-ts-mode configuration
;; - grip-mode for GitHub-flavored markdown preview
;; - Syntax highlighting and editing enhancements
;;
;; Module metadata:
;; :depends ()
;; :defer t
;;
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

(require 'core-lib)
#+end_src

** Variables

Markdown 模块的配置变量。

#+begin_src emacs-lisp
;;; ============================================================
;;; Variables
;;; ============================================================

(defvar mcg-markdown-command "pandoc"
  "Command to use for markdown processing.
Pandoc is recommended for full-featured markdown support.")

(defvar mcg-markdown-preview-port 6419
  "Port for grip-mode preview server.")

(defvar mcg-markdown-enable-math t
  "Whether to enable math support in markdown.")

(defvar mcg-markdown-enable-wiki-links t
  "Whether to enable wiki-style links in markdown.")
#+end_src

** markdown-mode Configuration

markdown-mode 的配置，包括文件关联、语法高亮和编辑设置。

#+begin_src emacs-lisp
;;; ============================================================
;;; markdown-mode Configuration
;;; ============================================================

(defun mcg-markdown-mode-setup ()
  "Setup function for markdown-mode."
  ;; Basic settings
  (setq-local fill-column 80)
  (setq-local indent-tabs-mode nil)
  (setq-local tab-width 2)
  
  ;; Enable visual line mode for better text wrapping
  (visual-line-mode 1)
  
  ;; Enable flyspell for spell checking
  (when (executable-find "aspell")
    (flyspell-mode 1))
  
  (mcg-log "Markdown mode setup complete"))

(defun mcg--setup-markdown-mode ()
  "Setup markdown-mode configuration."
  (when (mcg-require-extension "markdown-mode" t)
    ;; File associations
    (add-to-list 'auto-mode-alist '("\\.md\\'" . markdown-mode))
    (add-to-list 'auto-mode-alist '("\\.markdown\\'" . markdown-mode))
    (add-to-list 'auto-mode-alist '("README\\.md\\'" . gfm-mode))
    
    ;; Markdown command for preview/export
    (when (executable-find mcg-markdown-command)
      (setq markdown-command mcg-markdown-command))
    
    ;; Enable math support
    (when mcg-markdown-enable-math
      (setq markdown-enable-math t))
    
    ;; Enable wiki links
    (when mcg-markdown-enable-wiki-links
      (setq markdown-enable-wiki-links t))
    
    ;; Fontification settings
    (setq markdown-fontify-code-blocks-natively t)
    (setq markdown-header-scaling t)
    (setq markdown-hide-urls nil)
    
    ;; Indentation
    (setq markdown-indent-on-enter 'indent-and-new-item)
    
    ;; List settings
    (setq markdown-list-indent-width 2)
    
    ;; Code block settings
    (setq markdown-code-lang-modes
          '(("elisp" . emacs-lisp-mode)
            ("emacs-lisp" . emacs-lisp-mode)
            ("python" . python-mode)
            ("py" . python-mode)
            ("javascript" . js-mode)
            ("js" . js-mode)
            ("typescript" . typescript-ts-mode)
            ("ts" . typescript-ts-mode)
            ("rust" . rust-mode)
            ("rs" . rust-mode)
            ("c" . c-mode)
            ("cpp" . c++-mode)
            ("c++" . c++-mode)
            ("lua" . lua-mode)
            ("shell" . sh-mode)
            ("bash" . sh-mode)
            ("sh" . sh-mode)
            ("json" . json-mode)
            ("yaml" . yaml-mode)
            ("html" . html-mode)
            ("css" . css-mode)))
    
    ;; Mode hook
    (add-hook 'markdown-mode-hook #'mcg-markdown-mode-setup)
    (add-hook 'gfm-mode-hook #'mcg-markdown-mode-setup)
    
    (mcg-log "markdown-mode configured")))
#+end_src

** markdown-ts-mode Configuration (Emacs 29+)

基于 tree-sitter 的 markdown-ts-mode 配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; markdown-ts-mode Configuration (Emacs 29+)
;;; ============================================================

(defun mcg--setup-markdown-ts-mode ()
  "Setup markdown-ts-mode for tree-sitter based highlighting."
  (when (and (fboundp 'treesit-available-p)
             (treesit-available-p)
             (mcg-require-extension "markdown-ts-mode" t))
    ;; Use markdown-ts-mode when tree-sitter is available
    ;; Note: markdown-ts-mode may override markdown-mode associations
    (add-hook 'markdown-ts-mode-hook #'mcg-markdown-mode-setup)
    (mcg-log "markdown-ts-mode configured")))
#+end_src

** grip-mode Configuration

grip-mode 配置，用于 GitHub 风格的 Markdown 预览。

#+begin_src emacs-lisp
;;; ============================================================
;;; grip-mode Configuration
;;; ============================================================

(defun mcg--setup-grip-mode ()
  "Setup grip-mode for GitHub-flavored markdown preview.
Grip renders markdown using GitHub's API for accurate preview."
  (when (mcg-require-extension "grip-mode" t)
    ;; Use GitHub API for rendering (requires grip: pip install grip)
    (setq grip-preview-use-webkit nil)  ; Use external browser
    
    ;; Custom port
    (setq grip-preview-port mcg-markdown-preview-port)
    
    ;; Auto-refresh on save
    (setq grip-update-after-change nil)  ; Manual refresh for performance
    
    ;; Keybinding for preview
    (with-eval-after-load 'markdown-mode
      (define-key markdown-mode-map (kbd "C-c C-c p") #'grip-mode)
      (define-key markdown-mode-map (kbd "C-c C-c g") #'grip-browse-preview))
    
    (with-eval-after-load 'gfm-mode
      (when (boundp 'gfm-mode-map)
        (define-key gfm-mode-map (kbd "C-c C-c p") #'grip-mode)
        (define-key gfm-mode-map (kbd "C-c C-c g") #'grip-browse-preview)))
    
    (mcg-log "grip-mode configured")))
#+end_src

** Markdown Commands

Markdown 相关的交互命令。

#+begin_src emacs-lisp
;;; ============================================================
;;; Markdown Commands
;;; ============================================================

(defun mcg/markdown-preview ()
  "Preview current markdown file.
Uses grip-mode if available, otherwise falls back to markdown-preview."
  (interactive)
  (if (fboundp 'grip-mode)
      (grip-mode 1)
    (when (fboundp 'markdown-preview)
      (markdown-preview))))

(defun mcg/markdown-export-html ()
  "Export current markdown file to HTML."
  (interactive)
  (when (fboundp 'markdown-export)
    (markdown-export)))

(defun mcg/markdown-insert-link ()
  "Insert a markdown link."
  (interactive)
  (when (fboundp 'markdown-insert-link)
    (markdown-insert-link)))

(defun mcg/markdown-insert-image ()
  "Insert a markdown image."
  (interactive)
  (when (fboundp 'markdown-insert-image)
    (markdown-insert-image)))

(defun mcg/markdown-insert-code-block ()
  "Insert a fenced code block."
  (interactive)
  (when (fboundp 'markdown-insert-gfm-code-block)
    (markdown-insert-gfm-code-block nil)))

(defun mcg/markdown-toggle-markup-hiding ()
  "Toggle markup hiding in markdown."
  (interactive)
  (when (fboundp 'markdown-toggle-markup-hiding)
    (markdown-toggle-markup-hiding)))
#+end_src

** Markdown Keybindings

Markdown 模式的快捷键配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; Markdown Keybindings
;;; ============================================================

(defun mcg-markdown-setup-keybindings ()
  "Setup markdown-specific keybindings."
  (when (boundp 'markdown-mode-map)
    ;; Preview
    (define-key markdown-mode-map (kbd "C-c C-c p") #'mcg/markdown-preview)
    (define-key markdown-mode-map (kbd "C-c C-c e") #'mcg/markdown-export-html)
    ;; Insert
    (define-key markdown-mode-map (kbd "C-c C-l") #'mcg/markdown-insert-link)
    (define-key markdown-mode-map (kbd "C-c C-i") #'mcg/markdown-insert-image)
    (define-key markdown-mode-map (kbd "C-c C-s c") #'mcg/markdown-insert-code-block)
    ;; Toggle
    (define-key markdown-mode-map (kbd "C-c C-x C-m") #'mcg/markdown-toggle-markup-hiding)))

(with-eval-after-load 'markdown-mode
  (mcg-markdown-setup-keybindings))
#+end_src

** Help Command

Markdown 帮助命令，显示快捷键和使用说明。

#+begin_src emacs-lisp
;;; ============================================================
;;; Help Command
;;; ============================================================

(defun mcg/markdown-help ()
  "Show Markdown keybindings and command help."
  (interactive)
  (with-help-window "*MCG Markdown Help*"
    (princ "
╔═══════════════════════════════════════════╗
║       MCG Markdown Keybindings            ║
╚═══════════════════════════════════════════╝

PREVIEW & EXPORT:
  C-c C-c p    - Preview with grip-mode
  C-c C-c g    - Browse grip preview
  C-c C-c e    - Export to HTML

INSERT:
  C-c C-l      - Insert link
  C-c C-i      - Insert image
  C-c C-s c    - Insert code block

TOGGLE:
  C-c C-x C-m  - Toggle markup hiding

NAVIGATION:
  C-c C-n      - Next heading
  C-c C-p      - Previous heading
  C-c C-u      - Up to parent heading

FORMATTING:
  C-c C-s b    - Bold
  C-c C-s i    - Italic
  C-c C-s c    - Code
  C-c C-s q    - Blockquote

═══════════════════════════════════════════

INSTALLATION:
  pip install grip    (for GitHub preview)
  Install pandoc      (for export)

═══════════════════════════════════════════
")))
#+end_src

** Initialize

初始化 Markdown 模块。

#+begin_src emacs-lisp
;;; ============================================================
;;; Initialize
;;; ============================================================

(mcg--setup-markdown-mode)
(mcg--setup-markdown-ts-mode)
(mcg--setup-grip-mode)
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-markdown)
;;; init-markdown.el ends here
#+end_src
