#+TITLE: Vale Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-vale.el :lexical t

* Vale Module

本模块负责 MCG Emacs 的 Vale 语法和风格检查，包括：
- flymake-vale 集成用于语法和风格检查
- 支持 markdown、org 和文本文件的散文检查

Vale 是一个语法感知的散文检查工具，支持多种风格指南（Microsoft、Google、write-good 等）。

** File Header

#+begin_src emacs-lisp
;;; init-vale.el --- Vale Grammar Checking for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-vale.el
;; Description: Vale grammar and style checking module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-10
;; Version: 3.0
;; Keywords: vale, grammar, writing, flymake
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Vale module for MCG Emacs, responsible for:
;; - flymake-vale integration for grammar and style checking
;; - Support for prose linting in markdown, org, and text files
;;
;; Vale is a syntax-aware linter for prose that supports multiple
;; style guides (Microsoft, Google, write-good, etc.)
;;
;; Module metadata:
;; :depends ()
;; :defer t
;;
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

(require 'core-lib)
#+end_src

** Variables

Vale 模块的配置变量。

#+begin_src emacs-lisp
;;; ============================================================
;;; Variables
;;; ============================================================

(defvar mcg-vale-enabled-modes
  '(markdown-mode gfm-mode org-mode text-mode)
  "List of major modes where Vale checking should be enabled.")

(defvar mcg-vale-config-file ".vale.ini"
  "Name of the Vale configuration file to look for.")

(defvar mcg-vale-styles-path nil
  "Path to Vale styles directory.
If nil, Vale will use its default location.")
#+end_src

** Vale Availability Check

检查 Vale 是否可用的函数。

#+begin_src emacs-lisp
;;; ============================================================
;;; Vale Availability Check
;;; ============================================================

(defun mcg-vale-available-p ()
  "Check if Vale is available on the system."
  (executable-find "vale"))

(defun mcg-vale-config-exists-p ()
  "Check if a Vale configuration file exists in the project or home directory."
  (or (locate-dominating-file default-directory mcg-vale-config-file)
      (file-exists-p (expand-file-name mcg-vale-config-file "~"))))
#+end_src

** flymake-vale Configuration

flymake-vale 配置，用于语法检查。

#+begin_src emacs-lisp
;;; ============================================================
;;; flymake-vale Configuration
;;; ============================================================

(defun mcg--setup-flymake-vale ()
  "Setup flymake-vale for grammar checking.
Vale provides prose linting with support for multiple style guides."
  (when (mcg-require-extension "flymake-vale" t)
    ;; Only enable if Vale is installed
    (if (mcg-vale-available-p)
        (progn
          ;; Enable flymake-vale in supported modes
          (dolist (mode mcg-vale-enabled-modes)
            (let ((hook (intern (concat (symbol-name mode) "-hook"))))
              (add-hook hook #'mcg-vale-maybe-enable)))
          
          (mcg-log "flymake-vale configured"))
      (mcg-log-warning "Vale not found. Install with: brew install vale (macOS) or scoop install vale (Windows)"))))

(defun mcg-vale-maybe-enable ()
  "Enable flymake-vale if conditions are met.
Checks for Vale availability and configuration file presence."
  (when (and (mcg-vale-available-p)
             (mcg-vale-config-exists-p))
    (flymake-vale-load)
    (flymake-mode 1)
    (mcg-log "Vale enabled for %s" (buffer-name))))
#+end_src

** Vale Commands

Vale 相关的交互命令。

#+begin_src emacs-lisp
;;; ============================================================
;;; Vale Commands
;;; ============================================================

(defun mcg/vale-check-buffer ()
  "Run Vale check on the current buffer."
  (interactive)
  (if (mcg-vale-available-p)
      (let ((file (buffer-file-name)))
        (if file
            (progn
              (save-buffer)
              (compile (format "vale %s" (shell-quote-argument file))))
          (message "Buffer is not visiting a file")))
    (message "Vale not found. Install with: brew install vale (macOS) or scoop install vale (Windows)")))

(defun mcg/vale-check-project ()
  "Run Vale check on the entire project."
  (interactive)
  (if (mcg-vale-available-p)
      (let ((default-directory (or (when (project-current)
                                     (project-root (project-current)))
                                   default-directory)))
        (compile "vale ."))
    (message "Vale not found. Install with: brew install vale (macOS) or scoop install vale (Windows)")))

(defun mcg/vale-init ()
  "Initialize Vale configuration in the current project."
  (interactive)
  (if (mcg-vale-available-p)
      (let ((config-file (expand-file-name mcg-vale-config-file
                                           (or (when (project-current)
                                                 (project-root (project-current)))
                                               default-directory))))
        (if (file-exists-p config-file)
            (find-file config-file)
          (with-temp-file config-file
            (insert "# Vale configuration file
# See: https://vale.sh/docs/topics/config/

StylesPath = styles

MinAlertLevel = suggestion

# File associations
[*.md]
BasedOnStyles = Vale

[*.org]
BasedOnStyles = Vale

[*.txt]
BasedOnStyles = Vale
"))
          (find-file config-file)
          (message "Created Vale configuration: %s" config-file)))
    (message "Vale not found. Install with: brew install vale (macOS) or scoop install vale (Windows)")))

(defun mcg/vale-sync ()
  "Sync Vale packages/styles."
  (interactive)
  (if (mcg-vale-available-p)
      (compile "vale sync")
    (message "Vale not found. Install with: brew install vale (macOS) or scoop install vale (Windows)")))

(defun mcg/vale-toggle ()
  "Toggle Vale checking in the current buffer."
  (interactive)
  (if flymake-mode
      (progn
        (flymake-mode -1)
        (message "Vale checking disabled"))
    (mcg-vale-maybe-enable)
    (message "Vale checking enabled")))
#+end_src

** Vale Keybindings

Vale 模式的快捷键配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; Vale Keybindings
;;; ============================================================

(defvar mcg-vale-mode-map
  (let ((map (make-sparse-keymap)))
    (define-key map (kbd "C-c v c") #'mcg/vale-check-buffer)
    (define-key map (kbd "C-c v p") #'mcg/vale-check-project)
    (define-key map (kbd "C-c v i") #'mcg/vale-init)
    (define-key map (kbd "C-c v s") #'mcg/vale-sync)
    (define-key map (kbd "C-c v t") #'mcg/vale-toggle)
    map)
  "Keymap for Vale commands.")

(defun mcg-vale-setup-keybindings ()
  "Setup Vale keybindings in the current buffer."
  (use-local-map (make-composed-keymap mcg-vale-mode-map (current-local-map))))

;; Add keybindings to supported modes
(dolist (mode mcg-vale-enabled-modes)
  (let ((hook (intern (concat (symbol-name mode) "-hook"))))
    (add-hook hook #'mcg-vale-setup-keybindings)))
#+end_src

** Flymake Integration

Flymake 集成，用于错误导航。

#+begin_src emacs-lisp
;;; ============================================================
;;; Flymake Integration
;;; ============================================================

(defun mcg/flymake-goto-next-error ()
  "Go to next Flymake error."
  (interactive)
  (flymake-goto-next-error))

(defun mcg/flymake-goto-prev-error ()
  "Go to previous Flymake error."
  (interactive)
  (flymake-goto-prev-error))

(defun mcg/flymake-show-diagnostics ()
  "Show Flymake diagnostics buffer."
  (interactive)
  (flymake-show-diagnostics-buffer))

;; Global flymake navigation keybindings
(with-eval-after-load 'flymake
  (define-key flymake-mode-map (kbd "M-n") #'mcg/flymake-goto-next-error)
  (define-key flymake-mode-map (kbd "M-p") #'mcg/flymake-goto-prev-error)
  (define-key flymake-mode-map (kbd "C-c ! l") #'mcg/flymake-show-diagnostics))
#+end_src

** Help Command

Vale 帮助命令，显示快捷键和使用说明。

#+begin_src emacs-lisp
;;; ============================================================
;;; Help Command
;;; ============================================================

(defun mcg/vale-help ()
  "Show Vale keybindings and command help."
  (interactive)
  (with-help-window "*MCG Vale Help*"
    (princ "
╔═══════════════════════════════════════════╗
║       MCG Vale Keybindings                ║
╚═══════════════════════════════════════════╝

VALE COMMANDS:
  C-c v c      - Check current buffer
  C-c v p      - Check entire project
  C-c v i      - Initialize Vale config
  C-c v s      - Sync Vale packages
  C-c v t      - Toggle Vale checking

FLYMAKE NAVIGATION:
  M-n          - Next error
  M-p          - Previous error
  C-c ! l      - Show diagnostics buffer

═══════════════════════════════════════════

INSTALLATION:

macOS:
  brew install vale

Windows:
  scoop install vale
  or
  choco install vale

Linux:
  Download from https://vale.sh/

CONFIGURATION:

1. Create .vale.ini in project root:
   M-x mcg/vale-init

2. Add style packages to .vale.ini:
   StylesPath = styles
   [*.md]
   BasedOnStyles = Vale, write-good

3. Sync packages:
   M-x mcg/vale-sync

═══════════════════════════════════════════
")))
#+end_src

** Initialize

初始化 Vale 模块。

#+begin_src emacs-lisp
;;; ============================================================
;;; Initialize
;;; ============================================================

(mcg--setup-flymake-vale)
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-vale)
;;; init-vale.el ends here
#+end_src
