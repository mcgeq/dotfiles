* init-vertico.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-vertico.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; init-vertico.el --- Completion System for MCG Emacs -*- lexical-binding: t; -*-

  ;; Filename: init-vertico.el
  ;; Description: Completion system module (Vertico + Marginalia + Embark + Consult + Orderless)
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024-2026, mcge, all rights reserved.
  ;; Create   Date: 2026-01-07
  ;; Version: 3.0
  ;; Keywords: completion, vertico, marginalia, embark, consult, orderless
  ;; Compatibility: GNU Emacs 29.0+

  ;;; Commentary:
  ;;
  ;; Completion system module for MCG Emacs, responsible for:
  ;; - Vertico vertical completion interface
  ;; - Marginalia candidate annotations
  ;; - Embark contextual actions
  ;; - Consult consulting search commands
  ;; - Orderless fuzzy matching
  ;; - Pinyin support (Chinese)
  ;;
  ;; Module metadata:
  ;; :depends ()
  ;; :defer nil
  ;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)
(require 'crm)

#+END_SRC

** Variables
#+BEGIN_SRC emacs-lisp
;;; Variables

(defvar mcg-completion-vertico-count 15
  "Number of candidates displayed by Vertico.")

(defvar mcg-completion-enable-pinyin t
  "Whether to enable pinyin completion.")

(defvar mcg-completion-preview-key 'any
  "Consult preview trigger key.
Options: 'any, nil, or specific key.")

#+END_SRC

** Orderless Configuration
#+BEGIN_SRC emacs-lisp
;;; Orderless Configuration

(defun mcg--setup-orderless ()
  "Setup Orderless fuzzy matching engine."
  (when (mcg-require-extension "completion/orderless" 'orderless)
    ;; Core completion styles
    (setq completion-styles '(orderless partial-completion basic)
          completion-category-defaults nil)
    
    ;; Component separator (space or &)
    (setq orderless-component-separator "[ &]")
    
    ;; File completion uses partial-completion style
    (setq completion-category-overrides
          '((file (styles partial-completion))
            (buffer (styles orderless))
            (info-menu (styles orderless))))
    
    ;; Matching styles
    (setq orderless-matching-styles
          '(orderless-literal
            orderless-regexp
            orderless-initialism))
    
    ;; Style dispatchers (! negation, = literal, ~ flex)
    (setq orderless-style-dispatchers
          '(orderless-affix-dispatch))
    
    (mcg-log "Orderless configured")))

#+END_SRC

** Pinyin Support
#+BEGIN_SRC emacs-lisp
;;; Pinyin Support (Chinese)

(defun mcg--setup-pinyin ()
  "Setup pinyin completion support."
  (when (and mcg-completion-enable-pinyin
             (mcg-require-extension "completion/pinyinlib" 'pinyinlib))
    
    (defun mcg/completion-regex-pinyin (str)
      "Pinyin match STR."
      (orderless-regexp (pinyinlib-build-regexp-string str)))
    
    ;; Add pinyin matching to orderless styles
    (add-to-list 'orderless-matching-styles 'mcg/completion-regex-pinyin)
    
    (mcg-log "Pinyin completion enabled")))

(defun mcg/toggle-pinyin-completion ()
  "Toggle pinyin completion."
  (interactive)
  (if (member 'mcg/completion-regex-pinyin orderless-matching-styles)
      (progn
        (setq orderless-matching-styles
              (remove 'mcg/completion-regex-pinyin orderless-matching-styles))
        (message "Pinyin completion disabled"))
    (add-to-list 'orderless-matching-styles 'mcg/completion-regex-pinyin)
    (message "Pinyin completion enabled")))

#+END_SRC

** Vertico Configuration
#+BEGIN_SRC emacs-lisp
;;; Vertico Configuration

(defun mcg--setup-vertico ()
  "Setup Vertico vertical completion interface."
  (when (mcg-require-extension "completion/vertico" 'vertico)
    ;; Display settings
    (setq vertico-count mcg-completion-vertico-count)
    (setq vertico-resize nil)              ; Fixed height
    (setq vertico-cycle t)                 ; Enable cycling (top <-> bottom)
    (setq vertico-scroll-margin 2)         ; Scroll margin
    
    ;; Enable vertico-mode
    (vertico-mode 1)
    
    ;; Load vertico-directory extension
    (require 'vertico-directory nil t)
    
    ;; Load vertico-sort extension and set history sorting
    (when (require 'vertico-sort nil t)
      (setq vertico-sort-function #'vertico-sort-history-length-alpha))
    
    (mcg-log "Vertico configured")))

(defun mcg--setup-vertico-keybindings ()
  "Setup Vertico keybindings."
  (when (and (featurep 'vertico) (boundp 'vertico-map))
    (define-key vertico-map (kbd "<tab>") #'vertico-insert)
    (define-key vertico-map (kbd "<escape>") #'vertico-exit)
    (define-key vertico-map (kbd "RET") #'vertico-exit)
    (define-key vertico-map (kbd "C-M-n") #'vertico-next-group)
    (define-key vertico-map (kbd "C-M-p") #'vertico-previous-group)
    (define-key vertico-map (kbd "M-<") #'vertico-first)
    (define-key vertico-map (kbd "M->") #'vertico-last)
    
    ;; vertico-directory 键绑定
    (when (featurep 'vertico-directory)
      (define-key vertico-map (kbd "DEL") #'vertico-directory-delete-char))))

#+END_SRC

** Marginalia Configuration
#+BEGIN_SRC emacs-lisp
;;; Marginalia Configuration

(defun mcg--setup-marginalia ()
  "Setup Marginalia candidate annotations."
  (when (mcg-require-extension "completion/marginalia" 'marginalia)
    ;; Alignment settings
    (setq marginalia-align 'right)
    (setq marginalia-align-offset 0)
    
    ;; Relative time display
    (setq marginalia-max-relative-age 3600)
    
    ;; Enable marginalia-mode
    (marginalia-mode 1)
    
    ;; Keybinding for cycling annotation levels
    (define-key minibuffer-local-map (kbd "M-A") #'marginalia-cycle)
    
    (mcg-log "Marginalia configured")))

(defun mcg/toggle-marginalia ()
  "Toggle Marginalia mode."
  (interactive)
  (if marginalia-mode
      (progn
        (marginalia-mode -1)
        (message "Marginalia disabled"))
    (marginalia-mode 1)
    (message "Marginalia enabled")))

#+END_SRC

** Consult Configuration
#+BEGIN_SRC emacs-lisp
;;; Consult Configuration

(defun mcg--setup-consult ()
  "Setup Consult consulting search commands."
  (when (mcg-require-extension "completion/consult" 'consult)
    ;; Preview configuration
    (setq consult-preview-key mcg-completion-preview-key)
    (setq consult-narrow-key "<")
    (setq consult-widen-key ">")
    
    ;; Preview limits
    (setq consult-preview-max-size 10485760)  ; 10 MB
    (setq consult-preview-max-count 10)
    
    ;; Async command configuration
    (setq consult-async-refresh-delay 0.15)
    (setq consult-async-input-throttle 0.2)
    (setq consult-async-input-debounce 0.1)
    
    ;; Register integration
    (setq register-preview-delay 0.5
          register-preview-function #'consult-register-format)
    (advice-add #'register-preview :override #'consult-register-window)
    
    ;; Xref integration
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)
    
    ;; Buffer filter
    (setq consult-buffer-filter
          '("\\` "
            "\\`\\*Completions\\*\\'"
            "\\`\\*Flymake log\\*\\'"
            "\\`\\*Semantic SymRef\\*\\'"
            "\\`\\*tramp/.*\\*\\'"))
    
    ;; Windows UTF-8 configuration
    (when (eq system-type 'windows-nt)
      (setq locale-coding-system 'utf-8)
      (set-default-coding-systems 'utf-8)
      (prefer-coding-system 'utf-8)
      (setq process-coding-system-alist
            (append '(("grep" . (utf-8 . utf-8))
                      ("rg" . (utf-8 . utf-8)))
                    process-coding-system-alist)))
    
    (mcg-log "Consult configured")))

(defun mcg--setup-consult-keybindings ()
  "Setup Consult keybindings."
  (when (featurep 'consult)
    ;; Programming mode keybindings
    (with-eval-after-load 'prog-mode
      (define-key prog-mode-map (kbd "C-c C-j") #'consult-outline)
      (define-key prog-mode-map (kbd "C-c C-i") #'consult-imenu))
    
    ;; Minibuffer history
    (define-key minibuffer-local-map (kbd "C-r") #'consult-history)
    
    ;; Enable completion list preview
    (add-hook 'completion-list-mode-hook #'consult-preview-at-point-mode)))

#+END_SRC

** Consult Custom Functions
#+BEGIN_SRC emacs-lisp
;;; Consult Custom Functions

(defun mcg/consult-line-symbol-at-point ()
  "Search for symbol at point in current buffer."
  (interactive)
  (consult-line (thing-at-point 'symbol)))

(defun mcg/consult-find-org-headings (&optional match)
  "Find headings in all org files.
MATCH is an optional match condition."
  (interactive)
  (when (and (boundp 'org-directory) org-directory)
    (consult-org-heading
     match
     (directory-files org-directory t "^[0-9]\\{8\\}.+\\.org$"))))

#+END_SRC

** Embark Configuration
#+BEGIN_SRC emacs-lisp
;;; Embark Configuration

(defun mcg--setup-embark ()
  "Setup Embark contextual actions."
  (when (mcg-require-extension "completion/embark" 'embark)
    ;; Action behavior
    (setq embark-quit-after-action nil)
    (setq embark-confirm-act-all nil)
    
    ;; Indicator settings
    (setq embark-indicators
          '(embark-minimal-indicator
            embark-highlight-indicator
            embark-isearch-highlight-indicator))
    
    ;; Action keys
    (setq embark-cycle-key ".")
    (setq embark-help-key "?")
    (setq embark-action-indicator t)
    
    ;; Use embark as prefix help
    (setq prefix-help-command #'embark-prefix-help-command)
    
    ;; Use sorted candidates
    (setq embark-candidate-collectors
          (cl-substitute 'embark-sorted-minibuffer-candidates
                         'embark-minibuffer-candidates
                         embark-candidate-collectors))
    
    ;; Embark Collect display configuration
    (add-to-list 'display-buffer-alist
                 '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                   nil
                   (window-parameters (mode-line-format . none))))
    
    ;; Embark Collect settings
    (setq embark-collect-live-initial-delay 0.15)
    (setq embark-collect-live-update-delay 0.15)
    
    (mcg-log "Embark configured")))

(defun mcg--setup-embark-consult ()
  "Setup Embark-Consult integration."
  (when (and (featurep 'embark) (featurep 'consult))
    (require 'embark-consult nil t)
    ;; Enable consult preview in embark collect
    (add-hook 'embark-collect-mode-hook #'consult-preview-at-point-mode)
    (mcg-log "Embark-Consult integration configured")))

#+END_SRC

** Embark Custom Actions
#+BEGIN_SRC emacs-lisp
;;; Embark Custom Actions

(defun mcg/embark-open-externally (&optional arg)
  "Open ARG marked or current file with system default application."
  (interactive "P")
  (when (featurep 'dired)
    (require 'dired)
    (dired-map-over-marks
     (embark-open-externally (dired-get-filename))
     arg)))

#+END_SRC

** Minibuffer Enhancement
#+BEGIN_SRC emacs-lisp
;;; Minibuffer Enhancement

(defun mcg--setup-minibuffer ()
  "Setup Minibuffer enhancements."
  ;; CRM indicator
  (defun mcg/crm-indicator (args)
    "Add CRM indicator to ARGS."
    (cons (format "[CRM%s] %s"
                  (replace-regexp-in-string
                   "\\`\\[.*?]\\*\\|\\[.*?]\\*\\'" ""
                   crm-separator)
                  (car args))
          (cdr args)))
  (advice-add #'completing-read-multiple :filter-args #'mcg/crm-indicator)
  
  ;; Prevent cursor from entering minibuffer prompt
  (setq minibuffer-prompt-properties
        '(read-only t cursor-intangible t face minibuffer-prompt))
  (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)
  
  ;; Enable recursive minibuffer
  (setq enable-recursive-minibuffers t)
  
  ;; Show recursion depth
  (minibuffer-depth-indicate-mode 1)
  
  (mcg-log "Minibuffer enhancements configured"))

#+END_SRC

** Performance Tuning
#+BEGIN_SRC emacs-lisp
;;; Performance Tuning

(defun mcg--setup-completion-performance ()
  "Setup completion performance optimization."
  ;; Increase GC threshold in minibuffer
  (defun mcg/minibuffer-setup-hook ()
    "Increase GC threshold in minibuffer."
    (setq gc-cons-threshold most-positive-fixnum))
  
  (defun mcg/minibuffer-exit-hook ()
    "Restore GC threshold after exiting minibuffer."
    (setq gc-cons-threshold 800000))
  
  (add-hook 'minibuffer-setup-hook #'mcg/minibuffer-setup-hook)
  (add-hook 'minibuffer-exit-hook #'mcg/minibuffer-exit-hook)
  
  (mcg-log "Completion performance tuning configured"))

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

;; Setup components in order
(mcg--setup-orderless)
(mcg--setup-pinyin)
(mcg--setup-vertico)
(mcg--setup-vertico-keybindings)
(mcg--setup-marginalia)
(mcg--setup-consult)
(mcg--setup-consult-keybindings)
(mcg--setup-embark)
(mcg--setup-embark-consult)
(mcg--setup-minibuffer)
(mcg--setup-completion-performance)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-vertico)
;;; init-vertico.el ends here
#+END_SRC
