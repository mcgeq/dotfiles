#+TITLE: Rust Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-rust.el :lexical t

* Rust Module

本模块负责 MCG Emacs 的 Rust 语言支持，包括：
- rust-mode / rust-ts-mode 配置
- rust-analyzer LSP 集成（通过 lsp-bridge）
- Cargo 集成
- 使用 rustfmt 保存时格式化

** File Header

#+begin_src emacs-lisp
;;; init-rust.el --- Rust language support for MCG Emacs -*- lexical-binding: t; -*-

;; Copyright (C) 2024-2026 MCG
;; Author: mcge <mcgeq@outlook.com>
;; Keywords: languages, rust
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;; Rust language support module for MCG Emacs:
;; - rust-mode / rust-ts-mode configuration
;; - rust-analyzer LSP integration (via lsp-bridge)
;; - Cargo integration
;; - Format on save with rustfmt
;;
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

(require 'core-lib)
#+end_src

** Variables

Rust 模块的配置变量。

#+begin_src emacs-lisp
;;; ============================================================
;;; Variables
;;; ============================================================

(defvar mcg-rust-format-on-save t
  "Whether to format Rust files on save using rustfmt.")

(defvar mcg-rust-clippy-on-save nil
  "Whether to run clippy on save.")
#+end_src

** rust-mode / rust-ts-mode Configuration

rust-mode 和 rust-ts-mode 的配置，包括缩进、子词模式和电气配对。

#+begin_src emacs-lisp
;;; ============================================================
;;; rust-mode / rust-ts-mode Configuration
;;; ============================================================

(defun mcg-rust-mode-setup ()
  "Setup function for rust-mode and rust-ts-mode."
  ;; Indentation
  (setq-local indent-tabs-mode nil)
  (setq-local tab-width 4)
  
  ;; Enable subword mode for CamelCase navigation
  (subword-mode 1)
  
  ;; Electric pair for angle brackets
  (setq-local electric-pair-pairs
              (append electric-pair-pairs '((?< . ?>))))
  
  (mcg-log "Rust mode setup complete"))

;; Setup Rust mode hooks (auto-mode-alist is managed in init-treesit.el)
(mcg-deflang rust
  :ts-mode rust-ts-mode
  :fallback-mode rust-mode
  :setup-fn mcg-rust-mode-setup)

;; rust-mode specific settings (loaded after rust-mode)
(with-eval-after-load 'rust-mode
  (setq rust-format-on-save mcg-rust-format-on-save)
  (setq rust-format-show-buffer nil)
  (setq rust-format-goto-problem t))
#+end_src

** Cargo Integration

Cargo 命令集成，提供构建、运行、测试等功能。

#+begin_src emacs-lisp
;;; ============================================================
;;; Cargo Integration
;;; ============================================================

(defun mcg/cargo-build ()
  "Run cargo build."
  (interactive)
  (compile "cargo build"))

(defun mcg/cargo-run ()
  "Run cargo run."
  (interactive)
  (compile "cargo run"))

(defun mcg/cargo-test ()
  "Run cargo test."
  (interactive)
  (compile "cargo test"))

(defun mcg/cargo-check ()
  "Run cargo check."
  (interactive)
  (compile "cargo check"))

(defun mcg/cargo-clippy ()
  "Run cargo clippy."
  (interactive)
  (compile "cargo clippy"))

(defun mcg/cargo-fmt ()
  "Run cargo fmt."
  (interactive)
  (let ((default-directory (or (locate-dominating-file default-directory "Cargo.toml")
                               default-directory)))
    (shell-command "cargo fmt")
    (revert-buffer t t t)
    (message "Formatted with cargo fmt")))

(defun mcg/cargo-doc ()
  "Run cargo doc --open."
  (interactive)
  (compile "cargo doc --open"))

(defun mcg/cargo-add (crate)
  "Add CRATE to Cargo.toml."
  (interactive "sCrate name: ")
  (compile (format "cargo add %s" crate)))
#+end_src

** Rust Keybindings

Rust 模式的快捷键配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; Rust Keybindings
;;; ============================================================

(defvar mcg-rust-mode-map
  (let ((map (make-sparse-keymap)))
    ;; Cargo commands
    (define-key map (kbd "C-c C-c C-b") #'mcg/cargo-build)
    (define-key map (kbd "C-c C-c C-r") #'mcg/cargo-run)
    (define-key map (kbd "C-c C-c C-t") #'mcg/cargo-test)
    (define-key map (kbd "C-c C-c C-k") #'mcg/cargo-check)
    (define-key map (kbd "C-c C-c C-l") #'mcg/cargo-clippy)
    (define-key map (kbd "C-c C-c C-f") #'mcg/cargo-fmt)
    (define-key map (kbd "C-c C-c C-d") #'mcg/cargo-doc)
    (define-key map (kbd "C-c C-c C-a") #'mcg/cargo-add)
    map)
  "Keymap for Rust-specific commands.")

(defun mcg-rust-setup-keybindings ()
  "Setup Rust-specific keybindings."
  (use-local-map (make-composed-keymap mcg-rust-mode-map (current-local-map))))

;; Keybindings setup via hooks
(with-eval-after-load 'rust-mode
  (add-hook 'rust-mode-hook #'mcg-rust-setup-keybindings))
(when (mcg-treesit-available-p)
  (add-hook 'rust-ts-mode-hook #'mcg-rust-setup-keybindings))
#+end_src

** Help Command

Rust 帮助命令，显示快捷键和使用说明。

#+begin_src emacs-lisp
;;; ============================================================
;;; Help Command
;;; ============================================================

(defun mcg/rust-help ()
  "Show Rust keybindings and command help."
  (interactive)
  (with-help-window "*MCG Rust Help*"
    (princ "
╔═══════════════════════════════════════════╗
║       MCG Rust Keybindings                ║
╚═══════════════════════════════════════════╝

CARGO COMMANDS:
  C-c C-c C-b  - cargo build
  C-c C-c C-r  - cargo run
  C-c C-c C-t  - cargo test
  C-c C-c C-k  - cargo check
  C-c C-c C-l  - cargo clippy
  C-c C-c C-f  - cargo fmt
  C-c C-c C-d  - cargo doc --open
  C-c C-c C-a  - cargo add <crate>

LSP COMMANDS (via lsp-bridge):
  M-.          - Go to definition
  M-,          - Return from definition
  M-?          - Find references
  C-c r r      - Rename symbol
  C-c r f      - Format buffer

═══════════════════════════════════════════
")))
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-rust)
;;; init-rust.el ends here
#+end_src
