* init-rust.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-rust.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; init-rust.el --- Rust Language Support for MCG Emacs -*- lexical-binding: t; -*-

  ;; Filename: init-rust.el
  ;; Description: Rust language support module
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024-2026, mcge, all rights reserved.
  ;; Create   Date: 2026-01-07
  ;; Version: 3.0
  ;; Keywords: rust, rust-analyzer, development
  ;; Compatibility: GNU Emacs 29.0+

  ;;; Commentary:
  ;;
  ;; Rust language support module for MCG Emacs, providing:
  ;; - rust-mode / rust-ts-mode configuration
  ;; - rust-analyzer LSP integration (via +lsp module)
  ;; - Cargo command integration
  ;; - Code formatting (rustfmt)
  ;; - Test running support
  ;;
  ;; Module metadata:
  ;; :depends (+lsp)
  ;; :defer t
  ;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)

;; Ensure +lsp module is loaded
(when (and (boundp 'mcg-module-enabled-p)
           (fboundp 'mcg-module-enabled-p)
           (mcg-module-enabled-p :lang 'lsp))
  (require '+lsp nil t))

#+END_SRC

** Rust Mode Configuration
#+BEGIN_SRC emacs-lisp
;;; Rust Basic Configuration

;; Load rust-mode extension
(mcg-require-extension "lsp/rust-mode" 'rust-mode)

;; Use rust-ts-mode (if available)
(when (and (fboundp 'treesit-available-p)
           (treesit-available-p))
  (add-to-list 'major-mode-remap-alist '(rust-mode . rust-ts-mode)))

;; File associations
(add-to-list 'auto-mode-alist '("\\.rs\\'" . rust-mode))
(add-to-list 'auto-mode-alist '("Cargo\\.toml\\'" . toml-ts-mode))

;; Rust indentation settings
(setq rust-indent-offset 4)

#+END_SRC

** Cargo Integration
#+BEGIN_SRC emacs-lisp
;;; Cargo Command Integration

(defun mcg/rust-cargo-build ()
  "Run cargo build."
  (interactive)
  (let ((compilation-scroll-output t))
    (compile "cargo build")))

(defun mcg/rust-cargo-run ()
  "Run cargo run."
  (interactive)
  (let ((compilation-scroll-output t))
    (compile "cargo run")))

(defun mcg/rust-cargo-test ()
  "Run cargo test."
  (interactive)
  (let ((compilation-scroll-output t))
    (compile "cargo test")))

(defun mcg/rust-cargo-check ()
  "Run cargo check."
  (interactive)
  (let ((compilation-scroll-output t))
    (compile "cargo check")))

(defun mcg/rust-cargo-clippy ()
  "Run cargo clippy."
  (interactive)
  (let ((compilation-scroll-output t))
    (compile "cargo clippy")))

(defun mcg/rust-cargo-doc ()
  "Run cargo doc --open."
  (interactive)
  (let ((compilation-scroll-output t))
    (compile "cargo doc --open")))

(defun mcg/rust-cargo-fmt ()
  "Run cargo fmt."
  (interactive)
  (let ((file (buffer-file-name)))
    (when file
      (save-buffer)
      (if (zerop (call-process "cargo" nil nil nil "fmt"))
          (progn
            (revert-buffer t t t)
            (message "Formatted with cargo fmt"))
        (message "cargo fmt failed")))))

#+END_SRC

** Test Functions
#+BEGIN_SRC emacs-lisp
;;; Testing Support

(defun mcg/rust-test-current-fn ()
  "Run test function at cursor."
  (interactive)
  (let ((fn-name (mcg--rust-current-fn-name)))
    (if fn-name
        (let ((compilation-scroll-output t))
          (compile (format "cargo test %s -- --nocapture" fn-name)))
      (message "No test function at point"))))

(defun mcg--rust-current-fn-name ()
  "Get function name at cursor."
  (save-excursion
    (when (re-search-backward "^\\s-*\\(?:pub\\s-+\\)?\\(?:async\\s-+\\)?fn\\s-+\\([a-zA-Z_][a-zA-Z0-9_]*\\)" nil t)
      (match-string-no-properties 1))))

(defun mcg/rust-test-module ()
  "Run all tests in current module."
  (interactive)
  (let* ((file (buffer-file-name))
         (module-name (when file
                        (file-name-sans-extension
                         (file-name-nondirectory file)))))
    (if module-name
        (let ((compilation-scroll-output t))
          (compile (format "cargo test %s::" module-name)))
      (message "Cannot determine module name"))))

#+END_SRC

** Format on Save
#+BEGIN_SRC emacs-lisp
;;; Format on Save

(defvar mcg-rust-format-on-save t
  "Whether to auto-format Rust code on save.")

(defun mcg-rust-format-buffer ()
  "Format current buffer using rustfmt."
  (interactive)
  (if (and (bound-and-true-p lsp-bridge-mode)
           (fboundp 'lsp-bridge-code-format))
      (lsp-bridge-code-format)
    ;; Fallback to direct rustfmt call
    (when (executable-find "rustfmt")
      (let ((temp-file (make-temp-file "rustfmt" nil ".rs")))
        (unwind-protect
            (progn
              (write-region (point-min) (point-max) temp-file nil 'silent)
              (when (zerop (call-process "rustfmt" nil nil nil temp-file))
                (let ((formatted (with-temp-buffer
                                   (insert-file-contents temp-file)
                                   (buffer-string))))
                  (erase-buffer)
                  (insert formatted)
                  (message "Formatted with rustfmt"))))
          (delete-file temp-file))))))

(defun mcg-rust-maybe-format-on-save ()
  "Maybe format Rust code on save."
  (when (and mcg-rust-format-on-save
             (or (derived-mode-p 'rust-mode)
                 (derived-mode-p 'rust-ts-mode)))
    (mcg-rust-format-buffer)))

;; Note: Formatting is handled by +lsp module's mcg-lsp-format-on-save
;; No longer adding before-save-hook here

#+END_SRC

** Keybindings
#+BEGIN_SRC emacs-lisp
;;; Keybindings Configuration

(defun mcg-rust-setup-keybindings ()
  "Setup Rust mode keybindings."
  ;; Cargo commands (C-c C-u prefix)
  (local-set-key (kbd "C-c C-u C-b") #'mcg/rust-cargo-build)
  (local-set-key (kbd "C-c C-u C-r") #'mcg/rust-cargo-run)
  (local-set-key (kbd "C-c C-u C-t") #'mcg/rust-cargo-test)
  (local-set-key (kbd "C-c C-u C-k") #'mcg/rust-cargo-check)
  (local-set-key (kbd "C-c C-u C-l") #'mcg/rust-cargo-clippy)
  (local-set-key (kbd "C-c C-u C-d") #'mcg/rust-cargo-doc)
  (local-set-key (kbd "C-c C-u C-f") #'mcg/rust-cargo-fmt)
  
  ;; Testing (C-c t prefix)
  (local-set-key (kbd "C-c t f") #'mcg/rust-test-current-fn)
  (local-set-key (kbd "C-c t m") #'mcg/rust-test-module)
  (local-set-key (kbd "C-c t t") #'mcg/rust-cargo-test)
  
  ;; Formatting
  (local-set-key (kbd "C-c r f") #'mcg-rust-format-buffer))

(add-hook 'rust-mode-hook #'mcg-rust-setup-keybindings)
(add-hook 'rust-ts-mode-hook #'mcg-rust-setup-keybindings)

#+END_SRC

** Project Detection
#+BEGIN_SRC emacs-lisp
;;; Project Detection

(defun mcg-rust-project-p ()
  "Detect if current project is a Rust project."
  (when-let ((project-root (when (project-current)
                             (project-root (project-current)))))
    (file-exists-p (expand-file-name "Cargo.toml" project-root))))

(defun mcg/rust-project-info ()
  "Show Rust project information."
  (interactive)
  (if (mcg-rust-project-p)
      (let* ((project-root (project-root (project-current)))
             (cargo-toml (expand-file-name "Cargo.toml" project-root)))
        (message "Rust project: %s" project-root))
    (message "Not in a Rust project")))

#+END_SRC

** Tool Status Check
#+BEGIN_SRC emacs-lisp
;;; Tool Status Check

(defun mcg/rust-check-tools ()
  "Check if Rust development tools are installed."
  (interactive)
  (let ((tools '(("rustc" . "rustup install stable")
                 ("cargo" . "rustup install stable")
                 ("rustfmt" . "rustup component add rustfmt")
                 ("clippy" . "rustup component add clippy")
                 ("rust-analyzer" . "rustup component add rust-analyzer"))))
    (with-help-window "*Rust Tools Status*"
      (princ "═══════════════════════════════════════════\n")
      (princ "   Rust Development Tools Status\n")
      (princ "═══════════════════════════════════════════\n\n")
      (dolist (tool tools)
        (let ((name (car tool))
              (install-cmd (cdr tool)))
          (princ (format "%-16s %s\n"
                         name
                         (if (executable-find name)
                             "✓ Installed"
                           (format "✗ Not installed (%s)" install-cmd))))))
      (princ "\n═══════════════════════════════════════════\n")
      (princ "\nRecommended install commands:\n")
      (princ "  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh\n")
      (princ "  rustup component add rustfmt clippy rust-analyzer\n"))))

#+END_SRC

** Keybindings Summary
#+BEGIN_SRC emacs-lisp
;;; Keybindings Summary

;; Cargo commands (C-c C-u prefix):
;; C-c C-u C-b   - cargo build
;; C-c C-u C-r   - cargo run
;; C-c C-u C-t   - cargo test
;; C-c C-u C-k   - cargo check
;; C-c C-u C-l   - cargo clippy
;; C-c C-u C-d   - cargo doc --open
;; C-c C-u C-f   - cargo fmt
;;
;; Testing (C-c t prefix):
;; C-c t f       - Run current function test
;; C-c t m       - Run current module tests
;; C-c t t       - Run all tests
;;
;; Formatting:
;; C-c r f       - Format code
;;
;; LSP (provided by +lsp module):
;; M-.           - Jump to definition
;; M-,           - Return
;; M-?           - Find references
;; C-c r r       - Rename

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-rust)
;;; init-rust.el ends here
#+END_SRC
