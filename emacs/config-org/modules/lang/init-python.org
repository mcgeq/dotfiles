* init-python.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-python.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; init-python.el --- Python Language Support for MCG Emacs -*- lexical-binding: t; -*-

  ;; Filename: init-python.el
  ;; Description: Python language support module
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024-2026, mcge, all rights reserved.
  ;; Create   Date: 2026-01-07
  ;; Version: 3.0
  ;; Keywords: python, ty, ruff, development
  ;; Compatibility: GNU Emacs 29.0+

  ;;; Commentary:
  ;;
  ;; Python language support module for MCG Emacs, providing:
  ;; - python-mode / python-ts-mode configuration
  ;; - ty + ruff LSP integration (via +lsp module)
  ;; - Virtual environment management
  ;; - pytest testing support
  ;; - REPL integration
  ;;
  ;; Toolchain description:
  ;; - ty: Python type checker by Astral, provides completion, navigation, type checking
  ;; - ruff: Ultra-fast Python linter/formatter by Astral, replaces black/isort/flake8
  ;;
  ;; Module metadata:
  ;; :depends (+lsp)
  ;; :defer t
  ;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)

;; Ensure +lsp module is loaded
(when (and (boundp 'mcg-module-enabled-p)
           (fboundp 'mcg-module-enabled-p)
           (mcg-module-enabled-p :lang 'lsp))
  (require '+lsp nil t))

#+END_SRC

** Python Mode Configuration
#+BEGIN_SRC emacs-lisp
;;; Python Basic Configuration

;; Python indentation settings
(setq python-indent-offset 4
      python-indent-guess-indent-offset nil)

;; Use Python 3
(setq python-shell-interpreter "python3"
      python-shell-interpreter-args "-i")

;; Use python-ts-mode (if available)
(when (and (fboundp 'treesit-available-p)
           (treesit-available-p))
  (add-to-list 'major-mode-remap-alist '(python-mode . python-ts-mode)))

;; File associations
(add-to-list 'auto-mode-alist '("\\.py\\'" . python-mode))
(add-to-list 'auto-mode-alist '("\\.pyi\\'" . python-mode))
(add-to-list 'interpreter-mode-alist '("python3" . python-mode))
(add-to-list 'interpreter-mode-alist '("python" . python-mode))

#+END_SRC

** Virtual Environment
#+BEGIN_SRC emacs-lisp
;;; Virtual Environment Support

(defvar mcg-python-venv-dirs '(".venv" "venv" ".virtualenv" "env")
  "List of virtual environment directory names.")

(defun mcg-python-setup-venv ()
  "Auto-detect and activate Python virtual environment."
  (when-let* ((project-root (when (project-current)
                              (project-root (project-current))))
              (venv-path (seq-find
                          (lambda (dir)
                            (file-directory-p (expand-file-name dir project-root)))
                          mcg-python-venv-dirs)))
    (let ((venv-full-path (expand-file-name venv-path project-root)))
      (setenv "VIRTUAL_ENV" venv-full-path)
      (setq python-shell-virtualenv-root venv-full-path)
      (mcg-log "Activated Python venv: %s" venv-full-path))))

;; Auto-activate virtual environment
(add-hook 'python-mode-hook #'mcg-python-setup-venv)
(add-hook 'python-ts-mode-hook #'mcg-python-setup-venv)

#+END_SRC

** Formatting with Ruff
#+BEGIN_SRC emacs-lisp
;;; Code Formatting (using ruff)

(defun mcg-python-format-buffer ()
  "Format Python code using ruff."
  (interactive)
  (if (and (bound-and-true-p lsp-bridge-mode)
           (fboundp 'lsp-bridge-code-format))
      ;; Use lsp-bridge formatting (will call ruff)
      (lsp-bridge-code-format)
    ;; Fallback to direct ruff call
    (when (executable-find "ruff")
      (let ((temp-file (make-temp-file "ruff-format" nil ".py")))
        (unwind-protect
            (progn
              (write-region (point-min) (point-max) temp-file nil 'silent)
              (when (zerop (call-process "ruff" nil nil nil "format" temp-file))
                (let ((formatted (with-temp-buffer
                                   (insert-file-contents temp-file)
                                   (buffer-string))))
                  (erase-buffer)
                  (insert formatted)
                  (message "Formatted with ruff"))))
          (delete-file temp-file))))))

#+END_SRC

** Linting with Ruff
#+BEGIN_SRC emacs-lisp
;;; Code Linting (using ruff)

(defun mcg/python-lint-buffer ()
  "Lint current buffer using ruff."
  (interactive)
  (if (executable-find "ruff")
      (compile (format "ruff check %s" (buffer-file-name)))
    (message "ruff not found. Install with: uv tool install ruff")))

(defun mcg/python-fix-buffer ()
  "Auto-fix current buffer using ruff."
  (interactive)
  (if (executable-find "ruff")
      (let ((file (buffer-file-name)))
        (when (zerop (call-process "ruff" nil nil nil "check" "--fix" file))
          (revert-buffer t t t)
          (message "Fixed with ruff")))
    (message "ruff not found")))

(defun mcg/python-sort-imports ()
  "Sort imports using ruff."
  (interactive)
  (if (executable-find "ruff")
      (let ((file (buffer-file-name)))
        (when file
          (save-buffer)
          (if (zerop (call-process "ruff" nil nil nil "check" "--select" "I" "--fix" file))
              (progn
                (revert-buffer t t t)
                (message "Sorted imports with ruff"))
            (message "ruff: no import changes needed"))))
    (message "ruff not found. Install with: uv tool install ruff")))

#+END_SRC

** Type Checking with ty
#+BEGIN_SRC emacs-lisp
;;; Type Checking (using ty)

(defun mcg/python-type-check ()
  "Type check using ty."
  (interactive)
  (if (executable-find "ty")
      (compile (format "ty check %s" (buffer-file-name)))
    (message "ty not found. Install with: uv tool install ty")))

(defun mcg/python-type-check-project ()
  "Type check entire project."
  (interactive)
  (if (executable-find "ty")
      (let ((default-directory (or (when (project-current)
                                     (project-root (project-current)))
                                   default-directory)))
        (compile "ty check ."))
    (message "ty not found. Install with: uv tool install ty")))

#+END_SRC

** Testing Support
#+BEGIN_SRC emacs-lisp
;;; Testing Support (pytest)

(defun mcg/python-run-pytest ()
  "Run pytest tests."
  (interactive)
  (if (executable-find "pytest")
      (let ((compilation-scroll-output t))
        (compile "pytest -v"))
    (message "pytest not found. Install with: pip install pytest")))

(defun mcg/python-run-pytest-file ()
  "Run tests in current file."
  (interactive)
  (if (executable-find "pytest")
      (let ((compilation-scroll-output t))
        (compile (format "pytest -v %s" (buffer-file-name))))
    (message "pytest not found")))

(defun mcg/python-run-pytest-function ()
  "Run test function at cursor."
  (interactive)
  (if (executable-find "pytest")
      (let* ((func-name (python-info-current-defun))
             (file (buffer-file-name)))
        (if func-name
            (compile (format "pytest -v %s::%s" file func-name))
          (message "No function at point")))
    (message "pytest not found")))

#+END_SRC

** REPL Integration
#+BEGIN_SRC emacs-lisp
;;; REPL Integration

(defun mcg/python-send-region-to-repl (start end)
  "Send selected region to Python REPL."
  (interactive "r")
  (python-shell-send-region start end)
  (python-shell-switch-to-shell))

(defun mcg/python-send-buffer-to-repl ()
  "Send entire buffer to Python REPL."
  (interactive)
  (python-shell-send-buffer)
  (python-shell-switch-to-shell))

(defun mcg/python-send-defun-to-repl ()
  "Send current function to Python REPL."
  (interactive)
  (python-shell-send-defun)
  (python-shell-switch-to-shell))

#+END_SRC

** Documentation
#+BEGIN_SRC emacs-lisp
;;; Documentation Support

(defun mcg/python-insert-docstring ()
  "Insert Python docstring template."
  (interactive)
  (let ((indent (make-string (current-indentation) ?\s)))
    (insert (format "%s\"\"\"\n%s\n%s\n%s\"\"\"\n"
                    indent
                    indent
                    indent
                    indent))
    (forward-line -2)
    (end-of-line)))

#+END_SRC

** Project Detection
#+BEGIN_SRC emacs-lisp
;;; Project Detection

(defun mcg-python-project-p ()
  "Detect if current project is a Python project."
  (when-let ((project-root (when (project-current)
                             (project-root (project-current)))))
    (or (file-exists-p (expand-file-name "setup.py" project-root))
        (file-exists-p (expand-file-name "pyproject.toml" project-root))
        (file-exists-p (expand-file-name "requirements.txt" project-root))
        (file-exists-p (expand-file-name "Pipfile" project-root))
        (file-exists-p (expand-file-name "poetry.lock" project-root))
        (file-exists-p (expand-file-name "uv.lock" project-root)))))

#+END_SRC

** Keybindings
#+BEGIN_SRC emacs-lisp
;;; Keybindings Configuration

(defun mcg-python-setup-keybindings ()
  "Setup Python mode keybindings."
  ;; Refactoring (C-c r prefix)
  (local-set-key (kbd "C-c r f") #'mcg-python-format-buffer)
  (local-set-key (kbd "C-c r l") #'mcg/python-lint-buffer)
  (local-set-key (kbd "C-c r x") #'mcg/python-fix-buffer)
  (local-set-key (kbd "C-c r i") #'mcg/python-sort-imports)
  
  ;; Type checking
  (local-set-key (kbd "C-c c") #'mcg/python-type-check)
  (local-set-key (kbd "C-c C") #'mcg/python-type-check-project)
  
  ;; Testing (C-c t prefix)
  (local-set-key (kbd "C-c t t") #'mcg/python-run-pytest)
  (local-set-key (kbd "C-c t f") #'mcg/python-run-pytest-file)
  (local-set-key (kbd "C-c t d") #'mcg/python-run-pytest-function)
  
  ;; REPL
  (local-set-key (kbd "C-c C-r") #'mcg/python-send-region-to-repl)
  (local-set-key (kbd "C-c C-b") #'mcg/python-send-buffer-to-repl)
  (local-set-key (kbd "C-c C-d") #'mcg/python-send-defun-to-repl)
  
  ;; Documentation
  (local-set-key (kbd "C-c d") #'mcg/python-insert-docstring))

(add-hook 'python-mode-hook #'mcg-python-setup-keybindings)
(add-hook 'python-ts-mode-hook #'mcg-python-setup-keybindings)

#+END_SRC

** Tool Status Check
#+BEGIN_SRC emacs-lisp
;;; Tool Status Check

(defun mcg/python-check-tools ()
  "Check if Python development tools are installed."
  (interactive)
  (let ((tools '(("ty" . "uv tool install ty")
                 ("ruff" . "uv tool install ruff")
                 ("pytest" . "uv pip install pytest")
                 ("python3" . "System install"))))
    (with-help-window "*Python Tools Status*"
      (princ "═══════════════════════════════════════════\n")
      (princ "   Python Development Tools Status\n")
      (princ "═══════════════════════════════════════════\n\n")
      (dolist (tool tools)
        (let ((name (car tool))
              (install-cmd (cdr tool)))
          (princ (format "%-12s %s\n"
                         name
                         (if (executable-find name)
                             "✓ Installed"
                           (format "✗ Not installed (%s)" install-cmd))))))
      (princ "\n═══════════════════════════════════════════\n")
      (princ "\nRecommended install commands:\n")
      (princ "  uv tool install ty\n")
      (princ "  uv tool install ruff\n")
      (princ "  uv pip install pytest\n")
      (princ "\nOr using pip:\n")
      (princ "  pip install ty ruff pytest\n"))))

#+END_SRC

** Keybindings Summary
#+BEGIN_SRC emacs-lisp
;;; Keybindings Summary

;; Refactoring (C-c r prefix):
;; C-c r f   - Format code (ruff format)
;; C-c r l   - Lint code (ruff check)
;; C-c r x   - Auto-fix (ruff --fix)
;; C-c r i   - Sort imports (ruff)
;; C-c r r   - Rename (lsp-bridge, provided by +lsp)
;;
;; Type checking:
;; C-c c     - Type check current file (ty)
;; C-c C     - Type check entire project (ty)
;;
;; Testing:
;; C-c t t   - Run all tests (pytest)
;; C-c t f   - Run current file tests
;; C-c t d   - Run current function test
;;
;; REPL:
;; C-c C-r   - Send selected region to REPL
;; C-c C-b   - Send entire buffer to REPL
;; C-c C-d   - Send current function to REPL
;; C-c C-z   - Switch to REPL (built-in)
;; C-c C-c   - Send current definition to REPL (built-in)
;;
;; Other:
;; C-c d     - Insert docstring
;;
;; LSP (provided by +lsp module):
;; M-.       - Jump to definition
;; M-,       - Return
;; M-?       - Find references

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-python)
;;; init-python.el ends here
#+END_SRC
