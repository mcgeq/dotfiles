#+TITLE: Python Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-python.el :lexical t

* Python Module

本模块负责 MCG Emacs 的 Python 语言支持，包括：
- python-mode / python-ts-mode 配置
- ty + ruff LSP 集成（通过 lsp-bridge）
- 虚拟环境支持
- 使用 ruff 保存时格式化

** File Header

#+begin_src emacs-lisp
;;; init-python.el --- Python language support for MCG Emacs -*- lexical-binding: t; -*-

;; Copyright (C) 2024-2026 MCG
;; Author: mcge <mcgeq@outlook.com>
;; Keywords: languages, python
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;; Python language support module for MCG Emacs:
;; - python-mode / python-ts-mode configuration
;; - ty + ruff LSP integration (via lsp-bridge)
;; - Virtual environment support
;; - Format on save with ruff
;;
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

(require 'core-lib)
#+end_src

** Variables

Python 模块的配置变量。

#+begin_src emacs-lisp
;;; ============================================================
;;; Variables
;;; ============================================================

(defvar mcg-python-format-on-save t
  "Whether to format Python files on save using ruff.")

(defvar mcg-python-sort-imports-on-save t
  "Whether to sort imports on save using ruff.")

(defvar mcg-python-venv-directory ".venv"
  "Default virtual environment directory name.")
#+end_src

** python-mode / python-ts-mode Configuration

python-mode 和 python-ts-mode 的配置，包括缩进、子词模式和填充列。

#+begin_src emacs-lisp
;;; ============================================================
;;; python-mode / python-ts-mode Configuration
;;; ============================================================

(defun mcg-python-mode-setup ()
  "Setup function for python-mode and python-ts-mode."
  ;; Indentation
  (setq-local indent-tabs-mode nil)
  (setq-local tab-width 4)
  (setq-local python-indent-offset 4)
  
  ;; Enable subword mode for snake_case navigation
  (subword-mode 1)
  
  ;; Fill column for docstrings
  (setq-local fill-column 88)  ; Black/Ruff default
  
  (mcg-log "Python mode setup complete"))

;; Setup Python mode hooks (auto-mode-alist is managed in init-treesit.el)
(mcg-deflang python
  :ts-mode python-ts-mode
  :fallback-mode python-mode
  :setup-fn mcg-python-mode-setup)
#+end_src

** Ruff Integration

Ruff 命令集成，提供格式化、检查、修复和导入排序功能。

*** Buffer Refresh

#+begin_src emacs-lisp
;;; ============================================================
;;; Ruff Integration
;;; ============================================================

(defun mcg--python-refresh-buffer-silently ()
  "Refresh buffer content without triggering hooks.
Uses `replace-buffer-contents' to avoid lsp-bridge reconnection."
  (let ((file (buffer-file-name)))
    (when file
      (let ((inhibit-modification-hooks t)
            (inhibit-read-only t))
        (with-temp-buffer
          (insert-file-contents file)
          (let ((temp-buf (current-buffer)))
            (with-current-buffer (get-file-buffer file)
              (replace-buffer-contents temp-buf)))))
      (set-buffer-modified-p nil))))
#+end_src

*** Ruff Commands

#+begin_src emacs-lisp
(defun mcg/ruff-format ()
  "Format current buffer with ruff format."
  (interactive)
  (if (executable-find "ruff")
      (let ((file (buffer-file-name)))
        (when file
          (save-buffer)
          (if (zerop (call-process "ruff" nil nil nil "format" file))
              (progn
                (mcg--python-refresh-buffer-silently)
                (message "Formatted with ruff"))
            (message "ruff format failed"))))
    (message "ruff not found. Install with: pip install ruff")))

(defun mcg/ruff-check ()
  "Run ruff check on current buffer."
  (interactive)
  (if (executable-find "ruff")
      (compile (format "ruff check %s" (shell-quote-argument (buffer-file-name))))
    (message "ruff not found. Install with: pip install ruff")))

(defun mcg/ruff-fix ()
  "Run ruff check --fix on current buffer."
  (interactive)
  (if (executable-find "ruff")
      (let ((file (buffer-file-name)))
        (when file
          (save-buffer)
          (if (zerop (call-process "ruff" nil nil nil "check" "--fix" file))
              (progn
                (mcg--python-refresh-buffer-silently)
                (message "Fixed with ruff"))
            (message "ruff fix completed with issues"))))
    (message "ruff not found. Install with: pip install ruff")))

(defun mcg/ruff-sort-imports ()
  "Sort imports with ruff."
  (interactive)
  (if (executable-find "ruff")
      (let ((file (buffer-file-name)))
        (when file
          (save-buffer)
          (if (zerop (call-process "ruff" nil nil nil "check" "--select" "I" "--fix" file))
              (progn
                (mcg--python-refresh-buffer-silently)
                (message "Sorted imports with ruff"))
            (message "ruff: no import changes needed"))))
    (message "ruff not found. Install with: pip install ruff")))
#+end_src

** Virtual Environment Support

虚拟环境支持，提供查找、激活和停用虚拟环境的功能。

#+begin_src emacs-lisp
;;; ============================================================
;;; Virtual Environment Support
;;; ============================================================

(defun mcg-python-find-venv ()
  "Find virtual environment directory for current project."
  (when-let* ((project-root (or (when (project-current)
                                  (project-root (project-current)))
                                (locate-dominating-file default-directory "pyproject.toml")
                                (locate-dominating-file default-directory "setup.py"))))
    (let ((venv-dir (expand-file-name mcg-python-venv-directory project-root)))
      (when (file-directory-p venv-dir)
        venv-dir))))

(defun mcg/python-activate-venv ()
  "Activate virtual environment for current project."
  (interactive)
  (if-let* ((venv (mcg-python-find-venv)))
      (progn
        (setenv "VIRTUAL_ENV" venv)
        (setenv "PATH" (concat (expand-file-name "bin" venv) path-separator (getenv "PATH")))
        (message "Activated venv: %s" venv))
    (message "No virtual environment found")))

(defun mcg/python-deactivate-venv ()
  "Deactivate current virtual environment."
  (interactive)
  (when (getenv "VIRTUAL_ENV")
    (let ((venv-bin (expand-file-name "bin" (getenv "VIRTUAL_ENV"))))
      (setenv "PATH" (string-replace (concat venv-bin path-separator) "" (getenv "PATH")))
      (setenv "VIRTUAL_ENV" nil)
      (message "Deactivated virtual environment"))))
#+end_src

** Python Commands

Python 运行和测试命令。

#+begin_src emacs-lisp
;;; ============================================================
;;; Python Commands
;;; ============================================================

(defun mcg/python-run ()
  "Run current Python file."
  (interactive)
  (let ((file (buffer-file-name)))
    (when file
      (save-buffer)
      (compile (format "python %s" (shell-quote-argument file))))))

(defun mcg/python-run-pytest ()
  "Run pytest on current file or project."
  (interactive)
  (if (executable-find "pytest")
      (compile "pytest -v")
    (message "pytest not found. Install with: pip install pytest")))

(defun mcg/python-run-pytest-current ()
  "Run pytest on current test function."
  (interactive)
  (if (executable-find "pytest")
      (let ((file (buffer-file-name)))
        (when file
          (compile (format "pytest -v %s" (shell-quote-argument file)))))
    (message "pytest not found. Install with: pip install pytest")))
#+end_src

** Python Keybindings

Python 模式的快捷键配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; Python Keybindings
;;; ============================================================

(defvar mcg-python-mode-map
  (let ((map (make-sparse-keymap)))
    ;; Ruff commands
    (define-key map (kbd "C-c C-f") #'mcg/ruff-format)
    (define-key map (kbd "C-c C-c") #'mcg/ruff-check)
    (define-key map (kbd "C-c C-x") #'mcg/ruff-fix)
    (define-key map (kbd "C-c C-i") #'mcg/ruff-sort-imports)
    ;; Run commands
    (define-key map (kbd "C-c C-r") #'mcg/python-run)
    (define-key map (kbd "C-c C-t") #'mcg/python-run-pytest)
    (define-key map (kbd "C-c C-T") #'mcg/python-run-pytest-current)
    ;; Venv commands
    (define-key map (kbd "C-c C-v a") #'mcg/python-activate-venv)
    (define-key map (kbd "C-c C-v d") #'mcg/python-deactivate-venv)
    map)
  "Keymap for Python-specific commands.")

(defun mcg-python-setup-keybindings ()
  "Setup Python-specific keybindings."
  (use-local-map (make-composed-keymap mcg-python-mode-map (current-local-map))))

;; Keybindings are now set up via mcg-deflang, but we keep manual hooks
;; for cases where the mode is loaded via other means
(add-hook 'python-mode-hook #'mcg-python-setup-keybindings)
(when (mcg-treesit-available-p)
  (add-hook 'python-ts-mode-hook #'mcg-python-setup-keybindings))
#+end_src

** Help Command

Python 帮助命令，显示快捷键和使用说明。

#+begin_src emacs-lisp
;;; ============================================================
;;; Help Command
;;; ============================================================

(defun mcg--python-help-content ()
  "Generate Python help content string."
  "
    ╔═══════════════════════════════════════════╗
    ║       MCG Python 快捷键速查               ║
    ╚═══════════════════════════════════════════╝

    【Ruff 命令】
      C-c C-f      格式化代码
      C-c C-c      检查代码
      C-c C-x      自动修复
      C-c C-i      整理导入

    【运行命令】
      C-c C-r      运行当前文件
      C-c C-t      运行 pytest
      C-c C-T      运行当前文件的 pytest

    【虚拟环境】
      C-c C-v a    激活 venv
      C-c C-v d    停用 venv

    【LSP 命令】 (通过 lsp-bridge + ty + ruff)
      M-.          跳转到定义
      M-,          返回
      M-?          查找引用
      C-c r r      重命名符号
      C-c r f      格式化缓冲区

    ───────────────────────────────────────────

    【安装】
      pip install ruff ty pytest

    ───────────────────────────────────────────
")

(defun mcg/python-help ()
  "Show Python keybindings and command help in posframe popup."
  (interactive)
  (if (and (display-graphic-p)
           (require 'posframe nil t)
           (fboundp 'mcg-popup-show))
      ;; Use posframe popup
      (mcg-popup-show "*MCG Python Help*" (mcg--python-help-content) 50 35)
    ;; Fallback to help window
    (with-help-window "*MCG Python Help*"
      (princ (mcg--python-help-content)))))
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-python)
;;; init-python.el ends here
#+end_src
