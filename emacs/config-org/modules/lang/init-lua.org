#+TITLE: Lua Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-lua.el :lexical t

* Lua Module

本模块负责 MCG Emacs 的 Lua 语言支持，包括：
- lua-mode / lua-ts-mode 配置
- lua-language-server (sumneko) LSP 集成（通过 lsp-bridge）
- StyLua 格式化
- Neovim/Love2D 开发支持

** File Header

#+begin_src emacs-lisp
;;; init-lua.el --- Lua language support for MCG Emacs -*- lexical-binding: t; -*-

;; Copyright (C) 2024-2026 MCG
;; Author: mcge <mcgeq@outlook.com>
;; Keywords: languages, lua
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;; Lua language support module for MCG Emacs:
;; - lua-mode / lua-ts-mode configuration
;; - lua-language-server (sumneko) LSP integration (via lsp-bridge)
;; - StyLua formatting
;; - Neovim/Love2D development support
;;
;; Requirements: 10.5
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

(require 'core-lib)
#+end_src

** Variables

Lua 模块的配置变量。

#+begin_src emacs-lisp
;;; ============================================================
;;; Variables
;;; ============================================================

(defvar mcg-lua-format-on-save t
  "Whether to format Lua files on save using stylua.")

(defvar mcg-lua-indent-level 2
  "Indentation level for Lua code.")
#+end_src

** lua-mode / lua-ts-mode Configuration

lua-mode 和 lua-ts-mode 的配置，包括缩进和子词模式。

#+begin_src emacs-lisp
;;; ============================================================
;;; lua-mode / lua-ts-mode Configuration
;;; ============================================================

(defun mcg-lua-mode-setup ()
  "Setup function for lua-mode and lua-ts-mode."
  ;; Indentation
  (setq-local indent-tabs-mode nil)
  (setq-local tab-width mcg-lua-indent-level)
  (setq-local lua-indent-level mcg-lua-indent-level)
  
  ;; Enable subword mode
  (subword-mode 1)
  
  (mcg-log "Lua mode setup complete"))

;; Setup Lua mode hooks (auto-mode-alist is managed in init-treesit.el)
(mcg-setup-lang-mode
 '(:ts-mode lua-ts-mode
   :fallback-mode lua-mode
   :setup-fn mcg-lua-mode-setup))

;; lua-mode extension
(let ((lua-mode-path (mcg-extension-path "lua-mode")))
  (when lua-mode-path
    (add-to-list 'load-path lua-mode-path)))

(with-eval-after-load 'lua-mode
  (setq lua-indent-level mcg-lua-indent-level)
  (setq lua-indent-string-contents t)
  (setq lua-indent-nested-block-content-align nil)
  (setq lua-indent-close-paren-align nil))
#+end_src

** StyLua Integration

StyLua 格式化工具集成。

#+begin_src emacs-lisp
;;; ============================================================
;;; StyLua Integration
;;; ============================================================

(defun mcg/stylua-format ()
  "Format current buffer with stylua."
  (interactive)
  (if (executable-find "stylua")
      (let ((file (buffer-file-name)))
        (when file
          (save-buffer)
          (if (zerop (call-process "stylua" nil nil nil file))
              (progn
                (revert-buffer t t t)
                (message "Formatted with stylua"))
            (message "stylua format failed"))))
    (message "stylua not found. Install with: cargo install stylua")))

(defun mcg/stylua-check ()
  "Check current buffer with stylua."
  (interactive)
  (if (executable-find "stylua")
      (compile (format "stylua --check %s" (shell-quote-argument (buffer-file-name))))
    (message "stylua not found. Install with: cargo install stylua")))
#+end_src

** Lua Commands

Lua 运行和 REPL 命令。

#+begin_src emacs-lisp
;;; ============================================================
;;; Lua Commands
;;; ============================================================

(defun mcg/lua-run ()
  "Run current Lua file."
  (interactive)
  (let ((file (buffer-file-name)))
    (when file
      (save-buffer)
      (compile (format "lua %s" (shell-quote-argument file))))))

(defun mcg/lua-run-luajit ()
  "Run current Lua file with LuaJIT."
  (interactive)
  (if (executable-find "luajit")
      (let ((file (buffer-file-name)))
        (when file
          (save-buffer)
          (compile (format "luajit %s" (shell-quote-argument file)))))
    (message "luajit not found")))

(defun mcg/lua-send-buffer ()
  "Send buffer to Lua REPL."
  (interactive)
  (if (fboundp 'lua-send-buffer)
      (call-interactively #'lua-send-buffer)
    (message "lua-send-buffer not available")))

(defun mcg/lua-send-region ()
  "Send region to Lua REPL."
  (interactive)
  (if (fboundp 'lua-send-region)
      (call-interactively #'lua-send-region)
    (message "lua-send-region not available")))
#+end_src

** Neovim Development Support

Neovim 插件开发支持。

#+begin_src emacs-lisp
;;; ============================================================
;;; Neovim Development Support
;;; ============================================================

(defun mcg/nvim-reload-config ()
  "Reload Neovim configuration (for Neovim plugin development)."
  (interactive)
  (if (executable-find "nvim")
      (shell-command "nvim --headless -c 'lua require(\"plenary.reload\").reload_module(\"config\")' -c 'qa'")
    (message "nvim not found")))

(defun mcg/nvim-test-plugin ()
  "Run Neovim plugin tests with plenary."
  (interactive)
  (if (executable-find "nvim")
      (let ((test-file (buffer-file-name)))
        (when test-file
          (compile (format "nvim --headless -c 'PlenaryBustedFile %s'" 
                           (shell-quote-argument test-file)))))
    (message "nvim not found")))
#+end_src

** Love2D Development Support

Love2D 游戏开发支持。

#+begin_src emacs-lisp
;;; ============================================================
;;; Love2D Development Support
;;; ============================================================

(defun mcg/love-run ()
  "Run Love2D project."
  (interactive)
  (if (executable-find "love")
      (let ((project-dir (or (locate-dominating-file default-directory "main.lua")
                             default-directory)))
        (compile (format "love %s" (shell-quote-argument project-dir))))
    (message "love not found. Install Love2D.")))
#+end_src

** Lua Keybindings

Lua 模式的快捷键配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; Lua Keybindings
;;; ============================================================

(defvar mcg-lua-mode-map
  (let ((map (make-sparse-keymap)))
    ;; Format
    (define-key map (kbd "C-c C-f") #'mcg/stylua-format)
    (define-key map (kbd "C-c C-k") #'mcg/stylua-check)
    ;; Run
    (define-key map (kbd "C-c C-c") #'mcg/lua-run)
    (define-key map (kbd "C-c C-j") #'mcg/lua-run-luajit)
    ;; REPL
    (define-key map (kbd "C-c C-b") #'mcg/lua-send-buffer)
    (define-key map (kbd "C-c C-r") #'mcg/lua-send-region)
    ;; Love2D
    (define-key map (kbd "C-c C-l") #'mcg/love-run)
    map)
  "Keymap for Lua-specific commands.")

(defun mcg-lua-setup-keybindings ()
  "Setup Lua-specific keybindings."
  (use-local-map (make-composed-keymap mcg-lua-mode-map (current-local-map))))

;; Keybindings setup via hooks
(with-eval-after-load 'lua-mode
  (add-hook 'lua-mode-hook #'mcg-lua-setup-keybindings))
(when (mcg-treesit-available-p)
  (add-hook 'lua-ts-mode-hook #'mcg-lua-setup-keybindings))
#+end_src

** Help Command

Lua 帮助命令，显示快捷键和使用说明。

#+begin_src emacs-lisp
;;; ============================================================
;;; Help Command
;;; ============================================================

(defun mcg/lua-help ()
  "Show Lua keybindings and command help."
  (interactive)
  (with-help-window "*MCG Lua Help*"
    (princ "
╔═══════════════════════════════════════════╗
║       MCG Lua Keybindings                 ║
╚═══════════════════════════════════════════╝

FORMAT:
  C-c C-f      - stylua format
  C-c C-k      - stylua check

RUN:
  C-c C-c      - Run with lua
  C-c C-j      - Run with luajit

REPL:
  C-c C-b      - Send buffer to REPL
  C-c C-r      - Send region to REPL

LOVE2D:
  C-c C-l      - Run Love2D project

LSP COMMANDS (via lsp-bridge with lua-language-server):
  M-.          - Go to definition
  M-,          - Return from definition
  M-?          - Find references
  C-c r r      - Rename symbol
  C-c r f      - Format buffer

═══════════════════════════════════════════

INSTALLATION:
  - lua-language-server: Download from GitHub
  - stylua: cargo install stylua
  - Love2D: https://love2d.org/

═══════════════════════════════════════════
")))
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-lua)
;;; init-lua.el ends here
#+end_src
