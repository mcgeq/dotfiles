* init-zig.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-zig.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
;;; init-zig.el --- Zig Development for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-zig.el
;; Description: Zig development module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: zig, systems-programming
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Zig development module for MCG Emacs, responsible for:
;; - Zig mode configuration
;; - LSP integration (zls)
;; - Build system integration
;; - Test support
;;
;; Module metadata:
;; :depends (+lsp)
;; :defer t
;; :mode ("\\.zig\\'")
;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)

#+END_SRC

** Zig Mode Configuration
#+BEGIN_SRC emacs-lisp
;;; Zig Mode Configuration

(defun mcg--setup-zig-mode ()
  "Setup Zig mode."
  ;; Try to load zig-mode extension
  (if (mcg-require-extension "lang/zig-mode" 'zig-mode)
      (mcg-log "Zig mode loaded from extension")
    ;; If no extension, define simple zig-mode
    (unless (fboundp 'zig-mode)
      (define-derived-mode zig-mode prog-mode "Zig"
        "Simple Zig mode."
        (setq-local comment-start "// ")
        (setq-local comment-end "")
        (setq-local tab-width 4)
        (setq-local indent-tabs-mode nil))
      (mcg-log "Using simple zig-mode")))
  
  ;; Zig file associations
  (add-to-list 'auto-mode-alist '("\\.zig\\'" . zig-mode)))

#+END_SRC

** LSP Configuration
#+BEGIN_SRC emacs-lisp
;;; LSP Configuration (zls)

(defun mcg--zig-mode-hook ()
  "Zig mode hook."
  ;; LSP is handled by global-lsp-bridge-mode, no need to enable manually
  )

#+END_SRC

** Formatting
#+BEGIN_SRC emacs-lisp
;;; Formatting

(defun mcg/zig-format-buffer ()
  "Format code using zig fmt."
  (interactive)
  (if (executable-find "zig")
      (let ((output-buffer (get-buffer-create "*zig fmt*"))
            (error-buffer (get-buffer-create "*zig errors*")))
        (if (zerop (call-process-region 
                    (point-min) (point-max)
                    "zig" nil (list output-buffer error-buffer) nil
                    "fmt" "--stdin"))
            (progn
              (erase-buffer)
              (insert-buffer-substring output-buffer)
              (message "Formatted with zig fmt"))
          (display-buffer error-buffer)
          (message "Zig fmt failed")))
    (message "Zig compiler not found")))

(defun mcg--zig-format-on-save ()
  "Auto-format on save."
  (when (and (eq major-mode 'zig-mode)
             (executable-find "zig"))
    (mcg/zig-format-buffer)))

#+END_SRC

** Build System
#+BEGIN_SRC emacs-lisp
;;; Build System

(defun mcg/zig-build ()
  "Run zig build."
  (interactive)
  (if (executable-find "zig")
      (let ((compilation-scroll-output t)
            (default-directory (or (locate-dominating-file default-directory "build.zig")
                                   default-directory)))
        (compile "zig build"))
    (message "Zig compiler not found")))

(defun mcg/zig-build-run ()
  "Build and run."
  (interactive)
  (if (executable-find "zig")
      (let ((compilation-scroll-output t)
            (default-directory (or (locate-dominating-file default-directory "build.zig")
                                   default-directory)))
        (compile "zig build run"))
    (message "Zig compiler not found")))

(defun mcg/zig-run-file ()
  "Run current Zig file directly."
  (interactive)
  (if (executable-find "zig")
      (let ((compilation-scroll-output t))
        (compile (format "zig run %s" (buffer-file-name))))
    (message "Zig compiler not found")))

#+END_SRC

** Testing Support
#+BEGIN_SRC emacs-lisp
;;; Testing Support

(defun mcg/zig-test ()
  "Run zig build test."
  (interactive)
  (if (executable-find "zig")
      (let ((compilation-scroll-output t)
            (default-directory (or (locate-dominating-file default-directory "build.zig")
                                   default-directory)))
        (compile "zig build test"))
    (message "Zig compiler not found")))

(defun mcg/zig-test-file ()
  "Test current file."
  (interactive)
  (if (executable-find "zig")
      (let ((compilation-scroll-output t))
        (compile (format "zig test %s" (buffer-file-name))))
    (message "Zig compiler not found")))

#+END_SRC

** Snippets
#+BEGIN_SRC emacs-lisp
;;; Snippets

(defun mcg/zig-insert-main ()
  "Insert main function template."
  (interactive)
  (insert "const std = @import(\"std\");\n\n")
  (insert "pub fn main() !void {\n")
  (insert "    const stdout = std.io.getStdOut().writer();\n")
  (insert "    try stdout.print(\"Hello, World!\\n\", .{});\n")
  (insert "}\n"))

(defun mcg/zig-insert-test ()
  "Insert test template."
  (interactive)
  (let ((test-name (read-string "Test name: ")))
    (insert (format "test \"%s\" {\n" test-name))
    (insert "    const testing = @import(\"std\").testing;\n")
    (insert "    \n")
    (insert "}\n")))

#+END_SRC

** Keybindings
#+BEGIN_SRC emacs-lisp
;;; Keybindings

(defun mcg--setup-zig-keybindings ()
  "Setup Zig keybindings."
  (with-eval-after-load 'zig-mode
    (define-key zig-mode-map (kbd "C-c r f") #'mcg/zig-format-buffer)
    (define-key zig-mode-map (kbd "C-c C-c") #'mcg/zig-build)
    (define-key zig-mode-map (kbd "C-c C-r") #'mcg/zig-build-run)
    (define-key zig-mode-map (kbd "C-c r") #'mcg/zig-run-file)
    (define-key zig-mode-map (kbd "C-c t") #'mcg/zig-test)
    (define-key zig-mode-map (kbd "C-c T") #'mcg/zig-test-file)
    (define-key zig-mode-map (kbd "C-c C-m") #'mcg/zig-insert-main)
    (define-key zig-mode-map (kbd "C-c C-t") #'mcg/zig-insert-test)))

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

(mcg--setup-zig-mode)
(mcg--setup-zig-keybindings)

;; Add hook
(add-hook 'zig-mode-hook #'mcg--zig-mode-hook)

;; Format on save (optional)
;; (add-hook 'before-save-hook #'mcg--zig-format-on-save)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-zig)
;;; init-zig.el ends here
#+END_SRC
