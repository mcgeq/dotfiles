#+TITLE: TypeScript Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-typescript.el :lexical t

* TypeScript Module

本模块负责 MCG Emacs 的 TypeScript/JavaScript 语言支持，包括：
- typescript-ts-mode / tsx-ts-mode 配置
- tsserver LSP 集成（通过 lsp-bridge）
- Biome 格式化和 lint
- npm/pnpm 集成

** File Header

#+begin_src emacs-lisp
;;; init-typescript.el --- TypeScript language support for MCG Emacs -*- lexical-binding: t; -*-

;; Copyright (C) 2024-2026 MCG
;; Author: mcge <mcgeq@outlook.com>
;; Keywords: languages, typescript, javascript
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;; TypeScript/JavaScript language support module for MCG Emacs:
;; - typescript-ts-mode / tsx-ts-mode configuration
;; - tsserver LSP integration (via lsp-bridge)
;; - Biome for formatting and linting
;; - npm/pnpm integration
;;
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

(require 'core-lib)
#+end_src

** Variables

TypeScript 模块的配置变量。

#+begin_src emacs-lisp
;;; ============================================================
;;; Variables
;;; ============================================================

(defvar mcg-ts-format-on-save t
  "Whether to format TypeScript files on save using biome.")

(defvar mcg-ts-package-manager "pnpm"
  "Package manager to use (npm, pnpm, yarn).")
#+end_src

** typescript-ts-mode / tsx-ts-mode Configuration

typescript-ts-mode 和 tsx-ts-mode 的配置，包括缩进和子词模式。

#+begin_src emacs-lisp
;;; ============================================================
;;; typescript-ts-mode / tsx-ts-mode Configuration
;;; ============================================================

(defun mcg-typescript-mode-setup ()
  "Setup function for typescript-ts-mode and tsx-ts-mode."
  ;; Indentation
  (setq-local indent-tabs-mode nil)
  (setq-local tab-width 2)
  (setq-local typescript-ts-mode-indent-offset 2)
  
  ;; Enable subword mode for camelCase navigation
  (subword-mode 1)
  
  ;; JSX/TSX specific
  (when (derived-mode-p 'tsx-ts-mode)
    (setq-local sgml-basic-offset 2))
  
  (mcg-log "TypeScript mode setup complete"))

;; Setup TypeScript/JavaScript mode hooks (auto-mode-alist is managed in init-treesit.el)
;; TypeScript
(mcg-setup-lang-mode
 '(:ts-mode typescript-ts-mode
   :setup-fn mcg-typescript-mode-setup))

;; TSX
(mcg-setup-lang-mode
 '(:ts-mode tsx-ts-mode
   :setup-fn mcg-typescript-mode-setup))

;; JavaScript
(mcg-setup-lang-mode
 '(:ts-mode js-ts-mode
   :setup-fn mcg-typescript-mode-setup))
#+end_src

** Biome Integration (Format & Lint)

Biome 集成，提供格式化和 lint 功能。

#+begin_src emacs-lisp
;;; ============================================================
;;; Biome Integration (Format & Lint)
;;; ============================================================

;; Note: Biome formatting is handled by init-lsp.el
;; These are additional convenience commands

(defun mcg--ts-refresh-buffer-silently ()
  "Refresh buffer content without triggering hooks.
Uses `replace-buffer-contents' to avoid lsp-bridge reconnection."
  (let ((file (buffer-file-name)))
    (when file
      (let ((inhibit-modification-hooks t)
            (inhibit-read-only t))
        (with-temp-buffer
          (insert-file-contents file)
          (let ((temp-buf (current-buffer)))
            (with-current-buffer (get-file-buffer file)
              (replace-buffer-contents temp-buf)))))
      (set-buffer-modified-p nil))))

(defun mcg/biome-format ()
  "Format current buffer with biome."
  (interactive)
  (if (executable-find "biome")
      (let ((file (buffer-file-name)))
        (when file
          (save-buffer)
          (if (zerop (call-process "biome" nil nil nil "format" "--write" file))
              (progn
                (mcg--ts-refresh-buffer-silently)
                (message "Formatted with biome"))
            (message "biome format failed"))))
    (message "biome not found. Install with: npm install -g @biomejs/biome")))

(defun mcg/biome-lint ()
  "Run biome lint on current buffer."
  (interactive)
  (if (executable-find "biome")
      (compile (format "biome lint %s" (shell-quote-argument (buffer-file-name))))
    (message "biome not found. Install with: npm install -g @biomejs/biome")))

(defun mcg/biome-check-fix ()
  "Run biome check --write on current buffer."
  (interactive)
  (if (executable-find "biome")
      (let ((file (buffer-file-name)))
        (when file
          (save-buffer)
          (call-process "biome" nil "*biome*" nil "check" "--write" "--unsafe" file)
          (mcg--ts-refresh-buffer-silently)
          (message "Fixed with biome")))
    (message "biome not found. Install with: npm install -g @biomejs/biome")))
#+end_src

** Package Manager Integration

包管理器集成，支持 npm、pnpm 和 yarn。

#+begin_src emacs-lisp
;;; ============================================================
;;; Package Manager Integration
;;; ============================================================

(defun mcg--ts-get-package-manager ()
  "Get the package manager for current project."
  (let ((root (or (locate-dominating-file default-directory "package.json")
                  default-directory)))
    (cond
     ((file-exists-p (expand-file-name "pnpm-lock.yaml" root)) "pnpm")
     ((file-exists-p (expand-file-name "yarn.lock" root)) "yarn")
     ((file-exists-p (expand-file-name "package-lock.json" root)) "npm")
     (t mcg-ts-package-manager))))

(defun mcg/ts-install ()
  "Run package install."
  (interactive)
  (let ((pm (mcg--ts-get-package-manager)))
    (compile (format "%s install" pm))))

(defun mcg/ts-add (package)
  "Add PACKAGE to dependencies."
  (interactive "sPackage name: ")
  (let ((pm (mcg--ts-get-package-manager)))
    (compile (format "%s add %s" pm package))))

(defun mcg/ts-add-dev (package)
  "Add PACKAGE to devDependencies."
  (interactive "sPackage name: ")
  (let ((pm (mcg--ts-get-package-manager)))
    (compile (format "%s add -D %s" pm package))))

(defun mcg/ts-run (script)
  "Run npm SCRIPT."
  (interactive "sScript name: ")
  (let ((pm (mcg--ts-get-package-manager)))
    (compile (format "%s run %s" pm script))))

(defun mcg/ts-test ()
  "Run test script."
  (interactive)
  (let ((pm (mcg--ts-get-package-manager)))
    (compile (format "%s test" pm))))

(defun mcg/ts-build ()
  "Run build script."
  (interactive)
  (let ((pm (mcg--ts-get-package-manager)))
    (compile (format "%s run build" pm))))
#+end_src

** TypeScript Keybindings

TypeScript 模式的快捷键配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; TypeScript Keybindings
;;; ============================================================

(defvar mcg-typescript-mode-map
  (let ((map (make-sparse-keymap)))
    ;; Biome commands
    (define-key map (kbd "C-c C-f") #'mcg/biome-format)
    (define-key map (kbd "C-c C-l") #'mcg/biome-lint)
    (define-key map (kbd "C-c C-x") #'mcg/biome-check-fix)
    ;; Package manager commands
    (define-key map (kbd "C-c C-p i") #'mcg/ts-install)
    (define-key map (kbd "C-c C-p a") #'mcg/ts-add)
    (define-key map (kbd "C-c C-p d") #'mcg/ts-add-dev)
    (define-key map (kbd "C-c C-p r") #'mcg/ts-run)
    ;; Build/Test
    (define-key map (kbd "C-c C-t") #'mcg/ts-test)
    (define-key map (kbd "C-c C-b") #'mcg/ts-build)
    map)
  "Keymap for TypeScript-specific commands.")

(defun mcg-typescript-setup-keybindings ()
  "Setup TypeScript-specific keybindings."
  (use-local-map (make-composed-keymap mcg-typescript-mode-map (current-local-map))))

;; Keybindings setup via hooks
(when (mcg-treesit-available-p)
  (add-hook 'typescript-ts-mode-hook #'mcg-typescript-setup-keybindings)
  (add-hook 'tsx-ts-mode-hook #'mcg-typescript-setup-keybindings)
  (add-hook 'js-ts-mode-hook #'mcg-typescript-setup-keybindings))
#+end_src

** Help Command

TypeScript 帮助命令，显示快捷键和使用说明。

#+begin_src emacs-lisp
;;; ============================================================
;;; Help Command
;;; ============================================================

(defun mcg/typescript-help ()
  "Show TypeScript keybindings and command help."
  (interactive)
  (with-help-window "*MCG TypeScript Help*"
    (princ "
╔═══════════════════════════════════════════╗
║       MCG TypeScript Keybindings          ║
╚═══════════════════════════════════════════╝

BIOME COMMANDS:
  C-c C-f      - biome format
  C-c C-l      - biome lint
  C-c C-x      - biome check --write

PACKAGE MANAGER:
  C-c C-p i    - Install dependencies
  C-c C-p a    - Add package
  C-c C-p d    - Add dev package
  C-c C-p r    - Run script

BUILD/TEST:
  C-c C-t      - Run tests
  C-c C-b      - Run build

LSP COMMANDS (via lsp-bridge):
  M-.          - Go to definition
  M-,          - Return from definition
  M-?          - Find references
  C-c r r      - Rename symbol
  C-c r f      - Format buffer

═══════════════════════════════════════════

INSTALLATION:
  npm install -g @biomejs/biome typescript

═══════════════════════════════════════════
")))
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-typescript)
;;; init-typescript.el ends here
#+end_src
