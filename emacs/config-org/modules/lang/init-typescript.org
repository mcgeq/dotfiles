* init-typescript.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-typescript.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; init-typescript.el --- TypeScript/JavaScript Support for MCG Emacs -*- lexical-binding: t; -*-

  ;; Filename: init-typescript.el
  ;; Description: TypeScript/JavaScript language support module
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024-2026, mcge, all rights reserved.
  ;; Create   Date: 2026-01-07
  ;; Version: 3.0
  ;; Keywords: typescript, javascript, tsx, jsx, biome
  ;; Compatibility: GNU Emacs 29.0+

  ;;; Commentary:
  ;;
  ;; TypeScript/JavaScript language support module for MCG Emacs, providing:
  ;; - typescript-ts-mode / tsx-ts-mode / js-ts-mode configuration
  ;; - Biome formatting and lint (replaces ESLint + Prettier)
  ;; - LSP integration (via +lsp module)
  ;; - Node.js run support
  ;; - React/JSX support
  ;;
  ;; Module metadata:
  ;; :depends (+lsp)
  ;; :defer t
  ;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)

;; Ensure +lsp module is loaded
(when (and (boundp 'mcg-module-enabled-p)
           (fboundp 'mcg-module-enabled-p)
           (mcg-module-enabled-p :lang 'lsp))
  (require '+lsp nil t))

#+END_SRC

** TypeScript Mode Configuration
#+BEGIN_SRC emacs-lisp
;;; TypeScript Basic Configuration

;; Indentation settings
(setq typescript-indent-level 2
      js-indent-level 2)

;; Force use of tree-sitter version
(when (and (fboundp 'treesit-available-p)
           (treesit-available-p))
  ;; Mode remapping
  (add-to-list 'major-mode-remap-alist '(typescript-mode . typescript-ts-mode))
  (add-to-list 'major-mode-remap-alist '(js-mode . js-ts-mode))
  (add-to-list 'major-mode-remap-alist '(tsx-mode . tsx-ts-mode))
  
  ;; TypeScript file associations
  (add-to-list 'auto-mode-alist '("\\.ts\\'" . typescript-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.tsx\\'" . tsx-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.mts\\'" . typescript-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.cts\\'" . typescript-ts-mode))
  
  ;; JavaScript file associations
  (add-to-list 'auto-mode-alist '("\\.js\\'" . js-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.jsx\\'" . js-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.mjs\\'" . js-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.cjs\\'" . js-ts-mode)))

;; Enable JSX syntax highlighting
(setq js-jsx-syntax t)

#+END_SRC

** Biome Integration
#+BEGIN_SRC emacs-lisp
;;; Biome Formatting and Lint (recommended, replaces ESLint + Prettier)

(defun mcg-ts-format-with-biome ()
  "Format code using Biome."
  (interactive)
  (if (executable-find "biome")
      (let ((output-buffer (get-buffer-create "*biome*")))
        (if (zerop (call-process-region (point-min) (point-max) "biome" nil output-buffer nil
                                        "format" "--stdin-file-path" (buffer-file-name)))
            (progn
              (erase-buffer)
              (insert-buffer-substring output-buffer)
              (message "Formatted with Biome"))
          (message "Biome formatting failed. Check *biome* buffer")))
    (message "Biome not found. Install with: npm install -g @biomejs/biome")))

(defun mcg/ts-check-with-biome ()
  "Check code using Biome (lint + format)."
  (interactive)
  (if (executable-find "biome")
      (let ((compilation-scroll-output t))
        (compile (format "biome check %s" (buffer-file-name))))
    (message "Biome not found. Install with: npm install -g @biomejs/biome")))

(defun mcg/ts-fix-with-biome ()
  "Auto-fix code using Biome."
  (interactive)
  (if (executable-find "biome")
      (let ((file (buffer-file-name)))
        (when (zerop (call-process "biome" nil nil nil "check" "--apply" file))
          (revert-buffer t t t)
          (message "Fixed with Biome")))
    (message "Biome not found")))

#+END_SRC

** Prettier Integration (Fallback)
#+BEGIN_SRC emacs-lisp
;;; Prettier Formatting (Fallback)

(defun mcg-ts-format-with-prettier ()
  "Format code using Prettier."
  (interactive)
  (if (executable-find "prettier")
      (let* ((temp-file (make-temp-file "prettier" nil
                                        (concat "." (file-name-extension (buffer-file-name)))))
             (output-buffer (get-buffer-create "*prettier*")))
        (write-region (point-min) (point-max) temp-file)
        (if (zerop (call-process "prettier" nil output-buffer nil
                                 "--write" temp-file))
            (progn
              (erase-buffer)
              (insert-file-contents temp-file)
              (delete-file temp-file)
              (message "Formatted with Prettier"))
          (message "Prettier formatting failed")))
    (message "Prettier not found. Install with: npm install -g prettier")))

(defun mcg-ts-format-buffer ()
  "Format TypeScript/JavaScript code (prefer Biome)."
  (interactive)
  (cond
   ((executable-find "biome") (mcg-ts-format-with-biome))
   ((executable-find "prettier") (mcg-ts-format-with-prettier))
   (t (message "No formatter found. Install biome or prettier"))))

#+END_SRC

** Node.js Support
#+BEGIN_SRC emacs-lisp
;;; Node.js Support

(defun mcg/ts-run-node ()
  "Run current file using Node.js."
  (interactive)
  (if (executable-find "node")
      (let ((compilation-scroll-output t))
        (compile (format "node %s" (buffer-file-name))))
    (message "Node.js not found")))

(defun mcg/ts-run-npm-script ()
  "Run npm script."
  (interactive)
  (if (executable-find "npm")
      (let* ((package-json (locate-dominating-file default-directory "package.json"))
             (default-directory (or package-json default-directory))
             (scripts (mcg--ts-get-npm-scripts))
             (script (completing-read "Run npm script: " scripts)))
        (compile (format "npm run %s" script)))
    (message "npm not found")))

(defun mcg--ts-get-npm-scripts ()
  "Get scripts from package.json."
  (when-let* ((package-json (locate-dominating-file default-directory "package.json"))
              (json-file (expand-file-name "package.json" package-json)))
    (when (file-exists-p json-file)
      (let* ((json-object-type 'hash-table)
             (json (json-read-file json-file))
             (scripts (gethash "scripts" json)))
        (when scripts
          (hash-table-keys scripts))))))

#+END_SRC

** Import Management
#+BEGIN_SRC emacs-lisp
;;; Import Management and Code Actions

(defun mcg/ts-organize-imports ()
  "Organize imports (requires LSP support)."
  (interactive)
  (if (and (fboundp 'lsp-bridge-code-action)
           (bound-and-true-p lsp-bridge-mode))
      (lsp-bridge-code-action "source.organizeImports")
    (message "LSP not active")))

(defun mcg/ts-remove-unused ()
  "Remove unused imports and variables."
  (interactive)
  (if (and (fboundp 'lsp-bridge-code-action)
           (bound-and-true-p lsp-bridge-mode))
      (lsp-bridge-code-action "source.removeUnused")
    (message "LSP not active")))

(defun mcg/ts-fix-all ()
  "Auto-fix all fixable issues."
  (interactive)
  (if (and (fboundp 'lsp-bridge-code-action)
           (bound-and-true-p lsp-bridge-mode))
      (lsp-bridge-code-action "source.fixAll")
    (message "LSP not active")))

#+END_SRC

** React/JSX Support
#+BEGIN_SRC emacs-lisp
;;; React/JSX Support

(defun mcg/ts-insert-component ()
  "Insert React component template."
  (interactive)
  (let ((component-name (read-string "Component name: ")))
    (insert (format "import React from 'react';\n\n"))
    (insert (format "interface %sProps {\n  \n}\n\n" component-name))
    (insert (format "export const %s: React.FC<%sProps> = (props) => {\n"
                    component-name component-name))
    (insert "  return (\n    <div>\n      \n    </div>\n  );\n};\n")))

(defun mcg/ts-insert-interface ()
  "Create TypeScript interface."
  (interactive)
  (let ((name (read-string "Interface name: ")))
    (insert (format "interface %s {\n  \n}\n" name))
    (forward-line -2)
    (end-of-line)))

(defun mcg/ts-insert-type ()
  "Create TypeScript type alias."
  (interactive)
  (let ((name (read-string "Type name: ")))
    (insert (format "type %s = \n" name))
    (backward-char 1)))

#+END_SRC

** Console Log Helper
#+BEGIN_SRC emacs-lisp
;;; Console.log Helper

(defun mcg/ts-insert-console-log ()
  "Insert console.log statement."
  (interactive)
  (let ((var-name (if (use-region-p)
                      (buffer-substring-no-properties (region-beginning) (region-end))
                    (read-string "Variable to log: "))))
    (end-of-line)
    (newline-and-indent)
    (insert (format "console.log('%s:', %s);" var-name var-name))))

(defun mcg/ts-remove-console-logs ()
  "Remove all console.log statements."
  (interactive)
  (save-excursion
    (goto-char (point-min))
    (let ((count 0))
      (while (re-search-forward "^.*console\\.log.*$" nil t)
        (delete-region (line-beginning-position) (1+ (line-end-position)))
        (setq count (1+ count)))
      (message "Removed %d console.log statement(s)" count))))

#+END_SRC

** Project Detection
#+BEGIN_SRC emacs-lisp
;;; Project Detection

(defun mcg-ts-project-p ()
  "Detect if current project is a TypeScript/JavaScript project."
  (when-let ((project-root (when (project-current)
                             (project-root (project-current)))))
    (or (file-exists-p (expand-file-name "package.json" project-root))
        (file-exists-p (expand-file-name "tsconfig.json" project-root))
        (file-exists-p (expand-file-name "jsconfig.json" project-root)))))

(defun mcg-ts-is-react-project-p ()
  "Detect if current project is a React project."
  (when-let* ((project-root (when (project-current)
                              (project-root (project-current))))
              (package-json (expand-file-name "package.json" project-root)))
    (when (file-exists-p package-json)
      (with-temp-buffer
        (insert-file-contents package-json)
        (or (search-forward "\"react\"" nil t)
            (search-forward "\"next\"" nil t))))))

#+END_SRC

** Keybindings
#+BEGIN_SRC emacs-lisp
;;; Keybindings Configuration

(defun mcg-ts-setup-keybindings ()
  "Setup TypeScript/JavaScript mode keybindings."
  ;; Formatting and checking
  (local-set-key (kbd "C-c r f") #'mcg-ts-format-buffer)
  (local-set-key (kbd "C-c b") #'mcg/ts-check-with-biome)
  (local-set-key (kbd "C-c B") #'mcg/ts-fix-with-biome)
  
  ;; Code actions
  (local-set-key (kbd "C-c i") #'mcg/ts-organize-imports)
  (local-set-key (kbd "C-c u") #'mcg/ts-remove-unused)
  (local-set-key (kbd "C-c x") #'mcg/ts-fix-all)
  
  ;; Run
  (local-set-key (kbd "C-c r r") #'mcg/ts-run-node)
  (local-set-key (kbd "C-c n") #'mcg/ts-run-npm-script)
  
  ;; Code generation
  (local-set-key (kbd "C-c c") #'mcg/ts-insert-component)
  (local-set-key (kbd "C-c t i") #'mcg/ts-insert-interface)
  (local-set-key (kbd "C-c t t") #'mcg/ts-insert-type)
  
  ;; Console.log
  (local-set-key (kbd "C-c C-l") #'mcg/ts-insert-console-log)
  (local-set-key (kbd "C-c C-k") #'mcg/ts-remove-console-logs))

(add-hook 'typescript-mode-hook #'mcg-ts-setup-keybindings)
(add-hook 'typescript-ts-mode-hook #'mcg-ts-setup-keybindings)
(add-hook 'tsx-ts-mode-hook #'mcg-ts-setup-keybindings)
(add-hook 'js-mode-hook #'mcg-ts-setup-keybindings)
(add-hook 'js-ts-mode-hook #'mcg-ts-setup-keybindings)

#+END_SRC

** Tool Status Check
#+BEGIN_SRC emacs-lisp
;;; Tool Status Check

(defun mcg/ts-check-tools ()
  "Check if TypeScript/JavaScript development tools are installed."
  (interactive)
  (let ((tools '(("node" . "Install Node.js")
                 ("npm" . "Installed with Node.js")
                 ("biome" . "npm install -g @biomejs/biome")
                 ("prettier" . "npm install -g prettier")
                 ("typescript-language-server" . "npm install -g typescript-language-server")
                 ("tsc" . "npm install -g typescript"))))
    (with-help-window "*TypeScript Tools Status*"
      (princ "═══════════════════════════════════════════\n")
      (princ "   TypeScript/JavaScript Development Tools Status\n")
      (princ "═══════════════════════════════════════════\n\n")
      (dolist (tool tools)
        (let ((name (car tool))
              (install-cmd (cdr tool)))
          (princ (format "%-28s %s\n"
                         name
                         (if (executable-find name)
                             "✓ Installed"
                           (format "✗ Not installed (%s)" install-cmd))))))
      (princ "\n═══════════════════════════════════════════\n")
      (princ "\nRecommended install commands:\n")
      (princ "  npm install -g typescript typescript-language-server\n")
      (princ "  npm install -g @biomejs/biome\n")
      (princ "\nOr using pnpm:\n")
      (princ "  pnpm add -g typescript typescript-language-server @biomejs/biome\n"))))

#+END_SRC

** Keybindings Summary
#+BEGIN_SRC emacs-lisp
;;; Keybindings Summary

;; Formatting and checking:
;; C-c r f   - Format code (Biome or Prettier)
;; C-c b     - Biome check (lint + format)
;; C-c B     - Biome auto-fix
;;
;; Code actions:
;; C-c i     - Organize imports
;; C-c u     - Remove unused imports/variables
;; C-c x     - Auto-fix all issues
;;
;; Run:
;; C-c r r   - Run Node.js
;; C-c n     - Run npm script
;;
;; Code generation:
;; C-c c     - Insert React component template
;; C-c t i   - Create interface
;; C-c t t   - Create type alias
;; C-c C-l   - Insert console.log
;; C-c C-k   - Remove all console.log
;;
;; LSP (provided by +lsp module):
;; M-.       - Jump to definition
;; M-,       - Return
;; M-?       - Find references
;; C-c r r   - Rename (note: conflicts with run, use LSP's C-c r r)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-typescript)
;;; init-typescript.el ends here
#+END_SRC
