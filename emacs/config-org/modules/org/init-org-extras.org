* init-org-extras.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-org-extras.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
;;; init-org-extras.el --- Org Extras for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-org-extras.el
;; Description: Org extensions module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: org, download, numbering, consult-todo
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Org extensions module for MCG Emacs, responsible for:
;; - Org-download image downloading
;; - Org-numbering heading numbering
;; - Consult-todo integration
;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)

#+END_SRC

** Org-Download Configuration
#+BEGIN_SRC emacs-lisp
;;; Org-Download Configuration

(defun mcg--setup-org-download ()
  "Setup Org-download image downloading."
  (when (mcg-require-extension "org/org-download" 'org-download)
    ;; Drag-and-drop support
    (add-hook 'dired-mode-hook 'org-download-enable)
    (add-hook 'org-mode-hook 'org-download-enable)
    
    ;; Display settings
    (setq org-download-display-inline-images 'posframe)
    
    (mcg-log "Org-download configured")))

#+END_SRC

** Clipboard Image Function
#+BEGIN_SRC emacs-lisp
;;; Clipboard Image Function

(defun mcg/org-insert-clipboard-image (width)
  "Insert image from clipboard into Org file.
WIDTH is the image width, default 800.
Images are saved in a .assets directory named after the Org file."
  (interactive (list
                (read-string (format "Input image width, default is 800: ")
                             nil nil "800")))
  ;; Set the folder location for storing images
  (let* ((foldername (concat (file-name-base (buffer-file-name)) ".assets/"))
         (imgName (concat "img_" (format-time-string "%Y%m%d_%H%M%S") ".png"))
         (relativeFilename (concat (file-name-base (buffer-name)) ".assets/" imgName)))
    
    ;; Create directory
    (unless (file-exists-p foldername)
      (mkdir foldername))
    
    ;; Set screenshot command based on operating system
    (cond
     ((eq system-type 'windows-nt)
      (setq org-download-screenshot-method
            (concat "magick clipboard: " relativeFilename)))
     ((eq system-type 'gnu/linux)
      (setq org-download-screenshot-method
            (concat "xclip -selection clipboard -t image/png -o > " relativeFilename)))
     ((eq system-type 'darwin)
      (setq org-download-screenshot-method
            (concat "pngpaste " relativeFilename))))
    
    ;; Insert image link
    (insert (concat "\n#+DOWNLOADED: screenshot @ "
                    (format-time-string "%Y-%m-%d %a %H:%M:%S" (current-time))
                    "\n#+CAPTION: \n#+ATTR_ORG: :width "
                    width
                    "\n#+ATTR_LATEX: :width "
                    (if (>= (/ (string-to-number width) 800.0) 1.0)
                        "1.0"
                      (number-to-string (/ (string-to-number width) 800.0)))
                    "\\linewidth :float nil\n"
                    "#+ATTR_HTML: :width "
                    width
                    "\n[[file:" relativeFilename "]]\n"))
    
    ;; Execute screenshot
    (when (fboundp 'org-download-screenshot)
      (org-download-screenshot))))

;; 绑定快捷键
(with-eval-after-load 'org
  (define-key org-mode-map (kbd "C-c n v") 'mcg/org-insert-clipboard-image))

#+END_SRC

** Org-Numbering Configuration
#+BEGIN_SRC emacs-lisp
;;; Org-Numbering Configuration

(defun mcg--setup-org-numbering ()
  "Setup Org-numbering heading numbering."
  (when (mcg-require-extension "org/org-numbering" 'org-numbering)
    ;; Numbering scheme
    (setq org-numbering-level-scheme
          '((1 . ((scheme . decimal)      ; 1, 2, 3...
                  (combine . nil)))
            (2 . ((scheme . decimal)      ; 1.1, 1.2...
                  (combine . t)))
            (3 . ((scheme . decimal)      ; 1.1.1, 1.1.2...
                  (combine . t)))
            (4 . ((scheme . alpha)        ; a), b), c)...
                  (combine . nil)))
            (5 . ((scheme . paren-num)    ; (1), (2), (3)...
                  (combine . nil)))))
    
    (mcg-log "Org-numbering configured")))

#+END_SRC

** Consult-Todo Configuration
#+BEGIN_SRC emacs-lisp
;;; Consult-Todo Configuration

(defun mcg--setup-consult-todo ()
  "Setup Consult-todo integration."
  (when (mcg-require-extension "org/consult-todo" 'consult-todo)
    ;; Bind keybindings
    (global-set-key (kbd "C-c n T") 'consult-todo)
    
    (mcg-log "Consult-todo configured")))

#+END_SRC

** Org Mode Keybindings
#+BEGIN_SRC emacs-lisp
;;; Org Mode Keybindings

(defun mcg--setup-org-extras-keybindings ()
  "Setup Org extensions keybindings."
  (with-eval-after-load 'org
    (define-key org-mode-map (kbd "C-c n e") 'org-edit-src-code)
    (define-key org-mode-map (kbd "C-c n h") 'org-insert-heading)
    (define-key org-mode-map (kbd "C-c n s") 'org-insert-subheading))
  
  (mcg-log "Org extras keybindings configured"))

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

(mcg--setup-org-download)
(mcg--setup-org-numbering)
(mcg--setup-consult-todo)
(mcg--setup-org-extras-keybindings)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-org-extras)
;;; init-org-extras.el ends here
#+END_SRC
