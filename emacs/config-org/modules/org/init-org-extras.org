#+TITLE: Org Extras Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-org-extras.el :lexical t

* Org Extras Module

本模块负责 MCG Emacs 的 Org 扩展功能配置，包括：
- Org-download 图片下载
- Consult-todo 集成
- 中国农历 (cal-china-x) 集成
- 剪贴板图片插入功能

** File Header

#+begin_src emacs-lisp
;;; init-org-extras.el --- Org Extras for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-org-extras.el
;; Description: Org extensions module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: org, download, numbering, consult-todo, cal-china-x
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Org extensions module for MCG Emacs, responsible for:
;; - Org-download image downloading
;; - Consult-todo integration
;; - Chinese calendar (cal-china-x) integration
;;
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

;;; Dependencies

(require 'core-lib)
#+end_src

** Org-Download Configuration

Org-download 图片下载配置。

#+begin_src emacs-lisp
;;; Org-Download Configuration

(defun mcg--setup-org-download ()
  "Setup Org-download image downloading."
  (with-eval-after-load 'org
    (when (mcg-require-extension "org-download" 'org-download)
      ;; Drag-and-drop support
      (add-hook 'dired-mode-hook 'org-download-enable)
      (add-hook 'org-mode-hook 'org-download-enable)

      ;; Display settings
      (setq org-download-display-inline-images 'posframe)

      (mcg-log "Org-download configured")))
#+end_src

** Clipboard Image Function

剪贴板图片插入功能。

#+begin_src emacs-lisp
;;; Clipboard Image Function

(defun mcg/org-insert-clipboard-image (width)
  "Insert image from clipboard into Org file.
WIDTH is the image width, default 800.
Images are saved in a .assets directory named after the Org file."
  (interactive (list
                (read-string (format "Input image width, default is 800: ")
                             nil nil "800")))
  ;; Set the folder location for storing images
  (let* ((foldername (concat (file-name-base (buffer-file-name)) ".assets/"))
         (imgName (concat "img_" (format-time-string "%Y%m%d_%H%M%S") ".png"))
         (relativeFilename (concat (file-name-base (buffer-name)) ".assets/" imgName)))
    
    ;; Create directory
    (unless (file-exists-p foldername)
      (mkdir foldername))
    
    ;; Set screenshot command based on operating system
    (cond
     ((eq system-type 'windows-nt)
      (setq org-download-screenshot-method
            (concat "magick clipboard: " relativeFilename)))
     ((eq system-type 'gnu/linux)
      (setq org-download-screenshot-method
            (concat "xclip -selection clipboard -t image/png -o > " relativeFilename)))
     ((eq system-type 'darwin)
      (setq org-download-screenshot-method
            (concat "pngpaste " relativeFilename))))
    
    ;; Insert image link
    (insert (concat "\n#+DOWNLOADED: screenshot @ "
                    (format-time-string "%Y-%m-%d %a %H:%M:%S" (current-time))
                    "\n#+CAPTION: \n#+ATTR_ORG: :width "
                    width
                    "\n#+ATTR_LATEX: :width "
                    (if (>= (/ (string-to-number width) 800.0) 1.0)
                        "1.0"
                      (number-to-string (/ (string-to-number width) 800.0)))
                    "\\linewidth :float nil\n"
                    "#+ATTR_HTML: :width "
                    width
                    "\n[[file:" relativeFilename "]]\n"))
    
    ;; Execute screenshot
    (when (fboundp 'org-download-screenshot)
      (org-download-screenshot))))

;; Bind keybinding
(with-eval-after-load 'org
  (define-key org-mode-map (kbd "C-c n v") 'mcg/org-insert-clipboard-image))
#+end_src

** Cal-China-X Configuration

中国农历 (cal-china-x) 配置。

#+begin_src emacs-lisp
;;; Cal-China-X Configuration (Chinese Calendar)

(defun mcg--setup-cal-china-x ()
  "Setup Chinese calendar (cal-china-x)."
  (with-eval-after-load 'org-agenda
    (when (mcg-require-extension "cal-china-x" 'cal-china-x)
      (with-eval-after-load 'calendar
        ;; Mark today
        (add-hook 'calendar-today-visible-hook 'calendar-mark-today)

        ;; Calendar basic settings
        (setq calendar-chinese-all-holidays-flag nil
              calendar-mark-holidays-flag t
              calendar-mark-diary-entries-flag nil
              calendar-time-zone-style 'numeric
              calendar-date-style 'iso)

        ;; Set Chinese celestial stems and terrestrial branches
        (setq calendar-chinese-celestial-stem
              ["甲" "乙" "丙" "丁" "戊" "己" "庚" "辛" "壬" "癸"])
        (setq calendar-chinese-terrestrial-branch
              ["子" "丑" "寅" "卯" "辰" "巳" "午" "未" "申" "酉" "戌" "亥"])

        ;; Set Chinese month names
        (setq calendar-month-name-array
              ["一月" "二月" "三月" "四月" "五月" "六月"
               "七月" "八月" "九月" "十月" "十一月" "十二月"])

        ;; Set weekday header display
        (setq calendar-day-name-array
              ["日" "一" "二" "三" "四" "五" "六"])

        ;; Set Monday as first day of week
        (setq calendar-week-start-day 1))

      ;; Auto-initialize cal-china-x
      (add-hook 'after-init-hook 'cal-china-x-setup)

      (mcg-log "Chinese calendar (cal-china-x) configured"))))
#+end_src

** Consult-Todo Configuration

Consult-todo 集成配置。

#+begin_src emacs-lisp
;;; Consult-Todo Configuration

(defun mcg--setup-consult-todo ()
  "Setup Consult-todo integration."
  (with-eval-after-load 'org
    (when (mcg-require-extension "consult-todo" 'consult-todo)
      ;; Bind keybindings
      (global-set-key (kbd "C-c n T") 'consult-todo)

      (mcg-log "Consult-todo configured"))))
#+end_src

** Org Mode Keybindings

Org 扩展快捷键配置。

#+begin_src emacs-lisp
;;; Org Mode Keybindings

(defun mcg--setup-org-extras-keybindings ()
  "Setup Org extensions keybindings."
  (with-eval-after-load 'org
    (define-key org-mode-map (kbd "C-c n e") 'org-edit-src-code)
    (define-key org-mode-map (kbd "C-c n h") 'org-insert-heading)
    (define-key org-mode-map (kbd "C-c n s") 'org-insert-subheading))
  
  (mcg-log "Org extras keybindings configured"))
#+end_src

** Initialize

初始化配置。

#+begin_src emacs-lisp
;;; Initialize

;; Setup hooks instead of immediate loading
(add-hook 'org-mode-hook #'mcg--setup-org-download)
(add-hook 'org-agenda-mode-hook #'mcg--setup-cal-china-x)
(add-hook 'org-mode-hook #'mcg--setup-consult-todo)
(mcg--setup-org-extras-keybindings)
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-org-extras)
;;; init-org-extras.el ends here
#+end_src
