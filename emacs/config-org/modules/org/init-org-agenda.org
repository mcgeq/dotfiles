* init-org-agenda.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-org-agenda.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
;;; init-org-agenda.el --- Org Agenda Configuration for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-org-agenda.el
;; Description: Org Agenda configuration module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: org, agenda, calendar
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Org Agenda configuration module for MCG Emacs, responsible for:
;; - Agenda files and view configuration
;; - Time grid and schedule display
;; - Date formatting (including lunar calendar support)
;; - Sunrise/sunset functions
;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)
(require 'org-agenda)
(require 'cal-china-x nil t)

#+END_SRC

** Variables
#+BEGIN_SRC emacs-lisp
;;; Variables

(defvar mcg-org-agenda-files
  (list (expand-file-name "agenda" mcg-org-directory))
  "Org agenda file list or directories to scan.")

(defvar mcg-org-agenda-diary-file
  (expand-file-name "diary.org" (expand-file-name "agenda" mcg-org-directory))
  "Org agenda diary file.")

(defvar mcg-calendar-location-longitude 116.9962
  "Current location longitude (for sunrise/sunset calculation).")

(defvar mcg-calendar-location-latitude 39.91
  "Current location latitude (for sunrise/sunset calculation).")

#+END_SRC

** Agenda Files Configuration
#+BEGIN_SRC emacs-lisp
;;; Agenda files and basic configuration

(defun mcg-org-agenda-setup-files ()
  "Setup Org Agenda file configuration."
  (setq org-agenda-files mcg-org-agenda-files)
  (setq org-agenda-use-time-grid t)
  (setq org-agenda-current-time-string "⏰------------now")
  
  (mcg-log "Configured org-agenda files"))

#+END_SRC

** Date Format with Lunar Calendar
#+BEGIN_SRC emacs-lisp
;;; Date formatting (with lunar calendar)

(defun mcg-org-agenda-format-date-aligned (date)
  "Format DATE for agenda display, including lunar calendar info."
  (require 'cal-iso)
  (let* ((dayname (if (boundp 'cal-china-x-days)
                      (aref cal-china-x-days (calendar-day-of-week date))
                    (aref ["日" "一" "二" "三" "四" "五" "六"]
                          (calendar-day-of-week date))))
         (day (cadr date))
         (month (car date))
         (year (nth 2 date))
         (day-of-week (calendar-day-of-week date))
         (iso-week (org-days-to-iso-week
                    (calendar-absolute-from-gregorian date)))
         ;; 农历计算
         (cn-date (calendar-chinese-from-absolute
                   (calendar-absolute-from-gregorian date)))
         (cn-month (cl-caddr cn-date))
         (cn-day (cl-cadddr cn-date))
         (cn-month-string (if (and (boundp 'cal-china-x-month-name)
                                   (< (1- (floor cn-month)) 12))
                              (concat (aref cal-china-x-month-name
                                            (1- (floor cn-month)))
                                      (if (integerp cn-month) "" "（闰月）"))
                            ""))
         (cn-day-string (if (and (boundp 'cal-china-x-day-name)
                                 (< (1- cn-day) 30))
                            (aref cal-china-x-day-name (1- cn-day))
                          ""))
         ;; 计算今年第几天
         (absolute-date (calendar-absolute-from-gregorian date))
         (start-of-year (calendar-absolute-from-gregorian (list 1 1 year)))
         (day-of-year (+ 1 (- absolute-date start-of-year)))
         (extra (format " 农历%s%s%s 今年第 %02d 周 第%03d 天"
                        cn-month-string
                        cn-day-string
                        (if (integerp cn-month) "" "[闰]")
                        iso-week
                        day-of-year)))
    (format "%04d-%02d-%02d 星期%s%s\n"
            year month day dayname extra)))

(defun mcg-org-agenda-setup-date-format ()
  "Setup Agenda date format."
  (setq org-agenda-format-date 'mcg-org-agenda-format-date-aligned)
  (mcg-log "Configured org-agenda date format"))

#+END_SRC

** Time Grid Configuration
#+BEGIN_SRC emacs-lisp
;;; Time grid configuration

(defun mcg-org-agenda-setup-time-grid ()
  "Setup Agenda time grid."
  ;; Eight-part time periods
  ;; 1: 0-3 midnight  2: 3-6 dawn  3: 6-9 morning  4: 9-12 forenoon
  ;; 5: 12-15 afternoon  6: 15-18 late afternoon  7: 18-21 evening  8: 21-24 night
  (setq org-agenda-time-grid
        '((daily today require-timed)
          (300 600 900 1200 1500 1800 2100 2400)
          "......"
          "-----------------------------------------------------"))
  
  (mcg-log "Configured org-agenda time grid"))

#+END_SRC

** Display and Format Settings
#+BEGIN_SRC emacs-lisp
;;; Display and format settings

(defun mcg-org-agenda-setup-display ()
  "Setup Agenda display format."
  ;; Diary integration
  (setq org-agenda-include-diary t
        org-agenda-diary-file mcg-org-agenda-diary-file
        diary-file mcg-org-agenda-diary-file)
  
  ;; Agenda view prefix settings
  (setq org-agenda-prefix-format
        '((agenda . " %i %-25:c %5t %s")
          (todo   . " %i %-25:c ")
          (tags   . " %i %-25:c ")
          (search . " %i %-25:c ")))
  
  ;; Scheduled task display
  (setq org-agenda-scheduled-leaders
        '("Scheduled " "Should have started %02d days ago "))
  
  ;; Deadline display
  (setq org-agenda-deadline-leaders
        '("Deadline " "%02d days until deadline " "Overdue by %02d days "))
  
  ;; Timestamp format
  (setq org-time-stamp-formats '("<%Y-%m-%d %A>" . "<%Y-%m-%d %A %H:%M>"))
  
  ;; Other display settings
  (setq org-cycle-separator-lines 2
        org-agenda-insert-diary-extract-time t
        org-agenda-sticky t
        org-agenda-time-leading-zero t
        org-agenda-tags-column -80
        org-deadline-warning-days 3)
  
  (mcg-log "Configured org-agenda display"))

#+END_SRC

** Location and Sunrise/Sunset
#+BEGIN_SRC emacs-lisp
;;; Location and sunrise/sunset

(defun mcg-org-agenda-setup-location ()
  "Setup geographic location."
  (setq calendar-longitude mcg-calendar-location-longitude
        calendar-latitude mcg-calendar-location-latitude)
  
  ;; Celestial stems and terrestrial branches configuration
  (setq calendar-chinese-celestial-stem
        ["甲" "乙" "丙" "丁" "戊" "己" "庚" "辛" "壬" "癸"]
        calendar-chinese-terrestrial-branch
        ["子" "丑" "寅" "卯" "辰" "巳" "午" "未" "申" "酉" "戌" "亥"])
  
  (mcg-log "Configured calendar location"))

(defun diary-sunrise ()
  "Get sunrise time."
  (let ((dss (diary-sunrise-sunset)))
    (with-temp-buffer
      (insert dss)
      (goto-char (point-min))
      (while (re-search-forward " ([^)]*)" nil t)
        (replace-match "" nil nil))
      (goto-char (point-min))
      (search-forward ",")
      (buffer-substring (point-min) (match-beginning 0)))))

(defun diary-sunset ()
  "Get sunset time."
  (let ((dss (diary-sunrise-sunset))
        start end)
    (with-temp-buffer
      (insert dss)
      (goto-char (point-min))
      (while (re-search-forward " ([^)]*)" nil t)
        (replace-match "" nil nil))
      (goto-char (point-min))
      (search-forward ", ")
      (setq start (match-end 0))
      (search-forward " at")
      (setq end (match-beginning 0))
      (goto-char start)
      (capitalize-word 1)
      (buffer-substring start end))))

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

(mcg-org-agenda-setup-files)
(mcg-org-agenda-setup-date-format)
(mcg-org-agenda-setup-time-grid)
(mcg-org-agenda-setup-display)
(mcg-org-agenda-setup-location)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-org-agenda)
;;; init-org-agenda.el ends here
#+END_SRC
