#+TITLE: Org Babel Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-org-babel.el :lexical t

* Org Babel Module

本模块负责 MCG Emacs 的 Org Babel 配置，包括：
- 多语言代码块执行支持
- 自定义语言扩展（如 Zig）
- 代码块结果处理和导出
- 安全和性能优化

** File Header

#+begin_src emacs-lisp
;;; init-org-babel.el --- Org Babel Configuration for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-org-babel.el
;; Description: Org Babel code execution configuration module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: org, babel, literate-programming
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Org Babel configuration module for MCG Emacs, responsible for:
;; - Multi-language code block execution support
;; - Custom language extensions (e.g., Zig)
;; - Code block result handling and export
;; - Security and performance optimization
;;
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

;;; Dependencies

(require 'core-lib)
(require 'org)
(require 'ob-core)
(require 'ob-tangle)
#+end_src

** Org Babel Basic Configuration

基本配置，包括代码块执行确认、字体高亮、缩进等设置。

#+begin_src emacs-lisp
;;; Org Babel Basic Configuration

(defun mcg-org-babel-setup-basic ()
  "Setup Org Babel basic configuration."
  ;; Confirmation settings before executing code blocks
  (setq org-confirm-babel-evaluate nil
        org-src-fontify-natively t
        org-src-tab-acts-natively t
        org-src-preserve-indentation t
        org-edit-src-content-indentation 0)
  
  ;; Code block editing window settings
  (setq org-src-window-setup 'current-window)
  
  ;; Code block export settings
  (setq org-export-use-babel t
        org-export-babel-evaluate t)
  
  (mcg-log "Configured org-babel basic settings"))
#+end_src

** Language Support Configuration

配置 Org Babel 支持的编程语言。

#+begin_src emacs-lisp
;;; Language Support Configuration

(defun mcg-org-babel-setup-languages ()
  "Setup Org Babel language support."
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (shell . t)
     (python . t)
     (js . t)
     (C . t)
     (css . t)
     (dot . t)
     (org . t)
     (plantuml . t)
     (sql . t)))
  
  (mcg-log "Configured org-babel languages"))
#+end_src

** Default Code Block Arguments

代码块默认参数配置。

#+begin_src emacs-lisp
;;; Default Code Block Arguments

(defun mcg-org-babel-setup-defaults ()
  "Setup Org Babel default arguments."
  ;; Global default arguments
  (setq org-babel-default-header-args
        '((:session . "none")
          (:results . "replace")
          (:exports . "code")
          (:cache . "no")
          (:noweb . "no")
          (:hlines . "no")
          (:tangle . "no")))
  
  ;; Python default arguments
  (setq org-babel-default-header-args:python
        '((:results . "output")))
  
  ;; Shell default arguments
  (setq org-babel-default-header-args:shell
        '((:results . "output")))
  
  (mcg-log "Configured org-babel default arguments"))
#+end_src

** Zig Language Support

Zig 语言支持，包括代码块执行函数和默认参数。

*** Zig Default Header Args

#+begin_src emacs-lisp
;;; Zig Language Support

(defvar org-babel-default-header-args:zig '()
  "Default arguments for Zig code blocks.")
#+end_src

*** Zig Execute Function

#+begin_src emacs-lisp
(defun org-babel-execute:zig (body params)
  "Execute Zig code block.
BODY is the code content, PARAMS are the parameters."
  (let* ((tmp-src-file (org-babel-temp-file "zig-src-" ".zig"))
         (tmp-bin-file (org-babel-temp-file "zig-bin-"))
         (cmdline (cdr (assq :cmdline params)))
         (flags (cdr (assq :flags params)))
         (full-body (org-babel-expand-body:generic body params)))
    
    ;; Check if Zig is installed
    (unless (executable-find "zig")
      (error "Zig compiler not found"))
    
    ;; Write source file
    (with-temp-file tmp-src-file
      (insert full-body))
    
    ;; Compile and run
    (let ((compile-command
           (format "zig build-exe %s %s -femit-bin=%s"
                   (or flags "")
                   (org-babel-process-file-name tmp-src-file)
                   (org-babel-process-file-name tmp-bin-file)))
          (run-command
           (format "%s %s"
                   (org-babel-process-file-name tmp-bin-file)
                   (or cmdline ""))))
      
      (let ((compile-result (org-babel-eval compile-command "")))
        (if (string-match-p "error" compile-result)
            (concat "Compilation failed:\n" compile-result)
          (org-babel-eval run-command ""))))))
#+end_src

*** Zig Setup Function

#+begin_src emacs-lisp
(defun mcg-org-babel-setup-zig ()
  "Setup Zig language support."
  ;; Register Zig language
  (add-to-list 'org-babel-load-languages '(zig . t))
  
  ;; Zig default arguments
  (setq org-babel-default-header-args:zig
        '((:results . "output")
          (:exports . "both")))
  
  (mcg-log "Configured org-babel Zig support"))
#+end_src

** Helper Functions

辅助函数，用于执行、tangle 和管理代码块。

#+begin_src emacs-lisp
;;; Helper Functions

(defun mcg/org-babel-execute-buffer ()
  "Execute all code blocks in current buffer."
  (interactive)
  (org-babel-execute-buffer)
  (message "Executed all code blocks in buffer"))

(defun mcg/org-babel-tangle-and-compile ()
  "Tangle current file."
  (interactive)
  (org-babel-tangle)
  (message "Tangled file"))

(defun mcg/org-babel-remove-all-results ()
  "Remove all code block results in current buffer."
  (interactive)
  (org-babel-remove-result-one-or-many t)
  (message "Removed all results"))

(defun mcg/org-insert-src-block (lang)
  "Insert a code block for the specified language LANG."
  (interactive
   (list (completing-read "Language: "
                          '("emacs-lisp" "python" "shell" "zig"
                            "C" "js" "css" "sql")
                          nil nil)))
  (insert (format "#+begin_src %s\n\n#+end_src" lang))
  (forward-line -1))
#+end_src

** Keybindings

Org Babel 快捷键配置。

#+begin_src emacs-lisp
;;; Keybindings

(defun mcg-org-babel-setup-keybindings ()
  "Setup Org Babel keybindings."
  (with-eval-after-load 'org
    (define-key org-mode-map (kbd "C-c C-v C-b") #'mcg/org-babel-execute-buffer)
    (define-key org-mode-map (kbd "C-c C-v C-r") #'mcg/org-babel-remove-all-results)
    (define-key org-mode-map (kbd "C-c C-v i") #'mcg/org-insert-src-block))
  
  (mcg-log "Configured org-babel keybindings"))
#+end_src

** Initialize

初始化配置。

#+begin_src emacs-lisp
;;; Initialize

(mcg-org-babel-setup-basic)
(mcg-org-babel-setup-languages)
(mcg-org-babel-setup-defaults)
(mcg-org-babel-setup-zig)
(mcg-org-babel-setup-keybindings)
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-org-babel)
;;; init-org-babel.el ends here
#+end_src
