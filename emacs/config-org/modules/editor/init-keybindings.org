#+TITLE: Keybindings Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-keybindings.el :lexical t

* Keybindings Module

本模块负责 MCG Emacs 的快捷键配置，包括：
- 全局快捷键设置
- 快捷键参考文档
- 各功能模块的快捷键绑定

注意：Vundo 和 Markmacro 已移至独立模块：
- init-undo.el 用于可视化撤销 (vundo)
- init-multicursor.el 用于多光标编辑 (markmacro)

** File Header

#+begin_src emacs-lisp
;;; init-keybindings.el --- Keybindings for MCG Emacs -*- lexical-binding: t; -*-

;; Copyright (C) 2024-2026 MCG
;; Author: mcge <mcgeq@outlook.com>
;; Keywords: keybindings, keyboard
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;; Keybindings module for MCG Emacs configuration, responsible for:
;; - Global keybindings setup
;; - Keybindings reference
;;
;; Note: Vundo and Markmacro have been moved to separate modules:
;; - init-undo.el for visual undo (vundo)
;; - init-multicursor.el for multi-cursor editing (markmacro)
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

(require 'core-lib)
#+end_src

** Unset Conflicting Keys

取消设置不常用或冲突的快捷键。

#+begin_src emacs-lisp
;;; ============================================================
;;; Unset Conflicting Keys
;;; ============================================================

;; Unset rarely used or conflicting keybindings
(global-unset-key (kbd "C-z"))   ; suspend-frame (rarely used)
(global-unset-key (kbd "s-q"))   ; save-buffers-kill-emacs (dangerous)
#+end_src

** Basic Editing Keys

基础编辑快捷键。

*** Smart Beginning of Line

#+begin_src emacs-lisp
;;; ============================================================
;;; Basic Editing Keys
;;; ============================================================

(defun mcg/smart-beginning-of-line ()
  "Smart beginning of line: toggle between line start and first non-whitespace character."
  (interactive)
  (let ((orig-point (point)))
    (back-to-indentation)
    (when (= orig-point (point))
      (beginning-of-line))))
#+end_src

*** Open Init File

#+begin_src emacs-lisp
(defun mcg/open-init-file ()
  "Open configuration entry file."
  (interactive)
  (find-file (expand-file-name "init.el" mcg-config-dir)))
#+end_src

*** Basic Editing Keybindings

#+begin_src emacs-lisp
;; Basic editing - using mcg-bind-key for registry tracking
(mcg-bind-key "C-a" 'mcg/smart-beginning-of-line "init-keybindings")
(mcg-bind-key "C-c E" 'mcg/open-init-file "init-keybindings")
(mcg-bind-key "C-c R" 'replace-string "init-keybindings")
(mcg-bind-key "C-c M-r" 'replace-regexp "init-keybindings")
(mcg-bind-key "C-c D" 'make-directory "init-keybindings")
#+end_src

** Line Manipulation

行操作快捷键。

*** Insert Line Functions

#+begin_src emacs-lisp
;;; ============================================================
;;; Line Manipulation
;;; ============================================================

(defun mcg/insert-line-below ()
  "Insert new line below current line."
  (interactive)
  (end-of-line)
  (newline-and-indent))

(defun mcg/insert-line-above ()
  "Insert new line above current line."
  (interactive)
  (beginning-of-line)
  (newline)
  (forward-line -1)
  (indent-according-to-mode))
#+end_src

*** Move Line Functions

#+begin_src emacs-lisp
(defun mcg/move-line-up ()
  "Move current line up."
  (interactive)
  (transpose-lines 1)
  (forward-line -2)
  (indent-according-to-mode))

(defun mcg/move-line-down ()
  "Move current line down."
  (interactive)
  (forward-line 1)
  (transpose-lines 1)
  (forward-line -1)
  (indent-according-to-mode))
#+end_src

*** Line Manipulation Keybindings

#+begin_src emacs-lisp
;; Line manipulation keybindings
(mcg-bind-key "C-c <down>" 'mcg/insert-line-below "init-keybindings")
(mcg-bind-key "C-c <up>" 'mcg/insert-line-above "init-keybindings")
(mcg-bind-key "M-<up>" 'mcg/move-line-up "init-keybindings")
(mcg-bind-key "M-<down>" 'mcg/move-line-down "init-keybindings")
#+end_src

** Scrolling

滚动快捷键。

#+begin_src emacs-lisp
;;; ============================================================
;;; Scrolling
;;; ============================================================

(defun mcg/scroll-down-third ()
  "Scroll down 1/3 window height."
  (interactive)
  (scroll-up (/ (window-body-height) 3)))

(defun mcg/scroll-up-third ()
  "Scroll up 1/3 window height."
  (interactive)
  (scroll-down (/ (window-body-height) 3)))

(mcg-bind-key "M-n" 'mcg/scroll-down-third "init-keybindings")
(mcg-bind-key "M-p" 'mcg/scroll-up-third "init-keybindings")
#+end_src

** Yasnippet Keys

Yasnippet 快捷键。

#+begin_src emacs-lisp
;;; ============================================================
;;; Yasnippet Keys
;;; ============================================================

(mcg-bind-key "C-c y n" 'yas-new-snippet "init-keybindings")
(mcg-bind-key "C-c y v" 'yas-visit-snippet-file "init-keybindings")
(mcg-bind-key "C-c y r" 'yas-reload-all "init-keybindings")
#+end_src

** Sort-tab Keys

标签页快捷键 (C-c t 前缀)。

*** Tab Selection Functions

#+begin_src emacs-lisp
;;; ============================================================
;;; Sort-tab Keys (C-c t prefix)
;;; ============================================================

(defun mcg-select-tab-1 ()
  "Select tab 1."
  (interactive)
  (when (fboundp 'sort-tab-select-by-index)
    (sort-tab-select-by-index 0)))

(defun mcg-select-tab-2 ()
  "Select tab 2."
  (interactive)
  (when (fboundp 'sort-tab-select-by-index)
    (sort-tab-select-by-index 1)))

(defun mcg-select-tab-3 ()
  "Select tab 3."
  (interactive)
  (when (fboundp 'sort-tab-select-by-index)
    (sort-tab-select-by-index 2)))
#+end_src

*** Setup Sort-tab Keys

#+begin_src emacs-lisp
(defun mcg--setup-sort-tab-keys ()
  "Setup sort-tab keybindings."
  (with-eval-after-load 'sort-tab
    ;; Navigation
    (mcg-bind-key "C-c t n" 'sort-tab-select-next-tab "init-keybindings")
    (mcg-bind-key "C-c t p" 'sort-tab-select-prev-tab "init-keybindings")
    (mcg-bind-key "C-c t f" 'sort-tab-select-first-tab "init-keybindings")
    (mcg-bind-key "C-c t l" 'sort-tab-select-last-tab "init-keybindings")
    ;; Management
    (mcg-bind-key "C-c t k" 'sort-tab-close-current-tab "init-keybindings")
    (mcg-bind-key "C-c t o" 'sort-tab-close-other-tabs "init-keybindings")
    (mcg-bind-key "C-c t K" 'sort-tab-close-all-tabs "init-keybindings")
    ;; Number quick selection
    (mcg-bind-key "C-c t 1" 'mcg-select-tab-1 "init-keybindings")
    (mcg-bind-key "C-c t 2" 'mcg-select-tab-2 "init-keybindings")
    (mcg-bind-key "C-c t 3" 'mcg-select-tab-3 "init-keybindings")
    (mcg-log "Sort-tab keybindings configured")))
#+end_src

** Search Keys

搜索快捷键 (C-c s 前缀)。

#+begin_src emacs-lisp
;;; ============================================================
;;; Search Keys (C-c s prefix)
;;; ============================================================

(defun mcg--setup-search-keys ()
  "Setup search-related keybindings."
  ;; Consult search (use autoload to ensure commands are available)
  (autoload 'consult-line "consult" nil t)
  (autoload 'consult-imenu "consult-imenu" nil t)
  (autoload 'consult-mark "consult" nil t)
  (autoload 'consult-buffer "consult" nil t)
  (autoload 'consult-recent-file "consult" nil t)
  (autoload 'consult-project-buffer "consult" nil t)
  
  (mcg-bind-key "C-c s l" 'consult-line "init-keybindings")
  (mcg-bind-key "C-c s i" 'consult-ripgrep "init-keybindings")
  (mcg-bind-key "C-c s m" 'consult-mark "init-keybindings")
  (mcg-bind-key "C-c s b" 'consult-buffer "init-keybindings")
  (mcg-bind-key "C-c s r" 'consult-recent-file "init-keybindings")
  
  ;; Buffer management with project filtering
  (mcg-bind-key "C-c b b" 'consult-buffer "init-keybindings")
  (mcg-bind-key "C-c b p" 'consult-project-buffer "init-keybindings")
  (mcg-bind-key "C-c b r" 'consult-recent-file "init-keybindings")
  
  ;; Embark
  (autoload 'embark-act "embark" nil t)
  (autoload 'embark-dwim "embark" nil t)
  (mcg-bind-key "C-." 'embark-act "init-keybindings")
  (mcg-bind-key "C-," 'embark-dwim "init-keybindings")
  
  ;; Color-rg search
  (with-eval-after-load 'color-rg
    (mcg-bind-key "C-c s g" 'color-rg-search-input "init-keybindings")
    (mcg-bind-key "C-c s G" 'color-rg-search-input-in-project "init-keybindings")
    (mcg-bind-key "C-c s s" 'color-rg-search-symbol "init-keybindings")
    (mcg-bind-key "C-c s S" 'color-rg-search-symbol-in-project "init-keybindings")
    (mcg-bind-key "C-c s ." 'color-rg-search-symbol-in-current-file "init-keybindings")
    (mcg-bind-key "C-c s ," 'color-rg-search-input-in-current-file "init-keybindings"))
  
  ;; Blink-search
  (with-eval-after-load 'blink-search
    (mcg-bind-key "C-c s B" 'blink-search "init-keybindings"))
  
  (mcg-log "Search keybindings configured"))
#+end_src

** File Keys

文件快捷键 (C-c f 前缀)。

#+begin_src emacs-lisp
;;; ============================================================
;;; File Keys (C-c f prefix)
;;; ============================================================

(defun mcg--setup-file-keys ()
  "Setup file-related keybindings."
  (mcg-bind-key "C-c f r" 'consult-recent-file "init-keybindings")
  (mcg-log "File keybindings configured"))
#+end_src

** Git Keys

Git 快捷键 (C-c g 前缀)。

#+begin_src emacs-lisp
;;; ============================================================
;;; Git Keys (C-c g prefix)
;;; ============================================================

(defun mcg--setup-git-keys ()
  "Setup Git-related keybindings."
  (with-eval-after-load 'magit
    ;; Main commands
    (mcg-bind-key "C-x g" 'magit-status "init-keybindings")
    (mcg-bind-key "C-x M-g" 'magit-dispatch "init-keybindings")
    (mcg-bind-key "C-c g s" 'magit-status "init-keybindings")
    (mcg-bind-key "C-c g l" 'magit-log "init-keybindings")
    (mcg-bind-key "C-c g d" 'magit-dispatch "init-keybindings")
    (mcg-bind-key "C-c g f" 'magit-file-dispatch "init-keybindings")
    ;; Push/Pull
    (mcg-bind-key "C-c g p" 'magit-push "init-keybindings")
    (mcg-bind-key "C-c g P" 'magit-pull "init-keybindings")
    ;; Branch
    (mcg-bind-key "C-c g b b" 'magit-branch-create "init-keybindings")
    (mcg-bind-key "C-c g b r" 'magit-branch-rename "init-keybindings")
    (mcg-bind-key "C-c g b d" 'magit-branch-delete "init-keybindings")
    ;; Submodules
    (mcg-bind-key "C-c g m a" 'magit-submodule-add "init-keybindings")
    (mcg-bind-key "C-c g m r" 'magit-submodule-remove "init-keybindings")
    (mcg-bind-key "C-c g m u" 'magit-submodule-update "init-keybindings")
    (mcg-log "Git keybindings configured")))
#+end_src

** LSP Keys

LSP 快捷键 (标准绑定)。

#+begin_src emacs-lisp
;;; ============================================================
;;; LSP Keys (Standard bindings)
;;; ============================================================

(defun mcg--setup-lsp-keys ()
  "Setup LSP-related keybindings (standard bindings)."
  (with-eval-after-load 'lsp-bridge
    ;; Navigation (standard LSP bindings)
    (mcg-bind-key "M-." 'lsp-bridge-find-def "init-keybindings")
    (mcg-bind-key "M-," 'lsp-bridge-find-def-return "init-keybindings")
    (mcg-bind-key "M-?" 'lsp-bridge-find-references "init-keybindings")
    (mcg-bind-key "C-M-." 'lsp-bridge-find-def-other-window "init-keybindings")
    ;; Documentation (C-h prefix for help)
    (mcg-bind-key "C-h ." 'lsp-bridge-popup-documentation "init-keybindings")
    (mcg-bind-key "C-h ," 'lsp-bridge-show-signature "init-keybindings")
    (mcg-bind-key "C-h <up>" 'lsp-bridge-popup-documentation-scroll-up "init-keybindings")
    (mcg-bind-key "C-h <down>" 'lsp-bridge-popup-documentation-scroll-down "init-keybindings")
    ;; Code actions (C-c r prefix for refactoring)
    (mcg-bind-key "C-c r r" 'lsp-bridge-rename "init-keybindings")
    (mcg-bind-key "C-c r a" 'lsp-bridge-code-action "init-keybindings")
    (mcg-bind-key "C-c r f" 'lsp-bridge-code-format "init-keybindings")
    (mcg-bind-key "C-c r l" 'lsp-bridge-find-impl "init-keybindings")
    (mcg-bind-key "C-c r s" 'lsp-bridge-workspace-list-symbols "init-keybindings")
    ;; Diagnostics (M-g prefix - standard Emacs "goto" prefix)
    (mcg-bind-key "M-g n" 'lsp-bridge-diagnostic-jump-next "init-keybindings")
    (mcg-bind-key "M-g p" 'lsp-bridge-diagnostic-jump-prev "init-keybindings")
    (mcg-bind-key "M-g l" 'lsp-bridge-diagnostic-list "init-keybindings"))
  (mcg-log "LSP keybindings configured"))
#+end_src

** Org Keys

Org 快捷键 (C-c n 前缀)。

#+begin_src emacs-lisp
;;; ============================================================
;;; Org Keys (C-c n prefix)
;;; ============================================================

(defun mcg--setup-org-keys ()
  "Setup Org-related keybindings."
  (with-eval-after-load 'org
    (mcg-bind-key "C-c n c" 'org-capture "init-keybindings")
    (mcg-bind-key "C-c n a" 'org-agenda "init-keybindings")
    (mcg-bind-key "C-c n l" 'org-store-link "init-keybindings")
    (mcg-bind-key "C-c n t" 'org-todo-list "init-keybindings"))
  (mcg-log "Org keybindings configured"))
#+end_src

** Elisp Development Keys

Elisp 开发快捷键。

#+begin_src emacs-lisp
;;; ============================================================
;;; Elisp Development Keys
;;; ============================================================

(with-eval-after-load 'elisp-mode
  (define-key emacs-lisp-mode-map (kbd "C-c C-b") 'eval-buffer)
  (define-key emacs-lisp-mode-map (kbd "C-c C-r") 'eval-region))
#+end_src

** Transient Menus

Transient 菜单配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; Transient Menus
;;; ============================================================

(defun mcg--setup-transient-menus ()
  "Setup Transient menus."
  (when (require 'transient nil t)
    ;; Search menu
    (transient-define-prefix mcg-search-menu ()
      "Search commands menu"
      [["Buffer"
        ("l" "Line" consult-line)
        ("i" "Ripgrep" consult-ripgrep)
        ("m" "Mark" consult-mark)]
       ["Project"
        ("g" "Grep" color-rg-search-input-in-project)
        ("s" "Symbol" color-rg-search-symbol-in-project)
        ("B" "Blink" blink-search)]
       ["Current"
        ("." "Symbol here" color-rg-search-symbol-in-current-file)
        ("," "Input here" color-rg-search-input-in-current-file)]])
    
    (mcg-bind-key "C-c s ?" 'mcg-search-menu "init-keybindings")
    
    ;; Git menu
    (transient-define-prefix mcg-git-menu ()
      "Git operations menu"
      [["Main"
        ("s" "Status" magit-status)
        ("l" "Log" magit-log)
        ("d" "Dispatch" magit-dispatch)]
       ["Commit"
        ("c" "Commit" magit-commit)
        ("a" "Amend" magit-commit-amend)]
       ["Remote"
        ("p" "Push" magit-push)
        ("P" "Pull" magit-pull)
        ("f" "Fetch" magit-fetch)]])
    
    (mcg-bind-key "C-c g ?" 'mcg-git-menu "init-keybindings")
    
    ;; Help menu - unified help system
    (transient-define-prefix mcg-help-menu ()
      "MCG Help Menu - unified help system"
      [["Documentation"
        ("k" "Keybindings" mcg-show-keybindings)
        ("m" "Modules" mcg-list-modules)
        ("e" "Extensions" mcg-show-extensions)]
       ["Diagnostics"
        ("d" "Doctor" mcg-doctor)
        ("t" "Load times" mcg-show-load-times)
        ("l" "Logs" mcg-show-logs)]
       ["Configuration"
        ("c" "Open config" mcg/open-init-file)
        ("r" "Reload module" mcg/reload-module)
        ("R" "Rebuild cache" mcg-cache-clear)]])
    
    (mcg-bind-key "C-h M" 'mcg-help-menu "init-keybindings")
    (mcg-log "Transient menus configured")))

;; Delayed load transient menus
(with-eval-after-load 'transient
  (mcg--setup-transient-menus))
#+end_src

** Keybindings Reference

快捷键参考文档功能。

*** Keybindings by Category

#+begin_src emacs-lisp
;;; ============================================================
;;; Keybindings Reference
;;; ============================================================

(defun mcg--keybindings-by-category ()
  "Group registered keybindings by category prefix.
Returns an alist of (CATEGORY . BINDINGS)."
  (let ((categories '(("C-c s" . "搜索 Search")
                      ("C-c g" . "Git")
                      ("C-c t" . "标签页 Tabs")
                      ("C-c n" . "Org/笔记")
                      ("C-c r" . "重构 Refactor")
                      ("C-c y" . "Yasnippet")
                      ("C-c f" . "文件 Files")
                      ("C-c w" . "窗口 Window")
                      ("C-c e" . "Eshell")
                      ("M-g" . "跳转 Goto")
                      ("M-." . "LSP 导航")
                      ("M-," . "LSP 导航")
                      ("M-?" . "LSP 导航")
                      ("C-h" . "帮助 Help")
                      ("C-." . "Embark")
                      ("C-," . "Embark")))
        (result nil)
        (other nil))
    ;; Group bindings by category
    (dolist (binding (mcg-list-keybindings))
      (let* ((key (car binding))
             (command (cadr binding))
             (source (caddr binding))
             (found nil))
        (dolist (cat categories)
          (when (and (not found) (string-prefix-p (car cat) key))
            (let ((existing (assoc (cdr cat) result)))
              (if existing
                  (setcdr existing (cons binding (cdr existing)))
                (push (cons (cdr cat) (list binding)) result)))
            (setq found t)))
        (unless found
          (push binding other))))
    ;; Add "Other" category if there are uncategorized bindings
    (when other
      (push (cons "其他 Other" (nreverse other)) result))
    (nreverse result)))
#+end_src

*** Keybindings Content

#+begin_src emacs-lisp
(defun mcg--keybindings-content ()
  "Generate keybindings reference content from registry."
  (let ((grouped (mcg--keybindings-by-category))
        (conflicts (when (fboundp 'mcg-list-keybinding-conflicts)
                     (mcg-list-keybinding-conflicts))))
    (with-temp-buffer
      (insert "                MCG Emacs 快捷键速查 (Registry)\n")
      (insert "    ═══════════════════════════════════════════════════\n\n")
      
      ;; Show conflicts if any
      (when conflicts
        (insert "    ⚠️  检测到快捷键冲突:\n")
        (dolist (conflict conflicts)
          (insert (format "       %s: %s vs %s\n"
                          (car conflict)
                          (cadr conflict)
                          (nth 3 conflict))))
        (insert "\n"))
      
      ;; Show bindings by category
      (if grouped
          (dolist (category grouped)
            (insert (format "    【%s】\n" (car category)))
            (dolist (binding (sort (cdr category)
                                   (lambda (a b) (string< (car a) (car b)))))
              (insert (format "    %-16s %s\n"
                              (car binding)
                              (cadr binding))))
            (insert "\n"))
        ;; Fallback to static content if registry is empty
        (insert (mcg--keybindings-static-content)))
      
      (insert "    ───────────────────────────────────────────────────\n")
      (insert (format "    共 %d 个快捷键已注册\n"
                      (if (boundp 'mcg-keybinding-registry)
                          (hash-table-count mcg-keybinding-registry)
                        0)))
      
      (buffer-string))))
#+end_src

*** Static Keybindings Content

#+begin_src emacs-lisp
(defun mcg--keybindings-static-content ()
  "Static keybindings content as fallback."
  "
    【LSP】                                               
    M-.             跳转到定义                            
    M-,             返回                                  
    M-?             查找引用                              
    C-h .           显示文档                              
    C-c r r         重命名                                
    C-c r a         代码操作                              
    M-g n/p         下一个/上一个诊断                     

    【Git】 C-c g                                         
    C-x g           Magit 状态                            
    C-c g s         Magit 状态                            
    C-c g p/P       推送/拉取                             

    【搜索】 C-c s                                        
    C-c s l         搜索行 (consult-line)                 
    C-c s g         搜索内容 (color-rg)                   
    C-c s G         项目内搜索                            
    C-c s i         ripgrep 搜索                            

    【标签页】 C-c t                                      
    C-c t n/p       下一个/上一个标签                     
    C-c t k         关闭当前标签                          
    C-c t 1/2/3     快速选择标签                          

    【编辑】                                              
    C-a             智能行首                              
    C-c E           打开配置文件                          
    M-n/M-p         滚动 1/3 窗口                         
    M-UP/DOWN       移动行                                
")
#+end_src

*** Show Keybindings Command

#+begin_src emacs-lisp
(defun mcg/show-keybindings ()
  "Show keybindings reference in posframe popup."
  (interactive)
  (if (and (display-graphic-p)
           (require 'posframe nil t)
           (fboundp 'mcg-popup-show))
      ;; Use posframe popup
      (mcg-popup-show "*MCG Keybindings*" (mcg--keybindings-content) 70 45)
    ;; Fallback to buffer display
    (with-help-window "*MCG Keybindings*"
      (princ (mcg--keybindings-content)))))

(mcg-bind-key "C-h K" 'mcg/show-keybindings "init-keybindings")
#+end_src

** Initialize

模块初始化。

#+begin_src emacs-lisp
;;; ============================================================
;;; Initialize
;;; ============================================================

(mcg--setup-sort-tab-keys)
(mcg--setup-search-keys)
(mcg--setup-file-keys)
(mcg--setup-git-keys)
(mcg--setup-lsp-keys)
(mcg--setup-org-keys)
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-keybindings)
;;; init-keybindings.el ends here
#+end_src
