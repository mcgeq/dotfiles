* init-keybindings.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-keybindings.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
;;; init-keybindings.el --- Keybindings for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-keybindings.el
;; Description: Global keybindings configuration module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: keybindings, keyboard
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Keybindings module for MCG Emacs configuration, responsible for:
;; - Global keybindings setup
;; - Keybindings reference
;;
;; Note: Vundo and Markmacro have been moved to separate modules:
;; - init-undo.org for visual undo (vundo)
;; - init-multicursor.org for multi-cursor editing (markmacro)
;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)

#+END_SRC

** Unset Conflicting Keys
#+BEGIN_SRC emacs-lisp
;;; Unset Conflicting Keys

;; Unset rarely used or conflicting keybindings
(global-unset-key (kbd "C-z"))   ; suspend-frame (rarely used)
(global-unset-key (kbd "s-q"))   ; save-buffers-kill-emacs (dangerous)

#+END_SRC

** Basic Editing Keys
#+BEGIN_SRC emacs-lisp
;;; Basic Editing Keys

(defun mcg/smart-beginning-of-line ()
  "Smart beginning of line: toggle between line start and first non-whitespace character."
  (interactive)
  (let ((orig-point (point)))
    (back-to-indentation)
    (when (= orig-point (point))
      (beginning-of-line))))

(defun mcg/open-init-file ()
  "Open configuration entry file."
  (interactive)
  (find-file (expand-file-name "init.el" mcg-config-dir)))

;; Basic editing
(global-set-key (kbd "C-a") 'mcg/smart-beginning-of-line)
(global-set-key (kbd "C-c E") 'mcg/open-init-file)
(global-set-key (kbd "C-c R") 'replace-string)
(global-set-key (kbd "C-c M-r") 'replace-regexp)
(global-set-key (kbd "C-c D") 'make-directory)

#+END_SRC

** Line Manipulation
#+BEGIN_SRC emacs-lisp
;;; Line Manipulation

;; Insert new line below
(global-set-key (kbd "C-c <down>")
                (lambda ()
                  (interactive)
                  (end-of-line)
                  (newline-and-indent)))

;; Insert new line above
(global-set-key (kbd "C-c <up>")
                (lambda ()
                  (interactive)
                  (beginning-of-line)
                  (newline)
                  (forward-line -1)
                  (indent-according-to-mode)))

;; Move line up
(global-set-key (kbd "M-<up>")
                (lambda ()
                  (interactive)
                  (transpose-lines 1)
                  (forward-line -2)
                  (indent-according-to-mode)))

;; Move line down
(global-set-key (kbd "M-<down>")
                (lambda ()
                  (interactive)
                  (forward-line 1)
                  (transpose-lines 1)
                  (forward-line -1)
                  (indent-according-to-mode)))

#+END_SRC

** Scrolling
#+BEGIN_SRC emacs-lisp
;;; Scrolling

(defun mcg/scroll-down-third ()
  "Scroll down 1/3 window height."
  (interactive)
  (scroll-up (/ (window-body-height) 3)))

(defun mcg/scroll-up-third ()
  "Scroll up 1/3 window height."
  (interactive)
  (scroll-down (/ (window-body-height) 3)))

(global-set-key (kbd "M-n") 'mcg/scroll-down-third)
(global-set-key (kbd "M-p") 'mcg/scroll-up-third)

#+END_SRC

** Vundo and Multicursor Modules
#+BEGIN_SRC emacs-lisp
;;; Vundo and Multicursor Modules
;; These features have been moved to separate modules for better modularity.
;; - init-undo: Visual undo with vundo
;; - init-multicursor: Multi-cursor editing with markmacro
;; Load them via mcg! macro: :editor undo multicursor

#+END_SRC

** Yasnippet Keys
#+BEGIN_SRC emacs-lisp
;;; Yasnippet Keys

(global-set-key (kbd "C-c y n") 'yas-new-snippet)
(global-set-key (kbd "C-c y v") 'yas-visit-snippet-file)
(global-set-key (kbd "C-c y r") 'yas-reload-all)

#+END_SRC

** Sort-tab Keys
#+BEGIN_SRC emacs-lisp
;;; Sort-tab Keys (C-c t prefix)

;; Tab number selection helper functions
(defun mcg-select-tab-1 ()
  "Select tab 1."
  (interactive)
  (when (fboundp 'sort-tab-select-by-index)
    (sort-tab-select-by-index 0)))

(defun mcg-select-tab-2 ()
  "Select tab 2."
  (interactive)
  (when (fboundp 'sort-tab-select-by-index)
    (sort-tab-select-by-index 1)))

(defun mcg-select-tab-3 ()
  "Select tab 3."
  (interactive)
  (when (fboundp 'sort-tab-select-by-index)
    (sort-tab-select-by-index 2)))

(defun mcg--setup-sort-tab-keys ()
  "Setup sort-tab keybindings."
  (with-eval-after-load 'sort-tab
    ;; Navigation
    (global-set-key (kbd "C-c t n") 'sort-tab-select-next-tab)
    (global-set-key (kbd "C-c t p") 'sort-tab-select-prev-tab)
    (global-set-key (kbd "C-c t f") 'sort-tab-select-first-tab)
    (global-set-key (kbd "C-c t l") 'sort-tab-select-last-tab)
    
    ;; Management
    (global-set-key (kbd "C-c t k") 'sort-tab-close-current-tab)
    (global-set-key (kbd "C-c t o") 'sort-tab-close-other-tabs)
    (global-set-key (kbd "C-c t K") 'sort-tab-close-all-tabs)
    
    ;; Number quick selection
    (global-set-key (kbd "C-c t 1") 'mcg-select-tab-1)
    (global-set-key (kbd "C-c t 2") 'mcg-select-tab-2)
    (global-set-key (kbd "C-c t 3") 'mcg-select-tab-3)
    
    (mcg-log "Sort-tab keybindings configured")))

#+END_SRC

** Search Keys
#+BEGIN_SRC emacs-lisp
;;; Search Keys (C-c s prefix)

(defun mcg--setup-search-keys ()
  "Setup search-related keybindings."
  ;; Consult search (use autoload to ensure commands are available)
  (autoload 'consult-line "consult" nil t)
  (autoload 'consult-imenu "consult-imenu" nil t)
  (autoload 'consult-mark "consult" nil t)
  (autoload 'consult-buffer "consult" nil t)
  (autoload 'consult-recent-file "consult" nil t)
  
  (global-set-key (kbd "C-c s l") #'consult-line)
  (global-set-key (kbd "C-c s i") #'consult-imenu)
  (global-set-key (kbd "C-c s m") #'consult-mark)
  (global-set-key (kbd "C-c s b") #'consult-buffer)
  (global-set-key (kbd "C-c s r") #'consult-recent-file)
  
  ;; Embark
  (autoload 'embark-act "embark" nil t)
  (autoload 'embark-dwim "embark" nil t)
  (global-set-key (kbd "C-.") #'embark-act)
  (global-set-key (kbd "C-,") #'embark-dwim)
  
  ;; Color-rg search
  (with-eval-after-load 'color-rg
    (global-set-key (kbd "C-c s g") #'color-rg-search-input)
    (global-set-key (kbd "C-c s G") #'color-rg-search-input-in-project)
    (global-set-key (kbd "C-c s s") #'color-rg-search-symbol)
    (global-set-key (kbd "C-c s S") #'color-rg-search-symbol-in-project)
    (global-set-key (kbd "C-c s .") #'color-rg-search-symbol-in-current-file)
    (global-set-key (kbd "C-c s ,") #'color-rg-search-input-in-current-file))
  
  ;; Blink-search
  (with-eval-after-load 'blink-search
    (global-set-key (kbd "C-c s B") #'blink-search))
  
  (mcg-log "Search keybindings configured"))

#+END_SRC

** File Keys
#+BEGIN_SRC emacs-lisp
;;; File Keys (C-c f prefix)

(defun mcg--setup-file-keys ()
  "Setup file-related keybindings."
  ;; Recent files (consult-recent-file already autoloaded in search keys)
  (global-set-key (kbd "C-c f r") #'consult-recent-file)
  
  (mcg-log "File keybindings configured"))

#+END_SRC

** Git Keys
#+BEGIN_SRC emacs-lisp
;;; Git Keys (C-c g prefix)

(defun mcg--setup-git-keys ()
  "Setup Git-related keybindings."
  (with-eval-after-load 'magit
    ;; Main commands
    (global-set-key (kbd "C-x g") 'magit-status)
    (global-set-key (kbd "C-x M-g") 'magit-dispatch)
    (global-set-key (kbd "C-c g s") 'magit-status)
    (global-set-key (kbd "C-c g l") 'magit-log)
    (global-set-key (kbd "C-c g d") 'magit-dispatch)
    (global-set-key (kbd "C-c g f") 'magit-file-dispatch)
    
    ;; Push/Pull
    (global-set-key (kbd "C-c g p") 'magit-push)
    (global-set-key (kbd "C-c g P") 'magit-pull)
    
    ;; Branch
    (global-set-key (kbd "C-c g b b") 'magit-branch-create)
    (global-set-key (kbd "C-c g b r") 'magit-branch-rename)
    (global-set-key (kbd "C-c g b d") 'magit-branch-delete)
    
    ;; Submodules
    (global-set-key (kbd "C-c g m a") 'magit-submodule-add)
    (global-set-key (kbd "C-c g m r") 'magit-submodule-remove)
    (global-set-key (kbd "C-c g m u") 'magit-submodule-update)
    
    (mcg-log "Git keybindings configured")))

#+END_SRC

** LSP Keys
#+BEGIN_SRC emacs-lisp
;;; LSP Keys (Standard bindings)

(defun mcg--setup-lsp-keys ()
  "Setup LSP-related keybindings (standard bindings)."
  (with-eval-after-load 'lsp-bridge
    ;; Navigation (standard LSP bindings)
    (global-set-key (kbd "M-.") 'lsp-bridge-find-def)
    (global-set-key (kbd "M-,") 'lsp-bridge-find-def-return)
    (global-set-key (kbd "M-?") 'lsp-bridge-find-references)
    (global-set-key (kbd "C-M-.") 'lsp-bridge-find-def-other-window)
    
    ;; Documentation (C-h prefix for help)
    (global-set-key (kbd "C-h .") 'lsp-bridge-popup-documentation)
    (global-set-key (kbd "C-h ,") 'lsp-bridge-show-signature)
    (global-set-key (kbd "C-h <up>") 'lsp-bridge-popup-documentation-scroll-up)
    (global-set-key (kbd "C-h <down>") 'lsp-bridge-popup-documentation-scroll-down)
    
    ;; Code actions (C-c r prefix for refactoring)
    (global-set-key (kbd "C-c r r") 'lsp-bridge-rename)
    (global-set-key (kbd "C-c r a") 'lsp-bridge-code-action)
    (global-set-key (kbd "C-c r f") 'lsp-bridge-code-format)
    (global-set-key (kbd "C-c r l") 'lsp-bridge-find-impl)
    (global-set-key (kbd "C-c r s") 'lsp-bridge-workspace-list-symbols)
    
    ;; Diagnostics (M-g prefix - standard Emacs "goto" prefix)
    (global-set-key (kbd "M-g n") 'lsp-bridge-diagnostic-jump-next)
    (global-set-key (kbd "M-g p") 'lsp-bridge-diagnostic-jump-prev)
    (global-set-key (kbd "M-g l") 'lsp-bridge-diagnostic-list))
  
  (mcg-log "LSP keybindings configured"))

#+END_SRC

** Org Keys
#+BEGIN_SRC emacs-lisp
;;; Org Keys (C-c n prefix)

(defun mcg--setup-org-keys ()
  "Setup Org-related keybindings."
  (with-eval-after-load 'org
    (global-set-key (kbd "C-c n c") 'org-capture)
    (global-set-key (kbd "C-c n a") 'org-agenda)
    (global-set-key (kbd "C-c n l") 'org-store-link)
    (global-set-key (kbd "C-c n t") 'org-todo-list))
  
  (mcg-log "Org keybindings configured"))

#+END_SRC

** Elisp Development Keys
#+BEGIN_SRC emacs-lisp
;;; Elisp Development Keys

(with-eval-after-load 'elisp-mode
  (define-key emacs-lisp-mode-map (kbd "C-c C-b") 'eval-buffer)
  (define-key emacs-lisp-mode-map (kbd "C-c C-r") 'eval-region))

#+END_SRC

** Transient Menus
#+BEGIN_SRC emacs-lisp
;;; Transient Menus

(defun mcg--setup-transient-menus ()
  "Setup Transient menus."
  (when (require 'transient nil t)
    ;; Search menu
    (transient-define-prefix mcg-search-menu ()
      "Search commands menu"
      [["Buffer"
        ("l" "Line" consult-line)
        ("i" "Imenu" consult-imenu)
        ("m" "Mark" consult-mark)]
       ["Project"
        ("g" "Grep" color-rg-search-input-in-project)
        ("s" "Symbol" color-rg-search-symbol-in-project)
        ("B" "Blink" blink-search)]
       ["Current"
        ("." "Symbol here" color-rg-search-symbol-in-current-file)
        ("," "Input here" color-rg-search-input-in-current-file)]])
    
    (global-set-key (kbd "C-c s ?") 'mcg-search-menu)
    
    ;; Git menu
    (transient-define-prefix mcg-git-menu ()
      "Git operations menu"
      [["Main"
        ("s" "Status" magit-status)
        ("l" "Log" magit-log)
        ("d" "Dispatch" magit-dispatch)]
       ["Commit"
        ("c" "Commit" magit-commit)
        ("a" "Amend" magit-commit-amend)]
       ["Remote"
        ("p" "Push" magit-push)
        ("P" "Pull" magit-pull)
        ("f" "Fetch" magit-fetch)]])
    
    (global-set-key (kbd "C-c g ?") 'mcg-git-menu)
    
    ;; Window menu
    (transient-define-prefix mcg-window-menu ()
      "Window operations menu"
      [["Switch"
        ("w" "Ace window" ace-window)
        ("o" "Other window" other-window)]
       ["Split"
        ("v" "Vertical" split-window-right)
        ("h" "Horizontal" split-window-below)]
       ["Delete"
        ("d" "Delete" ace-delete-window)
        ("D" "Delete others" delete-other-windows)]
       ["Swap"
        ("s" "Swap" ace-swap-window)
        ("u" "Undo layout" winner-undo)
        ("r" "Redo layout" winner-redo)]])
    
    (global-set-key (kbd "C-c w ?") 'mcg-window-menu)
    
    (mcg-log "Transient menus configured")))

;; Delayed load transient menus
(with-eval-after-load 'transient
  (mcg--setup-transient-menus))

#+END_SRC

** Keybindings Reference
#+BEGIN_SRC emacs-lisp
;;; Keybindings Reference

(defun mcg/show-keybindings ()
  "Show keybindings reference in posframe popup."
  (interactive)
  (mcg-popup-show "*MCG Keybindings*" (mcg--keybindings-content) 60 40))

(defun mcg--keybindings-content ()
  "Generate keybindings reference content."
  "
                   MCG Emacs 快捷键速查                    
    ═══════════════════════════════════════════════════  

    【LSP】                                               
    M-.             跳转到定义                            
    M-,             返回                                  
    M-?             查找引用                              
    C-h .           显示文档                              
    C-c r r         重命名                                
    C-c r a         代码操作                              
    M-g n/p         下一个/上一个诊断                     

    【Git】 C-c g                                         
    C-x g           Magit 状态                            
    C-c g s         Magit 状态                            
    C-c g p/P       推送/拉取                             
    C-c g H         Git 帮助弹窗                          

    【搜索】 C-c s                                        
    C-c s l         搜索行 (consult-line)                 
    C-c s g         搜索内容 (color-rg)                   
    C-c s G         项目内搜索                            
    C-c s i         Imenu 导航                            

    【标签页】 C-c t                                      
    C-c t n/p       下一个/上一个标签                     
    C-c t k         关闭当前标签                          
    C-c t 1/2/3     快速选择标签                          

    【Org/笔记】 C-c n                                    
    C-c n c         Capture                               
    C-c n a         Agenda                                
    C-c n ?         Org 帮助弹窗                          

    【编辑】                                              
    C-a             智能行首                              
    C-c E           打开配置文件                          
    M-n/M-p         滚动 1/3 窗口                         
    M-UP/DOWN       移动行                                
    C-c u           可视化撤销 (vundo)                    

    【窗口】 C-c w                                        
    M-O             Ace window 切换                       
    C-c w ?         窗口菜单                              

    【跳转】 Avy                                          
    C-;             跳转到字符                            
    C-'             跳转到两个字符                        
    M-g w           跳转到单词                            

    【Eshell】 C-c e                                      
    C-c e e         切换 Eshell                           
    C-c e h         当前目录打开                          
    C-c e ?         Eshell 帮助弹窗                       

    【帮助弹窗】                                          
    C-h K           快捷键速查 (本页)                     
")

(global-set-key (kbd "C-h K") 'mcg/show-keybindings)

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

(mcg--setup-sort-tab-keys)
(mcg--setup-search-keys)
(mcg--setup-file-keys)
(mcg--setup-git-keys)
(mcg--setup-lsp-keys)
(mcg--setup-org-keys)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-keybindings)
;;; init-keybindings.el ends here
#+END_SRC
