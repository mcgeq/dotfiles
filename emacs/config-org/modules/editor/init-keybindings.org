* init-keybindings.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-keybindings.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
;;; init-keybindings.el --- Keybindings for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-keybindings.el
;; Description: Global keybindings configuration module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: keybindings, keyboard
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Keybindings module for MCG Emacs configuration, responsible for:
;; - Global keybindings setup
;; - Keybindings reference
;;
;; Note: Vundo and Markmacro have been moved to separate modules:
;; - init-undo.org for visual undo (vundo)
;; - init-multicursor.org for multi-cursor editing (markmacro)
;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)

#+END_SRC

** Unset Conflicting Keys
#+BEGIN_SRC emacs-lisp
;;; Unset Conflicting Keys

;; Unset rarely used or conflicting keybindings
(global-unset-key (kbd "C-z"))   ; suspend-frame (rarely used)
(global-unset-key (kbd "s-q"))   ; save-buffers-kill-emacs (dangerous)

#+END_SRC

** Basic Editing Keys
#+BEGIN_SRC emacs-lisp
;;; Basic Editing Keys

(defun mcg/smart-beginning-of-line ()
  "Smart beginning of line: toggle between line start and first non-whitespace character."
  (interactive)
  (let ((orig-point (point)))
    (back-to-indentation)
    (when (= orig-point (point))
      (beginning-of-line))))

(defun mcg/open-init-file ()
  "Open configuration entry file."
  (interactive)
  (find-file (expand-file-name "init.el" mcg-config-dir)))

;; Basic editing - using mcg-bind-key for registry tracking
(mcg-bind-key "C-a" mcg/smart-beginning-of-line "init-keybindings")
(mcg-bind-key "C-c E" mcg/open-init-file "init-keybindings")
(mcg-bind-key "C-c R" replace-string "init-keybindings")
(mcg-bind-key "C-c M-r" replace-regexp "init-keybindings")
(mcg-bind-key "C-c D" make-directory "init-keybindings")

#+END_SRC

** Line Manipulation
#+BEGIN_SRC emacs-lisp
;;; Line Manipulation

;; Define named functions for line manipulation
(defun mcg/insert-line-below ()
  "Insert new line below current line."
  (interactive)
  (end-of-line)
  (newline-and-indent))

(defun mcg/insert-line-above ()
  "Insert new line above current line."
  (interactive)
  (beginning-of-line)
  (newline)
  (forward-line -1)
  (indent-according-to-mode))

(defun mcg/move-line-up ()
  "Move current line up."
  (interactive)
  (transpose-lines 1)
  (forward-line -2)
  (indent-according-to-mode))

(defun mcg/move-line-down ()
  "Move current line down."
  (interactive)
  (forward-line 1)
  (transpose-lines 1)
  (forward-line -1)
  (indent-according-to-mode))

;; Line manipulation keybindings
(mcg-bind-key "C-c <down>" mcg/insert-line-below "init-keybindings")
(mcg-bind-key "C-c <up>" mcg/insert-line-above "init-keybindings")
(mcg-bind-key "M-<up>" mcg/move-line-up "init-keybindings")
(mcg-bind-key "M-<down>" mcg/move-line-down "init-keybindings")

#+END_SRC

** Scrolling
#+BEGIN_SRC emacs-lisp
;;; Scrolling

(defun mcg/scroll-down-third ()
  "Scroll down 1/3 window height."
  (interactive)
  (scroll-up (/ (window-body-height) 3)))

(defun mcg/scroll-up-third ()
  "Scroll up 1/3 window height."
  (interactive)
  (scroll-down (/ (window-body-height) 3)))

(mcg-bind-key "M-n" mcg/scroll-down-third "init-keybindings")
(mcg-bind-key "M-p" mcg/scroll-up-third "init-keybindings")

#+END_SRC

** Vundo and Multicursor Modules
#+BEGIN_SRC emacs-lisp
;;; Vundo and Multicursor Modules
;; These features have been moved to separate modules for better modularity.
;; - init-undo: Visual undo with vundo
;; - init-multicursor: Multi-cursor editing with markmacro
;; Load them via mcg! macro: :editor undo multicursor

#+END_SRC

** Yasnippet Keys
#+BEGIN_SRC emacs-lisp
;;; Yasnippet Keys

(mcg-bind-key "C-c y n" yas-new-snippet "init-keybindings")
(mcg-bind-key "C-c y v" yas-visit-snippet-file "init-keybindings")
(mcg-bind-key "C-c y r" yas-reload-all "init-keybindings")

#+END_SRC

** Sort-tab Keys
#+BEGIN_SRC emacs-lisp
;;; Sort-tab Keys (C-c t prefix)

;; Tab number selection helper functions
(defun mcg-select-tab-1 ()
  "Select tab 1."
  (interactive)
  (when (fboundp 'sort-tab-select-by-index)
    (sort-tab-select-by-index 0)))

(defun mcg-select-tab-2 ()
  "Select tab 2."
  (interactive)
  (when (fboundp 'sort-tab-select-by-index)
    (sort-tab-select-by-index 1)))

(defun mcg-select-tab-3 ()
  "Select tab 3."
  (interactive)
  (when (fboundp 'sort-tab-select-by-index)
    (sort-tab-select-by-index 2)))

(defun mcg--setup-sort-tab-keys ()
  "Setup sort-tab keybindings."
  (with-eval-after-load 'sort-tab
    ;; Navigation
    (mcg-bind-key "C-c t n" sort-tab-select-next-tab "init-keybindings")
    (mcg-bind-key "C-c t p" sort-tab-select-prev-tab "init-keybindings")
    (mcg-bind-key "C-c t f" sort-tab-select-first-tab "init-keybindings")
    (mcg-bind-key "C-c t l" sort-tab-select-last-tab "init-keybindings")
    
    ;; Management
    (mcg-bind-key "C-c t k" sort-tab-close-current-tab "init-keybindings")
    (mcg-bind-key "C-c t o" sort-tab-close-other-tabs "init-keybindings")
    (mcg-bind-key "C-c t K" sort-tab-close-all-tabs "init-keybindings")
    
    ;; Number quick selection
    (mcg-bind-key "C-c t 1" mcg-select-tab-1 "init-keybindings")
    (mcg-bind-key "C-c t 2" mcg-select-tab-2 "init-keybindings")
    (mcg-bind-key "C-c t 3" mcg-select-tab-3 "init-keybindings")
    
    (mcg-log "Sort-tab keybindings configured")))

#+END_SRC

** Search Keys
#+BEGIN_SRC emacs-lisp
;;; Search Keys (C-c s prefix)

(defun mcg--setup-search-keys ()
  "Setup search-related keybindings."
  ;; Consult search (use autoload to ensure commands are available)
  (autoload 'consult-line "consult" nil t)
  (autoload 'consult-imenu "consult-imenu" nil t)
  (autoload 'consult-mark "consult" nil t)
  (autoload 'consult-buffer "consult" nil t)
  (autoload 'consult-recent-file "consult" nil t)
  (autoload 'consult-project-buffer "consult" nil t)
  
  (mcg-bind-key "C-c s l" consult-line "init-keybindings")
  (mcg-bind-key "C-c s i" consult-imenu "init-keybindings")
  (mcg-bind-key "C-c s m" consult-mark "init-keybindings")
  (mcg-bind-key "C-c s b" consult-buffer "init-keybindings")
  (mcg-bind-key "C-c s r" consult-recent-file "init-keybindings")
  
  ;; Buffer management with project filtering
  (mcg-bind-key "C-c b b" consult-buffer "init-keybindings")
  (mcg-bind-key "C-c b p" consult-project-buffer "init-keybindings")
  (mcg-bind-key "C-c b r" consult-recent-file "init-keybindings")
  
  ;; Embark
  (autoload 'embark-act "embark" nil t)
  (autoload 'embark-dwim "embark" nil t)
  (mcg-bind-key "C-." embark-act "init-keybindings")
  (mcg-bind-key "C-," embark-dwim "init-keybindings")
  
  ;; Color-rg search
  (with-eval-after-load 'color-rg
    (mcg-bind-key "C-c s g" color-rg-search-input "init-keybindings")
    (mcg-bind-key "C-c s G" color-rg-search-input-in-project "init-keybindings")
    (mcg-bind-key "C-c s s" color-rg-search-symbol "init-keybindings")
    (mcg-bind-key "C-c s S" color-rg-search-symbol-in-project "init-keybindings")
    (mcg-bind-key "C-c s ." color-rg-search-symbol-in-current-file "init-keybindings")
    (mcg-bind-key "C-c s ," color-rg-search-input-in-current-file "init-keybindings"))
  
  ;; Blink-search
  (with-eval-after-load 'blink-search
    (mcg-bind-key "C-c s B" blink-search "init-keybindings"))
  
  (mcg-log "Search keybindings configured"))

#+END_SRC

** File Keys
#+BEGIN_SRC emacs-lisp
;;; File Keys (C-c f prefix)

(defun mcg--setup-file-keys ()
  "Setup file-related keybindings."
  ;; Recent files (consult-recent-file already autoloaded in search keys)
  (mcg-bind-key "C-c f r" consult-recent-file "init-keybindings")
  
  (mcg-log "File keybindings configured"))

#+END_SRC

** Git Keys
#+BEGIN_SRC emacs-lisp
;;; Git Keys (C-c g prefix)

(defun mcg--setup-git-keys ()
  "Setup Git-related keybindings."
  (with-eval-after-load 'magit
    ;; Main commands
    (mcg-bind-key "C-x g" magit-status "init-keybindings")
    (mcg-bind-key "C-x M-g" magit-dispatch "init-keybindings")
    (mcg-bind-key "C-c g s" magit-status "init-keybindings")
    (mcg-bind-key "C-c g l" magit-log "init-keybindings")
    (mcg-bind-key "C-c g d" magit-dispatch "init-keybindings")
    (mcg-bind-key "C-c g f" magit-file-dispatch "init-keybindings")
    
    ;; Push/Pull
    (mcg-bind-key "C-c g p" magit-push "init-keybindings")
    (mcg-bind-key "C-c g P" magit-pull "init-keybindings")
    
    ;; Branch
    (mcg-bind-key "C-c g b b" magit-branch-create "init-keybindings")
    (mcg-bind-key "C-c g b r" magit-branch-rename "init-keybindings")
    (mcg-bind-key "C-c g b d" magit-branch-delete "init-keybindings")
    
    ;; Submodules
    (mcg-bind-key "C-c g m a" magit-submodule-add "init-keybindings")
    (mcg-bind-key "C-c g m r" magit-submodule-remove "init-keybindings")
    (mcg-bind-key "C-c g m u" magit-submodule-update "init-keybindings")
    
    (mcg-log "Git keybindings configured")))

#+END_SRC

** LSP Keys
#+BEGIN_SRC emacs-lisp
;;; LSP Keys (Standard bindings)

(defun mcg--setup-lsp-keys ()
  "Setup LSP-related keybindings (standard bindings)."
  (with-eval-after-load 'lsp-bridge
    ;; Navigation (standard LSP bindings)
    (mcg-bind-key "M-." lsp-bridge-find-def "init-keybindings")
    (mcg-bind-key "M-," lsp-bridge-find-def-return "init-keybindings")
    (mcg-bind-key "M-?" lsp-bridge-find-references "init-keybindings")
    (mcg-bind-key "C-M-." lsp-bridge-find-def-other-window "init-keybindings")
    
    ;; Documentation (C-h prefix for help)
    (mcg-bind-key "C-h ." lsp-bridge-popup-documentation "init-keybindings")
    (mcg-bind-key "C-h ," lsp-bridge-show-signature "init-keybindings")
    (mcg-bind-key "C-h <up>" lsp-bridge-popup-documentation-scroll-up "init-keybindings")
    (mcg-bind-key "C-h <down>" lsp-bridge-popup-documentation-scroll-down "init-keybindings")
    
    ;; Code actions (C-c r prefix for refactoring)
    (mcg-bind-key "C-c r r" lsp-bridge-rename "init-keybindings")
    (mcg-bind-key "C-c r a" lsp-bridge-code-action "init-keybindings")
    (mcg-bind-key "C-c r f" lsp-bridge-code-format "init-keybindings")
    (mcg-bind-key "C-c r l" lsp-bridge-find-impl "init-keybindings")
    (mcg-bind-key "C-c r s" lsp-bridge-workspace-list-symbols "init-keybindings")
    
    ;; Diagnostics (M-g prefix - standard Emacs "goto" prefix)
    (mcg-bind-key "M-g n" lsp-bridge-diagnostic-jump-next "init-keybindings")
    (mcg-bind-key "M-g p" lsp-bridge-diagnostic-jump-prev "init-keybindings")
    (mcg-bind-key "M-g l" lsp-bridge-diagnostic-list "init-keybindings"))
  
  (mcg-log "LSP keybindings configured"))

#+END_SRC

** Org Keys
#+BEGIN_SRC emacs-lisp
;;; Org Keys (C-c n prefix)

(defun mcg--setup-org-keys ()
  "Setup Org-related keybindings."
  (with-eval-after-load 'org
    (mcg-bind-key "C-c n c" org-capture "init-keybindings")
    (mcg-bind-key "C-c n a" org-agenda "init-keybindings")
    (mcg-bind-key "C-c n l" org-store-link "init-keybindings")
    (mcg-bind-key "C-c n t" org-todo-list "init-keybindings"))
  
  (mcg-log "Org keybindings configured"))

#+END_SRC

** Elisp Development Keys
#+BEGIN_SRC emacs-lisp
;;; Elisp Development Keys

(with-eval-after-load 'elisp-mode
  (define-key emacs-lisp-mode-map (kbd "C-c C-b") 'eval-buffer)
  (define-key emacs-lisp-mode-map (kbd "C-c C-r") 'eval-region))

#+END_SRC

** Transient Menus
#+BEGIN_SRC emacs-lisp
;;; Transient Menus

(defun mcg--setup-transient-menus ()
  "Setup Transient menus."
  (when (require 'transient nil t)
    ;; Search menu
    (transient-define-prefix mcg-search-menu ()
      "Search commands menu"
      [["Buffer"
        ("l" "Line" consult-line)
        ("i" "Imenu" consult-imenu)
        ("m" "Mark" consult-mark)]
       ["Project"
        ("g" "Grep" color-rg-search-input-in-project)
        ("s" "Symbol" color-rg-search-symbol-in-project)
        ("B" "Blink" blink-search)]
       ["Current"
        ("." "Symbol here" color-rg-search-symbol-in-current-file)
        ("," "Input here" color-rg-search-input-in-current-file)]])
    
    (mcg-bind-key "C-c s ?" mcg-search-menu "init-keybindings")
    
    ;; Buffer menu - enhanced with project filtering
    (transient-define-prefix mcg-buffer-menu ()
      "Buffer management menu with project filtering"
      [["Switch"
        ("b" "All buffers" consult-buffer)
        ("p" "Project buffers" consult-project-buffer)
        ("r" "Recent files" consult-recent-file)
        ("m" "By mode" mcg/consult-buffer-by-mode)]
       ["Actions"
        ("k" "Kill buffer" kill-buffer)
        ("K" "Kill project buffers" mcg/kill-project-buffers)
        ("s" "Save buffer" save-buffer)
        ("S" "Save all" save-some-buffers)]
       ["Navigate"
        ("n" "Next buffer" next-buffer)
        ("P" "Previous buffer" previous-buffer)
        ("o" "Other window" switch-to-buffer-other-window)]])
    
    (mcg-bind-key "C-c b ?" mcg-buffer-menu "init-keybindings")
    
    ;; Git menu
    (transient-define-prefix mcg-git-menu ()
      "Git operations menu"
      [["Main"
        ("s" "Status" magit-status)
        ("l" "Log" magit-log)
        ("d" "Dispatch" magit-dispatch)]
       ["Commit"
        ("c" "Commit" magit-commit)
        ("a" "Amend" magit-commit-amend)]
       ["Remote"
        ("p" "Push" magit-push)
        ("P" "Pull" magit-pull)
        ("f" "Fetch" magit-fetch)]])
    
    (mcg-bind-key "C-c g ?" mcg-git-menu "init-keybindings")
    
    ;; Window menu
    (transient-define-prefix mcg-window-menu ()
      "Window operations menu"
      [["Switch"
        ("w" "Ace window" ace-window)
        ("o" "Other window" other-window)]
       ["Split"
        ("v" "Vertical" split-window-right)
        ("h" "Horizontal" split-window-below)]
       ["Delete"
        ("d" "Delete" ace-delete-window)
        ("D" "Delete others" delete-other-windows)]
       ["Swap"
        ("s" "Swap" ace-swap-window)
        ("u" "Undo layout" winner-undo)
        ("r" "Redo layout" winner-redo)]])
    
    (mcg-bind-key "C-c w ?" mcg-window-menu "init-keybindings")
    
    ;; Help menu - unified help system
    (transient-define-prefix mcg-help-menu ()
      "MCG Help Menu - unified help system"
      [["Documentation"
        ("k" "Keybindings" mcg/show-keybindings)
        ("m" "Modules" mcg-list-modules)
        ("e" "Extensions" mcg/list-extensions)]
       ["Diagnostics"
        ("d" "Doctor" mcg-doctor)
        ("t" "Load times" mcg/show-load-times)
        ("l" "Logs" mcg/show-logs)]
       ["Configuration"
        ("c" "Open config" mcg/open-init-file)
        ("r" "Reload module" mcg/reload-module)
        ("R" "Rebuild cache" mcg/rebuild-extension-cache)]])
    
    (mcg-bind-key "C-h M" mcg-help-menu "init-keybindings")
    
    (mcg-log "Transient menus configured")))

;; Delayed load transient menus
(with-eval-after-load 'transient
  (mcg--setup-transient-menus))

#+END_SRC

** Keybindings Reference
#+BEGIN_SRC emacs-lisp
;;; Keybindings Reference

(defun mcg/show-keybindings ()
  "Show keybindings reference in posframe popup."
  (interactive)
  (mcg-popup-show "*MCG Keybindings*" (mcg--keybindings-content) 70 45))

(defun mcg--format-keybinding-entry (key command source)
  "Format a single keybinding entry for display.
KEY is the key sequence, COMMAND is the command symbol, SOURCE is the module."
  (format "  %-16s %-30s %s" key command source))

(defun mcg--keybindings-by-category ()
  "Group registered keybindings by category prefix.
Returns an alist of (CATEGORY . BINDINGS)."
  (let ((categories '(("C-c s" . "搜索 Search")
                      ("C-c g" . "Git")
                      ("C-c t" . "标签页 Tabs")
                      ("C-c n" . "Org/笔记")
                      ("C-c r" . "重构 Refactor")
                      ("C-c y" . "Yasnippet")
                      ("C-c f" . "文件 Files")
                      ("C-c w" . "窗口 Window")
                      ("C-c e" . "Eshell")
                      ("M-g" . "跳转 Goto")
                      ("M-." . "LSP 导航")
                      ("M-," . "LSP 导航")
                      ("M-?" . "LSP 导航")
                      ("C-h" . "帮助 Help")
                      ("C-." . "Embark")
                      ("C-," . "Embark")))
        (result nil)
        (other nil))
    ;; Group bindings by category
    (dolist (binding (mcg-list-keybindings))
      (let* ((key (car binding))
             (command (cadr binding))
             (source (caddr binding))
             (found nil))
        (dolist (cat categories)
          (when (and (not found) (string-prefix-p (car cat) key))
            (let ((existing (assoc (cdr cat) result)))
              (if existing
                  (setcdr existing (cons binding (cdr existing)))
                (push (cons (cdr cat) (list binding)) result)))
            (setq found t)))
        (unless found
          (push binding other))))
    ;; Add "Other" category if there are uncategorized bindings
    (when other
      (push (cons "其他 Other" (nreverse other)) result))
    (nreverse result)))

(defun mcg--keybindings-content ()
  "Generate keybindings reference content from registry."
  (let ((grouped (mcg--keybindings-by-category))
        (conflicts (mcg-list-keybinding-conflicts)))
    (with-temp-buffer
      (insert "                MCG Emacs 快捷键速查 (Registry)\n")
      (insert "    ═══════════════════════════════════════════════════\n\n")
      
      ;; Show conflicts if any
      (when conflicts
        (insert "    ⚠️  检测到快捷键冲突:\n")
        (dolist (conflict conflicts)
          (insert (format "       %s: %s vs %s\n"
                          (car conflict)
                          (cadr conflict)
                          (nth 3 conflict))))
        (insert "\n"))
      
      ;; Show bindings by category
      (if grouped
          (dolist (category grouped)
            (insert (format "    【%s】\n" (car category)))
            (dolist (binding (sort (cdr category)
                                   (lambda (a b) (string< (car a) (car b)))))
              (insert (format "    %-16s %s\n"
                              (car binding)
                              (cadr binding))))
            (insert "\n"))
        ;; Fallback to static content if registry is empty
        (insert (mcg--keybindings-static-content)))
      
      (insert "    ───────────────────────────────────────────────────\n")
      (insert (format "    共 %d 个快捷键已注册\n" (length mcg-keybinding-registry)))
      
      (buffer-string))))

(defun mcg--keybindings-static-content ()
  "Static keybindings content as fallback."
  "
    【LSP】                                               
    M-.             跳转到定义                            
    M-,             返回                                  
    M-?             查找引用                              
    C-h .           显示文档                              
    C-c r r         重命名                                
    C-c r a         代码操作                              
    M-g n/p         下一个/上一个诊断                     

    【Git】 C-c g                                         
    C-x g           Magit 状态                            
    C-c g s         Magit 状态                            
    C-c g p/P       推送/拉取                             

    【搜索】 C-c s                                        
    C-c s l         搜索行 (consult-line)                 
    C-c s g         搜索内容 (color-rg)                   
    C-c s G         项目内搜索                            
    C-c s i         Imenu 导航                            

    【标签页】 C-c t                                      
    C-c t n/p       下一个/上一个标签                     
    C-c t k         关闭当前标签                          
    C-c t 1/2/3     快速选择标签                          

    【编辑】                                              
    C-a             智能行首                              
    C-c E           打开配置文件                          
    M-n/M-p         滚动 1/3 窗口                         
    M-UP/DOWN       移动行                                
")

(mcg-bind-key "C-h K" mcg/show-keybindings "init-keybindings")

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

(mcg--setup-sort-tab-keys)
(mcg--setup-search-keys)
(mcg--setup-file-keys)
(mcg--setup-git-keys)
(mcg--setup-lsp-keys)
(mcg--setup-org-keys)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-keybindings)
;;; init-keybindings.el ends here
#+END_SRC
