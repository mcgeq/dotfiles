#+TITLE: Chinese Input Method Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-rime.el :lexical t

* Chinese Input Method Module

本模块负责 MCG Emacs 的中文输入法配置，包括：
- emacs-rime 配置
- 自动中英文切换
- 光标颜色指示器

** File Header

#+begin_src emacs-lisp
;;; init-rime.el --- Chinese Input Method for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-rime.el
;; Description: Chinese input method module (emacs-rime)
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-10
;; Version: 3.0
;; Keywords: input-method, rime, chinese
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Chinese input method module for MCG Emacs, responsible for:
;; - emacs-rime configuration
;; - Automatic Chinese/English switching
;; - Cursor color indicator
;;
;; Module metadata:
;; :depends ()
;; :defer t
;;
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

(require 'core-lib)
#+end_src

** Variables

Rime 相关的配置变量。

#+begin_src emacs-lisp
;;; ============================================================
;;; Variables
;;; ============================================================

(defvar mcg-tools-rime-user-data-dir "~/.config/emacs_rime"
  "Rime user data directory.")

(defvar mcg-tools-rime-show-candidate 'posframe
  "Rime candidate display method.
Options: 'posframe, 'popup, 'minibuffer")

(defvar mcg-tools-rime-posframe-bg "#333333"
  "Rime posframe background color.")

(defvar mcg-tools-rime-posframe-fg "#dcdccc"
  "Rime posframe foreground color.")

(defvar mcg-tools-rime-posframe-border-width 10
  "Rime posframe border width.")

(defvar mcg-tools-rime-cursor-color "white"
  "Cursor color when typing Chinese.")

(defvar mcg-tools-rime-default-cursor-color nil
  "Default cursor color (auto-detected).")

(defvar mcg-rime-auto-enable nil
  "Whether to auto-enable rime when entering text-mode.
When non-nil, rime will be automatically enabled in text-mode
after being disabled in prog-mode.")

(defvar mcg-rime-prog-mode-disabled nil
  "Internal variable to track if rime was disabled by prog-mode hook.
Used to restore rime state when switching to text-mode.")
#+end_src

** Rime Configuration

Rime 核心配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; Rime Configuration
;;; ============================================================

(defun mcg--setup-rime ()
  "Setup emacs-rime."
  (when (mcg-require-extension "emacs-rime" t)
    ;; Load popup (optional dependency)
    (mcg-require-extension "popup" t)
    (require 'popup nil t)
    
    ;; Set default input method
    (setq default-input-method "rime")
    
    ;; User data directory
    (setq rime-user-data-dir mcg-tools-rime-user-data-dir)
    
    ;; Candidate display method
    (setq rime-show-candidate mcg-tools-rime-show-candidate)
    
    ;; Posframe style
    (setq rime-posframe-properties
          (list :background-color mcg-tools-rime-posframe-bg
                :foreground-color mcg-tools-rime-posframe-fg
                :internal-border-width mcg-tools-rime-posframe-border-width))
    
    (mcg-log "emacs-rime configured")))
#+end_src

** Rime Keybindings

Rime 快捷键配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; Rime Keybindings
;;; ============================================================

(defun mcg--setup-rime-keybindings ()
  "Setup Rime keybindings."
  (when (and (featurep 'rime) (boundp 'rime-active-mode-map))
    (define-key rime-active-mode-map (kbd "M-DEL") 'rime--escape)
    (define-key rime-active-mode-map (kbd "C-w") 'rime--escape)
    (mcg-log "Rime keybindings configured")))
#+end_src

** Auto Switch Predicates

Rime 自动切换规则配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; Auto Switch Predicates
;;; ============================================================

(defun mcg--setup-rime-predicates ()
  "Setup Rime auto-switch rules."
  (when (featurep 'rime)
    (setq rime-disable-predicates
          '(rime-predicate-after-ascii-char-p
            rime-predicate-evil-mode-p
            rime-predicate-punctuation-after-space-cc-p
            rime-predicate-punctuation-after-ascii-p
            rime-predicate-punctuation-line-begin-p
            rime-predicate-org-in-src-block-p
            rime-predicate-prog-in-code-p
            rime-predicate-org-latex-mode-p
            rime-predicate-space-after-cc-p
            rime-predicate-current-uppercase-letter-p
            rime-predicate-tex-math-or-command-p))
    (mcg-log "Rime predicates configured")))
#+end_src

** Cursor Color Indicator

光标颜色指示器配置。

*** Get Frame Cursor Color

#+begin_src emacs-lisp
;;; ============================================================
;;; Cursor Color Indicator
;;; ============================================================

(defun mcg--get-frame-cursor-color ()
  "Get current frame cursor color."
  (frame-parameter nil 'cursor-color))
#+end_src

*** Change Cursor Color

#+begin_src emacs-lisp
(defun mcg--change-cursor-color-on-input-method ()
  "Change cursor color based on input method state."
  (when (featurep 'rime)
    (set-cursor-color
     (if (and (rime--should-enable-p)
              (not (rime--should-inline-ascii-p))
              current-input-method)
         mcg-tools-rime-cursor-color
       (or mcg-tools-rime-default-cursor-color "black")))))
#+end_src

*** Setup Cursor Color

#+begin_src emacs-lisp
(defun mcg--setup-rime-cursor-color ()
  "Setup Rime cursor color indicator."
  (when (featurep 'rime)
    ;; Save default cursor color
    (setq mcg-tools-rime-default-cursor-color (mcg--get-frame-cursor-color))
    
    ;; Change cursor color after toggling input method
    (advice-add 'toggle-input-method :after #'mcg--change-cursor-color-on-input-method)
    
    ;; Check after each command
    (add-hook 'post-command-hook #'mcg--change-cursor-color-on-input-method)
    
    (mcg-log "Rime cursor color indicator configured")))
#+end_src

** Commands

Rime 操作命令。

*** Switch Manually

#+begin_src emacs-lisp
;;; ============================================================
;;; Commands
;;; ============================================================

(defun mcg/rime-switch-manually ()
  "Manually switch to Rime input method."
  (interactive)
  (when (featurep 'rime)
    (rime-force-enable)))
#+end_src

*** Switch Auto

#+begin_src emacs-lisp
(defun mcg/rime-switch-auto ()
  "Switch to auto mode."
  (interactive)
  (when (featurep 'rime)
    (rime-disable)))
#+end_src

*** Toggle Show Candidate

#+begin_src emacs-lisp
(defun mcg/rime-toggle-show-candidate ()
  "Toggle candidate display method."
  (interactive)
  (when (featurep 'rime)
    (setq rime-show-candidate
          (pcase rime-show-candidate
            ('posframe 'popup)
            ('popup 'minibuffer)
            ('minibuffer 'posframe)
            (_ 'posframe)))
    (message "Rime show candidate: %s" rime-show-candidate)))
#+end_src

*** Rime Sync

#+begin_src emacs-lisp
(defun mcg/rime-sync ()
  "Sync Rime user data."
  (interactive)
  (when (featurep 'rime)
    (rime-sync)
    (message "Rime sync done")))
#+end_src

*** Sync with ibus

#+begin_src emacs-lisp
(defun mcg/rime-sync-with-ibus ()
  "Sync ibus and emacs-rime user databases."
  (interactive)
  (when (featurep 'rime)
    (rime-sync)
    (start-process-shell-command
     ""
     nil
     "ibus exit;cd ~/.config/ibus/rime; rime_dict_manager -s;ibus-daemon --xim -d -r")
    (message "ibus-rime and emacs rime sync done")))
#+end_src

** Prog-mode Integration

编程模式集成配置。

*** Disable in Prog-mode

#+begin_src emacs-lisp
;;; ============================================================
;;; Prog-mode Integration
;;; ============================================================

(defun mcg--rime-disable-in-prog-mode ()
  "Auto-disable rime in programming modes.
This function is added to `prog-mode-hook' to automatically
disable Chinese input when editing code."
  (when (and (featurep 'rime)
             (boundp 'current-input-method)
             current-input-method
             (string= current-input-method "rime"))
    ;; Mark that we disabled rime due to prog-mode
    (setq mcg-rime-prog-mode-disabled t)
    ;; Disable rime input method
    (deactivate-input-method)
    (mcg-log "Rime auto-disabled in prog-mode: %s" major-mode)))
#+end_src

*** Enable in Text-mode

#+begin_src emacs-lisp
(defun mcg--rime-enable-in-text-mode ()
  "Auto-enable rime in text modes.
This function is added to `text-mode-hook' to automatically
re-enable Chinese input when editing text, if it was previously
disabled by prog-mode and `mcg-rime-auto-enable' is non-nil."
  (when (and (featurep 'rime)
             mcg-rime-auto-enable
             mcg-rime-prog-mode-disabled)
    ;; Reset the flag
    (setq mcg-rime-prog-mode-disabled nil)
    ;; Re-enable rime input method
    (activate-input-method "rime")
    (mcg-log "Rime auto-enabled in text-mode: %s" major-mode)))
#+end_src

*** Setup Prog-mode Integration

#+begin_src emacs-lisp
(defun mcg--setup-rime-prog-mode ()
  "Setup auto-disable rime in programming modes."
  (when (featurep 'rime)
    ;; Disable rime when entering prog-mode
    (add-hook 'prog-mode-hook #'mcg--rime-disable-in-prog-mode)
    
    ;; Re-enable rime when entering text-mode (if configured)
    (add-hook 'text-mode-hook #'mcg--rime-enable-in-text-mode)
    
    (mcg-log "Rime prog-mode integration configured")))
#+end_src

*** Toggle Auto Enable

#+begin_src emacs-lisp
(defun mcg/toggle-rime-auto-enable ()
  "Toggle automatic rime re-enable in text-mode."
  (interactive)
  (setq mcg-rime-auto-enable (not mcg-rime-auto-enable))
  (message "Rime auto-enable in text-mode: %s"
           (if mcg-rime-auto-enable "enabled" "disabled")))
#+end_src

** Symbol to Rime

符号转换为 Rime 输入。

*** Translate Symbol

#+begin_src emacs-lisp
;;; ============================================================
;;; Symbol to Rime
;;; ============================================================

(defun mcg/translate-symbol-to-rime ()
  "Convert English characters before cursor to Rime input."
  (interactive)
  (when (featurep 'rime)
    (let* ((end (point))
           (beg (+ end (skip-chars-backward "a-z")))
           (input (buffer-substring beg end)))
      (delete-region beg end)
      (unless current-input-method
        (toggle-input-method))
      (dolist (c (string-to-list input))
        (rime-lib-process-key c 0))
      (rime--redisplay))))
#+end_src

*** Convert Code or Disable

#+begin_src emacs-lisp
(defun mcg/convert-code-or-disable-rime ()
  "Convert code or disable Rime."
  (interactive)
  (when (featurep 'rime)
    (let ((str-before-1 (if (> (point) (point-min))
                            (buffer-substring-no-properties (1- (point)) (point))
                          "")))
      (cond ((string-match-p "[a-z]" str-before-1)
             (mcg/translate-symbol-to-rime))
            (t (toggle-input-method))))))
#+end_src

** Modeline Indicator

模式行指示器配置。

*** Indicator Variables

#+begin_src emacs-lisp
;;; ============================================================
;;; Modeline Indicator
;;; ============================================================

(defvar mcg-rime-modeline-indicator " 中"
  "Modeline indicator when rime is active.
This string is displayed in the modeline to show Chinese input is enabled.")

(defvar mcg-rime-modeline-indicator-ascii " En"
  "Modeline indicator when rime is in ASCII mode.
This string is displayed in the modeline to show English input is active.")
#+end_src

*** Get Modeline Indicator

#+begin_src emacs-lisp
(defun mcg--rime-get-modeline-indicator ()
  "Get the current rime modeline indicator string.
Returns the appropriate indicator based on rime state."
  (if (and (featurep 'rime)
           (boundp 'current-input-method)
           current-input-method
           (string= current-input-method "rime"))
      (if (and (fboundp 'rime--should-inline-ascii-p)
               (rime--should-inline-ascii-p))
          mcg-rime-modeline-indicator-ascii
        mcg-rime-modeline-indicator)
    ""))
#+end_src

*** Setup Modeline

#+begin_src emacs-lisp
(defun mcg--setup-rime-modeline ()
  "Setup rime indicator in modeline."
  (when (featurep 'rime)
    ;; Use posframe for candidate display (enhanced visual feedback)
    (setq rime-show-candidate 'posframe)
    (setq rime-posframe-style 'vertical)
    
    ;; Set the rime title for modeline display
    (setq rime-title mcg-rime-modeline-indicator)
    
    ;; Add rime indicator to mode-line-misc-info if not already present
    (unless (member '(:eval (mcg--rime-get-modeline-indicator)) mode-line-misc-info)
      (push '(:eval (mcg--rime-get-modeline-indicator)) mode-line-misc-info))
    
    (mcg-log "Rime modeline indicator configured")))
#+end_src

*** Toggle Modeline Indicator

#+begin_src emacs-lisp
(defun mcg/toggle-rime-modeline-indicator ()
  "Toggle rime modeline indicator visibility."
  (interactive)
  (if (member '(:eval (mcg--rime-get-modeline-indicator)) mode-line-misc-info)
      (progn
        (setq mode-line-misc-info
              (remove '(:eval (mcg--rime-get-modeline-indicator)) mode-line-misc-info))
        (message "Rime modeline indicator hidden"))
    (push '(:eval (mcg--rime-get-modeline-indicator)) mode-line-misc-info)
    (message "Rime modeline indicator shown"))
  (force-mode-line-update t))
#+end_src

** Initialize

模块初始化。

#+begin_src emacs-lisp
;;; ============================================================
;;; Initialize
;;; ============================================================

;; Setup Rime
(mcg--setup-rime)

;; Setup other configurations after rime loads
(with-eval-after-load 'rime
  (mcg--setup-rime-keybindings)
  (mcg--setup-rime-predicates)
  (mcg--setup-rime-cursor-color)
  (mcg--setup-rime-prog-mode)
  (mcg--setup-rime-modeline))
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-rime)
;;; init-rime.el ends here
#+end_src
