* init-rime.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-rime.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; init-rime.el --- Chinese Input Method for MCG Emacs -*- lexical-binding: t; -*-

  ;; Filename: init-rime.el
  ;; Description: Chinese input method module (emacs-rime)
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024-2026, mcge, all rights reserved.
  ;; Create   Date: 2026-01-07
  ;; Version: 3.0
  ;; Keywords: input-method, rime, chinese
  ;; Compatibility: GNU Emacs 29.0+

  ;;; Commentary:
  ;;
  ;; Chinese input method module for MCG Emacs, responsible for:
  ;; - emacs-rime configuration
  ;; - Automatic Chinese/English switching
  ;; - Cursor color indicator
  ;;
  ;; Module metadata:
  ;; :depends ()
  ;; :defer t
  ;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)

#+END_SRC

** Variables
#+BEGIN_SRC emacs-lisp
;;; Variables

(defvar mcg-tools-rime-user-data-dir "~/.config/emacs_rime"
  "Rime user data directory.")

(defvar mcg-tools-rime-show-candidate 'posframe
  "Rime candidate display method.
Options: 'posframe, 'popup, 'minibuffer")

(defvar mcg-tools-rime-posframe-bg "#333333"
  "Rime posframe background color.")

(defvar mcg-tools-rime-posframe-fg "#dcdccc"
  "Rime posframe foreground color.")

(defvar mcg-tools-rime-posframe-border-width 10
  "Rime posframe border width.")

(defvar mcg-tools-rime-cursor-color "white"
  "Cursor color when typing Chinese.")

(defvar mcg-tools-rime-default-cursor-color nil
  "Default cursor color (auto-detected).")

#+END_SRC

** Rime Configuration
#+BEGIN_SRC emacs-lisp
;;; Rime Configuration

(defun mcg--setup-rime ()
  "Setup emacs-rime."
  (when (mcg-require-extension "input/rime" 'rime)
    ;; Load popup (optional dependency)
    (mcg-load-extension "input/popup")
    (require 'popup nil t)
    
    ;; Set default input method
    (setq default-input-method "rime")
    
    ;; User data directory
    (setq rime-user-data-dir mcg-tools-rime-user-data-dir)
    
    ;; Candidate display method
    (setq rime-show-candidate mcg-tools-rime-show-candidate)
    
    ;; Posframe style
    (setq rime-posframe-properties
          (list :background-color mcg-tools-rime-posframe-bg
                :foreground-color mcg-tools-rime-posframe-fg
                :internal-border-width mcg-tools-rime-posframe-border-width))
    
    (mcg-log "emacs-rime configured")))

#+END_SRC

** Rime Keybindings
#+BEGIN_SRC emacs-lisp
;;; Rime Keybindings

(defun mcg--setup-rime-keybindings ()
  "Setup Rime keybindings."
  (when (and (featurep 'rime) (boundp 'rime-active-mode-map))
    (define-key rime-active-mode-map (kbd "M-DEL") 'rime--escape)
    (define-key rime-active-mode-map (kbd "C-w") 'rime--escape)
    (mcg-log "Rime keybindings configured")))

#+END_SRC

** Auto Switch Predicates
#+BEGIN_SRC emacs-lisp
;;; Auto Switch Predicates

(defun mcg--setup-rime-predicates ()
  "Setup Rime auto-switch rules."
  (when (featurep 'rime)
    (setq rime-disable-predicates
          '(rime-predicate-after-ascii-char-p
            rime-predicate-evil-mode-p
            rime-predicate-punctuation-after-space-cc-p
            rime-predicate-punctuation-after-ascii-p
            rime-predicate-punctuation-line-begin-p
            rime-predicate-org-in-src-block-p
            rime-predicate-prog-in-code-p
            rime-predicate-org-latex-mode-p
            rime-predicate-space-after-cc-p
            rime-predicate-current-uppercase-letter-p
            rime-predicate-tex-math-or-command-p))
    (mcg-log "Rime predicates configured")))

#+END_SRC

** Cursor Color Indicator
#+BEGIN_SRC emacs-lisp
;;; Cursor Color Indicator

(defun mcg--get-frame-cursor-color ()
  "Get current frame cursor color."
  (frame-parameter nil 'cursor-color))

(defun mcg--change-cursor-color-on-input-method ()
  "Change cursor color based on input method state."
  (when (featurep 'rime)
    (set-cursor-color
     (if (and (rime--should-enable-p)
              (not (rime--should-inline-ascii-p))
              current-input-method)
         mcg-tools-rime-cursor-color
       (or mcg-tools-rime-default-cursor-color "black")))))

(defun mcg--setup-rime-cursor-color ()
  "Setup Rime cursor color indicator."
  (when (featurep 'rime)
    ;; Save default cursor color
    (setq mcg-tools-rime-default-cursor-color (mcg--get-frame-cursor-color))
    
    ;; Change cursor color after toggling input method
    (advice-add 'toggle-input-method :after #'mcg--change-cursor-color-on-input-method)
    
    ;; Check after each command
    (add-hook 'post-command-hook #'mcg--change-cursor-color-on-input-method)
    
    (mcg-log "Rime cursor color indicator configured")))

#+END_SRC

** Commands
#+BEGIN_SRC emacs-lisp
;;; Commands

(defun mcg/rime-switch-manually ()
  "Manually switch to Rime input method."
  (interactive)
  (when (featurep 'rime)
    (rime-force-enable)))

(defun mcg/rime-switch-auto ()
  "Switch to auto mode."
  (interactive)
  (when (featurep 'rime)
    (rime-disable)))

(defun mcg/rime-toggle-show-candidate ()
  "Toggle candidate display method."
  (interactive)
  (when (featurep 'rime)
    (setq rime-show-candidate
          (pcase rime-show-candidate
            ('posframe 'popup)
            ('popup 'minibuffer)
            ('minibuffer 'posframe)
            (_ 'posframe)))
    (message "Rime show candidate: %s" rime-show-candidate)))

(defun mcg/rime-sync ()
  "Sync Rime user data."
  (interactive)
  (when (featurep 'rime)
    (rime-sync)
    (message "Rime sync done")))

(defun mcg/rime-sync-with-ibus ()
  "Sync ibus and emacs-rime user databases."
  (interactive)
  (when (featurep 'rime)
    (rime-sync)
    (start-process-shell-command
     ""
     nil
     "ibus exit;cd ~/.config/ibus/rime; rime_dict_manager -s;ibus-daemon --xim -d -r")
    (message "ibus-rime and emacs rime sync done")))

#+END_SRC

** Symbol to Rime
#+BEGIN_SRC emacs-lisp
;;; Symbol to Rime

(defun mcg/translate-symbol-to-rime ()
  "Convert English characters before cursor to Rime input."
  (interactive)
  (when (featurep 'rime)
    (let* ((end (point))
           (beg (+ end (skip-chars-backward "a-z")))
           (input (buffer-substring beg end)))
      (delete-region beg end)
      (unless current-input-method
        (toggle-input-method))
      (dolist (c (string-to-list input))
        (rime-lib-process-key c 0))
      (rime--redisplay))))

(defun mcg/convert-code-or-disable-rime ()
  "Convert code or disable Rime."
  (interactive)
  (when (featurep 'rime)
    (let ((str-before-1 (if (> (point) (point-min))
                            (buffer-substring-no-properties (1- (point)) (point))
                          "")))
      (cond ((string-match-p "[a-z]" str-before-1)
             (mcg/translate-symbol-to-rime))
            (t (toggle-input-method))))))

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

;; Setup Rime
(mcg--setup-rime)

;; Setup other configurations after rime loads
(with-eval-after-load 'rime
  (mcg--setup-rime-keybindings)
  (mcg--setup-rime-predicates)
  (mcg--setup-rime-cursor-color))

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-rime)
;;; init-rime.el ends here
#+END_SRC
