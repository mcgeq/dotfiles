#+TITLE: Eshell Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-eshell.el :lexical t

* Eshell Module

æœ¬æ¨¡å—è´Ÿè´£ MCG Emacs çš„ Eshell é…ç½®ï¼ŒåŒ…æ‹¬ï¼š
- Eshell åŸºæœ¬è®¾ç½®
- è‡ªå®šä¹‰æç¤ºç¬¦ï¼ˆå¸¦ Git åˆ†æ”¯æ˜¾ç¤ºï¼‰
- å¸¸ç”¨åˆ«å
- ä¸ Emacs ç”Ÿæ€ç³»ç»Ÿçš„é›†æˆ

** File Header

#+begin_src emacs-lisp
;;; init-eshell.el --- Eshell Configuration for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-eshell.el
;; Description: Eshell shell module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-10
;; Version: 3.0
;; Keywords: eshell, shell, terminal
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Eshell configuration module for MCG Emacs, responsible for:
;; - Eshell basic settings
;; - Custom prompt with git branch
;; - Useful aliases
;; - Integration with Emacs ecosystem
;;
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

(require 'core-lib)
(require 'eshell)
(require 'esh-mode)
(require 'em-hist)
(require 'em-dirs)
(require 'em-alias)
#+end_src

** Basic Settings

Eshell åŸºæœ¬è®¾ç½®ï¼ŒåŒ…æ‹¬ç›®å½•ã€å†å²è®°å½•ã€ç¼“å†²åŒºå’Œè¡Œä¸ºé…ç½®ã€‚

#+begin_src emacs-lisp
;;; ============================================================
;;; Basic Settings
;;; ============================================================

(defun mcg--setup-eshell-basic ()
  "Setup Eshell basic settings."
  ;; Directory settings
  (setq eshell-directory-name (expand-file-name "eshell" mcg-cache-dir))
  
  ;; History settings
  (setq eshell-history-size 10000)
  (setq eshell-save-history-on-exit t)
  (setq eshell-hist-ignoredups t)
  (setq eshell-input-filter #'eshell-input-filter-initial-space)
  
  ;; Buffer settings
  (setq eshell-buffer-maximum-lines 10000)
  (setq eshell-scroll-to-bottom-on-input 'all)
  (setq eshell-scroll-to-bottom-on-output 'all)
  (setq eshell-kill-on-exit t)
  (setq eshell-destroy-buffer-when-process-dies t)
  
  ;; Behavior settings
  (setq eshell-banner-message "")
  (setq eshell-error-if-no-glob t)
  (setq eshell-glob-case-insensitive t)
  (setq eshell-highlight-prompt t)
  (setq eshell-prefer-lisp-functions nil)
  
  ;; Visual commands (use term for these)
  (setq eshell-visual-commands
        '("vi" "vim" "nvim" "screen" "tmux" "top" "htop" "btop"
          "less" "more" "ncdu" "ranger" "ssh" "tail" "watch"))
  (setq eshell-visual-subcommands
        '(("git" "log" "diff" "show" "stash")))
  
  (mcg-log "Eshell basic settings configured"))
#+end_src

** Prompt Configuration

è‡ªå®šä¹‰ Eshell æç¤ºç¬¦ï¼Œæ˜¾ç¤ºå½“å‰ç›®å½•å’Œ Git åˆ†æ”¯ã€‚

*** Git Branch

#+begin_src emacs-lisp
;;; ============================================================
;;; Prompt Configuration
;;; ============================================================

(defun mcg--eshell-git-branch ()
  "Get current git branch name."
  (let ((branch (ignore-errors
                  (car (process-lines "git" "rev-parse" "--abbrev-ref" "HEAD")))))
    (if branch
        (format " (%s)" branch)
      "")))
#+end_src

*** Prompt Function

#+begin_src emacs-lisp
(defun mcg--eshell-prompt ()
  "Custom eshell prompt function."
  (let* ((dir (abbreviate-file-name (eshell/pwd)))
         (branch (mcg--eshell-git-branch))
         (user (if (= (user-uid) 0) "#" "Î»")))
    (concat
     (propertize dir 'face 'font-lock-keyword-face)
     (propertize branch 'face 'font-lock-function-name-face)
     (propertize (format " %s " user) 'face 'eshell-prompt-face))))
#+end_src

*** Setup Prompt

#+begin_src emacs-lisp
(defun mcg--setup-eshell-prompt ()
  "Setup Eshell prompt."
  (setq eshell-prompt-function #'mcg--eshell-prompt)
  (setq eshell-prompt-regexp "^.* [Î»#] ")
  (mcg-log "Eshell prompt configured"))
#+end_src

** Aliases

Eshell åˆ«åé…ç½®ï¼ŒåŒ…æ‹¬æ–‡ä»¶æ“ä½œã€Emacs é›†æˆã€å¯¼èˆªå’Œ Git å¿«æ·æ–¹å¼ã€‚

#+begin_src emacs-lisp
;;; ============================================================
;;; Aliases
;;; ============================================================

(defun mcg--setup-eshell-aliases ()
  "Setup Eshell aliases."
  ;; File operations
  (eshell/alias "ll" "ls -la $*")
  (eshell/alias "la" "ls -a $*")
  (eshell/alias "l" "ls -CF $*")
  (eshell/alias "md" "mkdir -p $*")
  
  ;; Emacs integration
  (eshell/alias "e" "find-file $1")
  (eshell/alias "ee" "find-file-other-window $1")
  (eshell/alias "d" "dired $1")
  (eshell/alias "do" "dired-other-window $1")
  
  ;; Navigation
  (eshell/alias ".." "cd ..")
  (eshell/alias "..." "cd ../..")
  (eshell/alias "...." "cd ../../..")
  
  ;; Git shortcuts
  (eshell/alias "gs" "git status $*")
  (eshell/alias "ga" "git add $*")
  (eshell/alias "gc" "git commit $*")
  (eshell/alias "gp" "git push $*")
  (eshell/alias "gl" "git pull $*")
  (eshell/alias "gd" "git diff $*")
  (eshell/alias "gb" "git branch $*")
  (eshell/alias "gco" "git checkout $*")
  
  ;; Clear
  (eshell/alias "clear" "eshell/clear-scrollback")
  (eshell/alias "cls" "eshell/clear-scrollback")
  
  (mcg-log "Eshell aliases configured"))
#+end_src

** Custom Commands

è‡ªå®šä¹‰ Eshell å‘½ä»¤ã€‚

*** File Search

#+begin_src emacs-lisp
;;; ============================================================
;;; Custom Commands
;;; ============================================================

(defun eshell/f (filename &optional dir)
  "Search for files matching FILENAME in DIR (default current)."
  (let ((dir (or dir default-directory)))
    (find-name-dired dir filename)))
#+end_src

*** Directory Jump

#+begin_src emacs-lisp
(defun eshell/z (pattern)
  "Jump to directory matching PATTERN using recent directories."
  (let* ((dirs (ring-elements eshell-last-dir-ring))
         (match (seq-find (lambda (d) (string-match-p pattern d)) dirs)))
    (if match
        (eshell/cd match)
      (message "No matching directory found for: %s" pattern))))
#+end_src

*** Make and Change Directory

#+begin_src emacs-lisp
(defun eshell/mkcd (dir)
  "Create directory DIR and cd into it."
  (make-directory dir t)
  (eshell/cd dir))
#+end_src

*** Syntax Highlighted Cat

#+begin_src emacs-lisp
(defun eshell/ccat (file)
  "Like cat but with syntax highlighting."
  (with-temp-buffer
    (insert-file-contents file)
    (let ((buffer-file-name file))
      (delay-mode-hooks
        (set-auto-mode)
        (font-lock-ensure)))
    (buffer-string)))
#+end_src

*** Take (Alias for mkcd)

#+begin_src emacs-lisp
(defun eshell/take (dir)
  "Create DIR and cd into it (alias for mkcd)."
  (eshell/mkcd dir))
#+end_src

** Mode Hook

Eshell æ¨¡å¼é’©å­é…ç½®ã€‚

#+begin_src emacs-lisp
;;; ============================================================
;;; Mode Hook
;;; ============================================================

(defun mcg--eshell-mode-setup ()
  "Setup for eshell-mode."
  ;; Setup aliases
  (mcg--setup-eshell-aliases)
  
  ;; Environment
  (setenv "PAGER" "cat")
  (setenv "TERM" "dumb")
  
  ;; Local keybindings
  (local-set-key (kbd "C-l") #'eshell/clear-scrollback)
  (local-set-key (kbd "C-r") #'consult-history)
  
  ;; Disable line numbers
  (display-line-numbers-mode -1)
  
  ;; Disable yas in eshell
  (when (bound-and-true-p yas-minor-mode)
    (yas-minor-mode -1)))

(add-hook 'eshell-mode-hook #'mcg--eshell-mode-setup)
#+end_src

** Integration

ä¸å…¶ä»– Emacs åŒ…çš„é›†æˆã€‚

*** With-Editor Integration

#+begin_src emacs-lisp
;;; ============================================================
;;; Integration
;;; ============================================================

;; With-editor integration for git commit etc.
(with-eval-after-load 'with-editor
  (add-hook 'eshell-mode-hook #'with-editor-export-editor))
#+end_src

*** Completion Integration

#+begin_src emacs-lisp
;; Completion integration
(defun mcg--eshell-completion-setup ()
  "Setup completion for eshell."
  ;; Use native completion
  (setq-local completion-at-point-functions
              '(eshell-complete-lisp-symbol
                eshell-complete-commands-list
                pcomplete-completions-at-point
                cape-file))
  ;; Disable corfu auto if present
  (when (bound-and-true-p corfu-mode)
    (setq-local corfu-auto nil)))

(add-hook 'eshell-mode-hook #'mcg--eshell-completion-setup)
#+end_src

** Display Buffer Rules

Eshell ç¼“å†²åŒºæ˜¾ç¤ºè§„åˆ™ã€‚

#+begin_src emacs-lisp
;;; ============================================================
;;; Display Buffer Rules
;;; ============================================================

;; Force eshell to display in bottom window
(add-to-list 'display-buffer-alist
             '("\\*eshell.*\\*"
               (display-buffer-in-side-window)
               (side . bottom)
               (slot . 0)
               (window-height . 0.3)
               (window-parameters . ((no-delete-other-windows . t)))))
#+end_src

** Interactive Commands

äº¤äº’å¼ Eshell å‘½ä»¤ã€‚

*** Toggle Eshell

#+begin_src emacs-lisp
;;; ============================================================
;;; Interactive Commands
;;; ============================================================

(defun mcg/eshell-toggle ()
  "Toggle eshell at bottom of frame."
  (interactive)
  (let* ((project (project-current))
         (dir (if project (project-root project) default-directory))
         (eshell-buffer-name (format "*eshell: %s*"
                                     (file-name-nondirectory
                                      (directory-file-name dir))))
         (buf (get-buffer eshell-buffer-name))
         (win (and buf (get-buffer-window buf t))))
    (cond
     ;; Already displayed, close window
     (win
      (delete-window win))
     ;; Exists but not displayed, show it
     (buf
      (pop-to-buffer buf))
     ;; Doesn't exist, create new
     (t
      (let ((default-directory dir))
        (eshell 'N))))))
#+end_src

*** Eshell Here

#+begin_src emacs-lisp
(defun mcg/eshell-here ()
  "Open eshell at bottom in current buffer's directory."
  (interactive)
  (let* ((dir (file-name-directory (or buffer-file-name default-directory)))
         (eshell-buffer-name (format "*eshell: %s*"
                                     (file-name-nondirectory
                                      (directory-file-name dir))))
         (buf (get-buffer eshell-buffer-name))
         (win (and buf (get-buffer-window buf t))))
    (cond
     (win
      (select-window win)
      (unless (string= (expand-file-name dir)
                       (expand-file-name default-directory))
        (eshell/cd dir)
        (eshell-send-input)))
     (buf
      (pop-to-buffer buf)
      (eshell/cd dir)
      (eshell-send-input))
     (t
      (let ((default-directory dir))
        (eshell 'N))))))
#+end_src

*** New Eshell

#+begin_src emacs-lisp
(defun mcg/eshell-new ()
  "Open a new eshell buffer at bottom."
  (interactive)
  (let ((buf (eshell 'N)))
    (pop-to-buffer buf)))
#+end_src

** Keybindings

Eshell å¿«æ·é”®é…ç½®ã€‚

#+begin_src emacs-lisp
;;; ============================================================
;;; Keybindings
;;; ============================================================

(global-set-key (kbd "C-c e e") #'mcg/eshell-toggle)
(global-set-key (kbd "C-c e h") #'mcg/eshell-here)
(global-set-key (kbd "C-c e n") #'mcg/eshell-new)
(global-set-key (kbd "C-c e ?") #'mcg/eshell-help)

;; Add which-key descriptions
(with-eval-after-load 'which-key
  (which-key-add-key-based-replacements
    "C-c e" "ğŸš Eshell"))
#+end_src

** Help Popup

Eshell å¸®åŠ©å¼¹çª—ã€‚

*** Help Command

#+begin_src emacs-lisp
;;; ============================================================
;;; Help Popup
;;; ============================================================

(defun mcg/eshell-help ()
  "Show Eshell commands reference."
  (interactive)
  (let ((buf (get-buffer-create "*Eshell Help*")))
    (with-current-buffer buf
      (erase-buffer)
      (insert (mcg--eshell-help-content)))
    (display-buffer buf)))
#+end_src

*** Help Content

#+begin_src emacs-lisp
(defun mcg--eshell-help-content ()
  "Generate Eshell help content."
  "
                      Eshell å‘½ä»¤é€ŸæŸ¥                      
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  

    ã€å¿«æ·é”®ã€‘                                            
    C-c e e         åˆ‡æ¢ Eshell (é¡¹ç›®ç›®å½•)                
    C-c e h         å½“å‰æ–‡ä»¶ç›®å½•æ‰“å¼€                      
    C-c e n         æ–°å»º Eshell                           
    C-l             æ¸…å±                                  
    C-r             å†å²æœç´¢ (consult)                    

    ã€å†…ç½®åˆ«åã€‘                                          
    ll              ls -la                                
    la              ls -a                                 
    ..              cd ..                                 
    ...             cd ../..                              
    e <file>        find-file (åœ¨ Emacs æ‰“å¼€)             
    d <dir>         dired                                 
    clear/cls       æ¸…å±                                  

    ã€Git åˆ«åã€‘                                          
    gs              git status                            
    ga              git add                               
    gc              git commit                            
    gp              git push                              
    gl              git pull                              
    gd              git diff                              
    gco             git checkout                          

    ã€è‡ªå®šä¹‰å‘½ä»¤ã€‘                                        
    z <pattern>     è·³è½¬åˆ°åŒ¹é…çš„å†å²ç›®å½•                  
    mkcd <dir>      åˆ›å»ºç›®å½•å¹¶è¿›å…¥                        
    take <dir>      åŒ mkcd                               
    f <name>        æœç´¢æ–‡ä»¶                              
    ccat <file>     è¯­æ³•é«˜äº®æ˜¾ç¤ºæ–‡ä»¶                      
")
#+end_src

** Initialize

æ¨¡å—åˆå§‹åŒ–ã€‚

#+begin_src emacs-lisp
;;; ============================================================
;;; Initialize
;;; ============================================================

(mcg--setup-eshell-basic)
(mcg--setup-eshell-prompt)
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-eshell)
;;; init-eshell.el ends here
#+end_src
