* init-search.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-search.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
;;; init-search.el --- Search Tools for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-search.el
;; Description: Search tools module (Blink-search + Color-rg)
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: search, blink-search, color-rg, ripgrep
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Search tools module for MCG Emacs, responsible for:
;; - Blink-search fast search framework
;; - Color-rg project content search
;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)

#+END_SRC

** Blink-Search Configuration
#+BEGIN_SRC emacs-lisp
;;; Blink-Search Configuration

(defun mcg--setup-blink-search ()
  "Setup Blink-search fast search framework."
  (when (mcg-require-extension "search/blink-search" 'blink-search)
    ;; Common directories
    (setq blink-search-common-directory
          `(("HOME" "~/")
            ("CONFIG" ,mcg-config-dir)
            ("DOWNLOADS" "~/Downloads/")
            ("DOCUMENTS" "~/Documents/")
            ("DESKTOP" "~/Desktop/")))
    
    ;; Python command
    (setq blink-search-python-command
          (if (memq system-type '(cygwin windows-nt ms-dos))
              "python.exe"
            "python3"))
    
    ;; Display settings
    (setq blink-search-enable-icon t)
    (setq blink-search-enable-posframe t)
    (setq blink-search-posframe-width-ratio 0.8)
    (setq blink-search-posframe-height-ratio 0.6)
    (setq blink-search-posframe-standalone nil)
    (setq blink-search-flash-line-delay 0.3)
    
    ;; Search backends (nil = use all backends)
    (setq blink-search-search-backends nil)
    
    ;; File manager
    (setq blink-search-file-manager 'dired)
    
    ;; History file path
    (setq blink-search-history-path
          (expand-file-name "blink-search/history.txt" user-emacs-directory))
    
    ;; Database path
    (setq blink-search-db-path
          (expand-file-name "blink-search.db" user-emacs-directory))
    (setq blink-search-db-table "kvstore")
    
    ;; Debug settings
    (setq blink-search-enable-debug nil)
    (setq blink-search-enable-log nil)
    
    (mcg-log "Blink-search configured")))

#+END_SRC

** Blink-Search Helper Functions
#+BEGIN_SRC emacs-lisp
;;; Blink-Search Helper Functions

(defun mcg/blink-search-grep-current-dir ()
  "Search files in current directory using blink-search."
  (interactive)
  (let ((default-directory (or (when buffer-file-name
                                 (file-name-directory buffer-file-name))
                               default-directory)))
    (blink-search)))

(defun mcg/blink-search-project-root ()
  "Search files in project root using blink-search."
  (interactive)
  (let* ((project-root (or (and (fboundp 'projectile-project-root)
                                (projectile-project-root))
                           (and (fboundp 'project-root)
                                (when-let ((project (project-current)))
                                  (project-root project)))
                           default-directory))
         (default-directory project-root))
    (blink-search)))

#+END_SRC

** Color-rg Configuration
#+BEGIN_SRC emacs-lisp
;;; Color-rg Configuration

(defun mcg--setup-color-rg ()
  "Setup Color-rg project content search."
  (when (mcg-require-extension "search/color-rg" 'color-rg)
    ;; Don't limit file types
    (setq color-rg-search-file-regexp nil)
    
    ;; Ignore directories
    (setq color-rg-search-ignore-dirs
          '(".git" ".svn" ".hg" "node_modules" "dist" "build" ".cache"
            "target" ".idea" ".vscode" "__pycache__" ".pytest_cache"
            "eln-cache" "elpa" "straight"))
    
    ;; Ignore files
    (setq color-rg-search-ignore-files
          '("*.pyc" "*.o" "*.elc" "*.class" "*.jar" "*.war" "*.ear"
            "*.min.js" "*.min.css" "*.log" "*.lock" "package-lock.json"
            "*.png" "*.jpg" "*.gif" "*.pdf" "*.zip" "*.tar.gz"))
    
    ;; Kill temp buffer on exit
    (setq color-rg-kill-temp-buffer-p t)
    
    ;; Mac uses GNU grep
    (when (eq system-type 'darwin)
      (when (executable-find "ggrep")
        (setq color-rg-mac-grep "ggrep")))
    
    ;; Window height
    (setq color-rg-window-height 15)
    
    ;; Show line numbers in result buffer
    (add-hook 'color-rg-mode-hook
              (lambda ()
                (when (fboundp 'display-line-numbers-mode)
                  (display-line-numbers-mode 1))))
    
    ;; Performance optimization
    (setq color-rg-regexp-match-limit 10000)
    
    ;; Use ripgrep
    (when (executable-find "rg")
      (setq color-rg-search-command "rg"))
    
    (mcg-log "Color-rg configured")))

#+END_SRC

** Color-rg Helper Functions
#+BEGIN_SRC emacs-lisp
;;; Color-rg Helper Functions

(defun mcg/color-rg-search-project-with-type ()
  "Search in project by file type."
  (interactive)
  (let ((file-type (completing-read "File type: "
                                    '("*.el" "*.org" "*.js" "*.ts" "*.py" "*.go"
                                      "*.rs" "*.java" "*.c" "*.cpp" "*.h"
                                      "*.md" "*.txt" "*.json" "*.yaml" "*.toml"))))
    (let ((color-rg-search-file-regexp file-type))
      (call-interactively 'color-rg-search-input-in-project))))

(defun mcg/color-rg-search-in-org-directory ()
  "Search in org directory."
  (interactive)
  (let ((org-dir (if (boundp 'org-directory)
                     org-directory
                   (expand-file-name "~/org"))))
    (when (file-directory-p org-dir)
      (let ((default-directory org-dir))
        (call-interactively 'color-rg-search-input)))))

(defun mcg/color-rg-search-in-config ()
  "Search in Emacs configuration directory."
  (interactive)
  (let ((default-directory mcg-config-dir))
    (call-interactively 'color-rg-search-input)))

#+END_SRC

** Keybindings
#+BEGIN_SRC emacs-lisp
;;; Keybindings (C-c s prefix)

(defun mcg--setup-search-keybindings ()
  "Setup search related keybindings."
  ;; Blink-search
  (when (featurep 'blink-search)
    (global-set-key (kbd "C-c s B") 'blink-search)
    (global-set-key (kbd "C-c s D") 'mcg/blink-search-grep-current-dir)
    (global-set-key (kbd "C-c s P") 'mcg/blink-search-project-root))
  
  ;; Color-rg
  (when (featurep 'color-rg)
    ;; Project content search
    (global-set-key (kbd "C-c s g") 'color-rg-search-input)
    (global-set-key (kbd "C-c s G") 'color-rg-search-input-in-project)
    
    ;; Symbol search
    (global-set-key (kbd "C-c s s") 'color-rg-search-symbol)
    (global-set-key (kbd "C-c s S") 'color-rg-search-symbol-in-project)
    
    ;; Current file
    (global-set-key (kbd "C-c s .") 'color-rg-search-symbol-in-current-file)
    (global-set-key (kbd "C-c s ,") 'color-rg-search-input-in-current-file)
    
    ;; Custom search
    (global-set-key (kbd "C-c s T") 'mcg/color-rg-search-project-with-type)
    (global-set-key (kbd "C-c s O") 'mcg/color-rg-search-in-org-directory)
    (global-set-key (kbd "C-c s C") 'mcg/color-rg-search-in-config))
  
  (mcg-log "Search keybindings configured"))

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

(mcg--setup-blink-search)
(mcg--setup-color-rg)
(mcg--setup-search-keybindings)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-search)
;;; init-search.el ends here
#+END_SRC
