#+TITLE: Git Integration Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-magit.el :lexical t

* Git Integration Module

本模块负责 MCG Emacs 的 Git 集成配置，包括：
- Magit 配置
- 自定义 transient 菜单
- Git commit 模式增强

** File Header

#+begin_src emacs-lisp
;;; init-magit.el --- Git Integration for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-magit.el
;; Description: Git integration module (Magit)
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-10
;; Version: 3.0
;; Keywords: git, magit, version-control
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Git integration module for MCG Emacs, responsible for:
;; - Magit configuration
;; - Custom transient menus
;; - Git commit mode enhancements
;;
;; Module metadata:
;; :depends ()
;; :defer t
;;
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

(require 'core-lib)
#+end_src

** Variables

Magit 相关的配置变量。

#+begin_src emacs-lisp
;;; ============================================================
;;; Variables
;;; ============================================================

(defvar mcg-tools-magit-diff-refine t
  "Whether to enable diff refined highlighting.")

(defvar mcg-tools-magit-ediff-dwim t
  "Whether to show ediff on hunks.")

(defvar mcg-tools-magit-flyspell t
  "Whether to enable spell checking in commit messages.")
#+end_src

** Magit Configuration

Magit 核心配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; Magit Configuration
;;; ============================================================

(defun mcg--setup-magit ()
  "Setup Magit."
  (when (mcg-require-extension "magit" t)
    ;; Diff settings
    (setq magit-diff-refine-hunk mcg-tools-magit-diff-refine)
    (setq magit-ediff-dwim-show-on-hunks mcg-tools-magit-ediff-dwim)
    
    ;; Commit mode settings
    (when mcg-tools-magit-flyspell
      (add-hook 'git-commit-mode-hook #'flyspell-mode))
    
    (mcg-log "Magit configured")))
#+end_src

** Transient Menus

自定义 Magit transient 菜单配置。

*** Main Menu

#+begin_src emacs-lisp
;;; ============================================================
;;; Transient Menus
;;; ============================================================

(defun mcg--setup-magit-transient-menus ()
  "Setup custom Magit transient menus."
  (when (featurep 'magit)
    (require 'transient)
    
    ;; Main menu
    (transient-define-prefix mcg/magit-menu ()
      "Custom Magit menu."
      [[("t" "Status" magit-status)]
       [("b" "Branch" mcg/magit-branch-menu)]
       [("l" "Logs" mcg/magit-log-menu)]
       [("d" "Diff" mcg/magit-diff-menu)]
       [("s" "Submodule" mcg/magit-submodule-menu)]
       [("r" "Remote" mcg/magit-remote-menu)]
       [("f" "Files" mcg/magit-file-menu)]])
#+end_src

*** Branch Menu

#+begin_src emacs-lisp
    ;; Branch menu
    (transient-define-prefix mcg/magit-branch-menu ()
      "Branch operations menu."
      [["Branch Operations"
        ("c" "Create       Branch" magit-branch-create)
        ("C" "Checkout     Branch" magit-branch-checkout)
        ("n" "New Checkout Branch" magit-branch-and-checkout)
        ("m" "Merge        Branch" magit-merge)
        ("d" "Delete       Branch" magit-branch-delete)
        ("r" "Rename       Branch" magit-branch-rename)
        ("R" "Reset        Branch" magit-branch-reset)]])
#+end_src

*** Submodule Menu

#+begin_src emacs-lisp
    ;; Submodule menu
    (transient-define-prefix mcg/magit-submodule-menu ()
      "Submodule operations menu."
      [["Submodules"
        ("a" "Add    Submodule" magit-submodule-add)
        ("r" "Remove Submodule" magit-submodule-remove)
        ("u" "Update Submodule" magit-submodule-update)]])
#+end_src

*** Remote Menu

#+begin_src emacs-lisp
    ;; Remote menu
    (transient-define-prefix mcg/magit-remote-menu ()
      "Remote operations menu."
      [["Remote Operations"
        ("a" "Add    Remote" magit-remote-add)
        ("r" "Rename Remote" magit-remote-rename)]])
#+end_src

*** Log Menu

#+begin_src emacs-lisp
    ;; Log menu
    (transient-define-prefix mcg/magit-log-menu ()
      "Log viewing menu."
      [["Log"
        ("c" "Log Current" magit-log-current)
        ("l" "Log All" magit-log-all)
        ("h" "Log Heads" magit-log-head)
        ("b" "Log Branch" magit-log-branches)
        ("f" "Log Current File" magit-log-buffer-file)]])
#+end_src

*** File Menu

#+begin_src emacs-lisp
    ;; File menu
    (transient-define-prefix mcg/magit-file-menu ()
      "File operations menu."
      [["File"
        ("r" "File Rename" magit-file-rename)
        ("d" "File Delete" magit-file-delete)]])
#+end_src

*** Diff Menu

#+begin_src emacs-lisp
    ;; Diff menu
    (transient-define-prefix mcg/magit-diff-menu ()
      "Diff viewing menu."
      [["Diff"
        ("d" "Diff file" magit-diff-buffer-file)]])
    
    (mcg-log "Magit transient menus configured")))
#+end_src

** Commands

Git 操作命令。

*** Git Status

#+begin_src emacs-lisp
;;; ============================================================
;;; Commands
;;; ============================================================

(defun mcg/git-status ()
  "Open Magit status buffer."
  (interactive)
  (if (featurep 'magit)
      (magit-status)
    (mcg--setup-magit)
    (when (featurep 'magit)
      (magit-status))))
#+end_src

*** Git Blame

#+begin_src emacs-lisp
(defun mcg/git-blame ()
  "Show git blame for current file."
  (interactive)
  (if (featurep 'magit)
      (magit-blame-addition)
    (mcg--setup-magit)
    (when (featurep 'magit)
      (magit-blame-addition))))
#+end_src

*** Git Log File

#+begin_src emacs-lisp
(defun mcg/git-log-file ()
  "Show git log for current file."
  (interactive)
  (if (featurep 'magit)
      (magit-log-buffer-file)
    (mcg--setup-magit)
    (when (featurep 'magit)
      (magit-log-buffer-file))))
#+end_src

** Keybindings

Magit 快捷键配置。

#+begin_src emacs-lisp
;;; ============================================================
;;; Keybindings
;;; ============================================================

(defun mcg--setup-magit-keybindings ()
  "Setup Magit keybindings."
  (when (featurep 'magit)
    ;; Main commands
    (global-set-key (kbd "C-x g") 'magit-status)
    (global-set-key (kbd "C-x M-g") 'magit-dispatch)
    (global-set-key (kbd "C-c g s") 'magit-status)
    (global-set-key (kbd "C-c g l") 'magit-log)
    (global-set-key (kbd "C-c g d") 'magit-dispatch)
    (global-set-key (kbd "C-c g f") 'magit-file-dispatch)
    ;; Push/Pull
    (global-set-key (kbd "C-c g p") 'magit-push)
    (global-set-key (kbd "C-c g P") 'magit-pull)
    ;; Branch
    (global-set-key (kbd "C-c g b b") 'magit-branch-create)
    (global-set-key (kbd "C-c g b r") 'magit-branch-rename)
    (global-set-key (kbd "C-c g b d") 'magit-branch-delete)
    ;; Submodules
    (global-set-key (kbd "C-c g m a") 'magit-submodule-add)
    (global-set-key (kbd "C-c g m r") 'magit-submodule-remove)
    (global-set-key (kbd "C-c g m u") 'magit-submodule-update)
    ;; Custom menu
    (global-set-key (kbd "C-c g ?") 'mcg/magit-menu)
    (mcg-log "Magit keybindings configured")))
#+end_src

** Help Popup

Git 帮助弹窗。

*** Git Help Command

#+begin_src emacs-lisp
;;; ============================================================
;;; Help Popup
;;; ============================================================

(defun mcg/git-help ()
  "Show Git/Magit commands reference."
  (interactive)
  (let ((buf (get-buffer-create "*Git Help*")))
    (with-current-buffer buf
      (erase-buffer)
      (insert (mcg--git-help-content)))
    (display-buffer buf)))
#+end_src

*** Git Help Content

#+begin_src emacs-lisp
(defun mcg--git-help-content ()
  "Generate Git help content."
  "
                    Git/Magit 操作速查                    
    ═══════════════════════════════════════════════════  

    【基本操作】                                          
    C-x g           Magit 状态 (主界面)                   
    C-c g s         Magit 状态                            
    C-c g d         Magit dispatch (所有命令)             
    C-c g f         文件操作菜单                          

    【提交与推送】                                        
    C-c g p         推送 (push)                           
    C-c g P         拉取 (pull)                           

    【分支操作】 C-c g b                                  
    C-c g b b       创建分支                              
    C-c g b r       重命名分支                            
    C-c g b d       删除分支                              

    【日志查看】                                          
    C-c g l         查看日志                              

    【Submodule】 C-c g m                                 
    C-c g m a       添加 submodule                        
    C-c g m r       移除 submodule                        
    C-c g m u       更新 submodule                        

    【Magit 状态界面】                                    
    s               Stage 文件/区块                       
    u               Unstage                               
    c c             提交                                  
    P p             推送                                  
    F p             拉取                                  
    b b             切换分支                              
    l l             查看日志                              
    d d             查看 diff                             
    g               刷新                                  
    q               退出                                  
")

(global-set-key (kbd "C-c g H") #'mcg/git-help)
#+end_src

** Initialize

模块初始化。

#+begin_src emacs-lisp
;;; ============================================================
;;; Initialize
;;; ============================================================

;; Setup Magit
(mcg--setup-magit)

;; Setup transient menus and keybindings (after magit loads)
(with-eval-after-load 'magit
  (mcg--setup-magit-transient-menus)
  (mcg--setup-magit-keybindings))
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-magit)
;;; init-magit.el ends here
#+end_src
