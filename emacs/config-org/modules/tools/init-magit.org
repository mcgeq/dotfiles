* init-magit.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-magit.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; init-magit.el --- Git Integration for MCG Emacs -*- lexical-binding: t; -*-

  ;; Filename: init-magit.el
  ;; Description: Git integration module (Magit)
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024-2026, mcge, all rights reserved.
  ;; Create   Date: 2026-01-07
  ;; Version: 3.0
  ;; Keywords: git, magit, version-control
  ;; Compatibility: GNU Emacs 29.0+

  ;;; Commentary:
  ;;
  ;; Git integration module for MCG Emacs, responsible for:
  ;; - Magit configuration
  ;; - Custom transient menus
  ;; - Git commit mode enhancements
  ;;
  ;; Module metadata:
  ;; :depends ()
  ;; :defer t
  ;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)

#+END_SRC

** Variables
#+BEGIN_SRC emacs-lisp
;;; Variables

(defvar mcg-tools-magit-diff-refine t
  "Whether to enable diff refined highlighting.")

(defvar mcg-tools-magit-ediff-dwim t
  "Whether to show ediff on hunks.")

(defvar mcg-tools-magit-flyspell t
  "Whether to enable spell checking in commit messages.")

#+END_SRC

** Magit Configuration
#+BEGIN_SRC emacs-lisp
;;; Magit Configuration

(defun mcg--setup-magit ()
  "Setup Magit."
  (when (mcg-require-extension "git/magit" 'magit)
    ;; Diff settings
    (setq magit-diff-refine-hunk mcg-tools-magit-diff-refine)
    (setq magit-ediff-dwim-show-on-hunks mcg-tools-magit-ediff-dwim)
    
    ;; Commit mode settings
    (when mcg-tools-magit-flyspell
      (add-hook 'git-commit-mode-hook #'flyspell-mode))
    
    (mcg-log "Magit configured")))

#+END_SRC

** Transient Menus
#+BEGIN_SRC emacs-lisp
;;; Transient Menus

(defun mcg--setup-magit-transient-menus ()
  "Setup custom Magit transient menus."
  (when (featurep 'magit)
    (require 'transient)
    
    ;; Main menu
    (transient-define-prefix mcg/magit-menu ()
      "Custom Magit menu."
      [[("t" "Status" magit-status)]
       [("b" "Branch" mcg/magit-branch-menu)]
       [("l" "Logs" mcg/magit-log-menu)]
       [("d" "Diff" mcg/magit-diff-menu)]
       [("s" "Submodule" mcg/magit-submodule-menu)]
       [("r" "Remote" mcg/magit-remote-menu)]
       [("f" "Files" mcg/magit-file-menu)]])
    
    ;; Branch menu
    (transient-define-prefix mcg/magit-branch-menu ()
      "Branch operations menu."
      [["Branch Operations"
        ("c" "Create       Branch" magit-branch-create)
        ("C" "Checkout     Branch" magit-branch-checkout)
        ("n" "New Checkout Branch" magit-branch-and-checkout)
        ("m" "Merge        Branch" magit-merge)
        ("d" "Delete       Branch" magit-branch-delete)
        ("r" "Rename       Branch" magit-branch-rename)
        ("R" "Reset        Branch" magit-branch-reset)]])
    
    ;; Submodule menu
    (transient-define-prefix mcg/magit-submodule-menu ()
      "Submodule operations menu."
      [["Submodules"
        ("a" "Add    Submodule" magit-submodule-add)
        ("r" "Remove Submodule" magit-submodule-remove)
        ("u" "Update Submodule" magit-submodule-update)]])
    
    ;; Remote menu
    (transient-define-prefix mcg/magit-remote-menu ()
      "Remote operations menu."
      [["Remote Operations"
        ("a" "Add    Remote" magit-remote-add)
        ("r" "Rename Remote" magit-remote-rename)]])
    
    ;; Log menu
    (transient-define-prefix mcg/magit-log-menu ()
      "Log viewing menu."
      [["Log"
        ("c" "Log Current" magit-log-current)
        ("l" "Log All" magit-log-all)
        ("h" "Log Heads" magit-log-head)
        ("b" "Log Branch" magit-log-branches)
        ("f" "Log Current File" magit-log-buffer-file)]])
    
    ;; File menu
    (transient-define-prefix mcg/magit-file-menu ()
      "File operations menu."
      [["File"
        ("r" "File Rename" magit-file-rename)
        ("d" "File Delete" magit-file-delete)]])
    
    ;; Diff menu
    (transient-define-prefix mcg/magit-diff-menu ()
      "Diff viewing menu."
      [["Diff"
        ("d" "Diff file" magit-diff-buffer-file)]])
    
    (mcg-log "Magit transient menus configured")))

#+END_SRC

** Commands
#+BEGIN_SRC emacs-lisp
;;; Commands

(defun mcg/git-status ()
  "Open Magit status buffer."
  (interactive)
  (if (featurep 'magit)
      (magit-status)
    (mcg--setup-magit)
    (when (featurep 'magit)
      (magit-status))))

(defun mcg/git-blame ()
  "Show git blame for current file."
  (interactive)
  (if (featurep 'magit)
      (magit-blame-addition)
    (mcg--setup-magit)
    (when (featurep 'magit)
      (magit-blame-addition))))

(defun mcg/git-log-file ()
  "Show git log for current file."
  (interactive)
  (if (featurep 'magit)
      (magit-log-buffer-file)
    (mcg--setup-magit)
    (when (featurep 'magit)
      (magit-log-buffer-file))))

#+END_SRC

** Help Popup
#+BEGIN_SRC emacs-lisp
;;; Help Popup

(defun mcg/git-help ()
  "Show Git/Magit commands reference in posframe popup."
  (interactive)
  (mcg-popup-show "*Git Help*" (mcg--git-help-content) 55 35))

(defun mcg--git-help-content ()
  "Generate Git help content."
  "
                    Git/Magit 操作速查                    
    ═══════════════════════════════════════════════════  

    【基本操作】                                          
    C-x g           Magit 状态 (主界面)                   
    C-c g s         Magit 状态                            
    C-c g d         Magit dispatch (所有命令)             
    C-c g f         文件操作菜单                          

    【提交与推送】                                        
    C-c g p         推送 (push)                           
    C-c g P         拉取 (pull)                           

    【分支操作】 C-c g b                                  
    C-c g b b       创建分支                              
    C-c g b r       重命名分支                            
    C-c g b d       删除分支                              

    【日志查看】                                          
    C-c g l         查看日志                              

    【Submodule】 C-c g m                                 
    C-c g m a       添加 submodule                        
    C-c g m r       移除 submodule                        
    C-c g m u       更新 submodule                        

    【Magit 状态界面】                                    
    s               Stage 文件/区块                       
    u               Unstage                               
    c c             提交                                  
    P p             推送                                  
    F p             拉取                                  
    b b             切换分支                              
    l l             查看日志                              
    d d             查看 diff                             
    g               刷新                                  
    q               退出                                  
")

(global-set-key (kbd "C-c g H") #'mcg/git-help)

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

;; Setup Magit
(mcg--setup-magit)

;; Setup transient menus (after magit loads)
(with-eval-after-load 'magit
  (mcg--setup-magit-transient-menus))

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-magit)
;;; init-magit.el ends here
#+END_SRC
