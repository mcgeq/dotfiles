* init-utils.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-utils.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
;;; init-utils.el --- Utility Tools for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-utils.el
;; Description: Utility tools module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: utils, auto-save, which-key, recentf
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Utility tools module for MCG Emacs, responsible for:
;; - Auto-save (idle-auto-save)
;; - Which-key keybinding hints
;; - Recentf recent files
;; - Helpful enhanced help
;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)
(require 'recentf)

#+END_SRC

** Posframe Popup Utility
#+BEGIN_SRC emacs-lisp
;;; Posframe Popup Utility

(defgroup mcg-popup nil
  "Posframe popup utilities."
  :group 'convenience)

(defcustom mcg-popup-width 60
  "Default width of popup."
  :type 'integer
  :group 'mcg-popup)

(defcustom mcg-popup-height 35
  "Default height of popup."
  :type 'integer
  :group 'mcg-popup)

(defvar mcg--popup-current-buffer nil
  "Current popup buffer name.")

(defun mcg--popup-get-border-color ()
  "Get border color from current theme."
  (or (face-foreground 'font-lock-keyword-face nil t)
      (face-foreground 'link nil t)
      "#61AFEF"))

(defun mcg--popup-get-background-color ()
  "Get background color from current theme."
  (or (face-background 'tooltip nil t)
      (face-background 'default nil t)
      "#282C34"))

(defun mcg--popup-get-foreground-color ()
  "Get foreground color from current theme."
  (or (face-foreground 'default nil t)
      "#ABB2BF"))

(defun mcg--popup-scroll-down ()
  "Scroll popup content down."
  (when-let* ((buf (get-buffer mcg--popup-current-buffer))
              (frame (buffer-local-value 'posframe--frame buf)))
    (with-selected-frame frame
      (ignore-errors (scroll-up 3)))))

(defun mcg--popup-scroll-up ()
  "Scroll popup content up."
  (when-let* ((buf (get-buffer mcg--popup-current-buffer))
              (frame (buffer-local-value 'posframe--frame buf)))
    (with-selected-frame frame
      (ignore-errors (scroll-down 3)))))

(defun mcg-popup-show (buffer-name content &optional width height)
  "Show CONTENT in a centered posframe popup.
BUFFER-NAME is the buffer name for the popup.
WIDTH and HEIGHT are optional dimensions.

Keys: j/k scroll, q/ESC exit"
  (require 'posframe)
  
  (setq mcg--popup-current-buffer buffer-name)
  
  (let* ((buf (get-buffer-create buffer-name))
         (hint "j/k scroll | q/ESC exit")
         (w (or width mcg-popup-width))
         (h (or height mcg-popup-height))
         (padding (make-string (/ (- w (string-width hint)) 2) ?\s))
         (border-color (mcg--popup-get-border-color))
         (bg-color (mcg--popup-get-background-color))
         (fg-color (mcg--popup-get-foreground-color)))
    
    (with-current-buffer buf
      (let ((inhibit-read-only t))
        (erase-buffer)
        (insert content))
      (setq-local buffer-read-only t)
      (setq-local cursor-type nil)
      (setq-local header-line-format
                  (propertize (concat padding hint)
                              'face `(:foreground ,border-color :weight bold)))
      (goto-char (point-min)))
    
    (posframe-show buf
                   :position (point)
                   :poshandler #'posframe-poshandler-frame-center
                   :internal-border-width 2
                   :internal-border-color border-color
                   :background-color bg-color
                   :foreground-color fg-color
                   :width w
                   :height h
                   :respect-header-line t
                   :accept-focus nil)
    
    (unwind-protect
        (catch 'exit-popup
          (while t
            (let ((key (read-key)))
              (cond
               ((memq key '(?q 27))
                (throw 'exit-popup nil))
               ((memq key '(?j ?n 14))
                (mcg--popup-scroll-down))
               ((equal key 'down)
                (mcg--popup-scroll-down))
               ((memq key '(?k ?p 16))
                (mcg--popup-scroll-up))
               ((equal key 'up)
                (mcg--popup-scroll-up))
               (t nil)))))
      (posframe-hide buffer-name))))

#+END_SRC

** Idle Auto-Save
#+BEGIN_SRC emacs-lisp
;;; Idle Auto-Save

(defgroup mcg-auto-save nil
  "Auto save files when Emacs is idle."
  :group 'convenience)

(defcustom mcg-auto-save-idle 1
  "Seconds of idle time before auto-save."
  :type 'integer
  :group 'mcg-auto-save)

(defcustom mcg-auto-save-silent t
  "Whether to save silently (no messages)."
  :type 'boolean
  :group 'mcg-auto-save)

(defvar mcg--auto-save-timer nil
  "Auto-save timer.")

;; Disable Emacs default auto-save
(setq make-backup-files nil)
(setq auto-save-default nil)
(setq create-lockfiles nil)

(defun mcg--auto-save-buffers ()
  "Auto-save all modified buffers."
  (interactive)
  (let ((saved-buffers nil))
    (save-current-buffer
      (dolist (buf (buffer-list))
        (set-buffer buf)
        (when (and (buffer-file-name)
                   (buffer-modified-p)
                   (not (bound-and-true-p yas--active-snippets))
                   (not (bound-and-true-p company-candidates))
                   (or (not (bound-and-true-p corfu--total))
                       (zerop corfu--total)))
          (push (buffer-name) saved-buffers)
          (let ((inhibit-message mcg-auto-save-silent)
                (message-log-max (unless mcg-auto-save-silent message-log-max)))
            (basic-save-buffer)))))
    (unless mcg-auto-save-silent
      (when saved-buffers
        (message "Auto-saved: %s" (string-join saved-buffers ", "))))))

(defun mcg--auto-save-enable ()
  "Enable auto-save."
  (when mcg--auto-save-timer
    (cancel-timer mcg--auto-save-timer))
  (setq mcg--auto-save-timer
        (run-with-idle-timer mcg-auto-save-idle t #'mcg--auto-save-buffers)))

(defun mcg--auto-save-disable ()
  "Disable auto-save."
  (when mcg--auto-save-timer
    (cancel-timer mcg--auto-save-timer)
    (setq mcg--auto-save-timer nil)))

;; Enable auto-save
(mcg--auto-save-enable)

#+END_SRC

** Which-Key Configuration
#+BEGIN_SRC emacs-lisp
;;; Which-Key Configuration

(defun mcg--setup-which-key ()
  "Setup Which-key keybinding hints."
  ;; which-key is built-in for Emacs 30+
  (require 'which-key)
  
  ;; Basic settings
  (setq which-key-idle-delay 0.3)
  (setq which-key-idle-secondary-delay 0.05)
  (setq which-key-popup-type 'side-window)
  (setq which-key-side-window-location 'bottom)
  (setq which-key-side-window-max-height 0.3)
  (setq which-key-min-display-lines 6)
  
  ;; Sorting and appearance
  (setq which-key-sort-order 'which-key-key-order-alpha)
  (setq which-key-separator "  ")
  (setq which-key-max-description-length 32)
  (setq which-key-add-column-padding 2)
  (setq which-key-ellipsis "..")
  
  ;; Key name beautification
  (setq which-key-special-keys '("SPC" "TAB" "RET" "DEL" "ESC"))
  (setq which-key-key-replacement-alist
        '(("<left>"  . "‚Üê")
          ("<right>" . "‚Üí")
          ("<up>"    . "‚Üë")
          ("<down>"  . "‚Üì")
          ("<return>" . "‚èé")
          ("<tab>"   . "‚á•")
          ("<escape>" . "‚éã")
          ("SPC"     . "‚ê£")
          ("RET"     . "‚èé")
          ("TAB"     . "‚á•")
          ("DEL"     . "‚å´")))
  
  ;; Prefix descriptions
  (which-key-add-key-based-replacements
    ;; C-c prefix groups
    "C-c"     "‚öô User"
    "C-c f"   "üìÅ File"
    "C-c g"   " Git"
    "C-c g b" " Branch"
    "C-c g m" " Submodule"
    "C-c m"   "‚úé Markmacro"
    "C-c n"   "üìù Notes/Org"
    "C-c r"   "üîß Refactor"
    "C-c s"   "üîç Search"
    "C-c t"   "üìë Tabs"
    "C-c u"   "‚Ü© Undo"
    "C-c y"   "‚úÇ Snippet"
    "C-c E"   "‚öô Config"
    
    ;; C-x prefix groups
    "C-x"     "üìã Emacs"
    "C-x r"   "üìå Register/Rect"
    "C-x n"   "üìê Narrow"
    "C-x p"   "üìÇ Project"
    "C-x t"   "üóÇ Tab-bar"
    "C-x 4"   "ü™ü Other Window"
    "C-x 5"   "üñº Frame"
    
    ;; Help
    "C-h"     "‚ùì Help"
    
    ;; Goto
    "M-g"     "‚û° Goto"
    
    ;; Search
    "M-s"     "üîé Search")
  
  ;; Performance optimization
  (setq which-key-compute-remaps nil)
  (setq which-key-allow-evil-operators nil)
  (setq which-key-show-remaining-keys nil)
  
  ;; Fix which-key window not closing after C-g cancel
  (advice-add 'keyboard-quit :before
              (lambda (&rest _)
                (when (which-key--popup-showing-p)
                  (which-key--hide-popup))))
  
  ;; Enable
  (which-key-mode 1)
  
  (mcg-log "Which-key configured"))

#+END_SRC

** Recentf Configuration
#+BEGIN_SRC emacs-lisp
;;; Recentf Configuration

(defun mcg--setup-recentf ()
  "Setup Recentf recent files."
  (setq recentf-max-saved-items 300)
  (setq recentf-auto-cleanup 'never)
  (setq recentf-filename-handlers '(abbreviate-file-name))
  
  ;; Exclude list
  (setq recentf-exclude
        '(".cache"
          ".cask"
          ".elfeed"
          "bookmarks"
          "cache"
          "ido.*"
          "recentf"
          "undo-tree-hist"
          "url"
          "^/tmp/"
          "/ssh\\(x\\)?:"
          "/su\\(do\\)?:"
          "^/usr/include/"
          "/TAGS\\'"
          "COMMIT_EDITMSG\\'"))
  
  ;; Enable
  (recentf-mode 1)
  
  (mcg-log "Recentf configured"))

#+END_SRC

** Helpful Configuration
#+BEGIN_SRC emacs-lisp
;;; Helpful Configuration

(defun mcg--setup-helpful ()
  "Setup Helpful enhanced help."
  (when (mcg-require-extension "core/helpful" 'helpful)
    ;; Replace default help commands
    (global-set-key (kbd "C-h f") #'helpful-callable)
    (global-set-key (kbd "C-h v") #'helpful-variable)
    (global-set-key (kbd "C-h k") #'helpful-key)
    (global-set-key (kbd "C-h x") #'helpful-command)
    (global-set-key (kbd "C-c C-d") #'helpful-at-point)
    
    (mcg-log "Helpful configured")))

#+END_SRC

** Sort-Tab Configuration
#+BEGIN_SRC emacs-lisp
;;; Sort-Tab Configuration

(defun mcg--setup-sort-tab ()
  "Setup Sort-tab tab management."
  (when (mcg-require-extension "ui/sort-tab" 'sort-tab)
    ;; Display settings
    (setq sort-tab-max-length 20)
    (setq sort-tab-show-index t)
    (setq sort-tab-position 'bottom)
    (setq sort-tab-close-button-show t)
    (setq sort-tab-icon-show t)
    (setq sort-tab-scale-factor 1.0)
    (setq sort-tab-auto-update t)
    (setq sort-tab-update-interval 0.5)
    
    ;; Hide rules
    (setq sort-tab-hide-function
          (lambda (buf)
            (let ((name (buffer-name buf)))
              (with-current-buffer buf
                (or
                 (string-prefix-p " " name)
                 (and (string-prefix-p "*" name)
                      (not (or
                            (string= name "*scratch*")
                            (string= name "*Messages*")
                            (string-prefix-p "*terminal" name))))
                 (derived-mode-p 'dired-mode)
                 (derived-mode-p 'eshell-mode)
                 (derived-mode-p 'shell-mode)
                 (derived-mode-p 'vterm-mode)
                 (derived-mode-p 'magit-status-mode)
                 (derived-mode-p 'help-mode)
                 (derived-mode-p 'helpful-mode)
                 (derived-mode-p 'compilation-mode)
                 (string-match-p "^\\*.*-preview\\*$" name)
                 (string-match-p "^\\*Completions\\*$" name))))))
    
    ;; Enable
    (sort-tab-mode 1)
    
    ;; Keybindings
    (global-set-key (kbd "C-c t n") #'sort-tab-select-next-tab)
    (global-set-key (kbd "C-c t p") #'sort-tab-select-prev-tab)
    (global-set-key (kbd "C-c t c") #'sort-tab-close-current-tab)
    
    (mcg-log "Sort-tab configured")))

#+END_SRC

** Symbol-Overlay Configuration
#+BEGIN_SRC emacs-lisp
;;; Symbol-Overlay Configuration

(defun mcg--setup-symbol-overlay ()
  "Setup Symbol-overlay symbol highlighting."
  (when (mcg-require-extension "editor/symbol-overlay" 'symbol-overlay)
    ;; Enable in prog-mode
    (add-hook 'prog-mode-hook #'symbol-overlay-mode)
    
    ;; Keybindings (in symbol-overlay-map)
    (with-eval-after-load 'symbol-overlay
      (define-key symbol-overlay-map (kbd "s") #'symbol-overlay-put)
      (define-key symbol-overlay-map (kbd "n") #'symbol-overlay-jump-next)
      (define-key symbol-overlay-map (kbd "p") #'symbol-overlay-jump-prev)
      (define-key symbol-overlay-map (kbd "w") #'symbol-overlay-save-symbol)
      (define-key symbol-overlay-map (kbd "t") #'symbol-overlay-toggle-in-scope)
      (define-key symbol-overlay-map (kbd "d") #'symbol-overlay-jump-to-definition)
      (define-key symbol-overlay-map (kbd "r") #'symbol-overlay-rename)
      (define-key symbol-overlay-map (kbd "R") #'symbol-overlay-query-replace)
      (define-key symbol-overlay-map (kbd "q") #'symbol-overlay-remove-all))
    
    (mcg-log "Symbol-overlay configured")))

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

(mcg--setup-recentf)
(mcg--setup-which-key)
(mcg--setup-helpful)
(mcg--setup-sort-tab)
(mcg--setup-symbol-overlay)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-utils)
;;; init-utils.el ends here
#+END_SRC
