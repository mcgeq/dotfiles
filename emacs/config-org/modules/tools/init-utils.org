* init-utils.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-utils.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
;;; init-utils.el --- Utility Tools for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-utils.el
;; Description: å®ç”¨å·¥å…·æ¨¡å—
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: utils, auto-save, which-key, recentf
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; MCG Emacs é…ç½®æ¶æ„çš„å®ç”¨å·¥å…·æ¨¡å—ï¼Œè´Ÿè´£ï¼š
;; - è‡ªåŠ¨ä¿å­˜ (idle-auto-save)
;; - Which-key å¿«æ·é”®æç¤º
;; - Recentf æœ€è¿‘æ–‡ä»¶
;; - Helpful å¢å¼ºå¸®åŠ©
;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)
(require 'recentf)

#+END_SRC

** Idle Auto-Save
#+BEGIN_SRC emacs-lisp
;;; Idle Auto-Save

(defgroup mcg-auto-save nil
  "Auto save files when Emacs is idle."
  :group 'convenience)

(defcustom mcg-auto-save-idle 1
  "ç©ºé—²å¤šå°‘ç§’åè‡ªåŠ¨ä¿å­˜ã€‚"
  :type 'integer
  :group 'mcg-auto-save)

(defcustom mcg-auto-save-silent t
  "æ˜¯å¦é™é»˜ä¿å­˜ï¼ˆä¸æ˜¾ç¤ºæ¶ˆæ¯ï¼‰ã€‚"
  :type 'boolean
  :group 'mcg-auto-save)

(defvar mcg--auto-save-timer nil
  "è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨ã€‚")

;; ç¦ç”¨ Emacs é»˜è®¤çš„è‡ªåŠ¨ä¿å­˜
(setq make-backup-files nil)
(setq auto-save-default nil)
(setq create-lockfiles nil)

(defun mcg--auto-save-buffers ()
  "è‡ªåŠ¨ä¿å­˜æ‰€æœ‰ä¿®æ”¹è¿‡çš„ bufferã€‚"
  (interactive)
  (let ((saved-buffers nil))
    (save-current-buffer
      (dolist (buf (buffer-list))
        (set-buffer buf)
        (when (and (buffer-file-name)
                   (buffer-modified-p)
                   (not (bound-and-true-p yas--active-snippets))
                   (not (bound-and-true-p company-candidates))
                   (or (not (bound-and-true-p corfu--total))
                       (zerop corfu--total)))
          (push (buffer-name) saved-buffers)
          (let ((inhibit-message mcg-auto-save-silent)
                (message-log-max (unless mcg-auto-save-silent message-log-max)))
            (basic-save-buffer)))))
    (unless mcg-auto-save-silent
      (when saved-buffers
        (message "Auto-saved: %s" (string-join saved-buffers ", "))))))

(defun mcg--auto-save-enable ()
  "å¯ç”¨è‡ªåŠ¨ä¿å­˜ã€‚"
  (when mcg--auto-save-timer
    (cancel-timer mcg--auto-save-timer))
  (setq mcg--auto-save-timer
        (run-with-idle-timer mcg-auto-save-idle t #'mcg--auto-save-buffers)))

(defun mcg--auto-save-disable ()
  "ç¦ç”¨è‡ªåŠ¨ä¿å­˜ã€‚"
  (when mcg--auto-save-timer
    (cancel-timer mcg--auto-save-timer)
    (setq mcg--auto-save-timer nil)))

;; å¯ç”¨è‡ªåŠ¨ä¿å­˜
(mcg--auto-save-enable)

#+END_SRC

** Which-Key Configuration
#+BEGIN_SRC emacs-lisp
;;; Which-Key Configuration

(defun mcg--setup-which-key ()
  "è®¾ç½® Which-key å¿«æ·é”®æç¤ºã€‚"
  ;; which-key æ˜¯ Emacs 30+ å†…ç½®çš„
  (require 'which-key)
  
  ;; åŸºç¡€è®¾ç½®
  (setq which-key-idle-delay 0.3)
  (setq which-key-idle-secondary-delay 0.05)
  (setq which-key-popup-type 'side-window)
  (setq which-key-side-window-location 'bottom)
  (setq which-key-side-window-max-height 0.3)
  (setq which-key-min-display-lines 6)
  
  ;; æ’åºå’Œå¤–è§‚
  (setq which-key-sort-order 'which-key-key-order-alpha)
  (setq which-key-separator "  ")
  (setq which-key-max-description-length 32)
  (setq which-key-add-column-padding 2)
  (setq which-key-ellipsis "..")
  
  ;; é”®åç¾åŒ–
  (setq which-key-special-keys '("SPC" "TAB" "RET" "DEL" "ESC"))
  (setq which-key-key-replacement-alist
        '(("<left>"  . "â†")
          ("<right>" . "â†’")
          ("<up>"    . "â†‘")
          ("<down>"  . "â†“")
          ("<return>" . "â")
          ("<tab>"   . "â‡¥")
          ("<escape>" . "â‹")
          ("SPC"     . "â£")
          ("RET"     . "â")
          ("TAB"     . "â‡¥")
          ("DEL"     . "âŒ«")))
  
  ;; å‰ç¼€æè¿°
  (which-key-add-key-based-replacements
    ;; C-c å‰ç¼€ç»„
    "C-c"     "âš™ User"
    "C-c f"   "ğŸ“ File"
    "C-c g"   " Git"
    "C-c g b" " Branch"
    "C-c g m" " Submodule"
    "C-c m"   "âœ Markmacro"
    "C-c n"   "ğŸ“ Notes/Org"
    "C-c r"   "ğŸ”§ Refactor"
    "C-c s"   "ğŸ” Search"
    "C-c t"   "ğŸ“‘ Tabs"
    "C-c u"   "â†© Undo"
    "C-c y"   "âœ‚ Snippet"
    "C-c E"   "âš™ Config"
    
    ;; C-x å‰ç¼€ç»„
    "C-x"     "ğŸ“‹ Emacs"
    "C-x r"   "ğŸ“Œ Register/Rect"
    "C-x n"   "ğŸ“ Narrow"
    "C-x p"   "ğŸ“‚ Project"
    "C-x t"   "ğŸ—‚ Tab-bar"
    "C-x 4"   "ğŸªŸ Other Window"
    "C-x 5"   "ğŸ–¼ Frame"
    
    ;; å¸®åŠ©
    "C-h"     "â“ Help"
    
    ;; è·³è½¬
    "M-g"     "â¡ Goto"
    
    ;; æœç´¢
    "M-s"     "ğŸ” Search")
  
  ;; æ€§èƒ½ä¼˜åŒ–
  (setq which-key-compute-remaps nil)
  (setq which-key-allow-evil-operators nil)
  (setq which-key-show-remaining-keys nil)
  
  ;; ä¿®å¤ C-g å–æ¶ˆå which-key çª—å£ä¸å…³é—­çš„é—®é¢˜
  (advice-add 'keyboard-quit :before
              (lambda (&rest _)
                (when (which-key--popup-showing-p)
                  (which-key--hide-popup))))
  
  ;; å¯ç”¨
  (which-key-mode 1)
  
  (mcg-log "Which-key configured"))

#+END_SRC

** Recentf Configuration
#+BEGIN_SRC emacs-lisp
;;; Recentf Configuration

(defun mcg--setup-recentf ()
  "è®¾ç½® Recentf æœ€è¿‘æ–‡ä»¶ã€‚"
  (setq recentf-max-saved-items 300)
  (setq recentf-auto-cleanup 'never)
  (setq recentf-filename-handlers '(abbreviate-file-name))
  
  ;; æ’é™¤åˆ—è¡¨
  (setq recentf-exclude
        '(".cache"
          ".cask"
          ".elfeed"
          "bookmarks"
          "cache"
          "ido.*"
          "recentf"
          "undo-tree-hist"
          "url"
          "^/tmp/"
          "/ssh\\(x\\)?:"
          "/su\\(do\\)?:"
          "^/usr/include/"
          "/TAGS\\'"
          "COMMIT_EDITMSG\\'"))
  
  ;; å¯ç”¨
  (recentf-mode 1)
  
  (mcg-log "Recentf configured"))

#+END_SRC

** Helpful Configuration
#+BEGIN_SRC emacs-lisp
;;; Helpful Configuration

(defun mcg--setup-helpful ()
  "è®¾ç½® Helpful å¢å¼ºå¸®åŠ©ã€‚"
  (when (mcg-require-extension "core/helpful" 'helpful)
    ;; æ›¿æ¢é»˜è®¤å¸®åŠ©å‘½ä»¤
    (global-set-key (kbd "C-h f") #'helpful-callable)
    (global-set-key (kbd "C-h v") #'helpful-variable)
    (global-set-key (kbd "C-h k") #'helpful-key)
    (global-set-key (kbd "C-h x") #'helpful-command)
    (global-set-key (kbd "C-c C-d") #'helpful-at-point)
    
    (mcg-log "Helpful configured")))

#+END_SRC

** Sort-Tab Configuration
#+BEGIN_SRC emacs-lisp
;;; Sort-Tab Configuration

(defun mcg--setup-sort-tab ()
  "è®¾ç½® Sort-tab æ ‡ç­¾ç®¡ç†ã€‚"
  (when (mcg-require-extension "ui/sort-tab" 'sort-tab)
    ;; æ˜¾ç¤ºè®¾ç½®
    (setq sort-tab-max-length 20)
    (setq sort-tab-show-index t)
    (setq sort-tab-position 'bottom)
    (setq sort-tab-close-button-show t)
    (setq sort-tab-icon-show t)
    (setq sort-tab-scale-factor 1.0)
    (setq sort-tab-auto-update t)
    (setq sort-tab-update-interval 0.5)
    
    ;; éšè—è§„åˆ™
    (setq sort-tab-hide-function
          (lambda (buf)
            (let ((name (buffer-name buf)))
              (with-current-buffer buf
                (or
                 (string-prefix-p " " name)
                 (and (string-prefix-p "*" name)
                      (not (or
                            (string= name "*scratch*")
                            (string= name "*Messages*")
                            (string-prefix-p "*terminal" name))))
                 (derived-mode-p 'dired-mode)
                 (derived-mode-p 'eshell-mode)
                 (derived-mode-p 'shell-mode)
                 (derived-mode-p 'vterm-mode)
                 (derived-mode-p 'magit-status-mode)
                 (derived-mode-p 'help-mode)
                 (derived-mode-p 'helpful-mode)
                 (derived-mode-p 'compilation-mode)
                 (string-match-p "^\\*.*-preview\\*$" name)
                 (string-match-p "^\\*Completions\\*$" name))))))
    
    ;; å¯ç”¨
    (sort-tab-mode 1)
    
    ;; å¿«æ·é”®
    (global-set-key (kbd "C-c t n") #'sort-tab-select-next-tab)
    (global-set-key (kbd "C-c t p") #'sort-tab-select-prev-tab)
    (global-set-key (kbd "C-c t c") #'sort-tab-close-current-tab)
    
    (mcg-log "Sort-tab configured")))

#+END_SRC

** Symbol-Overlay Configuration
#+BEGIN_SRC emacs-lisp
;;; Symbol-Overlay Configuration

(defun mcg--setup-symbol-overlay ()
  "è®¾ç½® Symbol-overlay ç¬¦å·é«˜äº®ã€‚"
  (when (mcg-require-extension "editor/symbol-overlay" 'symbol-overlay)
    ;; åœ¨ prog-mode ä¸­å¯ç”¨
    (add-hook 'prog-mode-hook #'symbol-overlay-mode)
    
    ;; å¿«æ·é”® (åœ¨ symbol-overlay-map ä¸­)
    (with-eval-after-load 'symbol-overlay
      (define-key symbol-overlay-map (kbd "s") #'symbol-overlay-put)
      (define-key symbol-overlay-map (kbd "n") #'symbol-overlay-jump-next)
      (define-key symbol-overlay-map (kbd "p") #'symbol-overlay-jump-prev)
      (define-key symbol-overlay-map (kbd "w") #'symbol-overlay-save-symbol)
      (define-key symbol-overlay-map (kbd "t") #'symbol-overlay-toggle-in-scope)
      (define-key symbol-overlay-map (kbd "d") #'symbol-overlay-jump-to-definition)
      (define-key symbol-overlay-map (kbd "r") #'symbol-overlay-rename)
      (define-key symbol-overlay-map (kbd "R") #'symbol-overlay-query-replace)
      (define-key symbol-overlay-map (kbd "q") #'symbol-overlay-remove-all))
    
    (mcg-log "Symbol-overlay configured")))

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

(mcg--setup-recentf)
(mcg--setup-which-key)
(mcg--setup-helpful)
(mcg--setup-sort-tab)
(mcg--setup-symbol-overlay)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-utils)
;;; init-utils.el ends here
#+END_SRC
