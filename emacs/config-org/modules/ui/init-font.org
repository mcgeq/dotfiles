* init-font.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-font.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
;;; init-font.el --- Font Configuration for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-font.el
;; Description: 字体配置模块
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: font, ui
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; MCG Emacs 配置架构的字体配置模块，负责：
;; - 默认字体设置
;; - Unicode 字体
;; - Emoji 字体
;; - CJK (中日韩) 字体
;;
;; 模块元数据:
;; :depends ()
;; :defer nil
;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'cl-lib)
(require 'core-bootstrap)

#+END_SRC

** Font Variables
#+BEGIN_SRC emacs-lisp
;;; Font Variables

(defvar mcg-fonts-default
  '("Cascadia Mono" "FiraCode Nerd Font" "DejaVuSansMono Nerd Font Mono"
    "Consolas" "Source Code Pro" "Hack" "Fira Code")
  "默认等宽字体列表，按优先级排序。")

(defvar mcg-fonts-unicode
  '("Symbola" "Segoe UI Symbol" "Symbol")
  "Unicode 字体列表。")

(defvar mcg-fonts-emoji
  '("Noto Color Emoji" "Apple Color Emoji")
  "Emoji 字体列表。")

(defvar mcg-fonts-cjk
  '("KaiTi" "WenQuanYi Micro Hei" "Microsoft Yahei UI"
    "Microsoft Yahei" "STFangsong")
  "CJK (中日韩) 字体列表。")

(defvar mcg-font-height-default
  (cond (mcg-is-mac 150)
        (mcg-is-windows 110)
        (mcg-is-linux 130)
        (t 120))
  "默认字体高度 (1/10 pt)。")

(defvar mcg-font-cjk-scale 1.2
  "CJK 字体缩放比例。")

(defvar mcg-icon-font-family "FiraCode Nerd Font"
  "图标字体。")

#+END_SRC

** Font Setup Functions
#+BEGIN_SRC emacs-lisp
;;; Font Setup Functions

(defun mcg--font-available-p (font)
  "检查字体 FONT 是否可用。"
  (find-font (font-spec :name font)))

(defun mcg--find-available-font (font-list)
  "从 FONT-LIST 中找到第一个可用的字体。"
  (cl-loop for font in font-list
           when (mcg--font-available-p font)
           return font))

(defun mcg--setup-font-common (character font-list &optional scale-factor)
  "为 CHARACTER 设置字体。

参数:
- CHARACTER: 字符集 (nil 表示默认字体, 或 'unicode, 'emoji, 'han 等)
- FONT-LIST: 字体列表
- SCALE-FACTOR: 缩放比例 (可选)"
  (let ((font (mcg--find-available-font font-list)))
    (when font
      (if (not character)
          ;; 设置默认字体
          (set-face-attribute 'default nil
                              :family font
                              :height mcg-font-height-default)
        ;; 设置特定字符集字体
        (when scale-factor
          (setq face-font-rescale-alist
                (cons (cons font scale-factor)
                      (assoc-delete-all font face-font-rescale-alist))))
        (set-fontset-font t character (font-spec :family font) nil 'prepend))
      font)))

#+END_SRC

** Main Font Setup
#+BEGIN_SRC emacs-lisp
;;; Main Font Setup

(defun mcg/font-setup (&optional default-fonts unicode-fonts emoji-fonts cjk-fonts)
  "设置所有字体。

可选参数:
- DEFAULT-FONTS: 默认字体列表
- UNICODE-FONTS: Unicode 字体列表
- EMOJI-FONTS: Emoji 字体列表
- CJK-FONTS: CJK 字体列表"
  (interactive)
  (when (display-graphic-p)
    ;; 默认字体
    (mcg--setup-font-common nil (or default-fonts mcg-fonts-default))
    
    ;; Unicode 字体
    (mcg--setup-font-common 'unicode (or unicode-fonts mcg-fonts-unicode))
    
    ;; Emoji 字体
    (mcg--setup-font-common 'emoji (or emoji-fonts mcg-fonts-emoji))
    
    ;; CJK 字体 (多个字符集)
    (dolist (charset '(kana han bopomofo cjk-misc))
      (mcg--setup-font-common charset
                              (or cjk-fonts mcg-fonts-cjk)
                              mcg-font-cjk-scale))
    
    (mcg-log "Fonts configured")))

#+END_SRC

** Interactive Commands
#+BEGIN_SRC emacs-lisp
;;; Interactive Commands

(defun mcg/increase-font-size ()
  "增大字体大小。"
  (interactive)
  (let ((current-height (face-attribute 'default :height)))
    (set-face-attribute 'default nil :height (+ current-height 10))
    (message "Font height: %d" (+ current-height 10))))

(defun mcg/decrease-font-size ()
  "减小字体大小。"
  (interactive)
  (let ((current-height (face-attribute 'default :height)))
    (when (> current-height 80)
      (set-face-attribute 'default nil :height (- current-height 10))
      (message "Font height: %d" (- current-height 10)))))

(defun mcg/reset-font-size ()
  "重置字体大小为默认值。"
  (interactive)
  (set-face-attribute 'default nil :height mcg-font-height-default)
  (message "Font height reset to: %d" mcg-font-height-default))

(defun mcg/list-available-fonts ()
  "列出所有可用的字体。"
  (interactive)
  (with-current-buffer (get-buffer-create "*Available Fonts*")
    (erase-buffer)
    (insert "可用字体列表\n")
    (insert "=============\n\n")
    
    ;; 检查配置的字体
    (insert "配置的字体状态:\n\n")
    
    (insert "默认字体:\n")
    (dolist (font mcg-fonts-default)
      (insert (format "  %s %s\n" (if (mcg--font-available-p font) "✓" "✗") font)))
    
    (insert "\nUnicode 字体:\n")
    (dolist (font mcg-fonts-unicode)
      (insert (format "  %s %s\n" (if (mcg--font-available-p font) "✓" "✗") font)))
    
    (insert "\nEmoji 字体:\n")
    (dolist (font mcg-fonts-emoji)
      (insert (format "  %s %s\n" (if (mcg--font-available-p font) "✓" "✗") font)))
    
    (insert "\nCJK 字体:\n")
    (dolist (font mcg-fonts-cjk)
      (insert (format "  %s %s\n" (if (mcg--font-available-p font) "✓" "✗") font)))
    
    (goto-char (point-min))
    (display-buffer (current-buffer))))

#+END_SRC

** Keybindings
#+BEGIN_SRC emacs-lisp
;;; Keybindings

;; 字体大小调整快捷键
(global-set-key (kbd "C-=") #'mcg/increase-font-size)
(global-set-key (kbd "C--") #'mcg/decrease-font-size)
(global-set-key (kbd "C-0") #'mcg/reset-font-size)

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

;; 初始化字体设置
(mcg/font-setup)

;; 确保在 GUI 启动后也设置字体
(add-hook 'window-setup-hook #'mcg/font-setup)
(add-hook 'server-after-make-frame-hook #'mcg/font-setup)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-font)
;;; init-font.el ends here
#+END_SRC
