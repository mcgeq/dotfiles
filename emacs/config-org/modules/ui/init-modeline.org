* init-modeline.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-modeline.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; init-modeline.el --- Modeline Configuration for MCG Emacs -*- lexical-binding: t; -*-

  ;; Filename: init-modeline.el
  ;; Description: 模式行配置模块（使用 awesome-tray）
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024-2026, mcge, all rights reserved.
  ;; Create   Date: 2026-01-07
  ;; Version: 3.0
  ;; Keywords: modeline, ui, awesome-tray
  ;; Compatibility: GNU Emacs 29.0+

  ;;; Commentary:
  ;;
  ;; MCG Emacs 配置架构的模式行模块，负责：
  ;; - awesome-tray 配置
  ;; - 模式行显示定制
  ;;
  ;; 模块元数据:
  ;; :depends ()
  ;; :defer nil
  ;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)

#+END_SRC

** Variables
#+BEGIN_SRC emacs-lisp
;;; Variables

(defvar mcg-modeline-position 'center
  "awesome-tray 显示位置。
可选值: 'left, 'center, 'right")

(defvar mcg-modeline-date-format "[%-Y-%-m-%-d %a %-H:%M]"
  "日期时间显示格式。")

(defvar mcg-modeline-active-modules
  '("buffer-name"    ; Buffer 名称
    "mode-name"      ; 主模式
    "location"       ; 光标位置 (行:列)
    "belong"         ; 当前函数/类
    "parent-dir"     ; 父目录名
    "input-method"   ; 输入法状态
    "date")          ; 日期时间
  "awesome-tray 显示的模块列表。

可用模块:
- git: Git 分支信息
- location: 光标位置 (行:列)
- belong: 当前函数/类
- mode-name: 主模式名称
- date: 日期时间
- buffer-name: Buffer 名称
- parent-dir: 父目录名
- file-path: 文件完整路径
- input-method: 输入法状态
- battery: 电池状态
- word-count: 字数统计
- volume: 音量
- hostname: 主机名
- github: GitHub 通知
- anzu: 搜索计数")

(defvar mcg-modeline-use-second-line t
  "是否使用第二行显示。")

(defvar mcg-modeline-buffer-name-max-length 30
  "Buffer 名称最大显示长度。")

(defvar mcg-modeline-input-method-default "EN"
  "英文输入法状态显示文本。")

(defvar mcg-modeline-input-method-local "中"
  "中文输入法状态显示文本。")

#+END_SRC

** Awesome Tray Configuration
#+BEGIN_SRC emacs-lisp
;;; Awesome Tray Configuration

(defun mcg-modeline-setup-awesome-tray ()
  "设置 awesome-tray。"
  (when (mcg-require-extension "ui/awesome-tray" 'awesome-tray)
    ;; 位置配置
    (setq awesome-tray-position mcg-modeline-position)
    
    ;; 日期格式
    (setq awesome-tray-date-format mcg-modeline-date-format)
    
    ;; 活动模块
    (setq awesome-tray-active-modules mcg-modeline-active-modules)
    
    ;; 样式配置
    (setq awesome-tray-info-padding-right 1)
    (setq awesome-tray-second-line mcg-modeline-use-second-line)
    
    ;; Buffer 名称配置
    (setq awesome-tray-buffer-name-buffer-changed t)
    (setq awesome-tray-buffer-name-max-length mcg-modeline-buffer-name-max-length)
    
    ;; 输入法样式
    (setq awesome-tray-input-method-default-style mcg-modeline-input-method-default)
    (setq awesome-tray-input-method-local-style mcg-modeline-input-method-local)
    
    ;; 隐藏默认 mode-line
    (setq-default mode-line-format nil)
    
    ;; 启用 awesome-tray
    (awesome-tray-mode 1)
    
    (mcg-log "Enabled awesome-tray mode")))

#+END_SRC

** Commands
#+BEGIN_SRC emacs-lisp
;;; Commands

(defun mcg/toggle-modeline ()
  "切换 awesome-tray 模式。"
  (interactive)
  (if (bound-and-true-p awesome-tray-mode)
      (progn
        (awesome-tray-mode -1)
        (setq-default mode-line-format (default-value 'mode-line-format))
        (message "awesome-tray disabled"))
    (mcg-modeline-setup-awesome-tray)
    (message "awesome-tray enabled")))

(defun mcg/modeline-add-module (module)
  "添加模块到 awesome-tray。

MODULE 是模块名称字符串。"
  (interactive
   (list (completing-read "Add module: "
                          '("git" "location" "belong" "mode-name" "date"
                            "buffer-name" "parent-dir" "file-path"
                            "input-method" "battery" "word-count"
                            "volume" "hostname" "github" "anzu")
                          nil t)))
  (unless (member module mcg-modeline-active-modules)
    (setq mcg-modeline-active-modules
          (append mcg-modeline-active-modules (list module)))
    (when (bound-and-true-p awesome-tray-mode)
      (setq awesome-tray-active-modules mcg-modeline-active-modules)
      (awesome-tray-mode -1)
      (awesome-tray-mode 1))
    (message "Added module: %s" module)))

(defun mcg/modeline-remove-module (module)
  "从 awesome-tray 移除模块。

MODULE 是模块名称字符串。"
  (interactive
   (list (completing-read "Remove module: "
                          mcg-modeline-active-modules
                          nil t)))
  (setq mcg-modeline-active-modules
        (delete module mcg-modeline-active-modules))
  (when (bound-and-true-p awesome-tray-mode)
    (setq awesome-tray-active-modules mcg-modeline-active-modules)
    (awesome-tray-mode -1)
    (awesome-tray-mode 1))
  (message "Removed module: %s" module))

(defun mcg/modeline-list-modules ()
  "显示当前活动的 awesome-tray 模块。"
  (interactive)
  (message "Active modules: %s"
           (string-join mcg-modeline-active-modules ", ")))

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

;; 设置 awesome-tray
(mcg-modeline-setup-awesome-tray)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-modeline)
;;; init-modeline.el ends here
#+END_SRC
