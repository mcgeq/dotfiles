#+TITLE: Modeline Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-modeline.el :lexical t

* Modeline Module

本模块负责 MCG Emacs 的 modeline 配置，包括：
- awesome-tray 配置
- Modeline 显示自定义
- 模块管理命令

** File Header

#+begin_src emacs-lisp
;;; init-modeline.el --- Modeline Configuration for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-modeline.el
;; Description: Modeline configuration module (using awesome-tray)
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: modeline, ui, awesome-tray
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Modeline module for MCG Emacs configuration, responsible for:
;; - awesome-tray configuration
;; - Modeline display customization
;;
;; Module metadata:
;; :depends ()
;; :defer nil
;;
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

;;; Dependencies

(require 'core-lib)
#+end_src

** Variables

Modeline 相关的配置变量。

*** Position

#+begin_src emacs-lisp
;;; Variables

(defvar mcg-modeline-position 'center
  "awesome-tray display position.
Options: 'left, 'center, 'right")
#+end_src

*** Date Format

#+begin_src emacs-lisp
(defvar mcg-modeline-date-format "[%-Y-%-m-%-d %a %-H:%M]"
  "Date and time display format.")
#+end_src

*** Active Modules

#+begin_src emacs-lisp
(defvar mcg-modeline-active-modules
  '("buffer-name"    ; Buffer name
    "mode-name"      ; Major mode
    "location"       ; Cursor position (line:column)
    "belong"         ; Current function/class
    "parent-dir"     ; Parent directory name
    "input-method"   ; Input method status
    "date")          ; Date and time
  "List of modules displayed by awesome-tray.

Available modules:
- git: Git branch info
- location: Cursor position (line:column)
- belong: Current function/class
- mode-name: Major mode name
- date: Date and time
- buffer-name: Buffer name
- parent-dir: Parent directory name
- file-path: Full file path
- input-method: Input method status
- battery: Battery status
- word-count: Word count
- volume: Volume
- hostname: Hostname
- github: GitHub notifications
- anzu: Search count")
#+end_src

*** Display Options

#+begin_src emacs-lisp
(defvar mcg-modeline-use-second-line t
  "Whether to use second line display.")

(defvar mcg-modeline-buffer-name-max-length 30
  "Maximum display length for buffer name.")
#+end_src

*** Input Method

#+begin_src emacs-lisp
(defvar mcg-modeline-input-method-default "EN"
  "Display text for English input method status.")

(defvar mcg-modeline-input-method-local "CN"
  "Display text for Chinese input method status.")
#+end_src

** Awesome Tray Configuration

awesome-tray 的核心配置函数。

#+begin_src emacs-lisp
;;; Awesome Tray Configuration

(defun mcg-modeline-setup-awesome-tray ()
  "Set up awesome-tray."
  (when (mcg-require-extension "awesome-tray" t)
    ;; Position configuration
    (setq awesome-tray-position mcg-modeline-position)
    
    ;; Date format
    (setq awesome-tray-date-format mcg-modeline-date-format)
    
    ;; Active modules
    (setq awesome-tray-active-modules mcg-modeline-active-modules)
    
    ;; Style configuration
    (setq awesome-tray-info-padding-right 1)
    (setq awesome-tray-second-line mcg-modeline-use-second-line)
    
    ;; Buffer name configuration
    (setq awesome-tray-buffer-name-buffer-changed t)
    (setq awesome-tray-buffer-name-max-length mcg-modeline-buffer-name-max-length)
    
    ;; Input method style
    (setq awesome-tray-input-method-default-style mcg-modeline-input-method-default)
    (setq awesome-tray-input-method-local-style mcg-modeline-input-method-local)
    
    ;; Hide default mode-line
    (setq-default mode-line-format nil)
    
    ;; Enable awesome-tray
    (awesome-tray-mode 1)
    
    (mcg-log "Enabled awesome-tray mode")))
#+end_src

** Commands

交互式 modeline 管理命令。

*** Toggle Modeline

#+begin_src emacs-lisp
;;; Commands

(defun mcg/toggle-modeline ()
  "Toggle awesome-tray mode."
  (interactive)
  (if (bound-and-true-p awesome-tray-mode)
      (progn
        (awesome-tray-mode -1)
        (setq-default mode-line-format (default-value 'mode-line-format))
        (message "awesome-tray disabled"))
    (mcg-modeline-setup-awesome-tray)
    (message "awesome-tray enabled")))
#+end_src

*** Add Module

#+begin_src emacs-lisp
(defun mcg/modeline-add-module (module)
  "Add module to awesome-tray.

MODULE is the module name string."
  (interactive
   (list (completing-read "Add module: "
                          '("git" "location" "belong" "mode-name" "date"
                            "buffer-name" "parent-dir" "file-path"
                            "input-method" "battery" "word-count"
                            "volume" "hostname" "github" "anzu")
                          nil t)))
  (unless (member module mcg-modeline-active-modules)
    (setq mcg-modeline-active-modules
          (append mcg-modeline-active-modules (list module)))
    (when (bound-and-true-p awesome-tray-mode)
      (setq awesome-tray-active-modules mcg-modeline-active-modules)
      (awesome-tray-mode -1)
      (awesome-tray-mode 1))
    (message "Added module: %s" module)))
#+end_src

*** Remove Module

#+begin_src emacs-lisp
(defun mcg/modeline-remove-module (module)
  "Remove module from awesome-tray.

MODULE is the module name string."
  (interactive
   (list (completing-read "Remove module: "
                          mcg-modeline-active-modules
                          nil t)))
  (setq mcg-modeline-active-modules
        (delete module mcg-modeline-active-modules))
  (when (bound-and-true-p awesome-tray-mode)
    (setq awesome-tray-active-modules mcg-modeline-active-modules)
    (awesome-tray-mode -1)
    (awesome-tray-mode 1))
  (message "Removed module: %s" module))
#+end_src

*** List Modules

#+begin_src emacs-lisp
(defun mcg/modeline-list-modules ()
  "Display currently active awesome-tray modules."
  (interactive)
  (message "Active modules: %s"
           (string-join mcg-modeline-active-modules ", ")))
#+end_src

** Initialize

模块初始化，设置 awesome-tray。

#+begin_src emacs-lisp
;;; Initialize

;; Set up awesome-tray
(mcg-modeline-setup-awesome-tray)
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-modeline)
;;; init-modeline.el ends here
#+end_src
