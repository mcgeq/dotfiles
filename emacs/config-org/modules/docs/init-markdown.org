* init-markdown.el
:PROPERTIES:
:HEADER-ARGS: :tangle init-markdown.el :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
;;; init-markdown.el --- Markdown Support for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-markdown.el
;; Description: Markdown documentation module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-07
;; Version: 3.0
;; Keywords: markdown, docs
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Markdown documentation module for MCG Emacs, responsible for:
;; - Markdown mode configuration
;; - Tree-sitter support
;; - Flymake-vale grammar checking
;;
;; Module metadata:
;; :defer t
;; :mode ("\\.md\\'" "\\.markdown\\'")
;;

#+END_SRC

** Dependencies
#+BEGIN_SRC emacs-lisp
;;; Dependencies

(require 'core-lib)

#+END_SRC

** Markdown Mode Configuration
#+BEGIN_SRC emacs-lisp
;;; Markdown Mode Configuration

(defun mcg--setup-markdown-mode ()
  "Setup Markdown mode."
  ;; Use built-in markdown-ts-mode (Emacs 29+)
  (when (fboundp 'markdown-ts-mode)
    (add-to-list 'auto-mode-alist '("\\.md\\'" . markdown-ts-mode))
    (add-to-list 'auto-mode-alist '("\\.markdown\\'" . markdown-ts-mode))
    (mcg-log "Markdown tree-sitter mode configured")))

#+END_SRC

** Flymake Vale Integration
#+BEGIN_SRC emacs-lisp
;;; Flymake Vale Integration

(defun mcg--setup-flymake-vale ()
  "Setup flymake-vale grammar checking."
  (when (mcg-require-extension "docs/flymake-vale" 'flymake-vale)
    ;; Enable vale for various text modes
    (add-hook 'text-mode-hook #'flymake-vale-load)
    (add-hook 'markdown-mode-hook #'flymake-vale-load)
    (add-hook 'markdown-ts-mode-hook #'flymake-vale-load)
    (add-hook 'org-mode-hook #'flymake-vale-load)
    (add-hook 'latex-mode-hook #'flymake-vale-load)
    (add-hook 'message-mode-hook #'flymake-vale-load)
    
    ;; Auto-detect and load
    (add-hook 'find-file-hook 'flymake-vale-maybe-load)
    
    ;; Add extra mode support
    (when (boundp 'flymake-vale-modes)
      (add-to-list 'flymake-vale-modes 'adoc-mode))
    
    (mcg-log "Flymake-vale configured")))

#+END_SRC

** Markdown Mode Hook
#+BEGIN_SRC emacs-lisp
;;; Markdown Mode Hook

(defun mcg--markdown-mode-hook ()
  "Markdown mode hook."
  ;; Enable visual line mode
  (visual-line-mode 1)
  ;; Enable spell checking (optional)
  ;; (flyspell-mode 1)
  )

#+END_SRC

** Grip Mode Integration
#+BEGIN_SRC emacs-lisp
;;; Grip Mode Integration

(defun mcg--setup-grip-mode ()
  "Setup grip-mode live preview."
  (when (mcg-require-extension "docs/grip-mode" 'grip-mode)
    ;; Bind shortcut to markdown-mode-command-map
    (with-eval-after-load 'markdown-mode
      (define-key markdown-mode-command-map (kbd "g") #'grip-mode))
    
    ;; Command selection: auto, grip, go-grip or mdopen
    (setq grip-command 'auto)
    
    ;; Theme selection
    (setq grip-theme 'auto)
    
    ;; Use embedded webkit preview (requires Emacs 26+ compiled with --with-xwidgets)
    (setq grip-preview-use-webkit t)
    
    ;; Update preview after save, not after every text change
    (setq grip-update-after-change nil)
    
    ;; Wait time for server startup
    (setq grip-sleep-time 2)
    
    (mcg-log "Grip-mode configured")))

#+END_SRC

** Initialize
#+BEGIN_SRC emacs-lisp
;;; Initialize

(mcg--setup-markdown-mode)
(mcg--setup-flymake-vale)
(mcg--setup-grip-mode)

;; 添加 hook
(add-hook 'markdown-mode-hook #'mcg--markdown-mode-hook)
(add-hook 'markdown-ts-mode-hook #'mcg--markdown-mode-hook)

#+END_SRC

** Provide
#+BEGIN_SRC emacs-lisp
(provide 'init-markdown)
;;; init-markdown.el ends here
#+END_SRC
