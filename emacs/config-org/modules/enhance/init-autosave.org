#+TITLE: Auto-Save Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init-autosave.el :lexical t

* Auto-Save Module

本模块负责 MCG Emacs 的空闲自动保存功能，包括：
- 当 Emacs 空闲时自动保存修改过的缓冲区
- 禁用 Emacs 默认的备份和自动保存机制

** File Header

#+begin_src emacs-lisp
;;; init-autosave.el --- Idle Auto-Save for MCG Emacs -*- lexical-binding: t; -*-

;; Filename: init-autosave.el
;; Description: Idle auto-save module
;; Author: mcge <mcgeq@outlook.com>
;; Copyright (C) 2024-2026, mcge, all rights reserved.
;; Create   Date: 2026-01-10
;; Version: 3.0
;; Keywords: auto-save, idle
;; Compatibility: GNU Emacs 29.0+

;;; Commentary:
;;
;; Idle auto-save module for MCG Emacs, responsible for:
;; - Automatically saving modified buffers when Emacs is idle
;; - Disabling Emacs default backup and auto-save mechanisms
;;
;; Module metadata:
;; :depends ()
;; :defer nil
;;
#+end_src

** Require

#+begin_src emacs-lisp
;;; Code:

(require 'core-lib)
#+end_src

** Variables

自动保存相关变量定义。

#+begin_src emacs-lisp
;;; ============================================================
;;; Variables
;;; ============================================================

(defgroup mcg-auto-save nil
  "Auto save files when Emacs is idle."
  :group 'convenience)

(defcustom mcg-auto-save-idle 1
  "Seconds of idle time before auto-save."
  :type 'integer
  :group 'mcg-auto-save)

(defcustom mcg-auto-save-silent t
  "Whether to save silently (no messages)."
  :type 'boolean
  :group 'mcg-auto-save)

(defvar mcg--auto-save-timer nil
  "Auto-save timer.")
#+end_src

** Disable Default Auto-Save

禁用 Emacs 默认的自动保存和备份功能。

#+begin_src emacs-lisp
;;; ============================================================
;;; Disable Default Auto-Save
;;; ============================================================

;; Disable Emacs default auto-save and backup
(setq make-backup-files nil)
(setq auto-save-default nil)
(setq create-lockfiles nil)
#+end_src

** Auto-Save Functions

自动保存核心函数。

*** Save Buffers

#+begin_src emacs-lisp
;;; ============================================================
;;; Auto-Save Functions
;;; ============================================================

(defun mcg--auto-save-buffers ()
  "Auto-save all modified buffers.
Skips buffers that are in the middle of completion or snippet expansion."
  (interactive)
  (let ((saved-buffers nil))
    (save-current-buffer
      (dolist (buf (buffer-list))
        (set-buffer buf)
        (when (and (buffer-file-name)
                   (buffer-modified-p)
                   ;; Skip during snippet expansion
                   (not (bound-and-true-p yas--active-snippets))
                   ;; Skip during company completion
                   (not (bound-and-true-p company-candidates))
                   ;; Skip during corfu completion
                   (or (not (bound-and-true-p corfu--total))
                       (zerop corfu--total)))
          (push (buffer-name) saved-buffers)
          (let ((inhibit-message mcg-auto-save-silent)
                (message-log-max (unless mcg-auto-save-silent message-log-max)))
            (basic-save-buffer)))))
    (unless mcg-auto-save-silent
      (when saved-buffers
        (message "Auto-saved: %s" (string-join saved-buffers ", "))))))
#+end_src

*** Enable Auto-Save

#+begin_src emacs-lisp
(defun mcg--auto-save-enable ()
  "Enable auto-save."
  (when mcg--auto-save-timer
    (cancel-timer mcg--auto-save-timer))
  (setq mcg--auto-save-timer
        (run-with-idle-timer mcg-auto-save-idle t #'mcg--auto-save-buffers))
  (mcg-log "Auto-save enabled (idle: %ds)" mcg-auto-save-idle))
#+end_src

*** Disable Auto-Save

#+begin_src emacs-lisp
(defun mcg--auto-save-disable ()
  "Disable auto-save."
  (when mcg--auto-save-timer
    (cancel-timer mcg--auto-save-timer)
    (setq mcg--auto-save-timer nil))
  (mcg-log "Auto-save disabled"))
#+end_src

** Commands

用户交互命令。

#+begin_src emacs-lisp
;;; ============================================================
;;; Commands
;;; ============================================================

(defun mcg/toggle-auto-save ()
  "Toggle auto-save on/off."
  (interactive)
  (if mcg--auto-save-timer
      (progn
        (mcg--auto-save-disable)
        (message "Auto-save disabled"))
    (mcg--auto-save-enable)
    (message "Auto-save enabled")))
#+end_src

** Initialize

初始化自动保存功能。

#+begin_src emacs-lisp
;;; ============================================================
;;; Initialize
;;; ============================================================

;; Enable auto-save
(mcg--auto-save-enable)
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init-autosave)
;;; init-autosave.el ends here
#+end_src
