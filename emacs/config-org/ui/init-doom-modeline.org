* init-doom-modeline.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "init-doom-modeline.el") :lexical t
:END:

** Headers

#+BEGIN_SRC emacs-lisp
  ;;; init-doom-modeline.el -- Config for doom-modeline -*- lexical-binding: t; -*-

  ;; Filename: init-doom-modeline.el
  ;; Description: Config for doom-modeline and themes integration
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024, mcge, all rights reserved.
  ;; Create   Date: 2025-01-04 15:00:00
  ;; Version: 0.1
  ;; Modified   By: mcgeq <mcgeq@outlook.com>
  ;; Last Modified:  <2025-08-05 Wed 22:38>
  ;; Keywords:
  ;; Compatibility: GNU Emacs 31.0.50

  ;;; Commentary:
  ;;
  ;; Config for doom-modeline with intelligent theme integration
  ;; Supports ef-themes and doom-themes series
  ;;

  ;;; Installation:
  ;;
  ;; Put init-doom-modeline.el to your load-path.
  ;; The load-path is usually ~/elisp/.
  ;; It's set in your ~/.emacs like this:
  ;; (add-to-list 'load-path (expand-file-name "~/elisp"))
  ;;
  ;; And the following to your ~/.emacs startup file.
  ;;
  ;; (require 'init-doom-modeline)
  ;;
  ;; No need more.

  ;;; Customize:
  ;;
  ;;
  ;;
  ;; All of the above can customize by:
  ;;      M-x customize-group RET init-aider RET

  ;;; Change log:
  ;;

#+END_SRC


** Require
#+BEGIN_SRC emacs-lisp
;;; Require:
;; 安全加载doom-modeline，即使失败也不阻止启动
(condition-case err
    (require 'doom-modeline)
  (error (message "Warning: Failed to load doom-modeline: %s" (error-message-string err))))
;;; Code:
#+END_SRC

** Code
#+BEGIN_SRC emacs-lisp
;; ============================================================
;; 通用主题智能适配系统
;; 支持 ef-themes 和 doom-themes 系列
;; ============================================================

;; 主题视觉配置仓库（可根据需要扩展）

(defvar mcg/theme-styles
  '(
    ;; ef-themes 系列
    ((ef-bio ef-winter ef-summer ef-spring)
     :style "ef"
     :dark t
     :doom-modeline-height 25
     :doom-modeline-buffer-file-name-style 'auto
     :solaire-bg-alt (lambda (theme) (ef-themes--palette-value 'bg-alt theme))
     :hl-line-bg (lambda (theme) (ef-themes--palette-value 'bg-dim theme))
     :status-bar-color (lambda (theme) 
                         (cond
                          ((eq theme 'ef-bio) "#6a95c0")
                          ((eq theme 'ef-winter) "#5d7fa8")
                          ((eq theme 'ef-summer) "#4a9c7c")
                          ((eq theme 'ef-spring) "#b57edc"))))
    
    ;; ef-autumn 特殊处理（浅色主题）
    (ef-autumn
     :style "ef"
     :dark nil
     :doom-modeline-height 28
     :doom-modeline-buffer-file-name-style 'truncate-except-project
     :solaire-bg-alt (lambda (_) "#ebe1d1")
     :hl-line-bg (lambda (_) "#e0d6c6")
     :status-bar-color (lambda (_) "#a6732f"))
    
    ;; doom-themes 系列
    (doom-themes
     :style "doom"
     :dark (lambda (theme) (string-match-p "dark" (symbol-name theme)))
     :doom-modeline-height 26
     :doom-modeline-buffer-file-name-style 'truncate-upto-project
     :solaire-bg-alt (lambda (theme) 
                       (if (funcall (plist-get (cdr (assoc 'doom-themes mcg/theme-styles)) :dark) theme)
                           "#282c34"
                         "#f0f0f0"))
     :hl-line-bg (lambda (theme) 
                   (if (funcall (plist-get (cdr (assoc 'doom-themes mcg/theme-styles)) :dark) theme)
                       "#2d333b" 
                     "#e4e4e4"))
     :status-bar-color (lambda (theme)
                         (cond
                          ((eq theme 'doom-one) "#51afef")
                          ((eq theme 'doom-vibrant) "#a9a1e1")
                          ((eq theme 'doom-acario-dark) "#cf9a72")
                          ((eq theme 'doom-acario-light) "#7f9f7f")
                          (t "#d18ec2"))))

    ;; 默认设置
    (default
     :style "unknown"
     :dark (lambda (theme) (if (string-match-p "dark" (symbol-name theme)) t nil))
     :doom-modeline-height 24
     :doom-modeline-buffer-file-name-style 'auto
     :solaire-bg-alt (lambda (_) "#181818")
     :hl-line-bg (lambda (_) "#202020")
     :status-bar-color (lambda (_) "#5d7fa8")))
  "主题特定的视觉参数仓库")

;; 主题智能适配器
(defun mcg/get-theme-settings (theme)
  "获取当前主题的设置"
  (catch 'found
    (dolist (entry mcg/theme-styles)
      (let ((theme-id (car entry)))
        (cond
         ;; 处理主题列表 (ef-winter, ef-spring 等)
         ((listp theme-id)
          (when (memq theme theme-id)
            (throw 'found (cons theme (cdr entry)))))

         ;; 处理独立主题
         ((symbolp theme-id)
          (when (eq theme-id theme)
            (throw 'found (cons theme (cdr entry)))))

         ;; 处理主题系列（如 doom-themes）
         ((eq theme-id 'doom-themes)
          (when (string-prefix-p "doom-" (symbol-name theme))
            (throw 'found (cons theme (cdr entry)))))))

    ;; 未找到匹配时使用默认设置
    (cons theme (cdr (assoc 'default mcg/theme-styles))))))

(defun mcg/apply-theme-settings ()
  "应用当前主题的视觉设置"
  (interactive)
  (when custom-enabled-themes
    (let* ((theme (car custom-enabled-themes))
           (theme-data (mcg/get-theme-settings theme))
           (settings (cdr theme-data))
           (style (plist-get settings :style))
           (is-dark (if (functionp (plist-get settings :dark))
                        (funcall (plist-get settings :dark) theme)
                      (plist-get settings :dark))))

      ;; 应用 doom-modeline 设置
      (when (bound-and-true-p doom-modeline-mode)
        (setq doom-modeline-height (or (plist-get settings :doom-modeline-height) 25))
        (setq doom-modeline-buffer-file-name-style 
              (or (plist-get settings :doom-modeline-buffer-file-name-style) 'auto))

        (let ((bar-color (or (if (functionp (plist-get settings :status-bar-color))
                                 (funcall (plist-get settings :status-bar-color) theme)
                               (plist-get settings :status-bar-color))
                             "#5d7fa8")))  ;; Default color if nil

          ;; 更新状态条颜色
          (custom-set-faces
           `(doom-modeline-bar 
             ((t (:background ,bar-color)))))
          
          ;; 根据深浅色调整图标
          (setq doom-modeline-major-mode-color-icon t
                doom-modeline-buffer-state-icon (if is-dark t nil)
                doom-modeline-icon t)))
      
      ;; 应用 solaire-mode 设置
      (when (bound-and-true-p solaire-global-mode)
        (let ((bg-alt (or (if (functionp (plist-get settings :solaire-bg-alt))
                              (funcall (plist-get settings :solaire-bg-alt) theme)
                            (plist-get settings :solaire-bg-alt))
                          'unspecified))
              (hl-bg (or (if (functionp (plist-get settings :hl-line-bg))
                             (funcall (plist-get settings :hl-line-bg) theme)
                           (plist-get settings :hl-line-bg))
                         'unspecified)))
          
          ;; Only set faces if values are not 'unspecified
          (when (not (eq bg-alt 'unspecified))
            (custom-set-faces
             `(solaire-default-face 
               ((t (:background ,bg-alt))))))
          
          (when (not (eq hl-bg 'unspecified))
            (custom-set-faces
             `(solaire-hl-line-face 
               ((t (:background ,hl-bg)))))
            
            ;; 更新高亮行设置
            (with-eval-after-load 'hl-line
              (set-face-background 'hl-line hl-bg)))))
      
      ;; 刷新界面
      (force-mode-line-update)
      (redisplay t)
      (message "已应用 %s 主题的视觉设置 (类型: %s)" theme style))))

;; ============================================================
;; 主题切换钩子
;; ============================================================

;; 通用主题切换检测
(add-hook 'load-theme-hook 'mcg/apply-theme-settings)

;; 为 ef-themes 添加专用钩子
(with-eval-after-load 'ef-themes
  (add-hook 'ef-themes-post-load-hook 'mcg/apply-theme-settings))

;; ============================================================
;; 初始化UI组件（主题无关设置）
;; ============================================================

(defun mcg/setup-ui-components ()
  "设置主题无关的通用UI配置 - 现代化增强版"
  ;; 确保插件已加载
  (require 'doom-modeline)
  (require 'solaire-mode)
  
  ;; 启用插件
  (doom-modeline-mode 1)
  (solaire-global-mode 1)
  
  ;; ============================================================
  ;; 现代化通用设置 - 优化视觉和性能
  ;; ============================================================
  
  ;; 基础外观
  (setq doom-modeline-bar-width 4                    ; 更宽的状态条，更明显
        doom-modeline-height 32                      ; 更高的modeline，更舒适（类似neo-emacs）
        doom-modeline-window-width-limit 80          ; 窗口宽度限制
        doom-modeline-hud t)                         ; 启用 HUD 滚动条效果
  
  ;; 图标设置 - 现代化图标显示
  (setq doom-modeline-icon t                         ; 启用图标
        doom-modeline-major-mode-icon t              ; 主模式图标
        doom-modeline-major-mode-color-icon t        ; 彩色主模式图标
        doom-modeline-buffer-state-icon t            ; 缓冲区状态图标
        doom-modeline-buffer-modification-icon t     ; 修改状态图标
        doom-modeline-time-icon t                    ; 时间图标
        doom-modeline-unicode-fallback nil)          ; 不使用Unicode后备
  
  ;; 缓冲区信息显示 - neo-emacs 风格
  (setq doom-modeline-buffer-name t                  ; 显示缓冲区名称
        doom-modeline-buffer-file-name-style 'truncate-upto-project  ; 智能截断
        doom-modeline-highlight-modified-buffer-name t  ; 高亮修改的缓冲区
        doom-modeline-buffer-encoding-explicit t)    ; 明确显示编码
  
  ;; 编码和文件信息 - 简化显示
  (setq doom-modeline-buffer-encoding t              ; 显示编码
        doom-modeline-indent-info t                  ; 显示缩进信息
        doom-modeline-total-line-number t)           ; 显示总行数
  
  ;; 项目和VCS - 增强Git集成（neo-emacs风格）
  (setq doom-modeline-project-detection 'auto        ; 自动检测项目
        doom-modeline-buffer-file-name-style 'truncate-upto-project
        doom-modeline-vcs-max-length 18              ; VCS信息最大长度（更宽）
        doom-modeline-check-simple-format t          ; 简化格式检查
        doom-modeline-vcs-icon t)                    ; 显示VCS图标
  
  ;; Git/VCS集成
  (setq doom-modeline-enable-word-count nil          ; 禁用字数统计（性能）
        doom-modeline-continuous-word-count-modes    ; 特定模式启用字数
        '(markdown-mode gfm-mode org-mode))
  
  ;; LSP集成 - 现代开发体验
  (setq doom-modeline-lsp t                          ; 显示LSP状态
        doom-modeline-lsp-icon t)                    ; LSP图标
  
  ;; 环境信息
  (setq doom-modeline-env-version t                  ; 显示环境版本
        doom-modeline-env-enable-python t            ; Python环境
        doom-modeline-env-enable-ruby t              ; Ruby环境
        doom-modeline-env-enable-perl t              ; Perl环境
        doom-modeline-env-enable-go t)               ; Go环境
  
  ;; 性能优化设置
  (setq doom-modeline-minor-modes nil                ; 隐藏minor modes（减少视觉噪音）
        doom-modeline-check-simple-format t          ; 简化语法检查显示
        doom-modeline-number-limit 99                ; 数字显示限制
        doom-modeline-persp-name t                   ; 显示透视图名称
        doom-modeline-display-default-persp-name nil ; 不显示默认透视图
        doom-modeline-persp-icon t                   ; 透视图图标
        doom-modeline-workspace-name t)              ; 显示工作区名称（neo-emacs风格）
  
  ;; 模态编辑状态 (Evil/Meow) - neo-emacs 风格
  (setq doom-modeline-modal t                        ; 显示模态状态
        doom-modeline-modal-icon t                   ; 模态图标
        doom-modeline-modal-modern-icon t)           ; 使用现代图标样式
  
  ;; 其他增强功能
  (setq doom-modeline-mu4e t                         ; mu4e邮件集成
        doom-modeline-gnus t                         ; Gnus集成
        doom-modeline-github t                       ; GitHub通知
        doom-modeline-github-interval (* 30 60))     ; GitHub检查间隔(30分钟)
  
  ;; 时间显示 - 可选
  (setq doom-modeline-time t                         ; 显示时间
        doom-modeline-time-icon t)                   ; 时间图标
  
  ;; IBuffer集成
  (setq doom-modeline-irc nil                        ; 禁用IRC
        doom-modeline-irc-stylize 'identity))

;; 在启动时加载
(mcg/setup-ui-components)

;; ============================================================
;; 现代化增强功能
;; ============================================================

;; 自定义modeline段的颜色和样式
(defun mcg/enhance-modeline-faces ()
  "增强modeline的视觉效果"
  (custom-set-faces
   ;; 更柔和的modeline背景
   '(mode-line 
     ((t (:height 1.0 :box (:line-width 4 :color nil :style flat-button)))))
   '(mode-line-inactive 
     ((t (:height 1.0 :box (:line-width 4 :color nil :style flat-button)))))
   
   ;; 增强的buffer名称显示
   '(doom-modeline-buffer-file 
     ((t (:inherit mode-line-buffer-id :weight semi-bold))))
   '(doom-modeline-buffer-modified 
     ((t (:inherit error :weight bold))))
   
   ;; Git分支显示优化
   '(doom-modeline-vcs-info 
     ((t (:inherit font-lock-keyword-face :weight semi-bold))))
   
   ;; LSP状态优化
   '(doom-modeline-lsp-success 
     ((t (:inherit success :weight semi-bold))))
   '(doom-modeline-lsp-warning 
     ((t (:inherit warning :weight semi-bold))))
   '(doom-modeline-lsp-error 
     ((t (:inherit error :weight bold))))
   
   ;; 项目名称
   '(doom-modeline-project-dir 
     ((t (:inherit font-lock-constant-face :weight semi-bold))))))

;; 应用视觉增强
(add-hook 'doom-modeline-mode-hook #'mcg/enhance-modeline-faces)

;; ============================================================
;; 类似 neo-emacs 的箭头效果配置
;; ============================================================

;; 增强 mode-line 的边框效果，模拟箭头视觉
(defun mcg/enhance-modeline-appearance ()
  "增强 modeline 外观，使其更像 neo-emacs 风格"
  (custom-set-faces
   ;; 更明显的边框，创造箭头般的视觉效果
   '(mode-line
     ((t (:box (:line-width 6 :style flat-button)
          :overline nil
          :underline nil))))
   '(mode-line-inactive
     ((t (:box (:line-width 6 :style flat-button)
          :overline nil
          :underline nil))))
   
   ;; 增强 doom-modeline-bar 的视觉效果（左侧状态指示器）
   '(doom-modeline-bar
     ((t (:inherit doom-modeline-project-dir :weight bold))))
   
   ;; 使 evil 状态更明显（如果使用 evil-mode）
   '(doom-modeline-evil-normal-state
     ((t (:inherit font-lock-builtin-face :weight bold))))
   '(doom-modeline-evil-insert-state
     ((t (:inherit font-lock-keyword-face :weight bold))))
   '(doom-modeline-evil-visual-state
     ((t (:inherit font-lock-variable-name-face :weight bold))))
   '(doom-modeline-evil-replace-state
     ((t (:inherit font-lock-type-face :weight bold))))
   '(doom-modeline-evil-operator-state
     ((t (:inherit font-lock-function-name-face :weight bold))))
   '(doom-modeline-evil-emacs-state
     ((t (:inherit font-lock-constant-face :weight bold))))))

(add-hook 'doom-modeline-mode-hook #'mcg/enhance-modeline-appearance)

;; ============================================================
;; 智能显示切换 - 根据窗口大小自动调整
;; ============================================================

(defvar mcg/modeline-compact-threshold 100
  "窗口宽度小于此值时启用紧凑模式")

(defun mcg/modeline-adapt-to-window-size ()
  "根据窗口大小调整modeline显示"
  (let ((width (window-total-width)))
    (if (< width mcg/modeline-compact-threshold)
        (progn
          ;; 紧凑模式
          (setq doom-modeline-buffer-file-name-style 'file-name
                doom-modeline-vcs-max-length 10
                doom-modeline-time nil))
      ;; 完整模式
      (setq doom-modeline-buffer-file-name-style 'truncate-upto-project
            doom-modeline-vcs-max-length 15
            doom-modeline-time t))))

;; 窗口配置变化时自动调整
(add-hook 'window-configuration-change-hook #'mcg/modeline-adapt-to-window-size)

;; ============================================================
;; 性能优化 - 智能更新
;; ============================================================

;; 减少不必要的更新
(defun mcg/optimize-modeline-update ()
  "优化modeline更新频率"
  ;; 仅在实际变化时更新
  (setq doom-modeline-update-interval 0.3)  ; 300ms更新间隔
  
  ;; 非活动窗口减少更新
  (setq inhibit-compacting-font-caches t))  ; 减少字体缓存压缩

(mcg/optimize-modeline-update)

;; ============================================================
;; 自定义段落 - 额外的信息显示
;; ============================================================

;; 显示当前位置百分比的优雅指示器
(doom-modeline-def-segment mcg/buffer-position-custom
  "A more elegant buffer position indicator with percentage."
  (concat
   (propertize
    (format-mode-line '("" mode-line-percent-position))
    'face 'doom-modeline-buffer-minor-mode
    'help-echo "Buffer position")
   " "
   (propertize
    (format "%d:%d" (line-number-at-pos) (current-column))
    'face 'doom-modeline-buffer-minor-mode
    'help-echo "Line:Column")))

;; 增强的文件大小显示
(doom-modeline-def-segment mcg/buffer-size-custom
  "Display buffer size in a modern format."
  (when (and buffer-file-name (not (file-remote-p buffer-file-name)))
    (let ((size (buffer-size)))
      (propertize
       (cond
        ((> size 1048576) (format "%.1fM" (/ size 1048576.0)))
        ((> size 1024) (format "%.1fK" (/ size 1024.0)))
        (t (format "%dB" size)))
       'face 'doom-modeline-buffer-minor-mode
       'help-echo (format "Buffer size: %d bytes" size)))))

;; 优雅的文件类型指示器
(doom-modeline-def-segment mcg/file-type-custom
  "Show file type with icon in a modern way."
  (when buffer-file-name
    (concat
     " "
     (if-let ((type (file-name-extension buffer-file-name)))
         (propertize
          (upcase type)
          'face 'doom-modeline-buffer-minor-mode
          'help-echo (format "File type: %s" type))
       ""))))

;; 当前函数/类名显示（使用which-function-mode）
(doom-modeline-def-segment mcg/which-function-custom
  "Display current function name elegantly."
  (when (and (bound-and-true-p which-function-mode)
             which-func-mode)
    (let ((current-func (which-function)))
      (when (and current-func (not (string= current-func "n/a")))
        (propertize
         (concat " ⊢ " (truncate-string-to-width current-func 30 nil nil "…"))
         'face 'font-lock-function-name-face
         'help-echo (format "Current function: %s" current-func))))))

;; ============================================================
;; 智能modeline布局系统
;; ============================================================

(defvar mcg/modeline-format-alist
  '((minimal . ((bar workspace-name window-number modals matches buffer-info)
                (vcs)))
    (balanced . ((bar workspace-name window-number modals matches buffer-info remote-host)
                 (misc-info minor-modes check vcs)))
    (maximal . ((bar workspace-name window-number modals matches buffer-info-simple buffer-directory remote-host)
                (major-mode process mcg/which-function-custom vcs check misc-info minor-modes input-method buffer-position-custom word-count parrot selection-info))))
  "Predefined modeline layouts for different use cases.")

(defvar mcg/current-modeline-style 'balanced
  "Current modeline style.")

(defun mcg/switch-modeline-style (style)
  "Switch to a predefined modeline STYLE."
  (interactive
   (list (intern (completing-read "Modeline style: "
                                  '("minimal" "balanced" "maximal")
                                  nil t))))
  (setq mcg/current-modeline-style style)
  (let ((format (alist-get style mcg/modeline-format-alist)))
    (when format
      (doom-modeline-set-modeline style t)
      (message "Switched to %s modeline style" style))))

;; 定义自定义modeline布局
(doom-modeline-def-modeline 'minimal
  '(bar workspace-name window-number modals matches buffer-info remote-host)
  '(vcs check))

(doom-modeline-def-modeline 'balanced
  '(bar workspace-name window-number modals matches buffer-info remote-host)
  '(misc-info minor-modes check vcs))

(doom-modeline-def-modeline 'maximal
  '(bar workspace-name window-number modals matches buffer-info buffer-position remote-host)
  '(major-mode process vcs check misc-info battery time))

;; ============================================================
;; 主题加载助手
;; ============================================================

(defun mcg/load-theme-with-settings (theme)
  "安全加载主题并应用设置"
  (interactive
   (list (intern (completing-read "加载主题: " (mapcar #'symbol-name (custom-available-themes))))))
  ;; 禁用当前主题
  (mapc #'disable-theme custom-enabled-themes)
  ;; 加载新主题
  (load-theme theme t)
  ;; 应用自定义设置
  (mcg/apply-theme-settings))

;; 增强的主题选择面板
(defun mcg/theme-selector ()
  "创建主题选择面板"
  (interactive)
  (let ((buf (get-buffer-create "*主题选择*"))
        (themes (custom-available-themes)))
    (with-current-buffer buf
      (erase-buffer)
      (insert (propertize " 主题选择器 (按类型分组)\n\n" 'face 'bold))
      
      ;; 分组插入主题
      (insert (propertize " ef-themes:\n" 'face '(:foreground "#4a9c7c" :weight bold)))
      (dolist (theme themes)
        (when (string-prefix-p "ef-" (symbol-name theme))
          (insert-button (format "  %s\n" (symbol-name theme))
                         'action `(lambda (_) (mcg/load-theme-with-settings ',theme))
                         'face '(:weight bold))))
      
      (insert "\n")
      (insert (propertize " doom-themes:\n" 'face '(:foreground "#a9a1e1" :weight bold)))
      (dolist (theme themes)
        (when (string-prefix-p "doom-" (symbol-name theme))
          (insert-button (format "  %s\n" (symbol-name theme))
                         'action `(lambda (_) (mcg/load-theme-with-settings ',theme))
                         'face '(:weight bold))))
      
      (insert "\n")
      (insert (propertize " 其他主题:\n" 'face '(:foreground "#d18ec2" :weight bold)))
      (dolist (theme themes)
        (when (not (or (string-prefix-p "ef-" (symbol-name theme))
                       (string-prefix-p "doom-" (symbol-name theme))))
          (insert-button (format "  %s\n" (symbol-name theme))
                         'action `(lambda (_) (mcg/load-theme-with-settings ',theme))
                         'face '(:slant italic))))
      
      (insert "\n当前主题: " (symbol-name (car custom-enabled-themes)))
      (special-mode)))
    (display-buffer buf 
                    '((display-buffer-in-side-window)
                      (side . bottom)
                      (window-height . 0.4))))

(global-set-key (kbd "C-c t s") #'mcg/theme-selector)

;; ============================================================
;; 自动识别并应用当前主题的设置（启动时）
;; ============================================================

(defun mcg/apply-theme-at-startup ()
  "在启动时应用当前主题的设置"
  (when custom-enabled-themes
    (run-with-timer 1 nil #'mcg/apply-theme-settings)))

(add-hook 'window-setup-hook #'mcg/apply-theme-at-startup)

;; ============================================================
;; 主题调试工具
;; ============================================================

(defun mcg/show-theme-settings ()
  "显示当前主题的配置"
  (interactive)
  (if (null custom-enabled-themes)
      (message "没有主题被加载")
    (let* ((theme (car custom-enabled-themes))
           (theme-data (mcg/get-theme-settings theme)))
      (with-output-to-temp-buffer "*主题配置*"
        (princ (format "当前主题: %s\n" theme))
        (princ (format "配置类型: %s\n" (plist-get (cdr theme-data) :style)))
        (princ (format "深色主题: %s\n" (if (plist-get (cdr theme-data) :dark) "是" "否")))
        (princ "\n详细配置:\n")
        (princ "----------------------------------------\n")
        (dolist (key '(:doom-modeline-height 
                       :doom-modeline-buffer-file-name-style
                       :status-bar-color))
          (let ((value (plist-get (cdr theme-data) key)))
            (princ (format "%-35s: " key))
            (if (functionp value)
                (princ (format "%s" (funcall value theme)))
              (princ value))
            (princ "\n"))))))) 

(global-set-key (kbd "C-c t i") #'mcg/show-theme-settings)

;; ============================================================
;; 快捷键绑定 - 现代化modeline管理
;; ============================================================

(global-set-key (kbd "C-c m s") #'mcg/switch-modeline-style)
(global-set-key (kbd "C-c m r") #'doom-modeline-mode)  ; 重启modeline
(global-set-key (kbd "C-c m i") #'mcg/show-modeline-info)

;; ============================================================
;; Modeline信息面板
;; ============================================================

(defun mcg/show-modeline-info ()
  "显示当前modeline配置信息"
  (interactive)
  (let ((buf (get-buffer-create "*Modeline Info*")))
    (with-current-buffer buf
      (erase-buffer)
      (insert (propertize "═══════════════════════════════════════════════\n" 'face 'bold))
      (insert (propertize " Doom Modeline 配置信息\n" 
                          'face '(:foreground "#51afef" :weight bold :height 1.2)))
      (insert (propertize "═══════════════════════════════════════════════\n\n" 'face 'bold))
      
      ;; 基础设置
      (insert (propertize "【基础设置】\n" 'face '(:foreground "#98be65" :weight bold)))
      (insert (format "  高度: %s\n" doom-modeline-height))
      (insert (format "  状态条宽度: %s\n" doom-modeline-bar-width))
      (insert (format "  文件名样式: %s\n" doom-modeline-buffer-file-name-style))
      (insert "\n")
      
      ;; 功能开关
      (insert (propertize "【功能开关】\n" 'face '(:foreground "#c678dd" :weight bold)))
      (insert (format "  图标: %s\n" (if doom-modeline-icon "✓ 启用" "✗ 禁用")))
      (insert (format "  LSP: %s\n" (if doom-modeline-lsp "✓ 启用" "✗ 禁用")))
      (insert (format "  Git: %s\n" (if (bound-and-true-p vc-mode) "✓ 启用" "✗ 禁用")))
      (insert (format "  项目检测: %s\n" doom-modeline-project-detection))
      (insert (format "  环境版本: %s\n" (if doom-modeline-env-version "✓ 启用" "✗ 禁用")))
      (insert "\n")
      
      ;; 性能设置
      (insert (propertize "【性能设置】\n" 'face '(:foreground "#ECBE7B" :weight bold)))
      (insert (format "  更新间隔: %s ms\n" (* doom-modeline-update-interval 1000)))
      (insert (format "  Minor modes: %s\n" (if doom-modeline-minor-modes "显示" "隐藏")))
      (insert (format "  字数统计: %s\n" (if doom-modeline-enable-word-count "启用" "禁用")))
      (insert "\n")
      
      ;; 当前样式
      (insert (propertize "【当前样式】\n" 'face '(:foreground "#46D9FF" :weight bold)))
      (insert (format "  Modeline样式: %s\n" mcg/current-modeline-style))
      (insert (format "  主题: %s\n" (car custom-enabled-themes)))
      (insert "\n")
      
      ;; 快捷键
      (insert (propertize "【快捷键】\n" 'face '(:foreground "#ff6c6b" :weight bold)))
      (insert "  C-c m s  - 切换modeline样式\n")
      (insert "  C-c m r  - 重启modeline\n")
      (insert "  C-c m i  - 显示此信息\n")
      (insert "  C-c t s  - 主题选择器\n")
      (insert "  C-c t i  - 主题信息\n")
      (insert "\n")
      
      (insert (propertize "═══════════════════════════════════════════════\n" 'face 'bold))
      
      (special-mode)
      (goto-char (point-min)))
    (display-buffer buf)))

;; ============================================================
;; 启动消息
;; ============================================================

(defun mcg/modeline-startup-message ()
  "显示modeline配置加载成功消息"
  (message "✓ Doom Modeline 现代化配置已加载 | 按 C-c m i 查看详情"))

;; 延迟显示启动消息
(run-with-timer 2 nil #'mcg/modeline-startup-message)

#+END_SRC

** Ends
#+BEGIN_SRC emacs-lisp
(provide 'init-doom-modeline)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-doom-modeline.el ends here
#+END_SRC

