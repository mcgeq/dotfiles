* init-which-key.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "init-which-key.el") :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; init-which-key.el -- Which-key Configuration -*- lexical-binding: t; -*-
  
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Version: 1.0
  ;; Keywords: which-key, keybindings, help
  
  ;;; Commentary:
  ;; Complete which-key configuration with:
  ;; - All prefix descriptions
  ;; - Custom display settings
  ;; - Integration with our keybindings
#+END_SRC

** Require
#+BEGIN_SRC emacs-lisp
  ;;; Require:
  (require 'which-key)
#+END_SRC

** Basic Configuration
#+BEGIN_SRC emacs-lisp
  ;;; === 基础配置 ===
  
  ;; Enable which-key mode
  (which-key-mode)
  
  ;; Display settings
  (setq which-key-idle-delay 0.5           ; Show after 0.5 seconds
        which-key-idle-secondary-delay 0.05 ; Update quickly
        which-key-popup-type 'side-window   ; Show in side window
        which-key-side-window-location 'bottom
        which-key-side-window-max-width 0.33
        which-key-side-window-max-height 0.25
        which-key-show-prefix 'echo        ; Show prefix in echo area
        which-key-show-remaining-keys t    ; Show count of keys
        which-key-sort-order 'which-key-key-order-alpha
        which-key-min-display-lines 6
        which-key-max-display-columns nil)
  
  ;; Lighter mode line display
  (setq which-key-lighter " WK")
  
  ;; Special key replacements for better display
  (setq which-key-special-keys '("SPC" "TAB" "RET" "ESC" "DEL"))
#+END_SRC

** Main Prefix Descriptions
#+BEGIN_SRC emacs-lisp
  ;;; === 主要前缀描述 ===
  
  (which-key-add-key-based-replacements
    ;; Top-level C-c prefixes
    "C-c g"   "git"
    "C-c m"   "markmacro"
    "C-c s"   "search"
    "C-c t"   "tabs"
    "C-c n"   "notes/org"
    "C-c r"   "refactor/lsp"
    "C-c !"   "diagnostics"
    "C-c y"   "yasnippet"
    "C-c f"   "files"
    "C-c e"   "edit"
    "C-c w"   "which-key"
    
    ;; Git subprefixes
    "C-c g b" "branch"
    "C-c g r" "remote"
    "C-c g m" "submodule"
    "C-c g F" "file-ops"
    
    ;; LSP/Refactor subprefixes
    "C-c r r" "rename"
    "C-c r i" "code-action"
    "C-c r f" "format"
    "C-c r l" "implementation"
    "C-c r w" "workspace"
    
    ;; Diagnostics
    "C-c ! n" "next-error"
    "C-c ! p" "prev-error"
    "C-c ! l" "list-errors"
    
    ;; Search subprefixes
    "C-c s l" "search-line"
    "C-c s g" "grep-project"
    "C-c s i" "imenu"
    "C-c s b" "switch-buffer"
    "C-c s ?" "search-menu"
    
    ;; Tabs
    "C-c t n" "next-tab"
    "C-c t p" "prev-tab"
    "C-c t k" "kill-tab"
    "C-c t o" "kill-other-tabs"
    
    ;; Org/Notes
    "C-c n c" "capture"
    "C-c n a" "agenda"
    "C-c n l" "store-link"
    "C-c n e" "edit-src"
    
    ;; Yasnippet
    "C-c y n" "new-snippet"
    "C-c y v" "visit-snippet"
    "C-c y r" "reload"
    
    ;; Standard Emacs prefixes (enhance descriptions)
    "C-x"     "files/buffers"
    "C-x g"   "magit-status"
    "C-x M-g" "magit-dispatch"
    
    ;; Help prefixes
    "C-h"     "help"
    "C-h ."   "lsp-doc"
    "C-h ,"   "lsp-signature"
    "C-h K"   "keybindings-ref"
    
    ;; Which-key helper commands
    "C-c w p" "show-prefixes"
    "C-c w m" "show-major-mode"
    "C-c w ?" "which-key-tips")
#+END_SRC

** Theme Prefixes
#+BEGIN_SRC emacs-lisp
  ;;; === 主题相关 ===
  
  (which-key-add-key-based-replacements
    "C-c t s" "theme-selector"
    "C-c t i" "theme-info")
#+END_SRC

** Markmacro Detailed Descriptions
#+BEGIN_SRC emacs-lisp
  ;;; === Markmacro 详细描述 ===
  
  (which-key-add-key-based-replacements
    ;; C-c m prefix
    "C-c m s" "rect-set"
    "C-c m d" "rect-delete"
    "C-c m r" "rect-replace"
    "C-c m i" "rect-insert"
    "C-c m c" "mark-columns"
    "C-c m S" "mark-symbols"
    "C-c m a" "apply-all"
    "C-c m e" "apply-except-first"
    
    ;; Super key bindings (if using)
    "s-/"     "mark-words"
    "s-?"     "mark-lines"
    "s-:"     "mark-chars"
    "s-L"     "mark-imenus"
    "s-<"     "apply-all"
    "s->"     "apply-except-first"
    "s-M"     "rect-set"
    "s-D"     "rect-delete"
    "s-F"     "rect-replace"
    "s-I"     "rect-insert"
    "s-C"     "mark-columns"
    "s-S"     "mark-symbols")
#+END_SRC

** LSP Detailed Descriptions
#+BEGIN_SRC emacs-lisp
  ;;; === LSP 详细描述 ===
  
  (which-key-add-key-based-replacements
    ;; Standard LSP navigation
    "M-."     "go-to-definition"
    "M-,"     "go-back"
    "M-?"     "find-references"
    "C-M-."   "def-other-window"
    
    ;; Documentation
    "C-h ."   "show-doc"
    "C-h ,"   "show-signature"
    
    ;; Scrolling in doc
    "C-h <up>"   "doc-scroll-up"
    "C-h <down>" "doc-scroll-down")
#+END_SRC

** Helpful Descriptions
#+BEGIN_SRC emacs-lisp
  ;;; === Helpful 增强的帮助系统 ===
  
  (which-key-add-key-based-replacements
    "C-h f"   "helpful-callable"
    "C-h v"   "helpful-variable"
    "C-h k"   "helpful-key"
    "C-h x"   "helpful-command"
    "C-h F"   "helpful-function"
    "C-c C-d" "helpful-at-point")
#+END_SRC

** Editing Descriptions
#+BEGIN_SRC emacs-lisp
  ;;; === 编辑相关 ===
  
  (which-key-add-key-based-replacements
    "C-a"         "smart-bol"
    "C-c <up>"    "insert-above"
    "C-c <down>"  "insert-below"
    "M-<up>"      "move-line-up"
    "M-<down>"    "move-line-down"
    "M-n"         "scroll-down-third"
    "M-p"         "scroll-up-third"
    "C-c d"       "make-directory"
    "C-c R"       "replace-string"
    "C-c M-r"     "replace-regexp"
    "C-c C-i"     "config-info")
#+END_SRC

** Custom Display Rules
#+BEGIN_SRC emacs-lisp
  ;;; === 自定义显示规则 ===
  
  ;; Group similar commands
  (which-key-add-major-mode-key-based-replacements 'emacs-lisp-mode
    "C-c C-b" "eval-buffer"
    "C-c C-c" "eval-comment"
    "C-c C-r" "eval-region")
  
  (which-key-add-major-mode-key-based-replacements 'org-mode
    "C-c n e" "edit-src-code"
    "C-c n v" "insert-image"
    "C-c n h" "insert-heading"
    "C-c n s" "insert-subheading")
#+END_SRC

** Paging Descriptions
#+BEGIN_SRC emacs-lisp
  ;;; === 分页显示 ===
  
  ;; Describe which-key's own bindings
  (which-key-add-key-based-replacements
    ;; When which-key paging is active
    "C-h n" "next-page"
    "C-h p" "previous-page"
    "C-h u" "undo-key")
#+END_SRC

** Prefix Highlighting
#+BEGIN_SRC emacs-lisp
  ;;; === 前缀高亮 ===
  
  ;; Highlight prefix keys
  (defface which-key-group-description-face-custom
    '((t :inherit font-lock-keyword-face :bold t))
    "Face for group descriptions in which-key.")
  
  (setq which-key-prefix-face 'which-key-group-description-face-custom)
#+END_SRC

** Integration with Transient
#+BEGIN_SRC emacs-lisp
  ;;; === 与 Transient 集成 ===
  
  ;; Show transient menu options in which-key
  (which-key-add-key-based-replacements
    "C-c g ?" "git-menu"
    "C-c s ?" "search-menu")
  
  ;; Note: Transient menus will show their own UI when called
  ;; which-key helps you discover that they exist!
#+END_SRC

** Helper Functions
#+BEGIN_SRC emacs-lisp
  ;;; === 辅助函数 ===
  
  (defun mcg-which-key-show-all-prefixes ()
    "Show all defined prefix key replacements."
    (interactive)
    (with-help-window "*Which-key Prefixes*"
      (princ "Which-key Defined Prefixes:\n\n")
      (dolist (replacement (sort (copy-sequence which-key--prefix-title-alist)
                                 (lambda (a b) (string< (car a) (car b)))))
        (princ (format "%-20s → %s\n" 
                       (car replacement) 
                       (cdr replacement))))))
  
  ;; Use C-c w prefix (user-reserved) instead of C-h w (which is 'where-is')
  (global-set-key (kbd "C-c w p") 'mcg-which-key-show-all-prefixes)
  
  (defun mcg-which-key-show-major-mode ()
    "Show which-key for current major mode."
    (interactive)
    (which-key-show-major-mode))
  
  (global-set-key (kbd "C-c w m") 'mcg-which-key-show-major-mode)
#+END_SRC

** Quick Tips
#+BEGIN_SRC emacs-lisp
  ;;; === 使用提示 ===
  
  (defun mcg-which-key-tips ()
    "Show which-key usage tips."
    (interactive)
    (with-help-window "*Which-key Tips*"
      (princ "
╔═══════════════════════════════════════════════════════════╗
║              Which-key Usage Tips                         ║
╚═══════════════════════════════════════════════════════════╝

1. DISCOVERY
   - Press any prefix key (e.g., C-c g)
   - Wait 0.5 seconds
   - Which-key shows all available completions!

2. PAGING
   When list is too long:
   - C-h n    Next page
   - C-h p    Previous page
   - C-h u    Undo/go back

3. MAJOR MODE KEYS
   - C-c w m  Show keys for current major mode

4. ALL PREFIXES
   - C-c w p  Show all defined prefixes

5. INTEGRATION WITH TRANSIENT
   Which-key shows menu options (? suffix)
   Example:
   - Press C-c g     → See all git keys
   - Notice C-c g ?  → Press for full menu!

6. CUSTOMIZATION
   - Prefix descriptions in init-which-key.org
   - Transient menus in init-keymaps.org

═══════════════════════════════════════════════════════════

TIP: If which-key doesn't show, check:
     1. (which-key-mode) is enabled
     2. which-key-idle-delay setting
     3. Prefix key is actually bound to something

")))
  
  (global-set-key (kbd "C-c w ?") 'mcg-which-key-tips)
#+END_SRC

** Ends
#+BEGIN_SRC emacs-lisp
(provide 'init-which-key)
;;; init-which-key.el ends here
#+END_SRC
