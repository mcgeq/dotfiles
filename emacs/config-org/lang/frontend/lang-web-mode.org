* lang-web-mode.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "lang-web-mode.el") :lexical t
:END:

** Headers

#+BEGIN_SRC emacs-lisp
  ;;; lang-web-mode -- Config for Web Development -*- lexical-binding: t; -*-

  ;; Filename: lang-web-mode.el
  ;; Description: Config for Web Development (HTML/CSS/JavaScript)
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024, mcge, all rights reserved.
  ;; Create   Date: 2025-01-04 15:00:00
  ;; Version: 0.1
  ;; Modified   By: mcge <mcgeq@outlook.com>
  ;; Last Modified: <2025-02-16 Sun 12:00>
  ;; Keywords:
  ;; Compatibility: GNU Emacs 31.0.50

  ;;; Commentary:
  ;;
  ;; Config for Web Development including HTML, CSS, JavaScript, Vue, etc.
  ;;

  ;;; Installation:
  ;;
  ;; Put lang-web-mode.el to your load-path.
  ;; The load-path is usually ~/elisp/.
  ;; It's set in your ~/.emacs like this:
  ;; (add-to-list 'load-path (expand-file-name "~/elisp"))
  ;;
  ;; And the following to your ~/.emacs startup file.
  ;;
  ;; (require 'lang-web-mode)
  ;;
  ;; No need more.

  ;;; Customize:
  ;;
  ;;
  ;;
  ;; All of the above can customize by:
  ;;      M-x customize-group RET init-aider RET

  ;;; Change log:
  ;;

#+END_SRC


** Require
#+BEGIN_SRC emacs-lisp
;;; Require:
(require 'lazy-load)
(require 'web-mode)
(require 'js)
(require 'instant-rename-tag)
(require 'highlight-matching-tag)
(require 'css-mode)
;;; Code:
#+END_SRC

** Code
#+BEGIN_SRC emacs-lisp
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; OS Config ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
(when (featurep 'cocoa)
  ;; Initialize environment from user's shell to make eshell know every PATH by other shell.
  (require 'exec-path-from-shell)
  (exec-path-from-shell-initialize))

;; Associate file extensions with web-mode
;; Vue files use web-mode for proper syntax highlighting
(add-to-list 'auto-mode-alist '("\\.vue\\'" . web-mode))

;; HTML files: use html-ts-mode if available (Emacs 29+), fallback to web-mode
(if (and (fboundp 'html-ts-mode) (treesit-available-p))
    (add-to-list 'auto-mode-alist '("\\.html\\'" . html-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.html\\'" . web-mode)))

;; Note: .jsx/.tsx handled by lang-typescript if enabled

(setq web-mode-enable-auto-quoting nil) ;disable automatic insertion of double quotes, not easy to use if cursor in string

(highlight-matching-tag 1)

;; css
(setq css-indent-offset 2)

;; Emmit.
(setq web-mode-tag-auto-close-style 2) ;2 mean auto-close with > and </.
(setq web-mode-content-types-alist '(("vue" . "\\.vue\\'")))
(setq web-mode-css-indent-offset 2)       ; CSS 缩进（包含 HTML 的 CSS 部分及 CSS/LESS/SASS 文件）
(setq web-mode-code-indent-offset 2)      ; JavaScript 缩进（包含 SCRIPT 部分及 JS/JSX/TS/TSX 文件）
(setq web-mode-markup-indent-offset 2)    ; HTML 缩进（包含 HTML 文件及 Vue 的 TEMPLATE 部分）
(setq web-mode-enable-css-colorization t) ; 开启 CSS 颜色值显示
(setq web-mode-enable-auto-indentation nil) ; 禁用粘贴时自动格式化
(setq web-mode-enable-current-column-highlight nil)

(with-eval-after-load 'web-mode
  (setq tab-width 2))
#+END_SRC

** LSP Configuration
#+BEGIN_SRC emacs-lisp
;;; LSP配置 - 为 Vue 文件启用 LSP Bridge
(defun mcg-web-mode-lsp-setup ()
  "为 web-mode 启用 lsp-bridge，特别是 Vue 文件"
  (when (and buffer-file-name
             (string-match-p "\\.vue\\'" buffer-file-name))
    (lsp-bridge-mode 1)))

(add-hook 'web-mode-hook #'mcg-web-mode-lsp-setup)

;; 诊断函数：检查 Vue LSP 环境
(defun mcg-vue-check-lsp-environment ()
  "检查 Vue LSP 所需的环境配置"
  (interactive)
  (let ((results '())
        (tsdk-path (expand-file-name "~/AppData/Roaming/npm/node_modules/typescript/lib")))
    ;; 检查 vue-language-server
    (if (executable-find "vue-language-server")
        (push "✓ vue-language-server 已安装" results)
      (push "✗ vue-language-server 未安装 - 运行: npm install -g @vue/language-server" results))
    
    ;; 检查 typescript
    (if (executable-find "tsc")
        (push "✓ TypeScript 已安装" results)
      (push "✗ TypeScript 未安装 - 运行: npm install -g typescript" results))
    
    ;; 检查 tsdk 路径
    (if (file-directory-p tsdk-path)
        (push (format "✓ TypeScript SDK 路径存在: %s" tsdk-path) results)
      (push (format "✗ TypeScript SDK 路径不存在: %s" tsdk-path) results))
    
    ;; 检查当前 buffer
    (when (eq major-mode 'web-mode)
      (if lsp-bridge-mode
          (push "✓ 当前 Vue 文件已启用 lsp-bridge-mode" results)
        (push "✗ 当前 Vue 文件未启用 lsp-bridge-mode" results)))
    
    ;; 显示结果
    (with-current-buffer (get-buffer-create "*Vue LSP 诊断*")
      (erase-buffer)
      (insert "=== Vue LSP 环境检查 ===\n\n")
      (dolist (result (reverse results))
        (insert result "\n"))
      (insert "\n推荐的全局 npm 包:\n")
      (insert "  npm install -g typescript\n")
      (insert "  npm install -g @vue/language-server\n")
      (insert "  npm install -g typescript-language-server\n")
      (goto-char (point-min))
      (display-buffer (current-buffer)))))
#+END_SRC

** Keybindings
#+BEGIN_SRC emacs-lisp
;; Web-mode 快捷键
;; (lazy-load-set-keys fingertip-key-alist web-mode-map)
(lazy-load-local-keys
 '(
   ("M-s-SPC" . web-mode-element-content-select)
   ("C-s-l" . web-mode-element-clone)
   ("C-M-SPC" . web-mode-mark-and-expand)
   ("C-:" . web-mode-comment-or-uncomment)
   ("C-M-SPC" . mark-sexp)
   ("M-R" . instant-rename-tag)
   )
 web-mode-map
 "web-mode-extension")
#+END_SRC

** Ends
#+BEGIN_SRC emacs-lisp
(provide 'lang-web-mode)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; lang-web-mode.el ends here
#+END_SRC

