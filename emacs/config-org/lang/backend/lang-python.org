* lang-python.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "lang-python.el") :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; lang-python.el -- Python Language Support -*- lexical-binding: t; -*-
  
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Version: 1.0
  ;; Keywords: python, lsp, development
  
  ;;; Commentary:
  ;; Comprehensive Python development support with:
  ;; - LSP (pyright/pylsp)
  ;; - Formatting (black)
  ;; - Linting (ruff)
  ;; - Virtual environment management
  ;; - Testing (pytest)
  ;; - REPL integration
#+END_SRC

** Python Mode Configuration
#+BEGIN_SRC emacs-lisp
;;; Python基础配置

;; Python 缩进设置
(setq python-indent-offset 4
      python-indent-guess-indent-offset nil)

;; 使用 Python 3
(setq python-shell-interpreter "python3"
      python-shell-interpreter-args "-i")
#+END_SRC

** Virtual Environment
#+BEGIN_SRC emacs-lisp
;;; 虚拟环境支持

(defun mcg-python-setup-venv ()
  "自动检测并激活Python虚拟环境"
  (when-let* ((project-root (project-root (project-current)))
              (venv-dirs '(".venv" "venv" ".virtualenv" "env"))
              (venv-path (seq-find 
                          (lambda (dir)
                            (file-directory-p (expand-file-name dir project-root)))
                          venv-dirs)))
    (let ((venv-full-path (expand-file-name venv-path project-root)))
      (setenv "VIRTUAL_ENV" venv-full-path)
      (setq python-shell-virtualenv-root venv-full-path)
      (message "Activated Python venv: %s" venv-full-path))))

;; 自动激活虚拟环境
(add-hook 'python-mode-hook #'mcg-python-setup-venv)
#+END_SRC

** LSP Configuration
#+BEGIN_SRC emacs-lisp
;;; LSP配置 (使用lsp-bridge)

(defun mcg-python-lsp-setup ()
  "配置Python LSP"
  ;; lsp-bridge会自动检测pyright或pylsp
  ;; 优先级: pyright > pylsp
  (when (derived-mode-p 'python-mode)
    (lsp-bridge-mode 1)))

(add-hook 'python-mode-hook #'mcg-python-lsp-setup)
#+END_SRC

** Formatting
#+BEGIN_SRC emacs-lisp
;;; 代码格式化

(defun mcg-python-format-buffer ()
  "使用black格式化Python代码"
  (interactive)
  (when (executable-find "black")
    (let ((output-buffer (get-buffer-create "*black output*"))
          (error-buffer (get-buffer-create "*black errors*")))
      (if (zerop (call-process-region 
                  (point-min) (point-max)
                  "black" nil (list output-buffer error-buffer) nil
                  "--quiet" "-"))
          (progn
            (replace-buffer-contents output-buffer)
            (message "Formatted with black"))
        (display-buffer error-buffer)
        (message "Black formatting failed")))))

;; 可选：保存时自动格式化
(defun mcg-python-format-on-save ()
  "保存时自动格式化"
  (when (and (eq major-mode 'python-mode)
             (executable-find "black"))
    (mcg-python-format-buffer)))

;; 取消注释以启用保存时格式化
;; (add-hook 'before-save-hook #'mcg-python-format-on-save)

;; 快捷键
(with-eval-after-load 'python
  (define-key python-mode-map (kbd "C-c f") #'mcg-python-format-buffer))
#+END_SRC

** Testing Support
#+BEGIN_SRC emacs-lisp
;;; 测试支持

(defun mcg-python-run-pytest ()
  "运行pytest测试"
  (interactive)
  (if (executable-find "pytest")
      (let ((compilation-scroll-output t))
        (compile "pytest -v"))
    (message "pytest not found. Install with: pip install pytest")))

(defun mcg-python-run-pytest-file ()
  "运行当前文件的测试"
  (interactive)
  (if (executable-find "pytest")
      (let ((compilation-scroll-output t))
        (compile (format "pytest -v %s" (buffer-file-name))))
    (message "pytest not found")))

;; 快捷键
(with-eval-after-load 'python
  (define-key python-mode-map (kbd "C-c t t") #'mcg-python-run-pytest)
  (define-key python-mode-map (kbd "C-c t f") #'mcg-python-run-pytest-file))
#+END_SRC

** REPL Integration
#+BEGIN_SRC emacs-lisp
;;; REPL集成

(defun mcg-python-send-region-to-repl (start end)
  "发送选中区域到Python REPL"
  (interactive "r")
  (python-shell-send-region start end)
  (python-shell-switch-to-shell))

(defun mcg-python-send-buffer-to-repl ()
  "发送整个buffer到Python REPL"
  (interactive)
  (python-shell-send-buffer)
  (python-shell-switch-to-shell))

;; 快捷键
(with-eval-after-load 'python
  (define-key python-mode-map (kbd "C-c C-r") #'mcg-python-send-region-to-repl)
  (define-key python-mode-map (kbd "C-c C-b") #'mcg-python-send-buffer-to-repl))
#+END_SRC

** Project Detection
#+BEGIN_SRC emacs-lisp
;;; 项目检测

(defun mcg-python-project-p ()
  "检测是否为Python项目"
  (when-let ((project-root (project-root (project-current))))
    (or (file-exists-p (expand-file-name "setup.py" project-root))
        (file-exists-p (expand-file-name "pyproject.toml" project-root))
        (file-exists-p (expand-file-name "requirements.txt" project-root))
        (file-exists-p (expand-file-name "Pipfile" project-root))
        (file-exists-p (expand-file-name "poetry.lock" project-root)))))
#+END_SRC

** Import Optimization
#+BEGIN_SRC emacs-lisp
;;; Import优化

(defun mcg-python-sort-imports ()
  "使用isort整理imports"
  (interactive)
  (when (executable-find "isort")
    (let ((output-buffer (get-buffer-create "*isort output*")))
      (if (zerop (call-process-region 
                  (point-min) (point-max)
                  "isort" nil output-buffer nil
                  "-"))
          (progn
            (replace-buffer-contents output-buffer)
            (message "Sorted imports with isort"))
        (message "isort failed")))))

;; 快捷键
(with-eval-after-load 'python
  (define-key python-mode-map (kbd "C-c i") #'mcg-python-sort-imports))
#+END_SRC

** Documentation
#+BEGIN_SRC emacs-lisp
;;; 文档支持

(defun mcg-python-insert-docstring ()
  "插入Python docstring模板"
  (interactive)
  (let ((indent (make-string (current-indentation) ?\s)))
    (insert (format "%s\"\"\"\n%s\n%s\n%s\"\"\"\n"
                    indent
                    indent
                    indent
                    indent))
    (forward-line -2)
    (end-of-line)))

;; 快捷键
(with-eval-after-load 'python
  (define-key python-mode-map (kbd "C-c d") #'mcg-python-insert-docstring))
#+END_SRC

** Keybindings Summary
#+BEGIN_SRC emacs-lisp
;;; 快捷键总结

;; C-c f     - 格式化代码 (black)
;; C-c i     - 整理imports (isort)
;; C-c d     - 插入docstring
;; C-c t t   - 运行所有测试 (pytest)
;; C-c t f   - 运行当前文件测试
;; C-c C-r   - 发送选中区域到REPL
;; C-c C-b   - 发送整个buffer到REPL
;; C-c C-z   - 切换到REPL (内置)
;; C-c C-c   - 发送当前定义到REPL (内置)
#+END_SRC

** Auto-load Configuration
#+BEGIN_SRC emacs-lisp
;;; 自动加载配置

;; 确保Python文件自动启用此配置
(add-to-list 'auto-mode-alist '("\\.py\\'" . python-mode))
(add-to-list 'interpreter-mode-alist '("python3" . python-mode))
(add-to-list 'interpreter-mode-alist '("python" . python-mode))

;; Jupyter notebook支持
(add-to-list 'auto-mode-alist '("\\.ipynb\\'" . python-mode))
#+END_SRC

** Setup Instructions
#+BEGIN_SRC emacs-lisp
;;; 安装说明

;; 1. 安装Python LSP服务器 (二选一):
;;    pip install pyright         # 推荐，速度快
;;    pip install python-lsp-server[all]
;;
;; 2. 安装格式化工具:
;;    pip install black           # 代码格式化
;;    pip install isort           # import排序
;;
;; 3. 安装linter (可选):
;;    pip install ruff            # 现代化linter，速度快
;;    pip install pylint          # 传统linter
;;
;; 4. 安装测试工具 (可选):
;;    pip install pytest          # 测试框架
;;
;; 推荐一次性安装:
;;    pip install pyright black isort ruff pytest
#+END_SRC

** Ends
#+BEGIN_SRC emacs-lisp
(provide 'lang-python)
;;; lang-python.el ends here
#+END_SRC
