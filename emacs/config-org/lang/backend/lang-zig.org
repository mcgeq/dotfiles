* lang-zig.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "lang-zig.el") :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; lang-zig.el -- Zig Language Support -*- lexical-binding: t; -*-
  
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Version: 1.0
  ;; Keywords: zig, systems-programming
  
  ;;; Commentary:
  ;; Zig language development support with:
  ;; - LSP (zls)
  ;; - Formatting (zig fmt)
  ;; - Build system integration
  ;; - Testing support
#+END_SRC

** Zig Mode Configuration
#+BEGIN_SRC emacs-lisp
;;; Zig基础配置

;; 尝试加载zig-mode，如果不存在则使用c-mode作为基础
(unless (fboundp 'zig-mode)
  ;; 定义简单的zig-mode (基于c-mode)
  (define-derived-mode zig-mode c-mode "Zig"
    "简单的Zig mode (基于C mode)"
    (setq-local comment-start "// ")
    (setq-local comment-end "")
    (setq-local tab-width 4)
    (setq-local indent-tabs-mode nil)))

;; Zig文件关联
(add-to-list 'auto-mode-alist '("\\.zig\\'" . zig-mode))

;; 如果有zig-mode扩展，加载它
(when (locate-library "zig-mode")
  (require 'zig-mode))
#+END_SRC

** LSP Configuration
#+BEGIN_SRC emacs-lisp
;;; LSP配置 (zls - Zig Language Server)

(defun mcg-zig-lsp-setup ()
  "配置Zig LSP"
  (when (derived-mode-p 'zig-mode)
    (lsp-bridge-mode 1)))

(add-hook 'zig-mode-hook #'mcg-zig-lsp-setup)
#+END_SRC

** Formatting
#+BEGIN_SRC emacs-lisp
;;; 代码格式化

(defun mcg-zig-format-buffer ()
  "使用zig fmt格式化代码"
  (interactive)
  (if (executable-find "zig")
      (let ((output-buffer (get-buffer-create "*zig fmt*"))
            (error-buffer (get-buffer-create "*zig errors*")))
        (if (zerop (call-process-region 
                    (point-min) (point-max)
                    "zig" nil (list output-buffer error-buffer) nil
                    "fmt" "--stdin"))
            (progn
              (erase-buffer)
              (insert-buffer-substring output-buffer)
              (message "Formatted with zig fmt"))
          (display-buffer error-buffer)
          (message "Zig fmt failed")))
    (message "Zig compiler not found")))

;; 保存时自动格式化
(defun mcg-zig-format-on-save ()
  "保存时自动格式化"
  (when (and (eq major-mode 'zig-mode)
             (executable-find "zig"))
    (mcg-zig-format-buffer)))

;; 启用保存时格式化
(add-hook 'before-save-hook #'mcg-zig-format-on-save)

;; 快捷键
(with-eval-after-load 'zig-mode
  (define-key zig-mode-map (kbd "C-c r f") #'mcg-zig-format-buffer))
#+END_SRC

** Build System
#+BEGIN_SRC emacs-lisp
;;; 构建系统集成

(defun mcg-zig-build ()
  "运行zig build"
  (interactive)
  (if (executable-find "zig")
      (let ((compilation-scroll-output t)
            (default-directory (or (locate-dominating-file default-directory "build.zig")
                                   default-directory)))
        (compile "zig build"))
    (message "Zig compiler not found")))

(defun mcg-zig-build-run ()
  "构建并运行"
  (interactive)
  (if (executable-find "zig")
      (let ((compilation-scroll-output t)
            (default-directory (or (locate-dominating-file default-directory "build.zig")
                                   default-directory)))
        (compile "zig build run"))
    (message "Zig compiler not found")))

(defun mcg-zig-run-file ()
  "直接运行当前Zig文件"
  (interactive)
  (if (executable-find "zig")
      (let ((compilation-scroll-output t))
        (compile (format "zig run %s" (buffer-file-name))))
    (message "Zig compiler not found")))

;; 快捷键
(with-eval-after-load 'zig-mode
  (define-key zig-mode-map (kbd "C-c C-c") #'mcg-zig-build)
  (define-key zig-mode-map (kbd "C-c C-r") #'mcg-zig-build-run)
  (define-key zig-mode-map (kbd "C-c r") #'mcg-zig-run-file))
#+END_SRC

** Testing Support
#+BEGIN_SRC emacs-lisp
;;; 测试支持

(defun mcg-zig-test ()
  "运行zig test"
  (interactive)
  (if (executable-find "zig")
      (let ((compilation-scroll-output t)
            (default-directory (or (locate-dominating-file default-directory "build.zig")
                                   default-directory)))
        (compile "zig build test"))
    (message "Zig compiler not found")))

(defun mcg-zig-test-file ()
  "测试当前文件"
  (interactive)
  (if (executable-find "zig")
      (let ((compilation-scroll-output t))
        (compile (format "zig test %s" (buffer-file-name))))
    (message "Zig compiler not found")))

;; 快捷键
(with-eval-after-load 'zig-mode
  (define-key zig-mode-map (kbd "C-c t") #'mcg-zig-test)
  (define-key zig-mode-map (kbd "C-c T") #'mcg-zig-test-file))
#+END_SRC

** Documentation
#+BEGIN_SRC emacs-lisp
;;; 文档支持

(defun mcg-zig-doc ()
  "生成并查看文档"
  (interactive)
  (when (executable-find "zig")
    (let ((default-directory (or (locate-dominating-file default-directory "build.zig")
                                 default-directory)))
      (compile "zig build docs"))))

;; 快捷键
(with-eval-after-load 'zig-mode
  (define-key zig-mode-map (kbd "C-c d") #'mcg-zig-doc))
#+END_SRC

** Project Detection
#+BEGIN_SRC emacs-lisp
;;; 项目检测

(defun mcg-zig-project-p ()
  "检测是否为Zig项目"
  (when-let ((project-root (project-root (project-current))))
    (file-exists-p (expand-file-name "build.zig" project-root))))
#+END_SRC

** Code Navigation
#+BEGIN_SRC emacs-lisp
;;; 代码导航辅助

(defun mcg-zig-find-main ()
  "跳转到main函数"
  (interactive)
  (goto-char (point-min))
  (re-search-forward "pub fn main" nil t))

;; 快捷键
(with-eval-after-load 'zig-mode
  (define-key zig-mode-map (kbd "C-c m") #'mcg-zig-find-main))
#+END_SRC

** Snippets
#+BEGIN_SRC emacs-lisp
;;; 代码片段

(defun mcg-zig-insert-main ()
  "插入main函数模板"
  (interactive)
  (insert "const std = @import(\"std\");\n\n")
  (insert "pub fn main() !void {\n")
  (insert "    const stdout = std.io.getStdOut().writer();\n")
  (insert "    try stdout.print(\"Hello, World!\\n\", .{});\n")
  (insert "}\n"))

(defun mcg-zig-insert-test ()
  "插入测试模板"
  (interactive)
  (let ((test-name (read-string "Test name: ")))
    (insert (format "test \"%s\" {\n" test-name))
    (insert "    const testing = @import(\"std\").testing;\n")
    (insert "    \n")
    (insert "}\n")))

;; 快捷键
(with-eval-after-load 'zig-mode
  (define-key zig-mode-map (kbd "C-c C-m") #'mcg-zig-insert-main)
  (define-key zig-mode-map (kbd "C-c C-t") #'mcg-zig-insert-test))
#+END_SRC

** Keybindings Summary
#+BEGIN_SRC emacs-lisp
;;; 快捷键总结

;; C-c r f   - 格式化代码 (zig fmt)
;; C-c C-c   - 构建项目 (zig build)
;; C-c C-r   - 构建并运行 (zig build run)
;; C-c r     - 运行当前文件
;; C-c t     - 运行所有测试
;; C-c T     - 测试当前文件
;; C-c d     - 生成文档
;; C-c m     - 跳转到main函数
;; C-c C-m   - 插入main函数模板
;; C-c C-t   - 插入测试模板
#+END_SRC

** Setup Instructions
#+BEGIN_SRC emacs-lisp
;;; 安装说明

;; 1. 安装Zig编译器:
;;    - 访问: https://ziglang.org/download/
;;    - 或使用包管理器:
;;      # Windows (Chocolatey)
;;      choco install zig
;;      # macOS (Homebrew)
;;      brew install zig
;;      # Linux
;;      # 下载二进制文件并添加到PATH
;;
;; 2. 安装ZLS (Zig Language Server):
;;    - 从 https://github.com/zigtools/zls/releases 下载
;;    - 或使用包管理器安装
;;    - 确保zls在PATH中
;;
;; 3. 安装zig-mode:
;;    - 已通过submodule管理
;;    - mcg-load-extension 会自动加载
;;
;; 验证安装:
;;    zig version    # 应显示Zig版本
;;    zls --version  # 应显示ZLS版本
#+END_SRC

** Ends
#+BEGIN_SRC emacs-lisp
(provide 'lang-zig)
;;; lang-zig.el ends here
#+END_SRC
