* init-lsp-bridge.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "init-lsp-bridge.el") :lexical t
:END:

** Headers

#+BEGIN_SRC emacs-lisp
  ;;; init-lsp-bridge.el -- Config for Lsp Bridge -*- lexical-binding: t; -*-

  ;; Filename: init-lsp-bridge.el
  ;; Description: Config for Lsp Bridge
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024, mcge, all rights reserved.
  ;; Create   Date: 2025-01-04 15:00:00
  ;; Version: 0.1
  ;; Modified   By: <2025-01-09 Thu 18:09>
  ;; Keywords:
  ;; Compatibility: GNU Emacs 31.0.50

  ;;; Commentary:
  ;;
  ;; Config for Lsp Bridge
  ;;

  ;;; Installation:
  ;;
  ;; Put init-lsp-bridge.el to your load-path.
  ;; The load-path is usually ~/elisp/.
  ;; It's set in your ~/.emacs like this:
  ;; (add-to-list 'load-path (expand-file-name "~/elisp"))
  ;;
  ;; And the following to your ~/.emacs startup file.
  ;;
  ;; (require 'init-lsp-bridge)
  ;;
  ;; No need more.

  ;;; Customize:
  ;;
  ;;
  ;;
  ;; All of the above can customize by:
  ;;      M-x customize-group RET init-aider RET
  ;;

  ;;; Change log:
  ;;

#+END_SRC


** Require
#+BEGIN_SRC emacs-lisp
  (require 'lazy-load)
  (require 'lsp-bridge)
  (require 'lsp-bridge-jdtls)
  
  ;; Language-specific configurations
  (require 'lang-cpp)
  (require 'lang-rust)
  (require 'lang-web-mode)  ;; Required for Vue files
  (require 'lang-typescript)  ;; Required for .ts/.tsx files
  ;; Uncomment if you need these languages:
  ;;(require 'lang-java)
  ;;(require 'lang-css-mode)
  ;;(require 'lang-clojure)
  ;;(require 'lang-lua)

  ;; Terminal support for non-graphic displays
  (unless (display-graphic-p)
    (require 'acm-terminal))

#+END_SRC

** Config bridge

#+BEGIN_SRC emacs-lisp
  ;;; Code:
  ;; custom language server dir
  (setq lsp-bridge-user-langserver-dir mcgemacs-custom-lsp-bridge-langserver-dir)
  (setq lsp-bridge-user-multiserver-dir mcgemacs-custom-lsp-bridge-multiserver-dir)

  ;; ===== Core Features =====
  ;; Enable completion in minibuffer for better UX
  (setq lsp-bridge-enable-completion-in-minibuffer t)
  ;; Use frame to show signature (better visibility than minibuffer)
  (setq lsp-bridge-signature-show-function 'lsp-bridge-signature-show-with-frame)
  ;; Signature frame position (options: "top-left", "top-right", "bottom-left", "bottom-right", "point")
  (setq lsp-bridge-signature-show-with-frame-position "bottom-right")
  ;; Enable tramp support for remote files
  (setq lsp-bridge-enable-with-tramp t)
  ;; Enable org-babel LSP completion
  (setq lsp-bridge-enable-org-babel t)
  ;; Enable inlay hints (useful for strongly typed languages like Rust/TypeScript)
  ;; 性能优化：inlay hints 可能影响性能，大文件时考虑禁用
  (setq lsp-bridge-enable-inlay-hint nil)  ; 禁用以提升性能，需要时再启用
  ;; Enable semantic tokens for better syntax highlighting
  ;; 性能优化：语义token会增加渲染负担
  (setq lsp-bridge-semantic-tokens nil)  ; 禁用以提升性能
  ;; Disable auto format on save (to avoid async formatting issues with auto-save)
  ;; Format only on manual save via keybinding
  (setq lsp-bridge-enable-auto-format-code nil)
  ;; Diagnostic delay (in seconds, default 0.5) - 性能优化：增加延迟减少频繁刷新
  (setq lsp-bridge-diagnostic-fetch-idle 0.5)  ; 从 0.3 增加到 0.5，减少卡顿
  ;; Hover diagnostic - show diagnostic tooltip when cursor hovers over error
  (setq lsp-bridge-enable-hover-diagnostic t)
  ;; Find definition in open windows when possible (better multi-window workflow)
  (setq lsp-bridge-find-def-select-in-open-windows t)
  ;; Enable search words indexing for better completion
  (setq lsp-bridge-enable-search-words t)
  ;; Debug mode: enable for troubleshooting
  ;; (setq lsp-bridge-enable-log t)
  ;; (setq lsp-bridge-enable-debug t)
  
  ;; ===== Enhanced Features (lazycat style) =====
  ;; Code action lightbulb in fringe
  (setq lsp-bridge-enable-diagnostics t)
  (setq lsp-bridge-code-action-enable-popup-tip t)
  ;; Signature help delay - 性能优化：增加延迟减少频繁请求
  (setq lsp-bridge-signature-help-fetch-idle 0.8)  ; 从 0.5 增加到 0.8
  ;; Completion trigger characters (customize per language if needed)
  (setq lsp-bridge-completion-popup-predicates
        '(lsp-bridge-not-only-blank-before-cursor
          lsp-bridge-not-match-hide-characters
          lsp-bridge-not-match-stop-commands
          lsp-bridge-not-complete-manually))
  ;; Enable rename file feature
  (setq lsp-bridge-enable-rename-file t)

  ;; ===== ACM (Auto Complete Menu) Configuration =====
  ;; Enable capf backend for non-LSP completion
  (setq acm-enable-capf t)
  ;; Enable quick access for faster navigation (use numbers to select candidates)
  (setq acm-enable-quick-access t)
  ;; Match yasnippet by trigger keyword
  (setq acm-backend-yas-match-by-trigger-keyword t)
  ;; Disable TabNine (high CPU usage, only enable if needed)
  (setq acm-enable-tabnine nil)
  ;; 性能优化：使用更快的匹配函数
  ;; orderless-flex 灵活但较慢，改为 regexp-quote 提升性能
  (setq acm-candidate-match-function 'regexp-quote)  ; 更快的匹配
  ;; Disable Codeium (enable if needed)
  (setq acm-enable-codeium nil)
  ;; 性能优化：禁用 workspace symbol 搜索（较消耗资源）
  (setq acm-enable-lsp-workspace-symbol nil)  ; 需要时可改为 t
  ;; 性能优化：延迟显示文档以减少卡顿
  (setq acm-enable-doc nil)  ; 禁用自动文档，需要时用 C-M-. 手动查看
  ;; Doc frame position
  (setq acm-doc-frame-pos 'bottom-right)
  ;; Enable icons in completion menu (set to nil if icons not displaying correctly)
  (setq acm-enable-icon t)
  ;; Async markdown rendering for doc (better performance than sync)
  (setq acm-enable-doc-markdown-render 'async)
  
  ;; ===== ACM Advanced Settings (lazycat style) =====
  ;; 性能优化：减少候选项长度限制
  (setq acm-candidate-match-max-length 50)  ; 从 60 减少到 50
  ;; 性能优化：禁用预览功能，这是导致卡顿的主要原因之一
  (setq acm-enable-preview nil)  ; 禁用预览以提升流畅度
  ;; 性能优化：限制显示的候选项数量
  (setq acm-menu-length 8)  ; 默认10，减少到8提升性能
  
  ;; ===== Completion Trigger Configuration =====
  ;; 补全触发字符数配置
  ;; 0 = 立即触发（可能太频繁）
  ;; 1 = 输入 1 个字符后触发（推荐）
  ;; 2 = 输入 2 个字符后触发（默认）
  
  ;; LSP 补全（主要补全源，最激进）
  (setq acm-backend-lsp-candidate-min-length 1)  ; 输入 1 个字符后触发，避免无输入时弹出补全
  
  ;; Elisp 补全（Emacs Lisp 代码）
  (setq acm-backend-elisp-candidate-min-length 1)  ; 1 字符触发，平衡性能和体验
  
  ;; YaSnippet 补全（代码片段）
  (setq acm-backend-yas-candidate-min-length 1)  ; 1 字符触发，快速访问代码片段
  
  ;; Search File Words 补全（当前文件词汇）
  (setq acm-backend-search-file-words-candidate-min-length 2)  ; 2 字符，避免干扰
  
  ;; Enable path completion
  (setq acm-enable-path t)
  ;; 性能优化：大文件时禁用文件词搜索
  (setq acm-enable-search-file-words nil)  ; 禁用以提升性能，特别是大文件
  ;; English helper for Chinese users (set nil if not needed)
  (setq acm-enable-english-helper nil)
  ;; Frame max width
  (setq acm-frame-max-width 100)

  ;; ===== Disable ESLint, use Biome instead =====
  ;; Biome is faster and supports Vue, TS, JS, TSX, JSX, JSON
  ;; ESLint is disabled by creating an empty config in langservers/vscode-eslint-language-server.json
  
  ;; Use Biome for formatting and linting
  ;; Install: npm install -g @biomejs/biome
  ;; or: bun add -g @biomejs/biome
  
  ;; Explicitly disable ESLint language server for JS/TS files
  (with-eval-after-load 'lsp-bridge
    (setq lsp-bridge-disable-langserver-by-project
          (lambda (project-path filepath)
            (let ((filename (file-name-nondirectory filepath)))
              (when (string-match-p "\\.\\(ts\\|tsx\\|js\\|jsx\\|vue\\)$" filename)
                '("vscode-eslint-language-server")))))
  
  ;; Use Biome with TypeScript/JavaScript (multi-server configuration)
  ;; Enable Biome alongside TypeScript Language Server:
  (with-eval-after-load 'lsp-bridge
    (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("ts") . "typescript-biome"))
    (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("tsx") . "typescript-biome"))
    (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("js") . "typescript-biome"))
    (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("jsx") . "typescript-biome"))
    ;; Vue with full stack: Volar + TypeScript + Biome + Emmet + TailwindCSS + CSS
    ;; 选择跳转方式：
    ;; - "vue-full" = TypeScript 跳转（准确但需要按两次 M-.）
    ;; - "vue-full-volar" = Volar 跳转（可能直接跳转）
    (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("vue") . "vue-full-volar"))))
  
  ;; Enable global lsp-bridge mode
  (global-lsp-bridge-mode)

  ;; ===== Multi-Language Server Configuration =====
  ;; Configure TailwindCSS support for files with HTML/JSX templates
  ;; Note: Requires @tailwindcss/language-server to be installed
  ;; Install: npm install -g @tailwindcss/language-server
  
  ;; TailwindCSS is ONLY needed for files with HTML/JSX templates:
  ;; - .tsx (TypeScript + JSX)
  ;; - .jsx (JavaScript + JSX) 
  ;; - .vue (Vue components)
  ;; - .svelte (Svelte components)
  ;; - .html (HTML files)
  ;; 
  ;; Pure .ts/.js files DON'T need TailwindCSS support
  
  ;; Uncomment if you use TailwindCSS:
  
  ;; HTML + TailwindCSS
  ;; (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("html") . "html_tailwindcss"))
  
  ;; CSS + TailwindCSS
  ;; (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("css") . "css_tailwindcss"))
  
  ;; JSX/TSX with TailwindCSS (React/JSX only, not plain JS/TS)
  ;; (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("jsx") . "javascript_tailwindcss"))
  ;; (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("tsx") . "typescript_tailwindcss"))
  
  ;; Vue + TailwindCSS
  ;; (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("vue") . "vue_tailwindcss"))
  
  ;; Svelte + TailwindCSS
  ;; (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("svelte") . "svelte_tailwindcss"))

  ;; Custom function to select language server based on project context
  ;; Example: Detect Deno projects by checking for deno.land imports
  (setq lsp-bridge-get-multi-lang-server-by-project
        (lambda (project-path filepath)
          (save-excursion
            (when (string-equal (file-name-extension filepath) "ts")
              (dolist (buf (buffer-list))
                (when (string-equal (buffer-file-name buf) filepath)
                  (with-current-buffer buf
                    (goto-char (point-min))
                    ;; Search forward from beginning of buffer
                    (when (search-forward-regexp "from \"https://deno\\.land" nil t)
                      (return "deno")))))))))
#+END_SRC

** Keymap
#+BEGIN_SRC emacs-lisp
  ;; Define keybindings for lsp-bridge
  (lazy-load-set-keys
   '(
     ;; Diagnostic commands
     ("C-c C-u d l" . lsp-bridge-diagnostic-list)        ;; List diagnostics
     ;; Note: lsp-bridge-workspace-diagnostic-list is not widely supported
     )
   lsp-bridge-mode-map)

  ;; Fix ACM completion keybindings
  ;; Ensure Return key works in completion menu
  (with-eval-after-load 'acm
    (define-key acm-mode-map (kbd "RET") #'acm-complete)
    (define-key acm-mode-map (kbd "<return>") #'acm-complete)
    (define-key acm-mode-map (kbd "C-m") #'acm-complete)
    ;; Alternative: use TAB if Return still doesn't work
    (define-key acm-mode-map (kbd "TAB") #'acm-complete)
    (define-key acm-mode-map (kbd "<tab>") #'acm-complete))
#+END_SRC

** flymake bridge
#+BEGIN_SRC emacs-lisp :tangle no
;; flymake-bridge
(add-hook 'lsp-bridge-mode-hook #'flymake-bridge-setup)

#+END_SRC

** Save and Format
#+BEGIN_SRC emacs-lisp
  ;; Note: Formatting is now handled by idle-auto-save uniformly
  ;; Both manual save (C-x C-s) and auto-save will format if idle-auto-save-format-before-save is t
  ;; No need for custom save function, using default save-buffer is fine
#+END_SRC

** After Save Hook
#+BEGIN_SRC emacs-lisp
  ;; Auto-update "Last Modified" timestamp in file headers when saving
  ;; 在编程模式下启用保存文件时自动更新 `Last Modified` 时间的功能
  (add-hook 'prog-mode-hook
            (lambda ()
              (add-hook 'before-save-hook 'mcge/update-file-headers nil t)))
#+END_SRC


** Rust with eglot

#+BEGIN_SRC emacs-lisp :tangle no
;; rust 使用 eglot
(defun enable-lsp-bridge-if-not-rust ()
  "Enable lsp-bridge-mode if the current major mode is not rust-ts-mode or rust-mode."
  (unless (or (derived-mode-p 'rust-mode)
              (derived-mode-p 'rust-ts-mode))
    (lsp-bridge-mode 1)))  ;; 启用 lsp-bridge-mode

;; 将该函数添加到 after-change-major-mode-hook
(add-hook 'after-change-major-mode-hook 'enable-lsp-bridge-if-not-rust)


#+END_SRC

** End
#+BEGIN_SRC emacs-lisp
(provide 'init-lsp-bridge)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-lsp-bridge.el ends here
#+END_SRC
