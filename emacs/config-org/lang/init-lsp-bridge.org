* init-lsp-bridge.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "init-lsp-bridge.el") :lexical t
:END:

** Headers

#+BEGIN_SRC emacs-lisp
  ;;; init-lsp-bridge.el -- Config for Lsp Bridge -*- lexical-binding: t; -*-

  ;; Filename: init-lsp-bridge.el
  ;; Description: Config for Lsp Bridge
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024, mcge, all rights reserved.
  ;; Create   Date: 2025-01-04 15:00:00
  ;; Version: 0.1
  ;; Modified   By: <2025-01-09 Thu 18:09>
  ;; Keywords:
  ;; Compatibility: GNU Emacs 31.0.50

  ;;; Commentary:
  ;;
  ;; Config for Lsp Bridge
  ;;

  ;;; Installation:
  ;;
  ;; Put init-lsp-bridge.el to your load-path.
  ;; The load-path is usually ~/elisp/.
  ;; It's set in your ~/.emacs like this:
  ;; (add-to-list 'load-path (expand-file-name "~/elisp"))
  ;;
  ;; And the following to your ~/.emacs startup file.
  ;;
  ;; (require 'init-lsp-bridge)
  ;;
  ;; No need more.

  ;;; Customize:
  ;;
  ;;
  ;;
  ;; All of the above can customize by:
  ;;      M-x customize-group RET init-aider RET
  ;;

  ;;; Change log:
  ;;

#+END_SRC


** Require
#+BEGIN_SRC emacs-lisp
  (require 'lazy-load)
  (require 'lsp-bridge)
  (require 'lsp-bridge-jdtls)
  
  ;; Language-specific configurations
  (require 'lang-cpp)
  (require 'lang-rust)
  ;; Uncomment if you need these languages:
  ;;(require 'lang-java)
  ;;(require 'lang-typescript)
  ;;(require 'lang-css-mode)
  ;;(require 'lang-web-mode)
  ;;(require 'lang-clojure)
  ;;(require 'lang-lua)

  ;; Terminal support for non-graphic displays
  (unless (display-graphic-p)
    (require 'acm-terminal))

#+END_SRC

** Config bridge

#+BEGIN_SRC emacs-lisp
  ;;; Code:
  ;; custom language server dir
  (setq lsp-bridge-user-langserver-dir mcgemacs-custom-lsp-bridge-langserver-dir)
  (setq lsp-bridge-user-multiserver-dir mcgemacs-custom-lsp-bridge-multiserver-dir)

  ;; ===== Core Features =====
  ;; Enable completion in minibuffer for better UX
  (setq lsp-bridge-enable-completion-in-minibuffer t)
  ;; Use frame to show signature (better visibility than minibuffer)
  (setq lsp-bridge-signature-show-function 'lsp-bridge-signature-show-with-frame)
  ;; Signature frame position (options: "top-left", "top-right", "bottom-left", "bottom-right", "point")
  (setq lsp-bridge-signature-show-with-frame-position "bottom-right")
  ;; Enable tramp support for remote files
  (setq lsp-bridge-enable-with-tramp t)
  ;; Enable org-babel LSP completion
  (setq lsp-bridge-enable-org-babel t)
  ;; Enable inlay hints (useful for strongly typed languages like Rust)
  (setq lsp-bridge-enable-inlay-hint t)
  ;; Enable semantic tokens for better syntax highlighting
  (setq lsp-bridge-semantic-tokens t)
  (setq-default lsp-bridge-semantic-tokens-ignore-modifier-limit-types ["variable"])
  ;; Disable auto format on save (to avoid async formatting issues with auto-save)
  ;; Format only on manual save via keybinding
  (setq lsp-bridge-enable-auto-format-code nil)
  ;; Diagnostic delay (in seconds, default 0.5) - optimize for responsiveness
  (setq lsp-bridge-diagnostic-fetch-idle 0.3)
  ;; Hover diagnostic - show diagnostic tooltip when cursor hovers over error
  (setq lsp-bridge-enable-hover-diagnostic t)
  ;; Find definition in open windows when possible (better multi-window workflow)
  (setq lsp-bridge-find-def-select-in-open-windows t)
  ;; Enable search words indexing for better completion
  (setq lsp-bridge-enable-search-words t)
  ;; Performance: ensure log level is not debug (avoid performance issues)
  (setq lsp-bridge-log-level 'default)
  (setq lsp-bridge-enable-debug nil)

  ;; ===== ACM (Auto Complete Menu) Configuration =====
  ;; Enable capf backend for non-LSP completion
  (setq acm-enable-capf t)
  ;; Enable quick access for faster navigation
  (setq acm-enable-quick-access t)
  ;; Match yasnippet by trigger keyword
  (setq acm-backend-yas-match-by-trigger-keyword t)
  ;; Disable TabNine (high CPU usage, only enable if needed)
  (setq acm-enable-tabnine nil)
  ;; Use orderless-flex for flexible candidate matching
  (setq acm-candidate-match-function 'orderless-flex)
  ;; Disable Codeium (enable if needed)
  (setq acm-enable-codeium nil)
  ;; Enable LSP workspace symbol for symbol search
  (setq acm-enable-lsp-workspace-symbol t)
  ;; Enable doc display in completion menu
  (setq acm-enable-doc t)
  ;; Enable icons in completion menu (set to nil if icons not displaying correctly)
  (setq acm-enable-icon t)
  ;; Async markdown rendering for doc (better performance than sync)
  (setq acm-enable-doc-markdown-render 'async)

  ;; Enable global lsp-bridge mode
  (global-lsp-bridge-mode)

  ;; ===== Multi-Language Server Configuration =====
  ;; Configure TailwindCSS support for multiple file types
  ;; HTML + TailwindCSS
  (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("html") . "html_tailwindcss"))
  
  ;; CSS + TailwindCSS
  (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("css") . "css_tailwindcss"))
  
  ;; JavaScript/TypeScript with TailwindCSS (for JSX/TSX)
  (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("js" "jsx") . "javascript_tailwindcss"))
  (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("ts" "tsx") . "typescript_tailwindcss"))
  
  ;; Vue + TailwindCSS
  (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("vue") . "vue_tailwindcss"))
  
  ;; Svelte + TailwindCSS
  (add-to-list 'lsp-bridge-multi-lang-server-extension-list '(("svelte") . "svelte_tailwindcss"))

  ;; Custom function to select language server based on project context
  ;; Example: Detect Deno projects by checking for deno.land imports
  (setq lsp-bridge-get-multi-lang-server-by-project
        (lambda (project-path filepath)
          (save-excursion
            (when (string-equal (file-name-extension filepath) "ts")
              (dolist (buf (buffer-list))
                (when (string-equal (buffer-file-name buf) filepath)
                  (with-current-buffer buf
                    (goto-char (point-min))
                    ;; Search forward from beginning of buffer
                    (when (search-forward-regexp "from \"https://deno\\.land" nil t)
                      (return "deno")))))))))
#+END_SRC

** Keymap
#+BEGIN_SRC emacs-lisp
  ;; Define keybindings for lsp-bridge
  (lazy-load-set-keys
   '(
     ;; Diagnostic commands
     ("C-c C-u d l" . lsp-bridge-diagnostic-list)        ;; List diagnostics
     ;; Note: lsp-bridge-workspace-diagnostic-list is not widely supported
     )
   lsp-bridge-mode-map)
#+END_SRC

** flymake bridge
#+BEGIN_SRC emacs-lisp :tangle no
;; flymake-bridge
(add-hook 'lsp-bridge-mode-hook #'flymake-bridge-setup)

#+END_SRC

** Save and Format
#+BEGIN_SRC emacs-lisp
  ;; Note: Formatting is now handled by idle-auto-save uniformly
  ;; Both manual save (C-x C-s) and auto-save will format if idle-auto-save-format-before-save is t
  ;; No need for custom save function, using default save-buffer is fine
#+END_SRC

** After Save Hook
#+BEGIN_SRC emacs-lisp
  ;; Auto-update "Last Modified" timestamp in file headers when saving
  ;; 在编程模式下启用保存文件时自动更新 `Last Modified` 时间的功能
  (add-hook 'prog-mode-hook
            (lambda ()
              (add-hook 'before-save-hook 'mcge/update-file-headers nil t)))
#+END_SRC


** Rust with eglot

#+BEGIN_SRC emacs-lisp :tangle no
;; rust 使用 eglot
(defun enable-lsp-bridge-if-not-rust ()
  "Enable lsp-bridge-mode if the current major mode is not rust-ts-mode or rust-mode."
  (unless (or (derived-mode-p 'rust-mode)
              (derived-mode-p 'rust-ts-mode))
    (lsp-bridge-mode 1)))  ;; 启用 lsp-bridge-mode

;; 将该函数添加到 after-change-major-mode-hook
(add-hook 'after-change-major-mode-hook 'enable-lsp-bridge-if-not-rust)


#+END_SRC

** End
#+BEGIN_SRC emacs-lisp
(provide 'init-lsp-bridge)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-lsp-bridge.el ends here
#+END_SRC
