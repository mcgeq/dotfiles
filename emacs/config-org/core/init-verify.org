* init-verify.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "init-verify.el") :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; init-verify.el -- Configuration Verification -*- lexical-binding: t; -*-

  ;; Filename: init-verify.el
  ;; Description: 验证配置完整性和正确性
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024, mcge, all rights reserved.
  ;; Create   Date: 2025-01-04 15:00:00
  ;; Version: 2.0
  ;; Modified   By: mcge <mcgeq@outlook.com>
  ;; Last Modified: <2025-02-16 Sun 12:00>
  ;; Keywords: verification, validation, diagnostics
  ;; Compatibility: GNU Emacs 31.0.50

  ;;; Commentary:
  ;;
  ;; 配置验证和错误诊断系统
  ;;

#+END_SRC


** Verification Variables
#+BEGIN_SRC emacs-lisp
;;; 验证变量

(defvar mcg-verification-errors '() "验证错误列表")
(defvar mcg-verification-warnings '() "验证警告列表")
(defvar mcg-verification-enabled t "是否启用配置验证")
#+END_SRC

** Verification Functions
#+BEGIN_SRC emacs-lisp
;;; 验证函数

(defun mcg-verify-directories ()
  "验证必需的目录是否存在"
  (let ((required-dirs
         '((mcgemacs-root-dir . "Emacs根目录")
           (mcgemacs-config-dir . "配置目录")
           (mcgemacs-extension-dir . "扩展目录"))))
    (dolist (dir-pair required-dirs)
      (let ((dir-value (symbol-value (car dir-pair)))
            (dir-name (cdr dir-pair)))
        (unless (file-directory-p dir-value)
          (add-to-list 'mcg-verification-errors
                       (format "%s不存在: %s" dir-name dir-value)))))))

(defun mcg-verify-core-modules ()
  "验证核心模块是否加载成功"
  (let ((required-modules
         '(init-paths init-font init-function init-builtin)))
    (dolist (module required-modules)
      (unless (featurep module)
        (add-to-list 'mcg-verification-errors
                     (format "核心模块加载失败: %s" module))))))

(defun mcg-verify-submodules ()
  "验证关键Git Submodules是否存在"
  (when (featurep 'init-loadpath)
    (let ((critical-submodules
           '("lazy-load" "doom-modeline" "ef-themes" "vertico" "marginalia")))
      (dolist (submodule critical-submodules)
        (let ((submodule-path (expand-file-name
                               submodule
                               (expand-file-name "site-lisp/extensions"
                                                 mcgemacs-root-dir))))
          (unless (file-directory-p submodule-path)
            (add-to-list 'mcg-verification-warnings
                         (format "子模块不存在: %s (路径: %s)" submodule submodule-path))))))))

(defun mcg-verify-configuration ()
  "执行完整配置验证"
  (when mcg-verification-enabled
    (setq mcg-verification-errors '())
    (setq mcg-verification-warnings '())

    (message "Verifying Emacs configuration...")
    (mcg-verify-directories)
    (mcg-verify-core-modules)
    (mcg-verify-submodules)

    ;; 报告结果
    (cond
     (mcg-verification-errors
      (message "Configuration errors found:")
      (dolist (err mcg-verification-errors)
        (message "  ERROR: %s" err))
      (error "Configuration verification failed"))
     (mcg-verification-warnings
      (message "Configuration warnings:")
      (dolist (warn mcg-verification-warnings)
        (message "  WARNING: %s" warn))
      (message "Configuration verification completed with warnings"))
     (t
      (message "Configuration verification passed")))))
#+END_SRC

** Extension Validation System
#+BEGIN_SRC emacs-lisp
;;; ============================================================
;;; 扩展验证系统 (Extension Validation System)
;;; ============================================================

;;; 验证结果数据结构

(defvar mcg-validation-results nil
  "验证结果列表

每个条目格式: (:level LEVEL :category CATEGORY :message MSG :target TARGET :suggestion SUGGESTION)")

(defun mcg-make-validation-item (level category message &optional target suggestion)
  "创建验证结果项

参数:
- LEVEL: 级别符号 ('error 'warning 'info)
- CATEGORY: 验证类别符号
- MESSAGE: 消息字符串
- TARGET: 相关目标（可选）
- SUGGESTION: 修复建议（可选）

返回 plist"
  (list :level level
        :category category
        :message message
        :target target
        :suggestion suggestion))

(defun mcg-add-validation-result (level category message &optional target suggestion)
  "添加验证结果到结果列表"
  (push (mcg-make-validation-item level category message target suggestion)
        mcg-validation-results))

;;; 扩展存在验证

(defun mcg-validate-extensions ()
  "验证所有注册扩展的目录是否存在

检查 mcg-extension-registry-v2 中的每个扩展:
1. 目录是否存在
2. 目录中是否包含 .el 文件

返回验证结果 plist:
(:success BOOL :errors LIST :warnings LIST :info LIST)"
  (interactive)
  (let ((errors '())
        (warnings '())
        (info '())
        (extensions-root (expand-file-name "site-lisp/extensions" mcgemacs-root-dir)))
    
    (dolist (entry mcg-extension-registry-v2)
      (let* ((name (car entry))
             (props (cdr entry))
             (required (plist-get props :required))
             (extension-path (expand-file-name name extensions-root)))
        
        ;; 检查目录是否存在
        (if (not (file-directory-p extension-path))
            ;; 目录不存在
            (if required
                (push (mcg-make-validation-item
                       'error
                       'extension-missing
                       (format "必需扩展目录不存在: %s" name)
                       extension-path
                       (format "运行 'git submodule update --init %s' 初始化子模块" name))
                      errors)
              (push (mcg-make-validation-item
                     'warning
                     'extension-missing
                     (format "可选扩展目录不存在: %s" name)
                     extension-path
                     (format "运行 'git submodule update --init %s' 初始化子模块" name))
                    warnings))
          
          ;; 目录存在，检查是否包含 .el 文件
          (let ((el-files (directory-files extension-path nil "\\.el$")))
            (if (null el-files)
                (push (mcg-make-validation-item
                       'warning
                       'extension-empty
                       (format "扩展目录不包含 .el 文件: %s" name)
                       extension-path
                       "检查子模块是否正确初始化")
                      warnings)
              ;; 扩展有效
              (push (mcg-make-validation-item
                     'info
                     'extension-valid
                     (format "扩展有效: %s (%d 个 .el 文件)" name (length el-files))
                     extension-path
                     nil)
                    info))))))
    
    ;; 构建结果
    (let ((result (list :success (null errors)
                        :errors (nreverse errors)
                        :warnings (nreverse warnings)
                        :info (nreverse info))))
      
      ;; 交互调用时显示结果
      (when (called-interactively-p 'any)
        (mcg-display-validation-result result "扩展存在验证"))
      
      result)))

(defun mcg-validate-extension-exists (extension-name)
  "验证单个扩展是否存在

参数:
- EXTENSION-NAME: 扩展名称

返回:
- t 如果扩展目录存在且包含 .el 文件
- nil 否则"
  (let* ((extensions-root (expand-file-name "site-lisp/extensions" mcgemacs-root-dir))
         (extension-path (expand-file-name extension-name extensions-root)))
    (and (file-directory-p extension-path)
         (directory-files extension-path nil "\\.el$"))))
#+END_SRC

** Dependency Validation
#+BEGIN_SRC emacs-lisp
;;; 依赖验证

(defun mcg-validate-dependencies ()
  "验证所有扩展的依赖关系是否正确

检查:
1. 依赖的扩展是否在注册表中
2. 依赖的扩展目录是否存在
3. 是否存在循环依赖

返回验证结果 plist:
(:success BOOL :errors LIST :warnings LIST :info LIST)"
  (interactive)
  (let ((errors '())
        (warnings '())
        (info '())
        (all-names (mapcar #'car mcg-extension-registry-v2)))
    
    (dolist (entry mcg-extension-registry-v2)
      (let* ((name (car entry))
             (props (cdr entry))
             (depends (plist-get props :depends)))
        
        (when depends
          (dolist (dep depends)
            ;; 检查依赖是否在注册表中
            (if (not (member dep all-names))
                (push (mcg-make-validation-item
                       'error
                       'dependency-not-registered
                       (format "扩展 %s 的依赖 %s 未在注册表中" name dep)
                       name
                       (format "将 %s 添加到 mcg-extension-registry-v2" dep))
                      errors)
              
              ;; 检查依赖目录是否存在
              (unless (mcg-validate-extension-exists dep)
                (push (mcg-make-validation-item
                       'warning
                       'dependency-missing
                       (format "扩展 %s 的依赖 %s 目录不存在" name dep)
                       dep
                       (format "运行 'git submodule update --init' 初始化 %s" dep))
                      warnings)))))))
    
    ;; 检查循环依赖
    (let ((cycles (mcg-check-circular-dependencies)))
      (when cycles
        (dolist (cycle cycles)
          (push (mcg-make-validation-item
                 'error
                 'circular-dependency
                 (format "检测到循环依赖: %s" cycle)
                 cycle
                 "检查并修复依赖关系")
                errors))))
    
    ;; 构建结果
    (let ((result (list :success (null errors)
                        :errors (nreverse errors)
                        :warnings (nreverse warnings)
                        :info (nreverse info))))
      
      ;; 交互调用时显示结果
      (when (called-interactively-p 'any)
        (mcg-display-validation-result result "依赖关系验证"))
      
      result)))

(defun mcg-validate-dependency-order (extension-name)
  "验证扩展的依赖加载顺序

参数:
- EXTENSION-NAME: 扩展名称

返回:
- t 如果所有依赖都在 load-path 中且在扩展之前
- nil 否则"
  (let* ((deps (mcg-extension-dependencies extension-name))
         (extensions-root (expand-file-name "site-lisp/extensions" mcgemacs-root-dir))
         (ext-path (expand-file-name extension-name extensions-root))
         (ext-pos (cl-position ext-path load-path :test #'string=)))
    
    ;; 如果扩展不在 load-path 中，返回 nil
    (when ext-pos
      ;; 检查所有依赖是否在扩展之前
      (cl-every
       (lambda (dep)
         (let* ((dep-path (expand-file-name dep extensions-root))
                (dep-pos (cl-position dep-path load-path :test #'string=)))
           (and dep-pos (< dep-pos ext-pos))))
       deps))))
#+END_SRC

** Config Syntax Validation
#+BEGIN_SRC emacs-lisp
;;; 配置语法验证

(defun mcg-validate-config-syntax ()
  "验证生成的 .el 配置文件语法正确

检查 site-lisp/config 目录下的所有 .el 文件:
1. 文件是否可以被 Emacs Lisp reader 解析
2. 是否有语法错误

返回验证结果 plist:
(:success BOOL :errors LIST :warnings LIST :info LIST)"
  (interactive)
  (let ((errors '())
        (warnings '())
        (info '())
        (config-dir (expand-file-name "site-lisp/config" mcgemacs-root-dir)))
    
    ;; 递归查找所有 .el 文件
    (when (file-directory-p config-dir)
      (dolist (file (directory-files-recursively config-dir "\\.el$"))
        (condition-case err
            (with-temp-buffer
              (insert-file-contents file)
              ;; 尝试解析整个文件
              (goto-char (point-min))
              (while (not (eobp))
                (condition-case parse-err
                    (read (current-buffer))
                  (end-of-file nil)
                  (error
                   (push (mcg-make-validation-item
                          'error
                          'syntax-error
                          (format "语法错误: %s" (error-message-string parse-err))
                          file
                          "检查文件语法，确保括号匹配")
                         errors)
                   ;; 跳过这个文件的剩余部分
                   (goto-char (point-max)))))
              ;; 文件解析成功
              (push (mcg-make-validation-item
                     'info
                     'syntax-valid
                     (format "语法有效: %s" (file-relative-name file mcgemacs-root-dir))
                     file
                     nil)
                    info))
          (error
           (push (mcg-make-validation-item
                  'error
                  'file-read-error
                  (format "无法读取文件: %s" (error-message-string err))
                  file
                  "检查文件权限和编码")
                 errors)))))
    
    ;; 构建结果
    (let ((result (list :success (null errors)
                        :errors (nreverse errors)
                        :warnings (nreverse warnings)
                        :info (nreverse info))))
      
      ;; 交互调用时显示结果
      (when (called-interactively-p 'any)
        (mcg-display-validation-result result "配置语法验证"))
      
      result)))

(defun mcg-validate-elisp-syntax (code-string)
  "验证 Elisp 代码字符串的语法

参数:
- CODE-STRING: Elisp 代码字符串

返回:
- t 如果语法有效
- nil 如果有语法错误"
  (condition-case nil
      (progn
        (read code-string)
        t)
    (error nil)))
#+END_SRC

** Complete Validation
#+BEGIN_SRC emacs-lisp
;;; 完整验证命令

(defun mcg-validate-all ()
  "执行所有验证检查

整合以下验证:
1. 扩展存在验证
2. 依赖关系验证
3. 配置语法验证

返回综合验证结果 plist:
(:success BOOL :errors LIST :warnings LIST :info LIST
 :extension-result RESULT :dependency-result RESULT :syntax-result RESULT)"
  (interactive)
  (message "开始完整配置验证...")
  
  (let* ((ext-result (mcg-validate-extensions))
         (dep-result (mcg-validate-dependencies))
         (syntax-result (mcg-validate-config-syntax))
         
         ;; 合并所有结果
         (all-errors (append (plist-get ext-result :errors)
                             (plist-get dep-result :errors)
                             (plist-get syntax-result :errors)))
         (all-warnings (append (plist-get ext-result :warnings)
                               (plist-get dep-result :warnings)
                               (plist-get syntax-result :warnings)))
         (all-info (append (plist-get ext-result :info)
                           (plist-get dep-result :info)
                           (plist-get syntax-result :info)))
         
         (result (list :success (null all-errors)
                       :errors all-errors
                       :warnings all-warnings
                       :info all-info
                       :extension-result ext-result
                       :dependency-result dep-result
                       :syntax-result syntax-result)))
    
    ;; 交互调用时显示结果
    (when (called-interactively-p 'any)
      (mcg-display-validation-report result))
    
    result))

(defun mcg-display-validation-result (result title)
  "显示单项验证结果

参数:
- RESULT: 验证结果 plist
- TITLE: 标题字符串"
  (let ((buffer (get-buffer-create "*Validation Result*"))
        (errors (plist-get result :errors))
        (warnings (plist-get result :warnings))
        (info (plist-get result :info)))
    
    (with-current-buffer buffer
      (erase-buffer)
      (insert (format "%s\n" title))
      (insert (make-string (length title) ?=))
      (insert "\n\n")
      
      ;; 显示错误
      (when errors
        (insert (propertize (format "错误 (%d):\n" (length errors))
                            'face '(:foreground "red" :weight bold)))
        (dolist (item errors)
          (insert (format "  [ERROR] %s\n" (plist-get item :message)))
          (when (plist-get item :target)
            (insert (format "          目标: %s\n" (plist-get item :target))))
          (when (plist-get item :suggestion)
            (insert (format "          建议: %s\n" (plist-get item :suggestion)))))
        (insert "\n"))
      
      ;; 显示警告
      (when warnings
        (insert (propertize (format "警告 (%d):\n" (length warnings))
                            'face '(:foreground "orange" :weight bold)))
        (dolist (item warnings)
          (insert (format "  [WARN] %s\n" (plist-get item :message)))
          (when (plist-get item :suggestion)
            (insert (format "         建议: %s\n" (plist-get item :suggestion)))))
        (insert "\n"))
      
      ;; 显示统计
      (insert (format "统计: %d 错误, %d 警告, %d 有效项\n"
                      (length errors)
                      (length warnings)
                      (length info)))
      
      ;; 显示结论
      (insert "\n")
      (if (plist-get result :success)
          (insert (propertize "✓ 验证通过\n" 'face '(:foreground "green" :weight bold)))
        (insert (propertize "✗ 验证失败\n" 'face '(:foreground "red" :weight bold))))
      
      (insert "\n按 'q' 关闭此窗口")
      (goto-char (point-min)))
    
    (display-buffer buffer)))

(defun mcg-display-validation-report (result)
  "显示完整验证报告

参数:
- RESULT: 完整验证结果 plist"
  (let ((buffer (get-buffer-create "*Validation Report*"))
        (errors (plist-get result :errors))
        (warnings (plist-get result :warnings))
        (ext-result (plist-get result :extension-result))
        (dep-result (plist-get result :dependency-result))
        (syntax-result (plist-get result :syntax-result)))
    
    (with-current-buffer buffer
      (erase-buffer)
      (insert "Emacs 配置完整验证报告\n")
      (insert "========================\n\n")
      
      ;; 总体状态
      (insert (format "验证时间: %s\n" (format-time-string "%Y-%m-%d %H:%M:%S")))
      (insert (format "Emacs 版本: %s\n\n" emacs-version))
      
      ;; 各项验证状态
      (insert "验证项目状态:\n")
      (insert (format "  扩展存在验证: %s\n"
                      (if (plist-get ext-result :success) "✓ 通过" "✗ 失败")))
      (insert (format "  依赖关系验证: %s\n"
                      (if (plist-get dep-result :success) "✓ 通过" "✗ 失败")))
      (insert (format "  配置语法验证: %s\n"
                      (if (plist-get syntax-result :success) "✓ 通过" "✗ 失败")))
      (insert "\n")
      
      ;; 显示错误
      (when errors
        (insert (propertize (format "错误 (%d):\n" (length errors))
                            'face '(:foreground "red" :weight bold)))
        (dolist (item errors)
          (insert (format "  [%s] %s\n"
                          (plist-get item :category)
                          (plist-get item :message)))
          (when (plist-get item :suggestion)
            (insert (format "        建议: %s\n" (plist-get item :suggestion)))))
        (insert "\n"))
      
      ;; 显示警告
      (when warnings
        (insert (propertize (format "警告 (%d):\n" (length warnings))
                            'face '(:foreground "orange" :weight bold)))
        (dolist (item warnings)
          (insert (format "  [%s] %s\n"
                          (plist-get item :category)
                          (plist-get item :message))))
        (insert "\n"))
      
      ;; 总结
      (insert (make-string 40 ?-))
      (insert "\n")
      (if (plist-get result :success)
          (insert (propertize "✓ 所有验证通过\n" 'face '(:foreground "green" :weight bold)))
        (insert (propertize (format "✗ 验证失败: %d 个错误, %d 个警告\n"
                                    (length errors)
                                    (length warnings))
                            'face '(:foreground "red" :weight bold))))
      
      (insert "\n按 'q' 关闭此窗口")
      (goto-char (point-min)))
    
    (display-buffer buffer)))
#+END_SRC

** Safe Require
#+BEGIN_SRC emacs-lisp
;;; 安全的require

(defun mcg-safe-require (feature &optional filename noerror)
  "安全地require一个特性

  参数:
  - FEATURE: 特性名称
  - FILENAME: 文件名（可选）
  - NOERROR: 如果为t，出错时不报错

  返回:
  - 成功加载返回t，否则返回nil"
  (condition-case err
      (progn
        (require feature filename noerror)
        t)
    (error
     (if noerror
         (progn
           (message "Warning: Failed to load %s: %s"
                    feature
                    (error-message-string err))
           nil)
       (error "Failed to load required feature %s: %s"
              feature
              (error-message-string err))))))
#+END_SRC

** Configuration Metadata
#+BEGIN_SRC emacs-lisp
;;; 配置元数据

(defconst mcg-config-version "2.0.0"
  "配置版本号")

(defconst mcg-config-build-date (format-time-string "%Y-%m-%d %H:%M:%S")
  "配置编译时间")

(defvar mcg-config-loaded-modules '()
  "已加载的配置模块列表")

(defun mcg-register-loaded-module (module-name)
  "注册已加载的模块"
  (add-to-list 'mcg-config-loaded-modules module-name))

(defun mcg-show-config-info ()
  "显示配置信息"
  (interactive)
  (let ((buf (get-buffer-create "*Emacs Config Info*")))
    (with-current-buffer buf
      (erase-buffer)
      (insert (propertize "Emacs Configuration Information\n" 'face '(:weight bold :height 1.3)))
      (insert (propertize "================================\n\n" 'face '(:weight bold)))
      (insert (format "Version: %s\n" mcg-config-version))
      (insert (format "Build Date: %s\n" mcg-config-build-date))
      (insert (format "Emacs Version: %s\n" emacs-version))
      (insert (format "\n" ))
      (insert (propertize "Loaded Modules:\n" 'face '(:weight bold)))
      (insert (format "Total: %d\n\n" (length mcg-config-loaded-modules)))
      (dolist (module mcg-config-loaded-modules)
        (insert (format "  ✓ %s\n" module)))
      (setq-local buffer-read-only t)
      (goto-char (point-min))
      (display-line-numbers-mode)))
    (display-buffer buf))

(global-set-key (kbd "C-c C-i") #'mcg-show-config-info)
#+END_SRC

** Ends
#+BEGIN_SRC emacs-lisp
(provide 'init-verify)
;;; init-verify.el ends here
#+END_SRC

