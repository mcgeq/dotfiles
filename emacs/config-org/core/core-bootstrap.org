#+TITLE: Core Bootstrap Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle core-bootstrap.el :lexical t

* Core Bootstrap Module

æœ¬æ¨¡å—åˆå§‹åŒ– MCG Emacs é…ç½®ç³»ç»Ÿçš„æ ¸å¿ƒè·¯å¾„ï¼Œæä¾›ç³»ç»Ÿæ£€æµ‹ã€æ€§èƒ½ä¼˜åŒ–å’Œæ—¥å¿—åŠŸèƒ½ã€‚

** File Header

#+begin_src emacs-lisp
;;; core-bootstrap.el --- Core bootstrap for MCG Emacs -*- lexical-binding: t; -*-

;; Copyright (C) 2024 MCG
;; Author: MCG
;; Keywords: configuration, bootstrap

;;; Commentary:
;; This module initializes the core paths and provides system detection,
;; performance optimization, and logging facilities for the MCG Emacs
;; configuration system.

;;; Code:
#+end_src

** System Detection

ç³»ç»Ÿç±»åž‹æ£€æµ‹å¸¸é‡ï¼Œç”¨äºŽè·¨å¹³å°å…¼å®¹æ€§å¤„ç†ã€‚

#+begin_src emacs-lisp
(defconst mcg-is-windows (eq system-type 'windows-nt)
  "Non-nil if running on Windows.")

(defconst mcg-is-linux (eq system-type 'gnu/linux)
  "Non-nil if running on Linux.")

(defconst mcg-is-mac (eq system-type 'darwin)
  "Non-nil if running on macOS.")

(defconst mcg-is-gui (display-graphic-p)
  "Non-nil if running in GUI mode.")

(defconst mcg-emacs-29+ (>= emacs-major-version 29)
  "Non-nil if Emacs version is 29 or higher.")

(defconst mcg-emacs-30+ (>= emacs-major-version 30)
  "Non-nil if Emacs version is 30 or higher.")
#+end_src

** Path Variables

MCG Emacs é…ç½®ç³»ç»Ÿçš„è·¯å¾„å˜é‡å®šä¹‰ã€‚

#+begin_src emacs-lisp
(defvar mcg-emacs-dir nil
  "Root directory of the Emacs configuration.
This is the base directory containing site-lisp, config-org, etc.")

(defvar mcg-config-dir nil
  "Directory containing generated .el configuration files.
Located at site-lisp/config/.")

(defvar mcg-core-dir nil
  "Directory containing core modules.
Located at site-lisp/config/core/.")

(defvar mcg-modules-dir nil
  "Directory containing feature modules.
Located at site-lisp/config/modules/.")

(defvar mcg-extensions-dir nil
  "Directory containing Borg drones (Git submodules).
Located at site-lisp/extensions/.")

(defvar mcg-private-dir nil
  "Directory containing private user configuration.
Located at site-lisp/config/private/.")

(defvar mcg-cache-dir nil
  "Directory for cache files.
Located at .cache/ under mcg-emacs-dir.")

(defvar mcg-data-dir nil
  "Directory for data files.
Located at .data/ under mcg-emacs-dir.")
#+end_src

** GC Optimization Variables

åžƒåœ¾å›žæ”¶ä¼˜åŒ–ç›¸å…³å˜é‡ï¼Œç”¨äºŽæå‡å¯åŠ¨æ€§èƒ½ã€‚

#+begin_src emacs-lisp
(defvar mcg-gc-cons-threshold-default (* 16 1024 1024)
  "Default GC threshold after startup (16MB).
This is restored after Emacs finishes starting up.")

(defvar mcg-gc-cons-percentage-default 0.1
  "Default GC percentage after startup.
This is restored after Emacs finishes starting up.")

(defvar mcg-gc-cons-threshold-startup (* 256 1024 1024)
  "High GC threshold during startup (256MB).
This prevents GC during startup for faster loading.")
#+end_src

** Startup Time Tracking

å¯åŠ¨æ—¶é—´è¿½è¸ªå˜é‡ã€‚

#+begin_src emacs-lisp
(defvar mcg--startup-start-time (current-time)
  "Time when Emacs started loading.
Used to calculate total startup time.")

(defvar mcg-startup-time nil
  "Total startup time in seconds.
Set after emacs-startup-hook runs.")

(defvar mcg-load-times nil
  "Alist of (module . load-time-ms) for profiling.
Populated when `mcg-profile-mode' is enabled.")
#+end_src

** Debug and Logging

è°ƒè¯•å’Œæ—¥å¿—ç›¸å…³å˜é‡ã€‚

#+begin_src emacs-lisp
(defvar mcg-debug-mode nil
  "Non-nil enables debug logging.
When enabled, `mcg-log' messages are displayed.")

(defvar mcg-profile-mode nil
  "Non-nil enables performance profiling.
When enabled, module load times are tracked.")

(defvar mcg--log-buffer-name "*MCG Log*"
  "Name of the log buffer.")

(defvar mcg--log-messages nil
  "List of recent log messages for diagnostics.")

(defvar mcg--log-max-messages 100
  "Maximum number of log messages to keep.")
#+end_src

** Logging System

æ—¥å¿—ç³»ç»Ÿå®žçŽ°ï¼Œæä¾›ä¸åŒçº§åˆ«çš„æ—¥å¿—è®°å½•åŠŸèƒ½ã€‚

*** Internal Logging Function

#+begin_src emacs-lisp
(defun mcg--log-internal (level format-string &rest args)
  "Internal logging function.
LEVEL is the log level (info, warning, error).
FORMAT-STRING and ARGS are passed to `format'."
  (let* ((timestamp (format-time-string "%H:%M:%S"))
         (message (apply #'format format-string args))
         (full-message (format "[%s] [%s] %s" timestamp level message)))
    ;; Store in log messages list
    (push full-message mcg--log-messages)
    (when (> (length mcg--log-messages) mcg--log-max-messages)
      (setq mcg--log-messages (seq-take mcg--log-messages mcg--log-max-messages)))
    ;; Display based on level and debug mode
    (cond
     ((eq level 'error)
      (message "MCG Error: %s" message))
     ((eq level 'warning)
      (message "MCG Warning: %s" message))
     ((and mcg-debug-mode (eq level 'info))
      (message "MCG: %s" message)))))
#+end_src

*** Logging Macros

#+begin_src emacs-lisp
(defmacro mcg-log (format-string &rest args)
  "Log an info message when debug mode is enabled.
FORMAT-STRING and ARGS are passed to `format'."
  `(when mcg-debug-mode
     (mcg--log-internal 'info ,format-string ,@args)))

(defmacro mcg-log-warning (format-string &rest args)
  "Log a warning message.
FORMAT-STRING and ARGS are passed to `format'."
  `(mcg--log-internal 'warning ,format-string ,@args))

(defmacro mcg-log-error (format-string &rest args)
  "Log an error message.
FORMAT-STRING and ARGS are passed to `format'."
  `(mcg--log-internal 'error ,format-string ,@args))
#+end_src

*** Show Logs

#+begin_src emacs-lisp
(defun mcg-show-logs ()
  "Display recent log messages in a buffer."
  (interactive)
  (let ((buf (get-buffer-create mcg--log-buffer-name)))
    (with-current-buffer buf
      (erase-buffer)
      (insert "=== MCG Log Messages ===\n\n")
      (if mcg--log-messages
          (dolist (msg (reverse mcg--log-messages))
            (insert msg "\n"))
        (insert "No log messages recorded.\n")))
    (display-buffer buf)))
#+end_src

** Profiling System

æ€§èƒ½åˆ†æžç³»ç»Ÿï¼Œç”¨äºŽè¿½è¸ªæ¨¡å—åŠ è½½æ—¶é—´ã€‚

#+begin_src emacs-lisp
(defmacro mcg-profile (name &rest body)
  "Execute BODY and record its execution time under NAME.
Only records time when `mcg-profile-mode' is enabled."
  (declare (indent 1))
  `(if mcg-profile-mode
       (let ((start-time (current-time)))
         (prog1
             (progn ,@body)
           (let ((elapsed (float-time (time-subtract (current-time) start-time))))
             (push (cons ,name (* elapsed 1000)) mcg-load-times)
             (mcg-log "Loaded %s in %.2fms" ,name (* elapsed 1000)))))
     (progn ,@body)))

(defun mcg-show-load-times ()
  "Display module load times."
  (interactive)
  (if (null mcg-load-times)
      (message "No load times recorded. Enable mcg-profile-mode before startup.")
    (let ((buf (get-buffer-create "*MCG Load Times*"))
          (sorted (sort (copy-sequence mcg-load-times)
                        (lambda (a b) (> (cdr a) (cdr b)))))
          (total 0))
      (with-current-buffer buf
        (erase-buffer)
        (insert "=== MCG Module Load Times ===\n\n")
        (insert (format "%-40s %10s\n" "Module" "Time (ms)"))
        (insert (make-string 52 ?-) "\n")
        (dolist (entry sorted)
          (setq total (+ total (cdr entry)))
          (insert (format "%-40s %10.2f\n" (car entry) (cdr entry))))
        (insert (make-string 52 ?-) "\n")
        (insert (format "%-40s %10.2f\n" "TOTAL" total)))
      (display-buffer buf))))
#+end_src

** Path Initialization

è·¯å¾„åˆå§‹åŒ–å‡½æ•°ï¼Œè®¾ç½®æ‰€æœ‰ MCG è·¯å¾„å˜é‡ã€‚

#+begin_src emacs-lisp
(defun mcg-init-paths (&optional base-dir)
  "Initialize all MCG path variables.
BASE-DIR is the root directory of the Emacs configuration.
If not provided, it defaults to the parent of site-lisp/config/core/."
  (let ((base (or base-dir
                  ;; Default: go up from core-bootstrap.el location
                  (file-name-directory
                   (directory-file-name
                    (file-name-directory
                     (directory-file-name
                      (file-name-directory
                       (or load-file-name buffer-file-name
                           (expand-file-name "emacs" user-emacs-directory))))))))))
    ;; Normalize path
    (setq base (file-name-as-directory (expand-file-name base)))
    
    ;; Set all path variables
    (setq mcg-emacs-dir base)
    (setq mcg-config-dir (expand-file-name "site-lisp/config/" base))
    (setq mcg-core-dir (expand-file-name "core/" mcg-config-dir))
    (setq mcg-modules-dir (expand-file-name "modules/" mcg-config-dir))
    (setq mcg-extensions-dir (expand-file-name "site-lisp/extensions/" base))
    (setq mcg-private-dir (expand-file-name "private/" mcg-config-dir))
    (setq mcg-cache-dir (expand-file-name ".cache/" base))
    (setq mcg-data-dir (expand-file-name ".data/" base))
    
    ;; Create cache and data directories if they don't exist
    (unless (file-directory-p mcg-cache-dir)
      (make-directory mcg-cache-dir t))
    (unless (file-directory-p mcg-data-dir)
      (make-directory mcg-data-dir t))
    
    (mcg-log "Initialized paths with base: %s" base)
    base))
#+end_src

** Load Path Setup

è®¾ç½® =load-path= ä»¥åŒ…å«æ‰€æœ‰é…ç½®ç›®å½•ã€‚

#+begin_src emacs-lisp
(defun mcg-setup-load-path ()
  "Set up `load-path' for MCG configuration.
Adds core, modules, and extensions directories to load-path."
  (unless mcg-config-dir
    (mcg-init-paths))
  
  ;; Add core directory
  (when (file-directory-p mcg-core-dir)
    (add-to-list 'load-path mcg-core-dir))
  
  ;; Add modules directory and subdirectories
  (when (file-directory-p mcg-modules-dir)
    (add-to-list 'load-path mcg-modules-dir)
    (dolist (subdir (directory-files mcg-modules-dir t "^[^.]"))
      (when (file-directory-p subdir)
        (add-to-list 'load-path subdir))))
  
  ;; Add extensions directories (Borg drones)
  (when (file-directory-p mcg-extensions-dir)
    (mcg--add-extensions-to-load-path mcg-extensions-dir))
  
  ;; Add private directory
  (when (file-directory-p mcg-private-dir)
    (add-to-list 'load-path mcg-private-dir))
  
  (mcg-log "Setup load-path with %d entries" (length load-path)))

(defun mcg--add-extensions-to-load-path (dir)
  "Recursively add extension directories under DIR to `load-path'.
Only adds directories that contain .el files."
  (when (file-directory-p dir)
    (dolist (entry (directory-files dir t "^[^.]"))
      (when (file-directory-p entry)
        ;; Check if directory contains .el files
        (if (directory-files entry nil "\\.el$" t)
            (add-to-list 'load-path entry)
          ;; Otherwise, recurse into subdirectories
          (mcg--add-extensions-to-load-path entry))))))
#+end_src

** GC Optimization

åžƒåœ¾å›žæ”¶ä¼˜åŒ–ï¼Œå¯åŠ¨æ—¶ä½¿ç”¨é«˜é˜ˆå€¼ï¼Œå¯åŠ¨åŽæ¢å¤é»˜è®¤å€¼ã€‚

#+begin_src emacs-lisp
(defun mcg-setup-gc-optimization ()
  "Set up GC optimization for startup.
Sets high GC threshold during startup and restores it after."
  ;; Set high threshold during startup
  (setq gc-cons-threshold mcg-gc-cons-threshold-startup)
  (setq gc-cons-percentage 0.6)
  
  ;; Restore normal values after startup
  (add-hook 'emacs-startup-hook #'mcg-restore-gc-defaults))

(defun mcg-restore-gc-defaults ()
  "Restore GC settings to normal values after startup."
  (setq gc-cons-threshold mcg-gc-cons-threshold-default)
  (setq gc-cons-percentage mcg-gc-cons-percentage-default)
  (mcg-log "Restored GC defaults: threshold=%s, percentage=%s"
           mcg-gc-cons-threshold-default
           mcg-gc-cons-percentage-default))
#+end_src

** Startup Time Display

å¯åŠ¨æ—¶é—´æ˜¾ç¤ºåŠŸèƒ½ï¼Œä½¿ç”¨ posframe æˆ–æ¶ˆæ¯æ˜¾ç¤ºå¯åŠ¨ä¿¡æ¯ã€‚

*** Variables

#+begin_src emacs-lisp
(defvar mcg--startup-message-displayed nil
  "Non-nil if startup message has been displayed.")

(defvar mcg-startup-posframe-timeout 3
  "Seconds to display startup posframe before auto-hiding.")
#+end_src

*** Helper Functions

#+begin_src emacs-lisp
(defun mcg--all-idle-modules-loaded-p ()
  "Check if all idle modules have been loaded."
  (and (boundp 'mcg-idle-load-modules)
       (null mcg-idle-load-modules)))

(defun mcg-display-startup-time ()
  "Display startup time, loaded modules count and GC statistics.
Waits until all idle modules are loaded before displaying."
  (if (mcg--all-idle-modules-loaded-p)
      ;; All modules loaded, display now
      (mcg--do-display-startup-time)
    ;; Wait for idle modules to finish loading
    (run-with-timer 0.5 nil #'mcg-display-startup-time)))
#+end_src

*** Display Implementation

#+begin_src emacs-lisp
(defun mcg--do-display-startup-time ()
  "Actually display the startup time message using posframe."
  (unless mcg--startup-message-displayed
    (setq mcg--startup-message-displayed t)
    (setq mcg-startup-time
          (float-time (time-subtract (current-time) mcg--startup-start-time)))
    (let ((loaded-count (if (boundp 'mcg-loaded-modules)
                            (length mcg-loaded-modules)
                          0))
          (error-count (if (boundp 'mcg-module-load-errors)
                           (length mcg-module-load-errors)
                         0))
          (gc-count gcs-done))
      ;; Try posframe first, fallback to message
      (if (and (display-graphic-p)
               (require 'posframe nil t))
          (mcg--show-startup-posframe mcg-startup-time loaded-count error-count gc-count)
        ;; Fallback to message
        (if (> error-count 0)
            (message "MCG Emacs loaded in %.2fs | %d modules | %d errors | %d GCs"
                     mcg-startup-time loaded-count error-count gc-count)
          (message "MCG Emacs loaded in %.2fs | %d modules | %d GCs"
                   mcg-startup-time loaded-count gc-count))))))
#+end_src

*** Posframe Display

#+begin_src emacs-lisp
(defun mcg--show-startup-posframe (time modules errors gcs)
  "Show startup info in a posframe.
TIME is startup time, MODULES is module count, ERRORS is error count, GCS is GC count."
  (let* ((buf-name " *mcg-startup*")
         (content (mcg--format-startup-content time modules errors gcs))
         (border-color (mcg--startup-get-border-color))
         (bg-color (mcg--startup-get-background-color))
         (fg-color (mcg--startup-get-foreground-color)))
    ;; Create buffer with content
    (with-current-buffer (get-buffer-create buf-name)
      (let ((inhibit-read-only t))
        (erase-buffer)
        (insert content))
      (setq-local buffer-read-only t)
      (setq-local cursor-type nil)
      (goto-char (point-min)))
    ;; Show posframe
    (posframe-show buf-name
                   :position (point)
                   :poshandler #'posframe-poshandler-frame-bottom-right-corner
                   :internal-border-width 2
                   :internal-border-color border-color
                   :background-color bg-color
                   :foreground-color fg-color
                   :width 45
                   :height 8
                   :accept-focus nil)
    ;; Auto-hide after timeout
    (run-with-timer mcg-startup-posframe-timeout nil
                    (lambda ()
                      (when (get-buffer buf-name)
                        (posframe-hide buf-name))))))
#+end_src

*** Content Formatting

#+begin_src emacs-lisp
(defun mcg--format-startup-content (time modules errors gcs)
  "Format startup content for posframe display.
TIME is startup time, MODULES is module count, ERRORS is error count, GCS is GC count."
  (let ((status-icon (if (> errors 0) "âš " "âœ“")))
    (concat
     "\n"
     "    â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®\n"
     "    â”‚     MCG Emacs Ready             â”‚\n"
     "    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n"
     (format "    â”‚  %s Time: %.2fs                  â”‚\n" status-icon time)
     (format "    â”‚  ðŸ“¦ Modules: %-3d                â”‚\n" modules)
     (if (> errors 0)
         (format "    â”‚  âŒ Errors: %-3d            â”‚\n" errors)
       "")
     (format "    â”‚  ðŸ”„ GCs: %-3d                    â”‚\n" gcs)
     "    â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯\n")))
#+end_src

*** Color Helpers

#+begin_src emacs-lisp
(defun mcg--color-valid-p (color)
  "Check if COLOR is a valid, usable color."
  (and color
       (stringp color)
       (not (string-prefix-p "unspecified" color))
       (or (string-match-p "^#[0-9A-Fa-f]\\{6\\}$" color)
           (color-defined-p color))))

(defun mcg--startup-get-border-color ()
  "Get border color from current theme."
  (let ((keyword-fg (face-foreground 'font-lock-keyword-face nil t))
        (link-fg (face-foreground 'link nil t)))
    (cond
     ((mcg--color-valid-p keyword-fg) keyword-fg)
     ((mcg--color-valid-p link-fg) link-fg)
     (t "#61AFEF"))))

(defun mcg--startup-get-background-color ()
  "Get background color from current theme."
  (let ((tooltip-bg (face-background 'tooltip nil t))
        (default-bg (face-background 'default nil t)))
    (cond
     ((mcg--color-valid-p tooltip-bg) tooltip-bg)
     ((mcg--color-valid-p default-bg) default-bg)
     (t "#282C34"))))

(defun mcg--startup-get-foreground-color ()
  "Get foreground color from current theme."
  (let ((default-fg (face-foreground 'default nil t)))
    (if (mcg--color-valid-p default-fg)
        default-fg
      "#ABB2BF")))
#+end_src

*** Setup Function

#+begin_src emacs-lisp
(defun mcg-setup-startup-time-display ()
  "Set up startup time display after Emacs starts."
  ;; Use window-setup-hook which runs after all windows are set up
  (add-hook 'window-setup-hook #'mcg-display-startup-time))
#+end_src

** Bootstrap Entry Point

MCG Emacs é…ç½®ç³»ç»Ÿçš„å¼•å¯¼å…¥å£ç‚¹ã€‚

#+begin_src emacs-lisp
(defun mcg-bootstrap ()
  "Bootstrap the MCG Emacs configuration.
This function should be called from init.el to initialize the system."
  ;; Initialize paths
  (mcg-init-paths)
  
  ;; Setup load-path
  (mcg-setup-load-path)
  
  ;; Setup GC optimization
  (mcg-setup-gc-optimization)
  
  ;; Setup startup time display
  (mcg-setup-startup-time-display)
  
  (mcg-log "MCG bootstrap complete"))
#+end_src

** Utility Functions

å®žç”¨å·¥å…·å‡½æ•°ï¼Œç”¨äºŽå¼€å‘å’Œè°ƒè¯•ã€‚

#+begin_src emacs-lisp
(defun mcg-reload-config ()
  "Reload the MCG configuration.
Useful for development and debugging."
  (interactive)
  (mcg-init-paths)
  (mcg-setup-load-path)
  (message "MCG configuration reloaded."))

(defun mcg-open-config-dir ()
  "Open the MCG configuration directory in dired."
  (interactive)
  (dired mcg-config-dir))

(defun mcg-open-private-dir ()
  "Open the MCG private configuration directory in dired."
  (interactive)
  (if (file-directory-p mcg-private-dir)
      (dired mcg-private-dir)
    (message "Private directory does not exist: %s" mcg-private-dir)))
#+end_src

** Doctor - Configuration Diagnostics

é…ç½®è¯Šæ–­ç³»ç»Ÿï¼Œç”¨äºŽæ£€æŸ¥é…ç½®å¥åº·çŠ¶æ€ã€‚

*** Doctor Variables

#+begin_src emacs-lisp
(defvar mcg-doctor-checks nil
  "List of doctor check functions.
Each function should return a plist with :status (:ok, :warning, :error)
and :message describing the result.")
#+end_src

*** Check Functions

#+begin_src emacs-lisp
(defun mcg-doctor--check-paths ()
  "Check if all required paths are properly configured."
  (let ((issues nil))
    ;; Check core directories
    (unless (and mcg-emacs-dir (file-directory-p mcg-emacs-dir))
      (push "mcg-emacs-dir is not set or doesn't exist" issues))
    (unless (and mcg-config-dir (file-directory-p mcg-config-dir))
      (push "mcg-config-dir is not set or doesn't exist" issues))
    (unless (and mcg-core-dir (file-directory-p mcg-core-dir))
      (push "mcg-core-dir is not set or doesn't exist" issues))
    (unless (and mcg-modules-dir (file-directory-p mcg-modules-dir))
      (push "mcg-modules-dir is not set or doesn't exist" issues))
    (unless (and mcg-extensions-dir (file-directory-p mcg-extensions-dir))
      (push "mcg-extensions-dir is not set or doesn't exist" issues))
    
    (if issues
        (list :status :error
              :message (format "Path issues:\n  - %s" (string-join issues "\n  - ")))
      (list :status :ok
            :message "All paths configured correctly"))))

(defun mcg-doctor--check-core-modules ()
  "Check if core modules are loaded."
  (let ((required '(core-bootstrap core-lib core-modules))
        (missing nil))
    (dolist (mod required)
      (unless (featurep mod)
        (push (symbol-name mod) missing)))
    (if missing
        (list :status :error
              :message (format "Missing core modules: %s" (string-join missing ", ")))
      (list :status :ok
            :message "All core modules loaded"))))
#+end_src

*** More Check Functions

#+begin_src emacs-lisp
(defun mcg-doctor--check-module-errors ()
  "Check for module load errors."
  (if (and (boundp 'mcg-module-load-errors) mcg-module-load-errors)
      (let ((error-count (length mcg-module-load-errors)))
        (list :status :warning
              :message (format "%d module(s) failed to load. Run M-x mcg-list-modules for details."
                               error-count)))
    (list :status :ok
          :message "No module load errors")))

(defun mcg-doctor--check-extensions ()
  "Check extensions directory status."
  (if (and mcg-extensions-dir (file-directory-p mcg-extensions-dir))
      (let ((ext-count (length (directory-files mcg-extensions-dir nil "^[^.]"))))
        (if (> ext-count 0)
            (list :status :ok
                  :message (format "Extensions directory contains %d items" ext-count))
          (list :status :warning
                :message "Extensions directory is empty. Run 'make gsb' to initialize submodules.")))
    (list :status :error
          :message "Extensions directory not found")))

(defun mcg-doctor--check-gc-settings ()
  "Check GC settings."
  (let ((threshold gc-cons-threshold)
        (expected mcg-gc-cons-threshold-default))
    (cond
     ;; During startup, threshold should be high
     ((not (boundp 'mcg-startup-time))
      (list :status :ok
            :message "GC threshold is high (startup in progress)"))
     ;; After startup, should be restored
     ((= threshold expected)
      (list :status :ok
            :message (format "GC threshold restored to %s bytes" expected)))
     ((> threshold expected)
      (list :status :warning
            :message (format "GC threshold (%s) higher than expected (%s)" threshold expected)))
     (t
      (list :status :ok
            :message (format "GC threshold: %s bytes" threshold))))))
#+end_src

*** System Check Functions

#+begin_src emacs-lisp
(defun mcg-doctor--check-native-comp ()
  "Check native compilation status."
  (if (and (fboundp 'native-comp-available-p) (native-comp-available-p))
      (list :status :ok
            :message "Native compilation is available")
    (list :status :warning
          :message "Native compilation not available (performance may be reduced)")))

(defun mcg-doctor--check-emacs-version ()
  "Check Emacs version compatibility."
  (cond
   ((>= emacs-major-version 30)
    (list :status :ok
          :message (format "Emacs %s (fully supported)" emacs-version)))
   ((>= emacs-major-version 29)
    (list :status :ok
          :message (format "Emacs %s (supported)" emacs-version)))
   (t
    (list :status :warning
          :message (format "Emacs %s (version 29+ recommended)" emacs-version)))))

(defun mcg-doctor--check-startup-time ()
  "Check startup time."
  (if (and (boundp 'mcg-startup-time) mcg-startup-time)
      (cond
       ((< mcg-startup-time 1.0)
        (list :status :ok
              :message (format "Startup time: %.2fs (excellent)" mcg-startup-time)))
       ((< mcg-startup-time 2.0)
        (list :status :ok
              :message (format "Startup time: %.2fs (good)" mcg-startup-time)))
       ((< mcg-startup-time 5.0)
        (list :status :warning
              :message (format "Startup time: %.2fs (could be improved)" mcg-startup-time)))
       (t
        (list :status :warning
              :message (format "Startup time: %.2fs (slow, consider profiling)" mcg-startup-time))))
    (list :status :ok
          :message "Startup time not yet recorded")))
#+end_src

*** Doctor Main Function

#+begin_src emacs-lisp
(defun mcg-doctor ()
  "Run diagnostic checks on MCG Emacs configuration.
Displays a report of configuration health and potential issues."
  (interactive)
  (let ((buf (get-buffer-create "*MCG Doctor*"))
        (checks (list
                 (cons "Emacs Version" #'mcg-doctor--check-emacs-version)
                 (cons "Path Configuration" #'mcg-doctor--check-paths)
                 (cons "Core Modules" #'mcg-doctor--check-core-modules)
                 (cons "Module Errors" #'mcg-doctor--check-module-errors)
                 (cons "Extensions" #'mcg-doctor--check-extensions)
                 (cons "GC Settings" #'mcg-doctor--check-gc-settings)
                 (cons "Native Compilation" #'mcg-doctor--check-native-comp)
                 (cons "Startup Time" #'mcg-doctor--check-startup-time)))
        (ok-count 0)
        (warning-count 0)
        (error-count 0))
    (with-current-buffer buf
      (erase-buffer)
      (insert "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
      (insert "â•‘                    MCG Emacs Doctor                          â•‘\n")
      (insert "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")
      (insert (format "Checked at: %s\n\n" (format-time-string "%Y-%m-%d %H:%M:%S")))
      
      ;; Run all checks
      (dolist (check checks)
        (let* ((name (car check))
               (fn (cdr check))
               (result (funcall fn))
               (status (plist-get result :status))
               (message (plist-get result :message))
               (icon (pcase status
                       (:ok "âœ“")
                       (:warning "âš ")
                       (:error "âœ—"))))
          ;; Count results
          (pcase status
            (:ok (cl-incf ok-count))
            (:warning (cl-incf warning-count))
            (:error (cl-incf error-count)))
          ;; Display result
          (insert (format "[%s] %s\n" icon name))
          (insert (format "    %s\n\n" message))))
      
      ;; Summary
      (insert (make-string 64 ?â”€) "\n")
      (insert (format "Summary: %d OK, %d Warnings, %d Errors\n"
                      ok-count warning-count error-count))
      
      ;; Overall status
      (cond
       ((> error-count 0)
        (insert "\nâš  Configuration has errors that need attention.\n"))
       ((> warning-count 0)
        (insert "\nâœ“ Configuration is working but has some warnings.\n"))
       (t
        (insert "\nâœ“ Configuration is healthy!\n")))
      
      ;; Help section
      (insert "\n" (make-string 64 ?â”€) "\n")
      (insert "Useful commands:\n")
      (insert "  M-x mcg-list-modules     - Show all modules and their status\n")
      (insert "  M-x mcg-show-load-times  - Show module load times\n")
      (insert "  M-x mcg-show-logs        - Show recent log messages\n")
      (insert "  M-x mcg-show-extensions  - Show discovered extensions\n")
      (insert "  M-x mcg-show-keybindings - Show registered keybindings\n"))
    (display-buffer buf)))
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'core-bootstrap)
;;; core-bootstrap.el ends here
#+end_src
