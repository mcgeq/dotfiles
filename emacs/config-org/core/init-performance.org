* init-performance.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "init-performance.el") :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; init-performance.el -- Performance Optimization -*- lexical-binding: t; -*-
  
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Version: 1.0
  ;; Keywords: performance, optimization
  
  ;;; Commentary:
  ;; Comprehensive performance optimization for Emacs startup and runtime:
  ;; - GC tuning
  ;; - File-name-handler optimization
  ;; - Compilation optimization
  ;; - Memory management
  ;; - Lazy loading enhancements
#+END_SRC

** Startup Performance
#+BEGIN_SRC emacs-lisp
;;; 启动性能优化

;; 记录启动时间
(defvar mcg-startup-time-start (current-time)
  "Record Emacs startup start time.")

;; 测量初始化时间
(defvar mcg-init-time nil
  "Time taken to initialize Emacs.")

(defun mcg-display-startup-time ()
  "Display Emacs startup time."
  (let ((elapsed (float-time (time-subtract (current-time) mcg-startup-time-start))))
    (setq mcg-init-time elapsed)
    (message "✨ Emacs loaded in %.2f seconds with %d garbage collections"
             elapsed gcs-done)))

(add-hook 'emacs-startup-hook #'mcg-display-startup-time)
#+END_SRC

** Garbage Collection Optimization
#+BEGIN_SRC emacs-lisp
;;; 垃圾回收优化

;; 保存默认GC阈值
(defvar mcg-gc-cons-threshold-default (* 16 1024 1024)
  "Default GC threshold (16MB).")

(defvar mcg-gc-cons-percentage-default 0.1
  "Default GC percentage.")

;; 启动时提高GC阈值
(setq gc-cons-threshold most-positive-fixnum
      gc-cons-percentage 0.6)

;; 启动后恢复正常GC设置
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq gc-cons-threshold mcg-gc-cons-threshold-default
                  gc-cons-percentage mcg-gc-cons-percentage-default)
            (message "GC settings restored: threshold=%dMB" 
                     (/ mcg-gc-cons-threshold-default 1024 1024))))

;; Minibuffer时临时提高GC阈值
(defun mcg-minibuffer-setup-hook ()
  "Increase GC threshold in minibuffer."
  (setq gc-cons-threshold most-positive-fixnum))

(defun mcg-minibuffer-exit-hook ()
  "Restore GC threshold after minibuffer."
  (setq gc-cons-threshold mcg-gc-cons-threshold-default))

(add-hook 'minibuffer-setup-hook #'mcg-minibuffer-setup-hook)
(add-hook 'minibuffer-exit-hook #'mcg-minibuffer-exit-hook)

;; Idle时执行GC
(run-with-idle-timer 5 t #'garbage-collect)
#+END_SRC

** File Name Handler Optimization
#+BEGIN_SRC emacs-lisp
;;; 文件名处理器优化

;; 保存原始file-name-handler-alist
(defvar mcg-file-name-handler-alist-original file-name-handler-alist
  "Original file-name-handler-alist.")

;; 启动时禁用file-name-handler（加速文件加载）
(setq file-name-handler-alist nil)

;; 启动后恢复file-name-handler
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq file-name-handler-alist mcg-file-name-handler-alist-original)
            (message "File name handlers restored")))
#+END_SRC

** Compilation Optimization
#+BEGIN_SRC emacs-lisp
;;; 编译优化

;; 启用本地编译（如果支持）
(when (and (fboundp 'native-comp-available-p)
           (native-comp-available-p))
  (setq native-comp-async-report-warnings-errors nil
        native-comp-deferred-compilation t
        native-comp-speed 2))

;; 字节编译警告
(setq byte-compile-warnings '(not free-vars unresolved noruntime lexical make-local))
#+END_SRC

** Memory Management
#+BEGIN_SRC emacs-lisp
;;; 内存管理

;; 设置合理的内存限制
(setq read-process-output-max (* 3 1024 1024))  ; 3MB

;; 减少字体锁定的内存消耗
(setq font-lock-maximum-decoration
      '((t . t)))

;; 限制最大buffer数量
(setq kill-buffer-delete-auto-save-files t)
#+END_SRC

** Lazy Loading Enhancement
#+BEGIN_SRC emacs-lisp
;;; 延迟加载增强

;; Defer font settings
(defun mcg-setup-fonts ()
  "Setup fonts after frame creation."
  (when (display-graphic-p)
    ;; Font settings will be loaded
    (require 'init-font nil t)))

(if (daemonp)
    (add-hook 'after-make-frame-functions
              (lambda (frame)
                (with-selected-frame frame
                  (mcg-setup-fonts))))
  (add-hook 'after-init-hook #'mcg-setup-fonts))

;; Defer UI elements
(defun mcg-setup-ui ()
  "Setup UI elements after init."
  (require 'init-ui nil t)
  (require 'init-doom-modeline nil t))

(add-hook 'after-init-hook #'mcg-setup-ui)
#+END_SRC

** Auto-Compilation
#+BEGIN_SRC emacs-lisp
;;; 自动编译

;; 自动编译elisp文件
(setq load-prefer-newer t)

;; Auto-compile on save (optional)
(defun mcg-byte-compile-current-buffer ()
  "Byte-compile current buffer if it's an elisp file."
  (when (and (eq major-mode 'emacs-lisp-mode)
             buffer-file-name
             (string-match-p "\\.el\\'" buffer-file-name)
             (not (string-match-p "/config-org/" buffer-file-name)))  ; Don't compile source org files
    (byte-compile-file buffer-file-name)))

;; Uncomment to enable auto-compilation
;; (add-hook 'after-save-hook #'mcg-byte-compile-current-buffer)
#+END_SRC

** Performance Monitoring
#+BEGIN_SRC emacs-lisp
;;; 性能监控

(defun mcg-show-startup-stats ()
  "Show detailed startup statistics."
  (interactive)
  (message "
=== Emacs Startup Statistics ===
Init time: %.2f seconds
GC count: %d
GC threshold: %dMB
Memory usage: %.2fMB
Loaded features: %d
=============================
"
           (or mcg-init-time 0)
           gcs-done
           (/ gc-cons-threshold 1024 1024)
           (/ (memory-use-count) 1024.0 1024.0)
           (length features)))

(defun mcg-profile-startup ()
  "Profile Emacs startup time."
  (interactive)
  (require 'profiler)
  (profiler-start 'cpu)
  (add-hook 'emacs-startup-hook
            (lambda ()
              (profiler-stop)
              (profiler-report)
              (message "Startup profiling complete"))))

;; Quick command to check performance
(defalias 'startup-stats #'mcg-show-startup-stats)
(defalias 'profile-startup #'mcg-profile-startup)
#+END_SRC

** Large File Optimization
#+BEGIN_SRC emacs-lisp
;;; 大文件优化

(defvar mcg-large-file-size (* 1 1024 1024)
  "Size in bytes above which a file is considered large (1MB).")

(defun mcg-large-file-hook ()
  "Optimize Emacs for large files."
  (when (> (buffer-size) mcg-large-file-size)
    (setq-local bidi-display-reordering nil)
    (setq-local bidi-paragraph-direction 'left-to-right)
    (setq-local global-hl-line-mode nil)
    (setq-local line-number-mode nil)
    (setq-local column-number-mode nil)
    (when (fboundp 'display-line-numbers-mode)
      (display-line-numbers-mode -1))
    (when (fboundp 'font-lock-mode)
      (font-lock-mode -1))
    (message "Large file mode enabled")))

(add-hook 'find-file-hook #'mcg-large-file-hook)
#+END_SRC

** Scrolling Performance
#+BEGIN_SRC emacs-lisp
;;; 滚动性能

;; 平滑滚动优化
(setq scroll-step 1
      scroll-margin 3
      scroll-conservatively 10000
      scroll-preserve-screen-position t
      auto-window-vscroll nil
      fast-but-imprecise-scrolling t)

;; 鼠标滚动优化
(setq mouse-wheel-scroll-amount '(1 ((shift) . 5))
      mouse-wheel-progressive-speed nil
      mouse-wheel-follow-mouse t)
#+END_SRC

** Advice for Performance
#+BEGIN_SRC emacs-lisp
;;; 性能建议

;; Disable bidirectional text for performance
(setq-default bidi-display-reordering nil
              bidi-paragraph-direction 'left-to-right)

;; Reduce rendering frequency
(setq idle-update-delay 1.0)

;; Fast file loading
(setq auto-mode-case-fold nil)

;; Reduce startup noise
(setq inhibit-startup-screen t
      inhibit-startup-message t
      inhibit-startup-echo-area-message user-login-name
      initial-scratch-message nil)
#+END_SRC

** Performance Tips
#+BEGIN_SRC emacs-lisp
;;; 性能提示

;; Display performance tips on first run
(defun mcg-show-performance-tips ()
  "Show performance optimization tips."
  (interactive)
  (with-help-window "*Performance Tips*"
    (princ "
╔═══════════════════════════════════════════╗
║   Emacs Performance Optimization Tips     ║
╚═══════════════════════════════════════════╝

1. GC Tuning:
   - Current threshold: ")
    (princ (format "%dMB\n" (/ gc-cons-threshold 1024 1024)))
    (princ "   - Increase for faster performance (at cost of memory)
   - Decrease for lower memory usage

2. Native Compilation:
   - Status: ")
    (princ (if (and (fboundp 'native-comp-available-p)
                    (native-comp-available-p))
               "✓ Enabled\n"
             "✗ Not available\n"))
    (princ "   - Compile frequently used packages for speed boost

3. Large Files:
   - Files > 1MB automatically optimized
   - Disable font-lock and line numbers

4. Profiling:
   - M-x startup-stats   - Show startup statistics
   - M-x profile-startup - Profile startup time
   - M-x profiler-start  - Start CPU profiler

5. Quick Commands:
   - M-x garbage-collect       - Manual GC
   - M-x list-processes        - Check running processes
   - M-x memory-report         - Memory usage report
   - M-x emacs-uptime          - Uptime

═══════════════════════════════════════════
Current Performance:
  Init Time: ")
    (princ (format "%.2f seconds\n" (or mcg-init-time 0)))
    (princ (format "  GC Count:  %d\n" gcs-done))
    (princ (format "  Memory:    %.2fMB\n" (/ (memory-use-count) 1024.0 1024.0)))
    (princ "═══════════════════════════════════════════\n")))

;; Show tips on first startup (optional)
;; (add-hook 'emacs-startup-hook #'mcg-show-performance-tips)
#+END_SRC

** Ends
#+BEGIN_SRC emacs-lisp
(provide 'init-performance)
;;; init-performance.el ends here
#+END_SRC
