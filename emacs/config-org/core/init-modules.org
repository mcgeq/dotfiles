* init-modules.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "init-modules.el") :lexical t
:END:

** Headers
#+BEGIN_SRC emacs-lisp
  ;;; init-modules.el -- Module Declaration System -*- lexical-binding: t; -*-

  ;; Filename: init-modules.el
  ;; Description: 声明式模块系统 (借鉴 Doom Emacs)
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024-2025, mcge, all rights reserved.
  ;; Create Date: 2025-12-06
  ;; Version: 1.0
  ;; Keywords: modules, configuration
  ;; Compatibility: GNU Emacs 29.0+

  ;;; Commentary:
  ;;
  ;; 声明式模块系统，允许通过 mcg! macro 启用/禁用模块
  ;;
  ;; 使用示例:
  ;; (mcg! :core
  ;;       :ui doom-modeline
  ;;       :editor line-number indent treesit
  ;;       :completion vertico embark
  ;;       :lang (rust lua typescript))
  ;;

#+END_SRC

** Module Registry
#+BEGIN_SRC emacs-lisp
;;; 模块注册表

(defvar mcg-enabled-modules '()
  "已启用的模块列表")

(defvar mcg-disabled-modules '()
  "已禁用的模块列表")

(defvar mcg-module-registry
  '((core
     :modules (paths loadpath verify font function builtin)
     :priority 0
     :required t
     :description "核心基础设施")
    
    (ui
     :modules (ui)
     :priority 1
     :required nil
     :description "用户界面和主题 (使用 awesome-tray)")
    
    (editor
     :modules (line-number indent editor treesit)
     :priority 2
     :required nil
     :description "编辑器功能增强")
    
    (completion
     :modules (marginalia vertico embark yasnippet)
     :priority 3
     :required nil
     :description "补全和选择框架")
    
    (keybindings
     :modules (keymaps vundo)
     :priority 4
     :required nil
     :description "键盘绑定")
    
    (tools
     :modules (sort-tab auto-save recentf generic symbol-overlay)
     :priority 5
     :required nil
     :description "实用工具")
    
    (search
     :modules (blink-search color-rg helpful)
     :priority 6
     :required nil
     :description "搜索和导航")
    
    (input
     :modules (rime wraplish fingertip)
     :priority 7
     :required nil
     :description "输入法和输入增强")
    
    (git
     :modules (magit)
     :priority 8
     :required nil
     :description "版本控制")
    
    (lang
     :modules (lsp-bridge)
     :langs (rust lua cpp typescript web-mode python)
     :priority 9
     :required nil
     :description "LSP和语言支持")
    
    (org
     :modules (org org-agenda org-download capture-hugo consult-todo org-numbering)
     :priority 10
     :required nil
     :description "Org Mode生态")
    
    (docs
     :modules (markdown grip-mode)
     :priority 11
     :required nil
     :description "文档编辑和预览"))
  "模块注册表，定义所有可用模块及其属性")
#+END_SRC

** Module Declaration Macro
#+BEGIN_SRC emacs-lisp
;;; 模块声明宏

(defmacro mcg! (&rest specs)
  "声明启用的模块（类似 Doom 的 doom! macro）

使用示例:
  (mcg! :core
        :ui doom-modeline
        :editor line-number indent
        :completion vertico
        :lang (rust lua))

语法:
  - :category          ; 启用该类别的所有默认模块
  - :category module   ; 启用特定模块
  - :category (mod1 mod2)  ; 启用多个模块
  - :category -module  ; 禁用特定模块"
  
  (let ((current-category nil)
        (enabled '())
        (disabled '()))
    
    (dolist (spec specs)
      (cond
       ;; 类别标识符 (:core, :ui, etc.)
       ((keywordp spec)
        (setq current-category (intern (substring (symbol-name spec) 1))))
       
       ;; 禁用模块 (-module)
       ((and (symbolp spec)
             (string-prefix-p "-" (symbol-name spec)))
        (let ((module-name (intern (substring (symbol-name spec) 1))))
          (push (cons current-category module-name) disabled)))
       
       ;; 启用单个模块
       ((symbolp spec)
        (push (cons current-category spec) enabled))
       
       ;; 启用多个模块 (mod1 mod2)
       ((listp spec)
        (dolist (module spec)
          (push (cons current-category module) enabled)))))
    
    ;; 生成配置代码
    `(progn
       (setq mcg-enabled-modules ',enabled)
       (setq mcg-disabled-modules ',disabled)
       (message "Modules configured: %d enabled, %d disabled"
                (length mcg-enabled-modules)
                (length mcg-disabled-modules)))))
#+END_SRC

** Module Helper Functions
#+BEGIN_SRC emacs-lisp
;;; 模块辅助函数

(defun mcg-module-enabled-p (category module)
  "检查模块是否启用"
  (and (member (cons category module) mcg-enabled-modules)
       (not (member (cons category module) mcg-disabled-modules))))

(defun mcg-get-category-info (category)
  "获取类别信息"
  (assoc category mcg-module-registry))

(defun mcg-get-category-modules (category)
  "获取类别的所有模块"
  (let ((info (mcg-get-category-info category)))
    (plist-get (cdr info) :modules)))

(defun mcg-category-required-p (category)
  "检查类别是否必需"
  (let ((info (mcg-get-category-info category)))
    (plist-get (cdr info) :required)))

(defun mcg-load-module (category module)
  "加载指定模块"
  (let* ((module-name (format "init-%s" module))
         (module-symbol (intern module-name))
         (category-dir (symbol-name category))
         (module-file (expand-file-name 
                       (format "site-lisp/config/%s/%s.el" 
                               category-dir 
                               module-name)
                       mcgemacs-root-dir)))
    
    (condition-case err
        (progn
          (when (file-exists-p module-file)
            (require module-symbol))
          (mcg-register-loaded-module module-symbol)
          t)
      (error
       (message "Failed to load module %s/%s: %s" 
                category module (error-message-string err))
       (when (mcg-category-required-p category)
         (error "Required module failed: %s/%s" category module))
       nil))))

(defun mcg-load-lang-module (lang)
  "加载语言支持模块"
  (let* ((lang-name (symbol-name lang))
         (module-name (format "lang-%s" lang-name))
         (module-symbol (intern module-name))
         ;; 检查是否在 backend 或 frontend 子目录
         (backend-file (expand-file-name 
                        (format "site-lisp/config/lang/backend/%s.el" module-name)
                        mcgemacs-root-dir))
         (frontend-file (expand-file-name 
                         (format "site-lisp/config/lang/frontend/%s.el" module-name)
                         mcgemacs-root-dir))
         (root-file (expand-file-name 
                     (format "site-lisp/config/lang/%s.el" module-name)
                     mcgemacs-root-dir)))
    
    (condition-case err
        (progn
          (cond
           ((file-exists-p backend-file) (require module-symbol))
           ((file-exists-p frontend-file) (require module-symbol))
           ((file-exists-p root-file) (require module-symbol)))
          (mcg-register-loaded-module module-symbol)
          t)
      (error
       (message "Failed to load language module %s: %s" 
                lang (error-message-string err))
       nil))))
#+END_SRC

** Module Loading
#+BEGIN_SRC emacs-lisp
;;; 模块加载

(defun mcg-load-enabled-modules ()
  "加载所有启用的模块"
  (interactive)
  
  ;; 按类别优先级排序
  (let ((categories (sort (mapcar #'car mcg-module-registry)
                          (lambda (a b)
                            (< (plist-get (cdr (assoc a mcg-module-registry)) :priority)
                               (plist-get (cdr (assoc b mcg-module-registry)) :priority))))))
    
    (dolist (category categories)
      (let ((category-modules (seq-filter 
                               (lambda (x) (eq (car x) category))
                               mcg-enabled-modules)))
        
        (when category-modules
          (message "Loading category: %s" category)
          
          ;; 加载该类别的模块
          (dolist (mod-pair category-modules)
            (let ((module (cdr mod-pair)))
              (message "  Loading module: %s" module)
              
              ;; 特殊处理语言模块
              (if (eq category 'lang)
                  (if (eq module 'lsp-bridge)
                      (mcg-load-module 'lang 'lsp-bridge)
                    (mcg-load-lang-module module))
                (mcg-load-module category module)))))))))

(defun mcg-reload-modules ()
  "重新加载所有模块"
  (interactive)
  (mcg-load-enabled-modules)
  (message "Modules reloaded"))
#+END_SRC

** Interactive Commands
#+BEGIN_SRC emacs-lisp
;;; 交互命令

(defun mcg/list-enabled-modules ()
  "显示已启用的模块"
  (interactive)
  (let ((buffer (get-buffer-create "*Enabled Modules*")))
    (with-current-buffer buffer
      (erase-buffer)
      (insert "已启用的模块\n")
      (insert "=============\n\n")
      
      (dolist (category (mapcar #'car mcg-module-registry))
        (let ((modules (seq-filter 
                        (lambda (x) (eq (car x) category))
                        mcg-enabled-modules)))
          (when modules
            (insert (format "## %s\n" (upcase (symbol-name category))))
            (dolist (mod modules)
              (insert (format "  - %s\n" (cdr mod))))
            (insert "\n"))))
      
      (goto-char (point-min)))
    (display-buffer buffer)))

(defun mcg/module-info (category module)
  "显示模块信息"
  (interactive 
   (let* ((category (intern (completing-read "Category: "
                                             (mapcar (lambda (x) (symbol-name (car x)))
                                                     mcg-module-registry)
                                             nil t)))
          (modules (mcg-get-category-modules category))
          (module (intern (completing-read "Module: "
                                           (mapcar #'symbol-name modules)
                                           nil t))))
     (list category module)))
  
  (let ((enabled (mcg-module-enabled-p category module))
        (category-info (mcg-get-category-info category)))
    (message "Module: %s/%s\nEnabled: %s\nCategory Description: %s"
             category
             module
             (if enabled "Yes" "No")
             (plist-get (cdr category-info) :description))))

(defun mcg/toggle-module (category module)
  "切换模块启用状态"
  (interactive 
   (let* ((category (intern (completing-read "Category: "
                                             (mapcar (lambda (x) (symbol-name (car x)))
                                                     mcg-module-registry)
                                             nil t)))
          (modules (mcg-get-category-modules category))
          (module (intern (completing-read "Module: "
                                           (mapcar #'symbol-name modules)
                                           nil t))))
     (list category module)))
  
  (let ((pair (cons category module)))
    (if (member pair mcg-enabled-modules)
        (progn
          (setq mcg-enabled-modules (remove pair mcg-enabled-modules))
          (push pair mcg-disabled-modules)
          (message "Disabled: %s/%s" category module))
      (progn
        (setq mcg-disabled-modules (remove pair mcg-disabled-modules))
        (push pair mcg-enabled-modules)
        (message "Enabled: %s/%s (restart required)" category module)))))
#+END_SRC

** Ends
#+BEGIN_SRC emacs-lisp
(provide 'init-modules)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-modules.el ends here
#+END_SRC
