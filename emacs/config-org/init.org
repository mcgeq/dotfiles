#+TITLE: Init Module
#+AUTHOR: mcge
#+PROPERTY: header-args:emacs-lisp :tangle init.el :lexical t

* Init Module

本模块是 MCG Emacs 配置的主入口点。它按顺序加载核心模块，设置模块系统，并协调所有启用模块的加载。

** File Header

#+begin_src emacs-lisp
;;; init.el --- Main initialization for MCG Emacs -*- lexical-binding: t; -*-

;; Copyright (C) 2024 MCG
;; Author: MCG
;; Keywords: configuration, init

;;; Commentary:
;; This is the main entry point for MCG Emacs configuration.
;; It loads core modules in order, sets up the module system,
;; and orchestrates the loading of all enabled modules.
;;
;; Requirements: 1.2, 13.2

;;; Code:
#+end_src

** Bootstrap: Load Core Modules

加载核心模块，按顺序初始化配置系统。

*** Determine Configuration Directory

#+begin_src emacs-lisp
;; Determine the configuration directory
(defvar mcg-init-file-dir
  (file-name-directory (or load-file-name buffer-file-name))
  "Directory containing init.el.")

;; Add core directory to load-path first
(add-to-list 'load-path (expand-file-name "core" mcg-init-file-dir))
#+end_src

*** Load core-bootstrap

#+begin_src emacs-lisp
;; Load core modules in order
;; 1. core-bootstrap: paths, GC optimization, logging
(require 'core-bootstrap)

;; Initialize paths based on init.el location
;; init.el is at: emacs/site-lisp/config/init.el
;; We need to go up two levels to get emacs/ directory
;; config/ -> site-lisp/ -> emacs/
(let* ((config-dir (file-name-as-directory mcg-init-file-dir))
       ;; Remove trailing slash, then get parent directory
       (site-lisp-dir (file-name-directory (directory-file-name config-dir)))
       (emacs-dir (file-name-directory (directory-file-name site-lisp-dir))))
  (mcg-init-paths emacs-dir))

;; Setup load-path for all modules and extensions
(mcg-setup-load-path)

;; Setup GC optimization
(mcg-setup-gc-optimization)

;; Setup startup time display
(mcg-setup-startup-time-display)
#+end_src

*** Load core-lib

#+begin_src emacs-lisp
;; 2. core-lib: extension cache, keybinding registry
(require 'core-lib)
(mcg-lib-init)
#+end_src

*** Load core-modules

#+begin_src emacs-lisp
;; 3. core-modules: module system, mcg! macro
(require 'core-modules)
(mcg-modules-init)
#+end_src

*** Load core-autoload (Optional)

#+begin_src emacs-lisp
;; 4. core-autoload: autoload generation (optional)
(when (locate-library "core-autoload")
  (require 'core-autoload nil t))
#+end_src

** Module Declaration: Define Enabled Modules

使用 mcg! 宏声明启用的模块。以 `-' 为前缀的模块被禁用。

#+begin_src emacs-lisp
;; Declare which modules to enable using mcg! macro
;; Modules prefixed with `-' are disabled
;; 
;; Categories:
;;   :ui         - Theme, modeline, fonts, icons
;;   :editor     - Editor defaults, navigation, editing tools
;;   :completion - Vertico, snippets
;;   :tools      - Git, search, input method, tabs, shell
;;   :enhance    - Auto-save, which-key, helpful, recentf
;;   :org        - Org-mode configuration
;;   :writing    - Markdown, grammar checking
;;   :lang       - LSP and language-specific modules

(mcg!
 ;; UI modules - loaded immediately
 :ui
 theme
 modeline
 font
 icons

 ;; Editor modules - loaded immediately
 :editor
 defaults
 indent
 treesit
 navigation
 keybindings
 paredit
 format
 undo
 multicursor

 ;; Completion modules - loaded on idle
 :completion
 vertico
 yasnippet

 ;; Tools modules - loaded immediately
 :tools
 magit
 search
 rime
 tabs
 eshell
 lsp  ; LSP must be loaded before language modules

 ;; Enhancement modules - loaded on idle
 :enhance
 autosave
 which-key
 helpful
 recentf
 symbol

 ;; Org modules - loaded immediately
 :org
 org
 org-agenda
 org-babel
 org-capture
 org-extras

 ;; Writing modules - deferred (loaded on file open)
 :writing
 markdown
 -vale  ; disabled by default

 ;; Language modules - deferred (loaded on file open)
 :lang
 rust
 python
 typescript
 web
 cpp
 lua
 zig)
#+end_src

** Module Loading Strategy

定义各类别使用的加载策略。

#+begin_src emacs-lisp
;; Define which categories use which loading strategy
(defvar mcg-immediate-categories '(:ui :editor :tools :org)
  "Categories to load immediately at startup.")

(defvar mcg-idle-categories '(:completion :enhance)
  "Categories to load during idle time.")

(defvar mcg-deferred-categories '(:writing :lang)
  "Categories to defer loading until triggered.")
#+end_src

** Load Immediate Modules

加载立即类别中的所有模块。

#+begin_src emacs-lisp
(defun mcg-load-immediate-modules ()
  "Load all modules in immediate categories."
  (dolist (category mcg-immediate-categories)
    (mcg-load-modules-by-category category)))
#+end_src

** Setup Idle Loading

设置完成和增强模块的空闲加载。

#+begin_src emacs-lisp
(defun mcg-setup-idle-modules ()
  "Set up idle loading for completion and enhance modules."
  (dolist (category mcg-idle-categories)
    (mcg-add-idle-load-category category))
  (mcg-setup-idle-loading))
#+end_src

** Setup Deferred Loading

设置写作和语言模块的延迟加载。

#+begin_src emacs-lisp
(defun mcg-setup-deferred-modules ()
  "Set up deferred loading for writing and language modules."
  ;; Setup deferred loading based on triggers defined in core-modules
  (mcg-setup-deferred-loading))
#+end_src

** Load Private Configuration

加载私有配置（如果存在）。私有配置在所有其他模块之后加载，以允许覆盖。

#+begin_src emacs-lisp
(defun mcg-load-private-config ()
  "Load private configuration if it exists.
Private config is loaded after all other modules to allow overrides."
  (let ((private-config (expand-file-name "config.el" mcg-private-dir)))
    (when (file-exists-p private-config)
      (condition-case err
          (progn
            (mcg-profile "private/config"
              (load private-config nil t))
            (mcg-log "Loaded private configuration"))
        (error
         (mcg-log-error "Failed to load private config: %s"
                        (error-message-string err)))))))
#+end_src

** Startup Statistics

Emacs 准备就绪后显示启动统计信息。

#+begin_src emacs-lisp
(defun mcg-display-startup-stats ()
  "Display startup statistics after Emacs is ready."
  (let ((loaded-count (length mcg-loaded-modules))
        (deferred-count (length mcg-deferred-modules))
        (idle-count (length mcg-idle-load-modules))
        (error-count (length mcg-module-load-errors)))
    (mcg-log "Startup complete: %d loaded, %d deferred, %d idle, %d errors"
             loaded-count deferred-count idle-count error-count)
    ;; Show errors if any
    (when (> error-count 0)
      (mcg-log-warning "Module load errors occurred. Run M-x mcg-list-modules to see details."))))
#+end_src

** Main Initialization Sequence

主初始化函数，用于设置完整的 MCG Emacs 配置。

#+begin_src emacs-lisp
(defun mcg-init ()
  "Main initialization function.
Called to set up the complete MCG Emacs configuration."
  ;; Load immediate modules (UI, editor, tools, org)
  (mcg-load-immediate-modules)
  
  ;; Setup idle loading for completion and enhance modules
  (mcg-setup-idle-modules)
  
  ;; Setup deferred loading for writing and language modules
  (mcg-setup-deferred-modules)
  
  ;; Load private configuration last
  (mcg-load-private-config)
  
  ;; Display startup statistics
  (add-hook 'emacs-startup-hook #'mcg-display-startup-stats 95))

;; Run initialization
(mcg-init)
#+end_src

** Post-Startup Hooks

Emacs 完全启动后的额外设置。

#+begin_src emacs-lisp
;; Additional setup after Emacs is fully started
(add-hook 'emacs-startup-hook
          (lambda ()
            ;; Restore GC settings (handled by core-bootstrap)
            ;; Display startup time (handled by core-bootstrap)
            
            ;; Any additional post-startup setup can go here
            (mcg-log "MCG Emacs ready"))
          100)
#+end_src

** Provide Feature

#+begin_src emacs-lisp
(provide 'init)
;;; init.el ends here
#+end_src
