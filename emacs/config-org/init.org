* init.el
:PROPERTIES:
:HEADER-ARGS: :tangle (concat temporary-file-directory "init.el") :lexical t
:END:

** Headers

#+BEGIN_SRC emacs-lisp
  ;;; init.el -- Emacs Configuration Manager -*- lexical-binding: t; -*-

  ;; Filename: init.el
  ;; Description: Emacs Configuration - Version 2.0
  ;; Author: mcge <mcgeq@outlook.com>
  ;; Copyright (C) 2024-2025, mcge, all rights reserved.
  ;; Create   Date: 2025-01-04 15:00:00
  ;; Version: 2.0
  ;; Modified   By: mcgeq <mcgeq@outlook.com>
  ;; Last Modified: <2025-02-16 Sun 12:00>
  ;; Keywords: emacs, configuration, startup
  ;; Compatibility: GNU Emacs 31.0.50+

  ;;; Commentary:
  ;;
  ;; Emacsé…ç½®ç®¡ç†å™¨ - ä½¿ç”¨Git Submoduleså’ŒOrg Babel
  ;;
  ;; é…ç½®ç»“æ„:
  ;; 1. Core: æ ¸å¿ƒåŸºç¡€é…ç½®
  ;; 2. UI: ç”¨æˆ·ç•Œé¢å’Œä¸»é¢˜
  ;; 3. Editor: ç¼–è¾‘å™¨å¢å¼º
  ;; 4. Completion: ä»£ç è¡¥å…¨
  ;; 5. Tools: å·¥å…·é›†
  ;; 6. Org: Org modeæ‰©å±•
  ;; 7. Lang: è¯­è¨€æ”¯æŒ
  ;;

  ;;; Installation:
  ;;
  ;; 1. å…‹éš†dotfilesä»“åº“å¹¶åˆå§‹åŒ–submodules:
  ;;    git clone --recursive https://github.com/user/dotfiles.git
  ;;
  ;; 2. ç¼–è¯‘é…ç½®:
  ;;    cd dotfiles/emacs
  ;;    make generate
  ;;
  ;; 3. åŠ è½½é…ç½®:
  ;;    emacs -Q -l site-lisp/config/init.el

  ;;; Change log:
  ;;
  ;; Version 2.0 (2025-02-16):
  ;; - é‡æ„ä¸ºæ¨¡å—åŒ–ç»“æ„
  ;; - ç»Ÿä¸€Load-pathç®¡ç†
  ;; - æ·»åŠ é…ç½®éªŒè¯ç³»ç»Ÿ
  ;; - ä¼˜åŒ–å¯åŠ¨æ€§èƒ½
  ;;

#+END_SRC

** Initialize Emacs UI
#+BEGIN_SRC emacs-lisp
;;; åˆå§‹åŒ–Emacsç•Œé¢
;; Hide tools menu vertical-scroll
(menu-bar-mode 0)
(tool-bar-mode 0)
(scroll-bar-mode 0)
#+END_SRC

** Phase 1: Core Infrastructure (Priority 0)
#+BEGIN_SRC emacs-lisp
;;; Phase 1: æ ¸å¿ƒåŸºç¡€è®¾æ–½

;; è®°å½•å¯åŠ¨æ—¶é—´
(defvar mcg-startup-start-time (current-time))

;; åŠ è½½è·¯å¾„å’ŒåŸºç¡€é…ç½®ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
(require 'init-paths)      ; è·¯å¾„é…ç½®ç®¡ç†
(require 'init-loadpath)   ; Load-pathç®¡ç†
(require 'init-verify)     ; é…ç½®éªŒè¯

;; ğŸ†• åŠ è½½æ¨¡å—å£°æ˜ç³»ç»Ÿï¼ˆå¯é€‰ï¼Œç”¨äºå£°æ˜å¼é…ç½®ï¼‰
(require 'init-modules)    ; æ¨¡å—å£°æ˜ç³»ç»Ÿ

;; æ ¸å¿ƒå¸¸é‡å’Œå‡½æ•°
(require 'init-font)       ; å­—ä½“é…ç½®
(require 'init-function)   ; è‡ªå®šä¹‰å‡½æ•°
(require 'init-builtin)    ; å†…ç½®åŠŸèƒ½å¢å¼º

;; æ³¨å†Œå·²åŠ è½½çš„æ¨¡å—
(mcg-register-loaded-module 'init-paths)
(mcg-register-loaded-module 'init-loadpath)
(mcg-register-loaded-module 'init-verify)
(mcg-register-loaded-module 'init-modules)    ; ğŸ†•
(mcg-register-loaded-module 'init-font)
(mcg-register-loaded-module 'init-function)
(mcg-register-loaded-module 'init-builtin)
#+END_SRC

** Phase 2: UI and Themes (Priority 1)
#+BEGIN_SRC emacs-lisp
;;; Phase 2: ç”¨æˆ·ç•Œé¢å’Œä¸»é¢˜

;; åŠ è½½UIé…ç½®
(require 'init-ui)
(require 'init-doom-modeline)

(mcg-register-loaded-module 'init-ui)
(mcg-register-loaded-module 'init-doom-modeline)
#+END_SRC

** Phase 3: Editor Enhancement (Priority 2)
#+BEGIN_SRC emacs-lisp
;;; Phase 3: ç¼–è¾‘å™¨å¢å¼º

;; æ€§èƒ½ä¼˜åŒ–ï¼šåœ¨å¿«é€ŸGCæ¨¡å¼ä¸‹åŠ è½½ç¼–è¾‘å™¨é…ç½®
(defmacro with-fast-gc (&rest body)
  "åœ¨å¿«é€ŸGCæ¨¡å¼ä¸‹æ‰§è¡Œä»£ç "
  `(let ((gc-threshold gc-cons-threshold)
         (file-handler file-name-handler-alist))
     (setq gc-cons-threshold most-positive-fixnum
           file-name-handler-alist nil)
     (unwind-protect
         (progn ,@body)
       (setq gc-cons-threshold gc-threshold
             file-name-handler-alist file-handler)
       (garbage-collect))))

(with-fast-gc
  ;; ç¼–è¾‘å™¨é…ç½®ï¼ˆå·²è¿ç§»åˆ°editorç›®å½•ï¼‰
  (require 'init-line-number)
  (require 'init-indent)
  (require 'init-editor)
  (require 'init-treesit)
  
  ;; å·¥å…·é…ç½®ï¼ˆå·²è¿ç§»åˆ°toolsç›®å½•ï¼‰
  (require 'init-sort-tab)
  (require 'init-auto-save)
  (require 'init-generic)
  (require 'init-symbol-overlay)
  (require 'init-rime)
  
  (mcg-register-loaded-module 'init-sort-tab)
  (mcg-register-loaded-module 'init-auto-save)
  (mcg-register-loaded-module 'init-line-number)
  (mcg-register-loaded-module 'init-generic)
  (mcg-register-loaded-module 'init-editor)
  (mcg-register-loaded-module 'init-treesit)
  (mcg-register-loaded-module 'init-symbol-overlay)
  (mcg-register-loaded-module 'init-rime))
#+END_SRC

** Phase 4: Completion and Search (Priority 3)
#+BEGIN_SRC emacs-lisp
;;; Phase 4: ä»£ç è¡¥å…¨å’Œæœç´¢ï¼ˆå·²è¿ç§»åˆ°completionç›®å½•ï¼‰

(require 'init-marginalia)
(require 'init-vertico)
(require 'init-embark)
(require 'init-yasnippet)

(mcg-register-loaded-module 'init-marginalia)
(mcg-register-loaded-module 'init-vertico)
(mcg-register-loaded-module 'init-embark)
(mcg-register-loaded-module 'init-yasnippet)
#+END_SRC

** Phase 5: Keybindings
#+BEGIN_SRC emacs-lisp
;;; Phase 5: é”®ç»‘å®š

;; Keybindings configuration
(require 'init-keymaps)
(require 'init-vundo)

;; å·¥å…·é…ç½®ï¼ˆå·²è¿ç§»åˆ°toolsç›®å½•ï¼‰
(require 'init-recentf)
(require 'init-wraplish)
(require 'init-fingertip)

(mcg-register-loaded-module 'init-keymaps)
(mcg-register-loaded-module 'init-vundo)
(mcg-register-loaded-module 'init-recentf)
(mcg-register-loaded-module 'init-wraplish)
(mcg-register-loaded-module 'init-fingertip)
#+END_SRC

** Phase 6: LSP and Languages (Delayed Loading)
#+BEGIN_SRC emacs-lisp
;;; Phase 6: LSPå’Œè¯­è¨€æ”¯æŒï¼ˆå»¶è¿ŸåŠ è½½ï¼‰

(defun mcg-load-lang-support ()
  "åŠ è½½è¯­è¨€æ”¯æŒ"
  (require 'init-lsp-bridge)
  ;; æŒ‰éœ€åŠ è½½å…·ä½“è¯­è¨€
  (mcg-load-extension "rust-mode")
  (mcg-load-extension "lua-mode")
  (mcg-load-extension "web-mode")
  ;; typescript-mode is built-in for Emacs 29+
  
  (require 'lang-rust)
  (require 'lang-lua)
  (require 'lang-web-mode)
  (require 'lang-cpp)
  (require 'lang-typescript)
  
  (mcg-register-loaded-module 'init-lsp-bridge)
  (mcg-register-loaded-module 'lang-rust)
  (mcg-register-loaded-module 'lang-lua)
  (mcg-register-loaded-module 'lang-web-mode)
  (mcg-register-loaded-module 'lang-cpp)
  (mcg-register-loaded-module 'lang-typescript))

;; å»¶è¿Ÿ1ç§’åŠ è½½è¯­è¨€æ”¯æŒ
(run-with-timer 1 nil #'mcg-load-lang-support)
#+END_SRC

** Phase 7: Org and Documentation (Delayed Loading)
#+BEGIN_SRC emacs-lisp
;;; Phase 7: Orgå’Œæ–‡æ¡£æ”¯æŒï¼ˆå»¶è¿ŸåŠ è½½ï¼‰

(defun mcg-load-org-support ()
  "åŠ è½½ Org å’Œæ–‡æ¡£æ”¯æŒï¼ˆä½¿ç”¨æ–°çš„æ¨¡å—åŒ–é…ç½®ç³»ç»Ÿï¼‰
  
æ–°çš„ Org é…ç½®ç³»ç»Ÿç‰¹æ€§ï¼š
- ç»Ÿä¸€å˜é‡ç®¡ç† (mcg-org-*)
- æ¨¡å—åŒ–åŠ è½½
- æ™ºèƒ½ä¾èµ–ç®¡ç†
- åŠŸèƒ½å¼€å…³æ§åˆ¶
  
æŸ¥çœ‹çŠ¶æ€: M-x mcg-org-show-status
å®Œæ•´æ–‡æ¡£: org/README-ORG-CONFIG.org"
  
  ;; å·¥å…·é…ç½®
  (require 'init-helpful)
  (require 'init-blink-search)
  (require 'init-color-rg)
  
  ;; ğŸš€ ä½¿ç”¨æ–°çš„ Org é…ç½®åŠ è½½å™¨
  ;; æä¾›ç»Ÿä¸€çš„å˜é‡ç³»ç»Ÿå’Œæ¨¡å—åŒ–é…ç½®
  (require 'init-org-loader)
  (mcg-org-setup-autoload)  ; è‡ªåŠ¨åŠ è½½æ‰€æœ‰ Org æ¨¡å—
  
  ;; æ˜¾ç¤ºåŠ è½½ä¿¡æ¯
  (message "âœ“ Org mode æ–°é…ç½®ç³»ç»Ÿå·²åŠ è½½")
  (message "  è¿è¡Œ M-x mcg-org-show-status æŸ¥çœ‹è¯¦æƒ…")
  
  ;; æ–‡æ¡£é…ç½®
  (require 'init-markdown)
  (require 'init-grip-mode)
  
  ;; æ³¨å†Œå·²åŠ è½½æ¨¡å—
  (mcg-register-loaded-module 'init-helpful)
  (mcg-register-loaded-module 'init-blink-search)
  (mcg-register-loaded-module 'init-color-rg)
  (mcg-register-loaded-module 'init-org-loader)
  (mcg-register-loaded-module 'init-markdown)
  (mcg-register-loaded-module 'init-grip-mode))

;; å»¶è¿Ÿ2ç§’åŠ è½½Orgæ”¯æŒ
(run-with-timer 2 nil #'mcg-load-org-support)
#+END_SRC

** Hooks
#+BEGIN_SRC emacs-lisp
;;; é’©å­é…ç½®

;; ç»‘å®šåˆ°ä¿å­˜å‰é’©å­
(add-hook 'before-save-hook 'mcg/org-update-file-headers)
#+END_SRC

** Display Startup Time
#+BEGIN_SRC emacs-lisp
;;; æ˜¾ç¤ºå¯åŠ¨æ—¶é—´

(defun mcg-display-startup-time ()
  "æ˜¾ç¤ºå¯åŠ¨æ—¶é—´"
  (let ((elapsed (float-time (time-subtract (current-time) mcg-startup-start-time))))
    (message "Emacs configuration loaded in %.2f seconds" elapsed)))

;; å»¶è¿Ÿæ˜¾ç¤ºå¯åŠ¨æ—¶é—´
(run-with-timer 3 nil #'mcg-display-startup-time)
#+END_SRC

** Ends
#+BEGIN_SRC emacs-lisp
(provide 'init)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init.el ends here
#+END_SRC

