#+TITLE: Emacs Configuration - Declarative Modular Architecture
#+AUTHOR: mcge
#+DATE: 2026-01-09
#+OPTIONS: toc:3 num:t

[[file:README_CN.org][中文文档]]

* Overview

MCG Emacs configuration adopts a declarative module system, inspired by Doom Emacs design philosophy while maintaining the advantages of Org Babel literate programming.

** Core Features

- Declarative module configuration (mcg! macro)
- Lazy loading support
- Module dependency management
- Unified extension management
- Complete test coverage
- Deprecated module migration support

* Directory Structure

#+begin_src text
config-org/
├── init.org                      # Entry file (mcg! declaration)
├── early-init.org                # Early init configuration
├── core/                         # Core layer (must be loaded)
│   ├── core-bootstrap.org        # Path definitions, performance optimization
│   ├── core-lib.org              # Utility functions, extension management
│   ├── core-modules.org          # mcg! macro, module system
│   └── core-autoload.org         # Auto tangle and autoload
├── modules/                      # Feature modules (8 categories, 35 modules)
│   ├── ui/                       # UI related (4 modules)
│   │   ├── init-theme.org
│   │   ├── init-modeline.org
│   │   ├── init-font.org
│   │   └── init-icons.org
│   ├── editor/                   # Editor features (8 modules)
│   │   ├── init-defaults.org
│   │   ├── init-treesit.org
│   │   ├── init-navigation.org
│   │   ├── init-keybindings.org
│   │   ├── init-paredit.org
│   │   ├── init-format.org
│   │   ├── init-undo.org
│   │   └── init-multicursor.org
│   ├── completion/               # Completion system (2 modules)
│   │   ├── init-vertico.org
│   │   └── init-yasnippet.org
│   ├── tools/                    # Tools (5 modules)
│   │   ├── init-magit.org
│   │   ├── init-search.org
│   │   ├── init-rime.org
│   │   ├── init-tabs.org
│   │   └── init-eshell.org
│   ├── enhance/                  # Enhancement features (5 modules)
│   │   ├── init-autosave.org
│   │   ├── init-which-key.org
│   │   ├── init-helpful.org
│   │   ├── init-recentf.org
│   │   └── init-symbol.org
│   ├── org/                      # Org-mode (5 modules)
│   │   ├── init-org.org
│   │   ├── init-org-agenda.org
│   │   ├── init-org-babel.org
│   │   ├── init-org-capture.org
│   │   └── init-org-extras.org
│   ├── writing/                  # Writing tools (2 modules)
│   │   ├── init-markdown.org
│   │   └── init-vale.org
│   └── lang/                     # Programming languages (9 modules)
│       ├── init-lsp.org
│       ├── init-lsp-common.org
│       ├── init-rust.org
│       ├── init-python.org
│       ├── init-typescript.org
│       ├── init-web.org
│       ├── init-cpp.org
│       ├── init-lua.org
│       └── init-zig.org
└── private/                      # Private configuration (not committed to Git)
    └── config.org
#+end_src

* Quick Start

** 1. Initialize submodules

#+begin_src bash
make init
#+end_src

** 2. Compile configuration

#+begin_src bash
make
#+end_src

** 3. Start Emacs

#+begin_src bash
emacs -Q -l site-lisp/config/init.el
#+end_src

* Module Declaration

Use =mcg!= macro in =init.org= to declare enabled modules:

#+begin_src emacs-lisp
(mcg! :ui
      theme modeline font icons

      :editor
      defaults treesit navigation keybindings
      paredit format undo multicursor

      :completion
      vertico yasnippet

      :tools
      magit search rime tabs eshell

      :enhance
      autosave which-key helpful recentf symbol

      :org
      org org-agenda org-babel org-capture org-extras

      :writing
      markdown vale

      :lang
      lsp lsp-common rust python typescript web cpp lua zig)
#+end_src

* Module Categories

| Category   | Modules | Description                       | Loading   |
|------------+---------+-----------------------------------+-----------|
| ui         |       4 | Theme, modeline, font, icons      | Immediate |
| editor     |       8 | Editing features                  | Immediate |
| completion |       2 | Vertico, yasnippet                | Idle      |
| tools      |       5 | Magit, search, rime, tabs, eshell | Deferred  |
| enhance    |       5 | Autosave, which-key, helpful, etc.| Idle      |
| org        |       5 | Org Mode ecosystem                | Deferred  |
| writing    |       2 | Markdown, vale                    | Deferred  |
| lang       |       9 | LSP and language support          | Deferred  |

* Module Loading Strategy

The configuration uses a three-tier loading strategy:

** Immediate Loading (At Startup)

Essential modules loaded immediately:
- Core: bootstrap, lib, modules, autoload
- UI: theme, modeline, font
- Editor: defaults, keybindings

** Idle Loading (After Startup)

Non-essential modules loaded during idle time:

#+begin_src emacs-lisp
;; Configure idle loading delay (default: 2 seconds)
(setq mcg-idle-load-delay 2)

;; Add modules to idle loading
(mcg-add-idle-load-module :completion 'vertico)
(mcg-add-idle-load-category :enhance)
#+end_src

** Deferred Loading (On Demand)

Language modules loaded when opening files:

#+begin_src emacs-lisp
;; Triggers defined in mcg-module-triggers
;; Example: Opening .rs file loads :lang rust module
#+end_src

* Keybinding Registry

All keybindings are registered in a central registry for conflict detection.

** Using mcg-bind-key

#+begin_src emacs-lisp
;; Instead of global-set-key, use:
(mcg-bind-key "C-c s l" consult-line "init-keybindings")

;; With optional keymap
(mcg-bind-key "C-c C-b" eval-buffer "init-keybindings" emacs-lisp-mode-map)
#+end_src

** Conflict Detection

Conflicts are automatically detected and logged:

#+begin_example
Warning: Keybinding conflict: C-c s l
  Was: old-command (from module-a)
  Now: new-command (from module-b)
#+end_example

** Query Functions

#+begin_src emacs-lisp
(mcg-list-keybindings)           ; List all registered keybindings
(mcg-keybinding-source "C-c s l") ; Get source module for a key
(mcg-keybindings-by-source "init-keybindings") ; Get all keys from a module
#+end_src

* Help System

Press =C-h M= to access the unified help menu:

| Key | Command                    |
|-----+----------------------------|
| k   | Show keybindings reference |
| m   | List all modules           |
| e   | List extensions            |
| d   | Run doctor                 |
| t   | Show load times            |
| l   | Show logs                  |
| c   | Open config file           |
| r   | Reload module              |
| R   | Rebuild extension cache    |

* Migration Guide

If migrating from an older configuration version:

** Category Changes

| Old Category | New Category | Notes                          |
|--------------+--------------+--------------------------------|
| :input       | :editor      | Input modules merged to editor |
| :docs        | :writing     | Docs renamed to writing        |
| (none)       | :enhance     | New enhancement category       |

** Module Renames

| Old Module          | New Module        | Notes              |
|---------------------+-------------------+--------------------|
| :input fingertip    | :editor paredit   | Structural editing |
| :input wraplish     | :editor format    | Text formatting    |
| :docs markdown      | :writing markdown | Markdown support   |
| :tools sort-tab     | :tools tabs       | Tab management     |
| :tools utils        | :enhance (split)  | Utils split up     |

** Auto Migration

The system automatically detects old category/module names and shows warnings:

#+begin_example
Warning: Category :input is deprecated, use :editor instead
Warning: Module fingertip is renamed to paredit
#+end_example

* Private Configuration

Create private configuration file:

#+begin_src bash
cp config-org/private/config.org.example config-org/private/config.org
#+end_src

Private configuration will not be committed to Git.

* Makefile Commands

#+begin_src bash
make              # Compile configuration
make clean        # Clean generated files
make list         # View file list
make test         # Run tests
make init         # Initialize submodules
make up           # Update submodules
make st           # View submodule status
#+end_src

* Common Commands

| Command                          | Description                    |
|----------------------------------+--------------------------------|
| M-x mcg-list-modules             | Show all modules and status    |
| M-x mcg/reload-module            | Reload specified module        |
| M-x mcg/show-keybindings         | Show keybindings reference     |
| M-x mcg/toggle-format-on-save    | Toggle format on save          |
| M-x mcg-doctor                   | Check configuration issues     |
| M-x mcg/show-load-times          | View module loading times      |
| M-x mcg/show-logs                | View recent log messages       |
| M-x mcg/list-extensions          | Show extension status          |
| M-x mcg-show-startup-errors      | Show startup error summary     |
| M-x mcg/rebuild-extension-cache  | Rebuild extension cache        |

* Changelog

** 2026-01-09 - Module Refactor

- Split init-utils.org into enhance category modules
- Merged :input category into :editor
- Renamed :docs category to :writing
- Added new :enhance category
- Module renames: fingertip → paredit, wraplish → format, sort-tab → tabs
- Added deprecated module migration support
- Extracted icons, undo, multicursor, vale modules

** 2026-01-07 - Initial Release

- Declarative module system (mcg! macro)
- Lazy loading support
- Complete test coverage
- Unified extension management
