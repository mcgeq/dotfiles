# Oh my tmux!
# https://github.com/gpakosz/.tmux
# Forked from gpakosz/.tmux

# -- general -------------------------------------------------------------------

set -g default-terminal "screen-256color"

set -s escape-time 10
set -sg repeat-time 600
set -s focus-events on

# use default C-b as prefix

set -g history-limit 5000

# -- display -------------------------------------------------------------------

set -g base-index 1
setw -g pane-base-index 1

setw -g automatic-rename on
set -g renumber-windows on

set -g set-titles on

set -g display-panes-time 800
set -g display-time 1000

set -g status-interval 10

# activity
set -g monitor-activity on
set -g visual-activity off

# -- navigation ----------------------------------------------------------------

# split current window
bind s split-window -v
bind v split-window -h

# pane navigation (vim style)
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R
bind > swap-pane -D
bind < swap-pane -U

# maximize current pane
bind + run "cut -c3- '#{TMUX_CONF}' | sh -s _maximize_pane '#{session_name}' '#D'"

# pane resizing
bind -r H resize-pane -L 2
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 2

# window navigation
unbind n
unbind p
bind -r C-h previous-window
bind -r C-l next-window
bind -r C-S-H swap-window -t -1 \; select-window -t -1
bind -r C-S-L swap-window -t +1 \; select-window -t +1
bind Tab last-window

# toggle mouse
bind m run "cut -c3- '#{TMUX_CONF}' | sh -s _toggle_mouse"

# close pane
bind x kill-pane

# -- copy mode -----------------------------------------------------------------

bind Enter copy-mode

bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line

# copy to clipboard (Linux)
if -b 'command -v xsel > /dev/null 2>&1' 'bind y run -b "\"\$TMUX_PROGRAM\" \${TMUX_SOCKET:+-S \"\$TMUX_SOCKET\"} save-buffer - | xsel -i -b"'
if -b '! command -v xsel > /dev/null 2>&1 && command -v xclip > /dev/null 2>&1' 'bind y run -b "\"\$TMUX_PROGRAM\" \${TMUX_SOCKET:+-S \"\$TMUX_SOCKET\"} save-buffer - | xclip -i -selection clipboard >/dev/null 2>&1"'

# copy to Wayland clipboard
if -b '[ "$XDG_SESSION_TYPE" = "wayland" ] && command -v wl-copy > /dev/null 2>&1' 'bind y run -b "\"\$TMUX_PROGRAM\" \${TMUX_SOCKET:+-S \"\$TMUX_SOCKET\"} save-buffer - | wl-copy"'

# -- buffers -------------------------------------------------------------------

bind b list-buffers
bind p paste-buffer -p
bind P choose-buffer

# -- reload configuration ------------------------------------------------------

bind r run "sh -c '\"\$TMUX_PROGRAM\" \${TMUX_SOCKET:+-S \"\$TMUX_SOCKET\"} source \"\$TMUX_CONF\"'" \; display "#{TMUX_CONF} sourced"
bind e new-window -n "#{TMUX_CONF_LOCAL}" sh -c '_E=${VISUAL:-${EDITOR:-vim}}; case "$_E" in *vim*) $_E -c ":set syntax=tmux" "$TMUX_CONF_LOCAL";; *) $_E "$TMUX_CONF_LOCAL";; esac && "$TMUX_PROGRAM" ${TMUX_SOCKET:+-S "$TMUX_SOCKET"} source "$TMUX_CONF" \; display "$TMUX_CONF_LOCAL sourced"'

# -- status bar ----------------------------------------------------------------

set -g status-left "[#S] "
set -g status-right "#(basename $(pwd)) %Y-%m-%d %H:%M"

# -- maximize pane ------------------------------------------------------------

run "sh -c ' _maximize_pane() { \
  current_session=\"\${1:-$(tmux display -p '#{session_name}')\" \
  current_pane=\"\${2:-$(tmux display -p '#{pane_id}')\" \
  dead_panes=\$(tmux list-panes -s -t \"\$current_session\" -F '#{pane_dead} #{pane_id} #{pane_start_command}' | grep -E -o \"^1 %.+maximized.+\$\" || true) \
  restore=\$(printf \"%s\" \"\$dead_panes\" | sed -n -E -e \"s/^1 \$current_pane .+maximized.+'(%[0-9]+)'\"?\\$/tmux swap-pane -s \\\\1 -t \$current_pane \; kill-pane -t \$current_pane/p\" \
                           -e \"s/^1 (%[0-9]+) .+maximized.+'\$current_pane'\"?\\$/tmux swap-pane -s \\\\1 -t \$current_pane \; kill-pane -\\\\1/p\") \
  if [ -z \"\$restore\" ]; then \
    [ \"\$(tmux list-panes -t \"\$current_session:\" | wc -l | sed 's/^ *//g')\" -eq 1 ] && tmux display \"Can\\'t maximize with only one pane\" && return \
    info=\$(tmux new-window -t \"\$current_session:\" -F \"#{session_name}:#{window_index}.#{pane_id}\" -P \"maximized... 2>/dev/null & \\\"\\\$TMUX_PROGRAM\\\" \${TMUX_SOCKET:+-S \"\\\$TMUX_SOCKET\"} setw -t \"\$current_session:\" remain-on-exit on; printf \"\\\\033[\$(tput lines);0fPane has been maximized, press <prefix>+ to restore\\n\" '\$current_pane'\") \
    session_window=\${info%.*} \
    new_pane=\${info#*.} \
    retry=20 \
    while [ \"\$(\"\\\$TMUX_PROGRAM\\\" \${TMUX_SOCKET:+-S \"\\\$TMUX_SOCKET\"} list-panes -t \"\$session_window\" -F '#{session_name}:#{window_index}.#{pane_id} #{pane_dead}' 2>/dev/null)\" != \"\$info 1\" ] && [ \"\$retry\" -ne 0 ]; do \
      sleep 0.1 \
      retry=\$((retry - 1)) \
    done \
    if [ \"\$retry\" -eq 0 ]; then \
      tmux display 'Unable to maximize pane' \
    fi \
    tmux setw -t \"\$session_window\" remain-on-exit off \; swap-pane -s \"\$current_pane\" -t \"\$new_pane\" \
  else \
    \$restore || tmux kill-pane \
  fi \
}; _maximize_pane'"

# -- toggle mouse --------------------------------------------------------------

run "sh -c '_toggle_mouse() { \
  old=\$(tmux show -gv mouse); \
  new=\"\"; \
  if [ \"\$old\" = \"on\" ]; then \
    new=\"off\"; \
  else \
    new=\"on\"; \
  fi; \
  tmux set -g mouse \$new \
}; _toggle_mouse'"

# -- source local configuration -------------------------------------------------

if -F '#{TMUX_CONF_LOCAL}' {
  run -b 'tmux source "#{TMUX_CONF_LOCAL}"'
}

# enable mouse by default on start
set -g mouse on
